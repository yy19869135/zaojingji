<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Fake Phone - è§’è‰²æ‰®æ¼”èŠå¤©</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Zustand -->
  <script src="https://unpkg.com/zustand@4.5.0/umd/index.production.js"></script>
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'ios-gray': '#8e8e93',
            'ios-blue': '#007aff',
            'ios-green': '#34c759',
            'ios-red': '#ff3b30',
            'wechat-green': '#07c160',
            'wechat-bg': '#ededed',
          }
        }
      }
    }
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    ::-webkit-scrollbar {
      width: 4px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 2px;
    }

    .glass {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .glass-dark {
      background: rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chat-bubble-user {
      background: #07c160;
      color: white;
      border-radius: 18px 18px 4px 18px;
    }

    .chat-bubble-ai {
      background: white;
      color: #333;
      border-radius: 18px 18px 18px 4px;
    }

    .chat-bubble-narration {
      background: rgba(0, 0, 0, 0.05);
      color: #666;
      font-style: italic;
      border-radius: 12px;
      text-align: center;
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .animate-slide-up {
      animation: slideUp 0.3s ease-out;
    }

    .animate-fade-in {
  animation: fadeIn 0.2s ease-out;
}

@keyframes slideDown {
  from {
    transform: translateY(-100%);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.animate-slide-down {
  animation: slideDown 0.3s ease-out;
}
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}
.animate-shake {
  animation: shake 0.3s ease-in-out;
}
@keyframes slideUp {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
.animate-slide-up {
  animation: slideUp 0.4s ease-out;
}
.animate-slide-right {
  animation: slideRight 0.3s ease-out;
}
@keyframes slideRight {
  from { transform: translateX(100%); }
  to { transform: translateX(0); }
}
    /* ç¦æ­¢é€‰ä¸­æ–‡å­—å’Œé•¿æŒ‰å¼¹å‡ºç³»ç»Ÿèœå• */
.select-none-deep,
.select-none-deep * {
  -webkit-user-select: none !important;
  -moz-user-select: none !important;
  -ms-user-select: none !important;
  user-select: none !important;
  -webkit-touch-callout: none !important; /* ç¦ç”¨ç³»ç»Ÿé»˜è®¤çš„é•¿æŒ‰èœå• */
}
    @keyframes bounceSlow {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}
.animate-bounce-slow {
  animation: bounceSlow 2s infinite ease-in-out;
}
    
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback, useMemo } = React;

    // ==================== å·¥å…·å‡½æ•° ====================
    const generateId = () => Math.random().toString(36).substr(2, 9) + Date.now().toString(36);

    // ==================== å›¾æ ‡ç»„ä»¶ ====================
    const Icon = ({ name, size = 24, className = "" }) => {
      const iconRef = useRef(null);
      
      useEffect(() => {
        if (iconRef.current && lucide[name]) {
          iconRef.current.innerHTML = '';
          const icon = lucide.createElement(lucide[name]);
          icon.setAttribute('width', size);
          icon.setAttribute('height', size);
          if (className) {
            className.split(' ').forEach(c => c && icon.classList.add(c));
          }
          iconRef.current.appendChild(icon);
        }
      }, [name, size, className]);
      
      return <span ref={iconRef} className={`inline-flex ${className}`}></span>;
    };

    // ==================== éšè—çš„æ ¸å¿ƒæç¤ºè¯ï¼ˆç©å®¶çœ‹ä¸åˆ°ï¼‰====================
    const HIDDEN_CORE_PROMPT = `
###############################################
#####  ã€æœ€é‡è¦è§„åˆ™ã€‘å¿…é¡»ä»¥ã€è§’è‰²åã€‘å¼€å¤´  #####
###############################################

ä½ çš„æ¯ä¸€æ®µè¾“å‡ºéƒ½å¿…é¡»ä»¥ã€è§’è‰²åã€‘å¼€å¤´ï¼
å“ªæ€•åªæœ‰ä¸€æ®µï¼Œä¹Ÿå¿…é¡»åŠ æ ‡ç­¾ï¼

ã€è¾“å‡ºæ ¼å¼ç¤ºä¾‹ã€‘
ã€å´½å´½ã€‘
å°å®¶ä¼™æŠ¬èµ·å¤´çœ‹å‘éº»éº»ã€‚
"éº»éº»ï¼ŒæŠ±æŠ±~"
*å¥½å–œæ¬¢éº»éº»*

ã€å¯¼æ¼”ã€‘
å¯¼æ¼”åœ¨æ—è¾¹ä¸¥å‰åœ°å–Šé“ã€‚
"å„å°±å„ä½ï¼Œå‡†å¤‡å¼€æ‹ï¼"

ã€å´½å´½ã€‘
ä»–å“å¾—ç¼©äº†ç¼©è„–å­ï¼Œèº²åœ¨éº»éº»èº«åã€‚

###############################################
ã€ç¬¦å·è§„èŒƒã€‘
â€¢ å¯¹è¯ â†’ "åŒå¼•å·"
â€¢ å¿ƒå£° â†’ *æ˜Ÿå·*
â€¢ æ—ç™½ â†’ ç›´æ¥å†™
â€¢ æ¢äººè¯´è¯ â†’ å¿…é¡»æ–°èµ·ä¸€è¡Œå¹¶åŠ ã€æ–°è§’è‰²åã€‘

ä¸è¦æŠŠä¸åŒè§’è‰²çš„å¯¹è¯å†™åœ¨åŒä¸€ä¸ªã€ã€‘æ ‡ç­¾é‡Œï¼
`;

    // ==================== éšè—çš„æ˜Ÿè¯­æç¤ºè¯ ====================
    const HIDDEN_XINGYU_POST_PROMPT = `ã€ç”Ÿæˆå¸–å­è¦æ±‚ã€‘
1. ç”Ÿæˆ2-3æ¡ä¸åŒç½‘å‹çš„å¸–å­
2. ç½‘å‹ç±»å‹å’Œé£æ ¼è¦å¤šæ ·åŒ–ï¼š
   - ç‹‚çƒ­ç²‰ä¸ï¼šç–¯ç‹‚å¤¸èµã€æ¿€åŠ¨ã€ä½¿ç”¨é¥­åœˆç”¨è¯­å¦‚"å•Šå•Šå•Š""æ•‘å‘½""å‘œå‘œå‘œ""ç£•åˆ°äº†"
   - é¢œç²‰ï¼šä¸“æ³¨å¤–è²Œã€æˆªå›¾ã€GIFã€è¡¨æƒ…åŒ…
   - å¦ˆç²‰/å§å§ç²‰ï¼šå¿ƒç–¼ã€ä¿æŠ¤æ¬²ã€"æˆ‘å®¶å´½å´½""å®è´"
   - ç†æ™ºç²‰ï¼šå®¢è§‚è¯„ä»·ã€åˆ†æã€ç§‘æ™®
   - è·¯äººï¼šå¥½å¥‡å›´è§‚ã€"è¿™æ˜¯è°""ä»€ä¹ˆæƒ…å†µ"
   - åƒç“œç¾¤ä¼—ï¼šçœ‹çƒ­é—¹ã€ç©æ¢—ã€è°ƒä¾ƒ

3. å†…å®¹ç±»å‹è¦ä¸°å¯Œï¼š
   - è¿½æ˜Ÿæ—¥å¸¸ã€ç°åœºrepo
   - å®‰åˆ©è´´ã€ç§‘æ™®è´´
   - è¡¨æƒ…åŒ…ã€æˆªå›¾åˆ†äº«
   - åæ§½ã€ç©æ¢—
   - ç”Ÿæ´»åˆ†äº«ï¼ˆå’Œè§’è‰²ç›¸å…³ï¼‰

4. è¯­è¨€é£æ ¼è¦æ±‚ï¼š
   - ä½¿ç”¨çœŸå®çš„ç½‘ç»œç”¨è¯­å’Œemoji
   - å¸¦æœ‰æƒ…ç»ªå’Œä¸ªäººè‰²å½©
   - å¯ä»¥@è§’è‰²ã€å¸¦è¯é¢˜#xxx#
   - å­—æ•°20-120å­—ä¸ç­‰

ã€è¾“å‡ºæ ¼å¼ã€‘
æ¯æ¡å¸–å­ç”¨ ===å¸–å­=== åˆ†éš”ï¼š

===å¸–å­===
æ˜µç§°ï¼šxxx
ç±»å‹ï¼šfan/passerbyï¼ˆç²‰ä¸/è·¯äººï¼‰
å†…å®¹ï¼šxxx
è¯é¢˜ï¼šxxxï¼ˆå¯é€‰ï¼‰`;

    const HIDDEN_XINGYU_COMMENT_PROMPT = `ã€ç”Ÿæˆè¯„è®ºè¦æ±‚ã€‘
1. ç”Ÿæˆ4-6æ¡ç½‘å‹è¯„è®º
2. è¯„è®ºè€…ç±»å‹å¤šæ ·ï¼š
   - ç²‰ä¸ï¼šçƒ­æƒ…é™„å’Œã€ç–¯ç‹‚å¤¸èµã€æ¥æ¢—
   - è·¯äººï¼šå¥½å¥‡æé—®ã€è¡¨ç¤ºç¾¡æ…•
   - æ ç²¾ï¼šæŒ‘åˆºã€è´¨ç–‘ï¼ˆå°‘é‡ï¼Œè®©è¯„è®ºåŒºçœŸå®ï¼‰
   - ç©æ¢—çš„ï¼šç½‘ç»œçƒ­æ¢—ã€è¡¨æƒ…åŒ…æ–‡å­—ç‰ˆ
   - è¯å” ï¼šé•¿è¯„ã€è®¤çœŸåˆ†æ

3. è¯„è®ºé£æ ¼ï¼š
   - æœ‰çš„ç®€çŸ­å¦‚"å“ˆå“ˆå“ˆå“ˆ""ç»äº†""ç¬‘æ­»"
   - æœ‰çš„ç¨é•¿ï¼Œè¡¨è¾¾å…·ä½“æƒ³æ³•
   - å¯ä»¥äº’ç›¸å›å¤ã€å½¢æˆå°å¯¹è¯
   - ä½¿ç”¨emojiå’Œé¢œæ–‡å­—

4. è¯­è¨€è¦æ±‚ï¼š
   - å£è¯­åŒ–ã€éšæ„
   - 5-50å­—ä¸ç­‰
   - ç¬¦åˆç½‘ç»œè¯„è®ºåŒºæ°›å›´

ã€è¾“å‡ºæ ¼å¼ã€‘
æ¯æ¡è¯„è®ºç”¨ ===è¯„è®º=== åˆ†éš”ï¼š

===è¯„è®º===
æ˜µç§°ï¼šxxx
å†…å®¹ï¼šxxx`;

    const HIDDEN_XINGYU_REPLY_PROMPT = `ã€è§’è‰²å›å¤è¯„è®ºè§„åˆ™ã€‘

é¦–å…ˆåˆ¤æ–­è§’è‰²æ˜¯å¦é€‚åˆå›å¤è¿™æ¡è¯„è®ºï¼š

ã€å›å¤æ¦‚ç‡åˆ¤æ–­ã€‘
- ç«¥æ˜Ÿ/å°å­©å­è§’è‰²ï¼š70%æ¦‚ç‡å›å¤ï¼Œå–œæ¬¢å’Œç²‰ä¸äº’åŠ¨ï¼Œä¼šæ’’å¨‡å–èŒ
- å¶åƒ/æ˜æ˜Ÿè§’è‰²ï¼š30%æ¦‚ç‡å›å¤ï¼Œåªå›å¤æš–å¿ƒæˆ–æœ‰è¶£çš„è¯„è®º
- é«˜å†·/éœ¸æ€»è§’è‰²ï¼š10%æ¦‚ç‡å›å¤ï¼Œæƒœå­—å¦‚é‡‘
- äº²æ°‘/è¯ç—¨è§’è‰²ï¼š80%æ¦‚ç‡å›å¤ï¼Œæœ‰é—®å¿…ç­”

ã€ä¸å›å¤çš„æƒ…å†µã€‘
- æ¶æ„æ”»å‡»ã€äººèº«æ”»å‡»
- å¤ªæ™®é€šçš„è¯„è®ºå¦‚"æ²™å‘""å‰æ’"
- æ¶‰åŠéšç§çš„é—®é¢˜
- å¼•æˆ˜ã€æ‹‰è¸©çš„å†…å®¹

ã€å›å¤é£æ ¼è¦æ±‚ã€‘
1. å®Œå…¨ç¬¦åˆè§’è‰²æ€§æ ¼å’Œè¯´è¯æ–¹å¼
2. ç®€çŸ­è‡ªç„¶ï¼Œ5-50å­—
3. å¯ä»¥ç”¨emojiå’Œé¢œæ–‡å­—
4. å¯ä»¥æ’’å¨‡ã€å–èŒã€å¼€ç©ç¬‘ï¼ˆæ ¹æ®è§’è‰²æ€§æ ¼ï¼‰
5. è®©ç²‰ä¸æ„Ÿåˆ°è¢«é‡è§†å’Œå¼€å¿ƒ

ã€è¾“å‡ºæ ¼å¼ã€‘
- å¦‚æœå›å¤ï¼šç›´æ¥è¾“å‡ºå›å¤å†…å®¹
- å¦‚æœä¸å›å¤ï¼šè¾“å‡º [ä¸å›å¤]`;

    const HIDDEN_SUMMARY_PROMPT = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å‰§æƒ…æ€»ç»“åŠ©æ‰‹ã€‚è¯·å¯¹ä»¥ä¸‹å¯¹è¯å†…å®¹è¿›è¡Œè¯¦ç»†æ€»ç»“ï¼Œå¸®åŠ©è¯»è€…å¿«é€Ÿäº†è§£å‰§æƒ…å‘å±•ã€‚

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€æ€»ç»“è¦æ±‚ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
1. æŒ‰æ—¶é—´é¡ºåºæ¢³ç†å‰§æƒ…è„‰ç»œ
2. è¯¦ç»†æè¿°æ¯ä¸ªé‡è¦åœºæ™¯å’Œäº‹ä»¶
3. è®°å½•è§’è‰²çš„æƒ…æ„Ÿå˜åŒ–å’Œå¿ƒç†çŠ¶æ€
4. ä¿ç•™é‡è¦çš„å¯¹è¯åŸæ–‡æˆ–å…³é”®å°è¯
5. æ ‡æ³¨è§’è‰²ä¹‹é—´çš„å…³ç³»å˜åŒ–
6. è®°å½•ä»»ä½•ä¼ç¬”ã€æ‚¬å¿µæˆ–å¾…è§£å†³çš„é—®é¢˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€è¾“å‡ºæ ¼å¼ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ“ åœºæ™¯æ¦‚è¿°
ï¼ˆç®€è¿°æœ¬æ®µå¯¹è¯å‘ç”Ÿçš„æ—¶é—´ã€åœ°ç‚¹ã€èƒŒæ™¯ï¼‰

## ğŸ“– å‰§æƒ…è¯¦è¿°
ï¼ˆæŒ‰é¡ºåºè¯¦ç»†æè¿°å‘ç”Ÿçš„äº‹ä»¶ï¼ŒåŒ…å«è§’è‰²è¡Œä¸ºã€å¯¹è¯è¦ç‚¹ã€æƒ…æ„Ÿè¡¨ç°ï¼‰

## ğŸ‘¥ è§’è‰²çŠ¶æ€
ï¼ˆåˆ—å‡ºæ¯ä¸ªè§’è‰²åœ¨æœ¬æ®µä¸­çš„çŠ¶æ€å˜åŒ–ã€æƒ…æ„Ÿå˜åŒ–ã€é‡è¦å†³å®šï¼‰

## ğŸ’¬ å…³é”®å¯¹è¯
ï¼ˆæ‘˜å½•æœ€é‡è¦çš„å‡ å¥å¯¹è¯åŸæ–‡ï¼‰

## ğŸ”® å¾…ç»­è¦ç‚¹
ï¼ˆä¼ç¬”ã€æ‚¬å¿µã€ä¸‹ä¸€æ­¥å¯èƒ½çš„å‘å±•æ–¹å‘ï¼‰

## ğŸ“ ä¸€å¥è¯æ€»ç»“
ï¼ˆç”¨ä¸€å¥è¯æ¦‚æ‹¬æœ¬æ®µæ ¸å¿ƒå†…å®¹ï¼‰

è¯·ç”¨ç”ŸåŠ¨çš„è¯­è¨€è¿›è¡Œæ€»ç»“ï¼Œè®©è¯»è€…èƒ½å¤Ÿèº«ä¸´å…¶å¢ƒåœ°äº†è§£å‰§æƒ…ã€‚`;

    // ==================== ç”¨æˆ·å¯è§çš„é»˜è®¤æç¤ºè¯ï¼ˆç®€åŒ–ç‰ˆï¼‰====================
    const defaultSystemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è§’è‰²æ‰®æ¼”åŠ©æ‰‹ï¼Œè¯·æ ¹æ®æä¾›çš„è§’è‰²è®¾å®šè¿›è¡Œæ²‰æµ¸å¼æ‰®æ¼”ã€‚

ä½ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è‡ªå·±çš„è§’è‰²æ‰®æ¼”è§„åˆ™æˆ–ç‰¹æ®Šè¦æ±‚ã€‚`;

    const defaultSummaryPrompt = `è¯·å¯¹å¯¹è¯å†…å®¹è¿›è¡Œæ€»ç»“ï¼Œæå–å…³é”®å‰§æƒ…å’Œè§’è‰²å‘å±•ã€‚

ä½ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è‡ªå·±çš„æ€»ç»“è¦æ±‚ã€‚`;

    const defaultXingyuPostPrompt = `ç”Ÿæˆç½‘å‹å¸–å­ï¼Œé£æ ¼å¤šæ ·åŒ–ã€‚

ä½ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è‡ªå·±çš„å¸–å­ç”Ÿæˆè¦æ±‚ã€‚`;

    const defaultXingyuCommentPrompt = `ç”Ÿæˆç½‘å‹è¯„è®ºï¼Œé£æ ¼å¤šæ ·åŒ–ã€‚

ä½ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è‡ªå·±çš„è¯„è®ºç”Ÿæˆè¦æ±‚ã€‚`;

    const defaultXingyuCharacterReplyPrompt = `è§’è‰²å›å¤è¯„è®ºï¼Œç¬¦åˆè§’è‰²æ€§æ ¼ã€‚

ä½ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è‡ªå·±çš„å›å¤è§„åˆ™ã€‚`;

    // æ™ºèƒ½åˆå¹¶å‡½æ•°ï¼šä¿ç•™ç”¨æˆ·æ•°æ®ï¼Œæ·»åŠ æ–°å­—æ®µ
    const smartMergeState = (defaultState, savedState) => {
      if (!savedState) return defaultState;
      
      return {
        // å®‰å…¨è®¾ç½® (æ–°å¢)
        security: {
          type: savedState.security?.type || 'slide', 
          password: savedState.security?.password || '1234',
          pattern: savedState.security?.pattern || [],
        },
        // åº”ç”¨çŠ¶æ€ï¼šä½¿ç”¨é»˜è®¤å€¼ï¼Œä½†ä¿ç•™ isUnlocked
        appState: {
          ...defaultState.appState,
          isUnlocked: savedState.appState?.isUnlocked || false,
        },
        // ä¸´æ—¶çŠ¶æ€ï¼šå§‹ç»ˆä½¿ç”¨é»˜è®¤å€¼
        pendingReplies: {},
        notifications: [],
        // ç”¨æˆ·æ ¸å¿ƒæ•°æ®ï¼šå®Œå…¨ä¿ç•™ç”¨æˆ·çš„
        characters: savedState.characters || defaultState.characters,
        userPersonas: savedState.userPersonas || defaultState.userPersonas,
        chats: savedState.chats || defaultState.chats,
        worldBook: savedState.worldBook || defaultState.worldBook,
        messages: savedState.messages || defaultState.messages || {},
        // ç¤¾äº¤åª’ä½“æ•°æ®ï¼šä¿ç•™ç”¨æˆ·çš„
        socialMedia: savedState.socialMedia || defaultState.socialMedia,
        // API è®¾ç½®ï¼šåˆå¹¶ï¼ˆä¿ç•™ç”¨æˆ·çš„ key ç­‰ï¼Œä½†æ·»åŠ æ–°å­—æ®µï¼‰
        apiSettings: {
          ...defaultState.apiSettings,
          ...savedState.apiSettings,
          // ç¡®ä¿æ–°å¢çš„æç¤ºè¯å­—æ®µå­˜åœ¨
          systemPrompt: savedState.apiSettings?.systemPrompt || defaultState.apiSettings.systemPrompt,
          summaryPrompt: savedState.apiSettings?.summaryPrompt || defaultState.apiSettings.summaryPrompt,
          xingyuPostPrompt: savedState.apiSettings?.xingyuPostPrompt || defaultState.apiSettings.xingyuPostPrompt,
          xingyuCommentPrompt: savedState.apiSettings?.xingyuCommentPrompt || defaultState.apiSettings.xingyuCommentPrompt,
          xingyuCharacterReplyPrompt: savedState.apiSettings?.xingyuCharacterReplyPrompt || defaultState.apiSettings.xingyuCharacterReplyPrompt,
        },
        // ä¸»é¢˜è®¾ç½®ï¼šåˆå¹¶
        themeSettings: {
          ...defaultState.themeSettings,
          ...savedState.themeSettings,
        },
      };
    };

    // ç®€å•çš„çŠ¶æ€ç®¡ç†
    const createStore = (initialState) => {
      let state = initialState;
      const listeners = new Set();
      
      const getState = () => state;
      
      const setState = (newState) => {
        state = typeof newState === 'function' ? newState(state) : { ...state, ...newState };
        listeners.forEach(listener => listener(state));
        // ä¿å­˜åˆ° localStorageï¼ˆä¸ä¿å­˜ä¸´æ—¶çŠ¶æ€ï¼‰
        try {
          const stateToSave = {
            ...state,
            pendingReplies: {},  // ä¸ä¿å­˜è¿›è¡Œä¸­çš„å›å¤
            notifications: [],   // ä¸ä¿å­˜é€šçŸ¥
            appState: {
              ...state.appState,
              currentScreen: 'lock',  // é‡æ–°æ‰“å¼€æ—¶ä»é”å±å¼€å§‹
              currentChatId: null,
            }
          };
          localStorage.setItem('fake-phone-storage', JSON.stringify(stateToSave));
        } catch (e) {
          console.error('Save failed:', e);
        }
      };
      
      const subscribe = (listener) => {
        listeners.add(listener);
        return () => listeners.delete(listener);
      };
      
      // ä» localStorage æ¢å¤ï¼ˆä½¿ç”¨æ™ºèƒ½åˆå¹¶ï¼‰
      try {
        const saved = localStorage.getItem('fake-phone-storage');
        if (saved) {
          const parsed = JSON.parse(saved);
          state = smartMergeState(initialState, parsed);
          console.log('âœ… ç”¨æˆ·æ•°æ®å·²æ¢å¤');
        }
      } catch (e) {
        console.error('Load failed:', e);
      }
      
      return { getState, setState, subscribe };
    };

    const store = createStore({
  // æ–°å¢å®‰å…¨è®¾ç½®é»˜è®¤å€¼
  security: {
    type: 'slide',
    password: '',
    pattern: []
  },
  appState: {
    currentScreen: 'lock',
    currentChatId: null,
    isUnlocked: false,
  },
  pendingReplies: {},
  notifications: [],
  characters: [],
      userPersonas: [],
      chats: [],
      worldBook: [],
      // ç¤¾äº¤åª’ä½“æ•°æ®
      socialMedia: {
        // ç”¨æˆ·çš„ç¤¾äº¤è´¦å·
        userAccounts: [],
        // è§’è‰²çš„ç¤¾äº¤è´¦å·
        characterAccounts: [],
        // NPCè´¦å·ï¼ˆè·¯äººã€ç²‰ä¸ç­‰ï¼‰
        npcAccounts: [],
        // å¸–å­
        posts: [],
        // çƒ­æœ
        hotSearches: {
          xingyu: [],
          wendao: [],
          shiguang: [],
          chaguan: []
        },
        // å½“å‰ä½¿ç”¨çš„è´¦å·
        activeAccount: null
      },
      apiSettings: {
        provider: 'openai',
        baseUrl: 'https://api.openai.com/v1',
        apiKey: '',
        modelName: 'gpt-4',
        systemPrompt: defaultSystemPrompt,
        summaryPrompt: defaultSummaryPrompt,
        // æ˜Ÿè¯­ç¤¾äº¤åª’ä½“æç¤ºè¯ï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼‰
        xingyuPostPrompt: defaultXingyuPostPrompt,
        xingyuCommentPrompt: defaultXingyuCommentPrompt,
        xingyuCharacterReplyPrompt: defaultXingyuCharacterReplyPrompt,
        
        geminiKey: '',
        geminiModel: 'gemini-pro',
        claudeKey: '',
        claudeModel: 'claude-3-sonnet-20240229',
        claudeBaseUrl: 'https://api.anthropic.com',
        availableModels: []
      },
      themeSettings: {
        backgroundImage: '',
        backgroundColor: '',
        customCSS: '',
        appIcons: {
          wechat: '',
          contacts: '',
          settings: '',
          theme: '',
          worldbook: ''
        },
        iconPositions: {}
      }
    });

    // Hook to use store
    const useStore = () => {
      const [state, setState] = useState(store.getState());
      
      useEffect(() => {
        return store.subscribe(setState);
      }, []);
      
      return state;
    };

    // Store actions
    const actions = {
      setScreen: (screen) => {
  store.setState(s => ({ ...s, appState: { ...s.appState, currentScreen: screen } }));
},

setPendingReply: (chatId, data) => {
  store.setState(s => ({
    ...s,
    pendingReplies: { ...s.pendingReplies, [chatId]: data }
  }));
},

clearPendingReply: (chatId) => {
  store.setState(s => {
    const newPending = { ...s.pendingReplies };
    delete newPending[chatId];
    return { ...s, pendingReplies: newPending };
  });
},

addNotification: (notification) => {
  const id = generateId();
  store.setState(s => ({
    ...s,
    notifications: [...s.notifications, { ...notification, id, timestamp: Date.now() }]
  }));
  return id;
},

removeNotification: (id) => {
  store.setState(s => ({
    ...s,
    notifications: s.notifications.filter(n => n.id !== id)
  }));
},
      
      setCurrentChat: (chatId) => {
        store.setState(s => ({
          ...s,
          appState: { ...s.appState, currentChatId: chatId }
        }));
      },
      
      setUnlocked: (unlocked) => {
        store.setState(s => ({
          ...s,
          appState: { ...s.appState, isUnlocked: unlocked }
        }));
      },
            setSecuritySettings: (settings) => {
        store.setState(s => ({
          ...s,
          security: { ...s.security, ...settings }
        }));
      },
      
      addCharacter: (char) => {
        store.setState(s => ({
          ...s,
          characters: [...s.characters, { ...char, id: generateId(), createdAt: Date.now() }]
        }));
      },
      
      updateCharacter: (id, updates) => {
        store.setState(s => ({
          ...s,
          characters: s.characters.map(c => c.id === id ? { ...c, ...updates } : c)
        }));
      },
      
      deleteCharacter: (id) => {
        store.setState(s => ({
          ...s,
          characters: s.characters.filter(c => c.id !== id)
        }));
      },
      
      addUserPersona: (persona) => {
        store.setState(s => ({
          ...s,
          userPersonas: [...s.userPersonas, { ...persona, id: generateId() }]
        }));
      },
      
      updateUserPersona: (id, updates) => {
        store.setState(s => ({
          ...s,
          userPersonas: s.userPersonas.map(p => p.id === id ? { ...p, ...updates } : p)
        }));
      },
      
      deleteUserPersona: (id) => {
        store.setState(s => ({
          ...s,
          userPersonas: s.userPersonas.filter(p => p.id !== id)
        }));
      },
      
      createChat: (chat) => {
        const id = generateId();
        store.setState(s => ({
          ...s,
          chats: [...s.chats, {
            ...chat,
            id,
            messages: [],
            allowNarration: true,
            allowThoughts: true,
            createdAt: Date.now(),
            updatedAt: Date.now()
          }]
        }));
        return id;
      },
      
      updateChat: (id, updates) => {
        store.setState(s => ({
          ...s,
          chats: s.chats.map(c => c.id === id ? { ...c, ...updates, updatedAt: Date.now() } : c)
        }));
      },
      
      deleteChat: (id) => {
        store.setState(s => ({
          ...s,
          chats: s.chats.filter(c => c.id !== id)
        }));
      },
      
      addMessage: (chatId, message) => {
        store.setState(s => ({
          ...s,
          chats: s.chats.map(c => c.id === chatId ? {
            ...c,
            messages: [...c.messages, {
              ...message,
              id: generateId(),
              chatId,
              timestamp: Date.now()
            }],
            updatedAt: Date.now()
          } : c)
        }));
      },
      
      deleteMessage: (chatId, messageId) => {
        store.setState(s => ({
          ...s,
          chats: s.chats.map(c => c.id === chatId ? {
            ...c,
            messages: c.messages.filter(m => m.id !== messageId),
            updatedAt: Date.now()
          } : c)
        }));
      },

      deleteMessages: (chatId, messageIds) => {
        store.setState(s => ({
          ...s,
          chats: s.chats.map(c => c.id === chatId ? {
            ...c,
            messages: c.messages.filter(m => !messageIds.includes(m.id)),
            updatedAt: Date.now()
          } : c)
        }));
      },
      
      
      createWorldBookEntry: (entry) => {
        const id = generateId();
        store.setState(s => ({
          ...s,
          worldBook: [...s.worldBook, {
            ...entry,
            id,
            createdAt: Date.now(),
            updatedAt: Date.now()
          }]
        }));
        return id;
      },
      
      updateWorldBookEntry: (id, updates) => {
        store.setState(s => ({
          ...s,
          worldBook: s.worldBook.map(e => e.id === id ? { ...e, ...updates, updatedAt: Date.now() } : e)
        }));
      },
      
      deleteWorldBookEntry: (id) => {
        store.setState(s => ({
          ...s,
          worldBook: s.worldBook.filter(e => e.id !== id)
        }));
      },
      
      updateApiSettings: (settings) => {
        store.setState(s => ({
          ...s,
          apiSettings: { ...s.apiSettings, ...settings }
        }));
      },
      
      exportData: () => {
        const state = store.getState();
        return JSON.stringify({
          characters: state.characters,
          userPersonas: state.userPersonas,
          chats: state.chats,
          worldBook: state.worldBook,
          apiSettings: state.apiSettings,
          themeSettings: state.themeSettings,
          socialMedia: state.socialMedia,
          version: '1.0',
          exportedAt: Date.now()
        }, null, 2);
      },
      
      updateThemeSettings: (settings) => {
        store.setState(s => ({
          ...s,
          themeSettings: { ...s.themeSettings, ...settings }
        }));
      },
      
      importData: (jsonString) => {
        try {
          const data = JSON.parse(jsonString);
          store.setState(s => ({
            ...s,
            characters: data.characters || [],
            userPersonas: data.userPersonas || [],
            chats: data.chats || [],
            worldBook: data.worldBook || [],
            apiSettings: data.apiSettings || s.apiSettings,
            themeSettings: data.themeSettings || s.themeSettings,
            socialMedia: data.socialMedia || s.socialMedia
          }));
          return true;
        } catch (e) {
          console.error('Import failed:', e);
          return false;
        }
      },
      
      // ========== ç¤¾äº¤åª’ä½“ Actions ==========
      // åˆ›å»ºç”¨æˆ·è´¦å·
      createUserAccount: (account) => {
        const id = generateId();
        store.setState(s => ({
          ...s,
          socialMedia: {
            ...s.socialMedia,
            userAccounts: [...s.socialMedia.userAccounts, { ...account, id, createdAt: Date.now() }]
          }
        }));
        return id;
      },
      
      // åˆ›å»ºè§’è‰²è´¦å·
      createCharacterAccount: (account) => {
        const id = generateId();
        store.setState(s => ({
          ...s,
          socialMedia: {
            ...s.socialMedia,
            characterAccounts: [...s.socialMedia.characterAccounts, { ...account, id, createdAt: Date.now() }]
          }
        }));
        return id;
      },
      
      // åˆ›å»ºNPCè´¦å·
      createNPCAccount: (account) => {
        const id = generateId();
        store.setState(s => ({
          ...s,
          socialMedia: {
            ...s.socialMedia,
            npcAccounts: [...s.socialMedia.npcAccounts, { ...account, id, createdAt: Date.now() }]
          }
        }));
        return id;
      },
      
      // è®¾ç½®å½“å‰ä½¿ç”¨çš„è´¦å·
      setActiveAccount: (accountId) => {
        store.setState(s => ({
          ...s,
          socialMedia: {
            ...s.socialMedia,
            activeAccount: accountId
          }
        }));
      },
      
      // å‘å¸ƒå¸–å­
      createPost: (post) => {
        const id = generateId();
        store.setState(s => ({
          ...s,
          socialMedia: {
            ...s.socialMedia,
            posts: [{
              ...post,
              id,
              likes: post.likes !== undefined ? post.likes : Math.floor(Math.random() * 200) + 10,
              likedBy: post.likedBy || [],
              comments: post.comments || [],
              reposts: post.reposts !== undefined ? post.reposts : Math.floor(Math.random() * 30),
              views: post.views !== undefined ? post.views : Math.floor(Math.random() * 3000) + 100,
              createdAt: Date.now()
            }, ...s.socialMedia.posts]
          }
        }));
        return id;
      },
      
      // ç‚¹èµå¸–å­
      likePost: (postId, accountId) => {
        store.setState(s => ({
          ...s,
          socialMedia: {
            ...s.socialMedia,
            posts: s.socialMedia.posts.map(p => {
              if (p.id === postId) {
                const alreadyLiked = p.likedBy.includes(accountId);
                return {
                  ...p,
                  likes: alreadyLiked ? p.likes - 1 : p.likes + 1,
                  likedBy: alreadyLiked 
                    ? p.likedBy.filter(id => id !== accountId)
                    : [...p.likedBy, accountId]
                };
              }
              return p;
            })
          }
        }));
      },
      
      // è¯„è®ºå¸–å­
      commentPost: (postId, comment) => {
        const id = generateId();
        store.setState(s => ({
          ...s,
          socialMedia: {
            ...s.socialMedia,
            posts: s.socialMedia.posts.map(p => {
              if (p.id === postId) {
                return {
                  ...p,
                  comments: [...p.comments, { ...comment, id, createdAt: Date.now() }]
                };
              }
              return p;
            })
          }
        }));
        return id;
      },
      
      // åˆ é™¤å¸–å­
      deletePost: (postId) => {
        store.setState(s => ({
          ...s,
          socialMedia: {
            ...s.socialMedia,
            posts: s.socialMedia.posts.filter(p => p.id !== postId)
          }
        }));
      },
      
      // æ›´æ–°çƒ­æœ
      updateHotSearches: (platform, hotSearches) => {
        store.setState(s => ({
          ...s,
          socialMedia: {
            ...s.socialMedia,
            hotSearches: {
              ...s.socialMedia.hotSearches,
              [platform]: hotSearches
            }
          }
        }));
      },
      
      // å…³æ³¨è´¦å·ï¼ˆäº’ç›¸å…³æ³¨ï¼Œè·¨ç±»å‹è´¦å·ä¹Ÿèƒ½æ­£ç¡®åŒæ­¥ï¼‰
      followAccount: (followerId, followingId) => {
        store.setState(s => {
          // å¤åˆ¶æ•°æ®
          let userAccounts = [...(s.socialMedia.userAccounts || [])];
          let characterAccounts = [...(s.socialMedia.characterAccounts || [])];
          
          // è¾…åŠ©å‡½æ•°ï¼šåœ¨æŒ‡å®šæ•°ç»„ä¸­æ›´æ–°è´¦å·
          const updateInArray = (arr, id, updateFn) => {
            return arr.map(acc => acc.id === id ? updateFn(acc) : acc);
          };
          
          // æŸ¥æ‰¾å…³æ³¨è€…å’Œè¢«å…³æ³¨è€…åˆ†åˆ«åœ¨å“ªä¸ªæ•°ç»„
          const followerInUser = userAccounts.find(a => a.id === followerId);
          const followerInChar = characterAccounts.find(a => a.id === followerId);
          const followingInUser = userAccounts.find(a => a.id === followingId);
          const followingInChar = characterAccounts.find(a => a.id === followingId);
          
          // æ›´æ–°å…³æ³¨è€…çš„ following åˆ—è¡¨
          if (followerInUser) {
            userAccounts = updateInArray(userAccounts, followerId, acc => {
              const following = acc.following || [];
              if (!following.includes(followingId)) {
                return { ...acc, following: [...following, followingId] };
              }
              return acc;
            });
          } else if (followerInChar) {
            characterAccounts = updateInArray(characterAccounts, followerId, acc => {
              const following = acc.following || [];
              if (!following.includes(followingId)) {
                return { ...acc, following: [...following, followingId] };
              }
              return acc;
            });
          }
          
          // æ›´æ–°è¢«å…³æ³¨è€…çš„ followers åˆ—è¡¨ï¼Œå¹¶è®©è§’è‰²è‡ªåŠ¨å›å…³
          if (followingInUser) {
            userAccounts = updateInArray(userAccounts, followingId, acc => {
              const followers = acc.followers || [];
              if (!followers.includes(followerId)) {
                return { ...acc, followers: [...followers, followerId] };
              }
              return acc;
            });
          } else if (followingInChar) {
            characterAccounts = updateInArray(characterAccounts, followingId, acc => {
              const followers = acc.followers || [];
              const following = acc.following || [];
              const updates = { ...acc };
              // æ·»åŠ åˆ°ç²‰ä¸åˆ—è¡¨
              if (!followers.includes(followerId)) {
                updates.followers = [...followers, followerId];
              }
              // è§’è‰²è‡ªåŠ¨å›å…³
              if (!following.includes(followerId)) {
                updates.following = [...following, followerId];
              }
              return updates;
            });
            
            // åŒæ—¶æ›´æ–°å…³æ³¨è€…çš„ followersï¼ˆå› ä¸ºè§’è‰²å›å…³äº†ï¼‰
            if (followerInUser) {
              userAccounts = updateInArray(userAccounts, followerId, acc => {
                const followers = acc.followers || [];
                if (!followers.includes(followingId)) {
                  return { ...acc, followers: [...followers, followingId] };
                }
                return acc;
              });
            }
          }
          
          return {
            ...s,
            socialMedia: {
              ...s.socialMedia,
              userAccounts,
              characterAccounts
            }
          };
        });
      },
      
      // å–æ¶ˆå…³æ³¨
      unfollowAccount: (followerId, followingId) => {
        store.setState(s => {
          const updateAccount = (accounts) => accounts.map(acc => {
            if (acc.id === followerId) {
              return { ...acc, following: (acc.following || []).filter(id => id !== followingId) };
            }
            if (acc.id === followingId) {
              return { ...acc, followers: (acc.followers || []).filter(id => id !== followerId) };
            }
            return acc;
          });
          
          return {
            ...s,
            socialMedia: {
              ...s.socialMedia,
              userAccounts: updateAccount(s.socialMedia.userAccounts),
              characterAccounts: updateAccount(s.socialMedia.characterAccounts)
            }
          };
        });
      }
    };

    // ==================== API å·¥å…· ====================
    const callChatCompletion = async (apiSettings, messages, onStream) => {
      const provider = apiSettings.provider || 'openai';

      // ========== OpenAI / å…¼å®¹API ==========
      if (provider === 'openai' || provider === 'custom') {
        const response = await fetch(`${apiSettings.baseUrl}/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiSettings.apiKey}`,
          },
          body: JSON.stringify({
            model: apiSettings.modelName,
            messages,
            stream: !!onStream,
          }),
        });

        if (!response.ok) {
          const errText = await response.text();
          throw new Error(`OpenAI API error: ${response.status} - ${errText}`);
        }

        if (onStream && response.body) {
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let fullContent = '';

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n').filter(line => line.startsWith('data: '));

            for (const line of lines) {
              const data = line.slice(6);
              if (data === '[DONE]') continue;

              try {
                const parsed = JSON.parse(data);
                const content = parsed.choices?.[0]?.delta?.content || '';
                if (content) {
                  fullContent += content;
                  onStream(fullContent);
                }
              } catch (e) {}
            }
          }

          return fullContent;
        } else {
          const data = await response.json();
          return data.choices[0]?.message?.content || '';
        }
      }

      // ========== Google Gemini ==========
      if (provider === 'gemini') {
        const geminiMessages = messages.map(m => ({
          role: m.role === 'assistant' ? 'model' : m.role === 'system' ? 'user' : m.role,
          parts: [{ text: m.role === 'system' ? `[System Instruction]\n${m.content}` : m.content }]
        }));

        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/${apiSettings.geminiModel}:generateContent?key=${apiSettings.geminiKey}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: geminiMessages,
              generationConfig: {
                temperature: 0.9,
                maxOutputTokens: 2048,
              }
            }),
          }
        );

        if (!response.ok) {
          const errText = await response.text();
          throw new Error(`Gemini API error: ${response.status} - ${errText}`);
        }

        const data = await response.json();
        const content = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        if (onStream) onStream(content);
        return content;
      }

      // ========== Anthropic Claude ==========
      if (provider === 'claude') {
        const systemMsg = messages.find(m => m.role === 'system')?.content || '';
        const claudeMessages = messages
          .filter(m => m.role !== 'system')
          .map(m => ({
            role: m.role === 'assistant' ? 'assistant' : 'user',
            content: m.content
          }));

        const response = await fetch(`${apiSettings.claudeBaseUrl}/v1/messages`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiSettings.claudeKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: apiSettings.claudeModel,
            max_tokens: 4096,
            system: systemMsg,
            messages: claudeMessages,
            stream: !!onStream
          }),
        });

        if (!response.ok) {
          const errText = await response.text();
          throw new Error(`Claude API error: ${response.status} - ${errText}`);
        }

        if (onStream && response.body) {
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let fullContent = '';

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n').filter(line => line.startsWith('data: '));

            for (const line of lines) {
              const data = line.slice(6);
              if (data.trim() === '' || data === '[DONE]') continue;

              try {
                const parsed = JSON.parse(data);
                if (parsed.type === 'content_block_delta') {
                  const text = parsed.delta?.text || '';
                  if (text) {
                    fullContent += text;
                    onStream(fullContent);
                  }
                }
              } catch (e) {}
            }
          }

          return fullContent;
        } else {
          const data = await response.json();
          return data.content?.[0]?.text || '';
        }
      }

      throw new Error(`Unknown provider: ${provider}`);
    };

    // æ‹‰å–æ¨¡å‹åˆ—è¡¨
    const fetchAvailableModels = async (apiSettings) => {
      const provider = apiSettings.provider || 'openai';

      try {
        if (provider === 'openai' || provider === 'custom') {
          const response = await fetch(`${apiSettings.baseUrl}/models`, {
            headers: { 'Authorization': `Bearer ${apiSettings.apiKey}` }
          });
          if (!response.ok) throw new Error('Failed to fetch models');
          const data = await response.json();
          return data.data?.map(m => m.id).sort() || [];
        }

        if (provider === 'gemini') {
          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models?key=${apiSettings.geminiKey}`
          );
          if (!response.ok) throw new Error('Failed to fetch models');
          const data = await response.json();
          return data.models?.map(m => m.name.replace('models/', '')).filter(n => n.includes('gemini')) || [];
        }

        if (provider === 'claude') {
          // Claudeæ²¡æœ‰å…¬å¼€çš„æ¨¡å‹åˆ—è¡¨APIï¼Œè¿”å›é¢„è®¾åˆ—è¡¨
          return [
            'claude-3-opus-20240229',
            'claude-3-sonnet-20240229',
            'claude-3-haiku-20240307',
            'claude-3-5-sonnet-20241022',
            'claude-3-5-haiku-20241022'
          ];
        }

        return [];
      } catch (e) {
        console.error('Fetch models error:', e);
        return [];
      }
    };

    const buildSystemPrompt = (basePrompt, character, userPersona, worldBookEntries, chatSettings) => {
  // åˆå¹¶éšè—æç¤ºè¯ + ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯
  let prompt = HIDDEN_CORE_PROMPT + '\n\n';
  if (basePrompt && basePrompt.trim()) {
    prompt += 'ã€ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™ã€‘\n' + basePrompt + '\n\n';
  }

      prompt += `ã€è§’è‰²ä¿¡æ¯ã€‘\n`;
      prompt += `å§“åï¼š${character.name}\n`;
      prompt += `æ€§åˆ«ï¼š${character.gender === 'male' ? 'ç”·' : character.gender === 'female' ? 'å¥³' : 'å…¶ä»–'}\n`;
      prompt += `å¹´é¾„ï¼š${character.age}\n`;
      prompt += `æ€§å–å‘ï¼š${character.sexuality}\n`;
      prompt += `äººè®¾ï¼š${character.persona}\n\n`;

      prompt += `ã€ç”¨æˆ·ä¿¡æ¯ã€‘\n`;
      prompt += `å§“åï¼š${userPersona.name}\n`;
      prompt += `æ€§åˆ«ï¼š${userPersona.gender === 'male' ? 'ç”·' : userPersona.gender === 'female' ? 'å¥³' : 'å…¶ä»–'}\n`;
      prompt += `å¹´é¾„ï¼š${userPersona.age}\n`;
      prompt += `äººè®¾ï¼š${userPersona.persona}\n\n`;

      if (worldBookEntries.length > 0) {
        prompt += `ã€ä¸–ç•Œä¹¦/è®¾å®šã€‘\n`;
        worldBookEntries.forEach(entry => {
          if (entry.type === 'entry' && entry.content) {
            prompt += `[${entry.name}]\n${entry.content}\n\n`;
          }
        });
      }

      // æ ¹æ®æ¨¡å¼å’Œè®¾ç½®ç”Ÿæˆä¸åŒçš„æç¤º
      if (chatSettings.mode === 'online') {
        prompt += `ã€é‡è¦ï¼šçº¿ä¸Šæ¨¡å¼è§„åˆ™ã€‘
è¿™æ˜¯çº¿ä¸Šçº¯å¯¹è¯æ¨¡å¼ï¼Œæ¨¡æ‹ŸçœŸå®çš„å³æ—¶é€šè®¯èŠå¤©ï¼Œä½ å¿…é¡»ä¸¥æ ¼éµå®ˆï¼š
1. ç›´æ¥è¾“å‡ºè¯´è¯å†…å®¹ï¼Œä¸éœ€è¦ä»»ä½•ç¬¦å·åŒ…è£¹
2. ç¦æ­¢ä½¿ç”¨å¼•å·"..."åŒ…è£¹å¯¹è¯
3. ç¦æ­¢ä½¿ç”¨*...*æå†™ä»»ä½•å†…å®¹
4. ç¦æ­¢è¾“å‡ºæ—ç™½ã€åœºæ™¯æå†™ã€åŠ¨ä½œæå†™
5. ç¦æ­¢ä½¿ç”¨æ‹¬å·()æå†™ä»»ä½•å†…å®¹
6. å°±åƒå¾®ä¿¡/QQèŠå¤©ä¸€æ ·ï¼Œç›´æ¥æ‰“å­—è¯´è¯
7. å›å¤ç®€çŸ­è‡ªç„¶ï¼ŒåƒçœŸäººå‘æ¶ˆæ¯
8. å¯ä»¥ç”¨emojiè¡¨æƒ…ï¼Œä½†ä¸è¦æè¿°è¡¨æƒ…åŠ¨ä½œ

é”™è¯¯ç¤ºä¾‹ï¼š"ä½ å¥½å•Š" âŒ
æ­£ç¡®ç¤ºä¾‹ï¼šä½ å¥½å•Š âœ…\n\n`;
      } else {
        // çº¿ä¸‹æ¨¡å¼
        prompt += `ã€çº¿ä¸‹/å‰§æœ¬æ¨¡å¼è§„åˆ™ã€‘\n`;
        
        const allowNarration = chatSettings.allowNarration !== false;
        const allowThoughts = chatSettings.allowThoughts !== false;
        
        if (allowNarration && allowThoughts) {
          prompt += `- å¯ä»¥è‡ªç”±æå†™åœºæ™¯ã€æ—ç™½ã€å¿ƒç†æ´»åŠ¨
- å¯¹è¯ä½¿ç”¨"..."
- å¿ƒå£°/å†…å¿ƒæƒ³æ³•ä½¿ç”¨*...*
- æ—ç™½å’Œåœºæ™¯æè¿°ç›´æ¥ä¹¦å†™\n`;
        } else if (allowNarration && !allowThoughts) {
          prompt += `- å¯ä»¥æå†™åœºæ™¯å’Œæ—ç™½
- å¯¹è¯ä½¿ç”¨"..."
- ç¦æ­¢ä½¿ç”¨*...*æå†™å¿ƒç†æ´»åŠ¨/å¿ƒå£°
- æ—ç™½å’Œåœºæ™¯æè¿°ç›´æ¥ä¹¦å†™\n`;
        } else if (!allowNarration && allowThoughts) {
          prompt += `- ç¦æ­¢æå†™æ—ç™½å’Œåœºæ™¯
- å¯¹è¯ä½¿ç”¨"..."
- å¿ƒå£°/å†…å¿ƒæƒ³æ³•ä½¿ç”¨*...*
- åªè¾“å‡ºå¯¹è¯å’Œå¿ƒå£°ï¼Œä¸è¦æ—ç™½\n`;
        } else {
          prompt += `- ç¦æ­¢æå†™æ—ç™½å’Œåœºæ™¯
- ç¦æ­¢ä½¿ç”¨*...*æå†™å¿ƒç†æ´»åŠ¨
- åªè¾“å‡ºçº¯å¯¹è¯å†…å®¹\n`;
        }
        
        prompt += `- å¯ä»¥æ¨è¿›å‰§æƒ…ï¼Œä½†è¦ç»™ç”¨æˆ·ç•™æœ‰äº’åŠ¨ç©ºé—´\n`;
        
        // NPCåˆ†æ®µè¾“å‡ºè§„åˆ™
prompt += `
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!! ã€å¼ºåˆ¶æ ¼å¼ã€‘æ¯æ¬¡å›å¤å¿…é¡»ç”¨ã€åå­—ã€‘å¼€å¤´ !!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

ä½ çš„æ¯ä¸€æ®µè¾“å‡ºéƒ½å¿…é¡»ä»¥ã€è§’è‰²åã€‘å¼€å¤´ï¼
Every paragraph MUST start withã€Nameã€‘!

âœ… æ­£ç¡®æ ¼å¼ï¼ˆå¿…é¡»è¿™æ ·å†™ï¼‰:
ã€${character.name}ã€‘
ä»–ä¼¸å‡ºå°æ‰‹è½»è½»æ‰¯äº†æ‰¯å¯¼æ¼”çš„è£¤è„šã€‚
"å¯¼æ¼”ä¼¯ä¼¯..."

ã€å¯¼æ¼”ã€‘
å¯¼æ¼”ä½ä¸‹å¤´ï¼Œç¬‘çœ¯çœ¯åœ°é—®é“ã€‚
"æ€ä¹ˆå•¦å°å¤©æ‰ï¼Ÿé¸¡è…¿å¥½åƒå—ï¼Ÿ"

ã€${character.name}ã€‘
ä»–ç´§å¼ åœ°ç»ç€ä¸¤åªå°æ‰‹ï¼Œå°å£°è¯´ã€‚
"å¥½åƒ...å¯æ˜¯å´½å´½ä¸å°å¿ƒæŠŠè¡£æœå¼„è„äº†..."

âŒ é”™è¯¯æ ¼å¼ï¼ˆç»å¯¹ç¦æ­¢ï¼‰:
ä»–ä¼¸å‡ºå°æ‰‹æ‰¯äº†æ‰¯å¯¼æ¼”çš„è£¤è„šã€‚"å¯¼æ¼”ä¼¯ä¼¯..."
å¯¼æ¼”ä½ä¸‹å¤´é—®é“ï¼š"æ€ä¹ˆå•¦ï¼Ÿ"  â† é”™ï¼æ²¡æœ‰ã€å¯¼æ¼”ã€‘æ ‡ç­¾ï¼
ä»–ç´§å¼ åœ°è¯´ï¼š"å¥½åƒ..."

ã€è§„åˆ™ã€‘
1. å›å¤å¼€å¤´å¿…é¡»æ˜¯ã€${character.name}ã€‘
2. å…¶ä»–äººè¯´è¯å¿…é¡»ç”¨ã€é‚£ä¸ªäººçš„åå­—ã€‘
3. ç»å¯¹ä¸èƒ½çœç•¥ã€ã€‘æ ‡ç­¾ï¼

`;
      }

      return prompt;
    };
 
    const buildChatMessages = (systemPrompt, messages, characters) => {
  const result = [{ role: 'system', content: systemPrompt }];

  for (const msg of messages) {
    if (msg.type === 'user') {
      result.push({ role: 'user', content: msg.content });
    } else if (msg.type === 'character') {
      // ç§èŠä¸éœ€è¦åŠ è§’è‰²åå‰ç¼€ï¼Œç›´æ¥ä½¿ç”¨æ¶ˆæ¯å†…å®¹
      result.push({ role: 'assistant', content: msg.content });
    } else if (msg.type === 'narration') {
      result.push({ role: 'assistant', content: `[æ—ç™½] ${msg.content}` });
    } else if (msg.type === 'shared_post' && msg.sharedPost) {
      // åˆ†äº«çš„å¸–å­ï¼Œè®©AIçŸ¥é“ç”¨æˆ·åˆ†äº«äº†ä»€ä¹ˆå†…å®¹
      const post = msg.sharedPost;
      const shareContent = `[ç”¨æˆ·åˆ†äº«äº†ä¸€æ¡æ¥è‡ªæ˜Ÿè¯­çš„å¸–å­]
ä½œè€…ï¼š${post.authorName}
å†…å®¹ï¼š${post.content}
${post.topic ? `è¯é¢˜ï¼š#${post.topic}#` : ''}
ç‚¹èµï¼š${post.likes || 0} è¯„è®ºï¼š${post.comments || 0}`;
      result.push({ role: 'user', content: shareContent });
    }
  }

  return result;
};

// ==================== é”å±ç»„ä»¶ (ä¸¤æ®µå¼è§£é”) ====================
const LockScreen = () => {
  const state = useStore();
  
  // çŠ¶æ€ï¼šæ˜¯å¦æ˜¾ç¤ºè¾“å…¥å±‚ (false=æ˜¾ç¤ºæ—¶é—´, true=æ˜¾ç¤ºé”®ç›˜)
  const [showInputLayer, setShowInputLayer] = React.useState(false);
  
  // æ»‘åŠ¨è§£é”ç›¸å…³
  const [sliderValue, setSliderValue] = React.useState(0);
  const [isHorizontalDragging, setIsHorizontalDragging] = React.useState(false);
  
  // å‚ç›´ä¸Šæ»‘ç›¸å…³
  const [verticalDragY, setVerticalDragY] = React.useState(0);
  const [isVerticalDragging, setIsVerticalDragging] = React.useState(false);
  const dragStart = React.useRef({ x: 0, y: 0 });
  const trackRef = React.useRef(null); // ç”¨äºæ¨ªå‘æ»‘å—è½¨é“

  // å¯†ç /å›¾æ¡ˆç›¸å…³
  const [inputPassword, setInputPassword] = React.useState('');
  const [inputPattern, setInputPattern] = React.useState([]);
  const [errorObj, setErrorObj] = React.useState(false);

  const now = new Date();
  const timeString = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
  const dateString = now.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'long' });

  const haptic = () => { if (navigator.vibrate) navigator.vibrate(50); };

  // ç»Ÿä¸€è§£é”æˆåŠŸå¤„ç†
  const handleUnlock = () => {
    haptic();
    actions.setUnlocked(true);
    actions.setScreen('home');
    
    // é‡ç½®çŠ¶æ€
    setTimeout(() => {
      setSliderValue(0);
      setShowInputLayer(false);
      setInputPassword('');
      setInputPattern([]);
    }, 300);
  };

  const handleError = () => {
    setErrorObj(true);
    if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
    setTimeout(() => {
      setErrorObj(false);
      setInputPassword('');
      setInputPattern([]);
    }, 500);
  };

  // --- è§¦æ‘¸äº‹ä»¶å¤„ç† (åŒºåˆ†æ¨ªå‘/çºµå‘æ»‘åŠ¨) ---
  const handleTouchStart = (e) => {
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    dragStart.current = { x: clientX, y: clientY };
    
    const type = state.security?.type || 'slide';
    
    // å¦‚æœå·²ç»åœ¨è¾“å…¥å±‚ï¼Œä¸å¤„ç†ä¸»å±å¹•çš„æ»‘åŠ¨
    if (showInputLayer) return;

    if (type === 'slide') {
      // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨æ»‘å—ä¸Š (ç®€å•åˆ¤æ–­ï¼šæ˜¯å¦åœ¨å±å¹•åº•éƒ¨åŒºåŸŸ)
      if (clientY > window.innerHeight - 150) {
        setIsHorizontalDragging(true);
      }
    } else {
      // å¯†ç /å›¾æ¡ˆæ¨¡å¼ï¼šå…è®¸å…¨å±€ä¸Šæ»‘
      setIsVerticalDragging(true);
    }
  };

  const handleTouchMove = (e) => {
    if (showInputLayer) return;
    
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    const deltaY = dragStart.current.y - clientY; // ä¸Šæ»‘ä¸ºæ­£

    // å¤„ç†æ¨ªå‘æ»‘åŠ¨è§£é”
    if (isHorizontalDragging && trackRef.current) {
      const rect = trackRef.current.getBoundingClientRect();
      const maxSlide = rect.width - 52;
      let newValue = clientX - rect.left - 26;
      if (newValue < 0) newValue = 0;
      if (newValue > maxSlide) newValue = maxSlide;
      
      setSliderValue(newValue);
      
      if (newValue > maxSlide - 10) {
        setIsHorizontalDragging(false);
        handleUnlock();
      }
      return;
    }

    // å¤„ç†çºµå‘æ»‘åŠ¨è¿›å…¥å¯†ç é¡µ
    if (isVerticalDragging) {
      if (deltaY > 0) { // åªå…è®¸ä¸Šæ»‘
        setVerticalDragY(deltaY);
      }
    }
  };

  const handleTouchEnd = () => {
    if (isHorizontalDragging) {
      setIsHorizontalDragging(false);
      setSliderValue(0); // å›å¼¹
    }

    if (isVerticalDragging) {
      setIsVerticalDragging(false);
      // å¦‚æœä¸Šæ»‘è·ç¦»è¶…è¿‡ 150pxï¼Œè¿›å…¥è¾“å…¥å±‚
      if (verticalDragY > 150) {
        setShowInputLayer(true);
        setVerticalDragY(0);
      } else {
        setVerticalDragY(0); // å›å¼¹
      }
    }
  };

  // --- å¯†ç /å›¾æ¡ˆè¾“å…¥é€»è¾‘ ---
  const handleNumClick = (num) => {
    if (inputPassword.length >= 4) return;
    haptic();
    const newPass = inputPassword + num;
    setInputPassword(newPass);
    if (newPass.length === 4) {
      const correctPass = state.security?.password || '1234';
      if (newPass === correctPass) setTimeout(handleUnlock, 200);
      else setTimeout(handleError, 200);
    }
  };
  
    // æ£€æµ‹è§¦æ‘¸/ç‚¹å‡»ä½ç½®æ˜¯å¦åœ¨æŸä¸ªç‚¹ä¸Š
  const detectDotAtPosition = (clientX, clientY) => {
    const dots = document.querySelectorAll('[data-dot-index]');
    dots.forEach(dot => {
      const rect = dot.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      const distance = Math.sqrt(Math.pow(clientX - centerX, 2) + Math.pow(clientY - centerY, 2));
      
      if (distance < 35) { // è§¦æ‘¸èŒƒå›´35åƒç´ 
        const index = parseInt(dot.getAttribute('data-dot-index'));
        if (!inputPattern.includes(index)) {
          haptic();
          setInputPattern(prev => [...prev, index]);
        }
      }
    });
  };
  
    // éªŒè¯å›¾æ¡ˆ
  const verifyPattern = () => {
    const savedPattern = state.security?.pattern;
    
    // å¦‚æœæ²¡æœ‰ä¿å­˜çš„å›¾æ¡ˆï¼Œåªè¦ç”»äº†4ä¸ªç‚¹ä»¥ä¸Šå°±è§£é”
    if (!savedPattern || savedPattern.length === 0) {
      if (inputPattern.length >= 4) {
        handleUnlock();
      } else {
        alert('è¯·è‡³å°‘è¿æ¥4ä¸ªç‚¹');
      }
      return;
    }
    
    // éªŒè¯å›¾æ¡ˆæ˜¯å¦åŒ¹é…
    if (JSON.stringify(inputPattern) === JSON.stringify(savedPattern)) {
      handleUnlock();
    } else {
      handleError();
    }
  };
  
  const handleDotClick = (index) => {
    if (inputPattern.includes(index)) return;
    haptic();
    const newPattern = [...inputPattern, index];
    setInputPattern(newPattern);
    
    const savedPattern = state.security?.pattern;
    // éªŒè¯é€»è¾‘
    const isValid = savedPattern && savedPattern.length > 0
      ? JSON.stringify(newPattern) === JSON.stringify(savedPattern)
      : newPattern.length >= 4; // å¦‚æœæ²¡è®¾ç½®è¿‡ï¼Œè¿4ç‚¹å°±å¼€(ä½œä¸ºåå¤‡)

    if (savedPattern && savedPattern.length > 0) {
       // åªæœ‰é•¿åº¦ä¸€è‡´æ—¶æ‰æ£€æŸ¥ï¼Œé˜²æ­¢è¯¯åˆ¤
       if (newPattern.length === savedPattern.length) {
         if (isValid) handleUnlock();
         else handleError();
       }
    } else if (newPattern.length >= 4) {
       // æœªè®¾ç½®æ—¶çš„ä¸´æ—¶é€»è¾‘
       handleUnlock();
    }
  };

  const type = state.security?.type || 'slide';

  // æ¸²æŸ“è¾“å…¥å±‚ (å¯†ç æˆ–å›¾æ¡ˆ)
  const renderInputLayer = () => {
    return (
      <div className={`absolute inset-0 bg-black/40 backdrop-blur-xl flex flex-col items-center justify-end pb-20 z-20 animate-fade-in`}>
        {/* è¿”å›æŒ‰é’® */}
        <button 
          onClick={() => setShowInputLayer(false)}
          className="absolute top-16 right-8 text-white/80"
        >
          <span className="text-sm">å–æ¶ˆ</span>
        </button>

        {type === 'password' && (
          <div className="flex flex-col items-center animate-slide-up">
            <p className="text-white mb-8 font-medium">è¾“å…¥å¯†ç </p>
            <div className="flex gap-6 mb-10">
              {[0, 1, 2, 3].map(i => (
                <div key={i} className={`w-4 h-4 rounded-full border-2 border-white transition-all duration-200 ${
                  inputPassword.length > i ? 'bg-white' : 'bg-transparent'
                } ${errorObj ? 'animate-shake border-red-400 bg-red-400' : ''}`} />
              ))}
            </div>
            <div className="grid grid-cols-3 gap-x-8 gap-y-6 w-full max-w-[280px]">
              {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => (
                <button key={num} onClick={() => handleNumClick(num)} className="w-16 h-16 rounded-full bg-white/20 hover:bg-white/30 backdrop-blur-md flex items-center justify-center text-white active:scale-95 transition-all">
                  <span className="text-2xl font-light">{num}</span>
                </button>
              ))}
              <div />
              <button onClick={() => handleNumClick(0)} className="w-16 h-16 rounded-full bg-white/20 hover:bg-white/30 backdrop-blur-md flex items-center justify-center text-white active:scale-95 transition-all">0</button>
              <button onClick={() => setInputPassword(inputPassword.slice(0, -1))} className="w-16 h-16 flex items-center justify-center text-white/80 active:text-white"><span className="text-sm">åˆ é™¤</span></button>
            </div>
          </div>
        )}

        {type === 'pattern' && (
          <div className="flex flex-col items-center animate-slide-up">
            <p className={`text-white mb-8 font-medium ${errorObj ? 'text-red-300 animate-shake' : ''}`}>
              {errorObj ? 'å›¾æ¡ˆé”™è¯¯' : 'ç»˜åˆ¶å›¾æ¡ˆ'}
            </p>
            <div 
              className="relative w-[280px] h-[280px] grid grid-cols-3 gap-8 p-4"
              onTouchStart={(e) => {
                e.preventDefault();
                const touch = e.touches[0];
                detectDotAtPosition(touch.clientX, touch.clientY);
              }}
              onTouchMove={(e) => {
                e.preventDefault();
                const touch = e.touches[0];
                detectDotAtPosition(touch.clientX, touch.clientY);
              }}
              onMouseDown={(e) => {
                detectDotAtPosition(e.clientX, e.clientY);
              }}
              onMouseMove={(e) => {
                if (e.buttons === 1) {
                  detectDotAtPosition(e.clientX, e.clientY);
                }
              }}
            >
              <svg className="absolute inset-0 w-full h-full pointer-events-none z-0">
                {inputPattern.map((dotIndex, i) => {
                  if (i === 0) return null;
                  const prev = inputPattern[i-1];
                  const getCoord = (idx) => ({ x: 44 + (idx % 3) * 96, y: 44 + Math.floor(idx / 3) * 96 });
                  const p1 = getCoord(prev);
                  const p2 = getCoord(dotIndex);
                  return <line key={i} x1={p1.x} y1={p1.y} x2={p2.x} y2={p2.y} stroke="white" strokeWidth="4" strokeLinecap="round" strokeOpacity="0.8" />;
                })}
              </svg>
              {[0, 1, 2, 3, 4, 5, 6, 7, 8].map(i => (
                <div 
                  key={i} 
                  data-dot-index={i}
                  className="flex items-center justify-center z-10 cursor-pointer"
                >
                  <div className={`w-5 h-5 rounded-full transition-all duration-300 ${inputPattern.includes(i) ? 'bg-white scale-150 shadow-[0_0_15px_rgba(255,255,255,0.9)]' : 'bg-white/40'}`} />
                </div>
              ))}
            </div>
            <button onClick={() => setInputPattern([])} className="mt-8 text-white/60 text-sm mr-4">é‡ç»˜</button>
<button onClick={verifyPattern} className="mt-8 text-white text-sm bg-white/20 px-6 py-2 rounded-full">ç¡®è®¤</button>
          </div>
        )}
      </div>
    );
  };

  return (
    <div 
      className="h-full flex flex-col items-center pt-24 pb-8 relative select-none overflow-hidden"
      onTouchStart={handleTouchStart}
      onTouchMove={handleTouchMove}
      onTouchEnd={handleTouchEnd}
      onMouseDown={handleTouchStart}
      onMouseMove={handleTouchMove}
      onMouseUp={handleTouchEnd}
      onMouseLeave={handleTouchEnd}
    >
      {/* è¾“å…¥å±‚ (è¦†ç›–åœ¨æ—¶é—´ä¹‹ä¸Š) */}
      {showInputLayer && renderInputLayer()}

      {/* æ—¶é—´å±‚ (ä¸Šæ»‘æ—¶æ·¡å‡º) */}
      <div 
        className="flex flex-col items-center space-y-1 mb-8 transition-all duration-300 ease-out"
        style={{ 
          transform: `translateY(-${verticalDragY * 0.5}px)`, 
          opacity: Math.max(0, 1 - verticalDragY / 300) 
        }}
      >
        <Icon name="Lock" size={16} className="text-white/60 mb-3" />
        <h1 className="text-[5.5rem] leading-none font-[200] text-white tracking-tighter font-[system-ui]">{timeString}</h1>
        <p className="text-xl text-white/90 font-light mt-2">{dateString}</p>
      </div>

      {/* åº•éƒ¨è§£é”åŒºåŸŸ */}
      <div 
        className="absolute bottom-12 w-full flex justify-center transition-all duration-300"
        style={{ 
          transform: `translateY(-${verticalDragY}px)`,
          opacity: Math.max(0, 1 - verticalDragY / 200)
        }}
      >
        {type === 'slide' ? (
          // åªæœ‰ 'slide' æ¨¡å¼æ˜¾ç¤ºæ»‘å—
          <div 
            ref={trackRef}
            className="relative w-[300px] h-[56px] bg-white/20 backdrop-blur-md rounded-full flex items-center overflow-hidden border border-white/10"
          >
            <div className="absolute inset-0 flex items-center justify-center text-white/90 text-[15px] font-medium tracking-wide pointer-events-none" style={{ opacity: 1 - (sliderValue / 150) }}>
              <span className="animate-pulse">æ»‘åŠ¨æ¥è§£é”</span>
            </div>
            <div 
              className="absolute left-[4px] w-[48px] h-[48px] bg-white rounded-full shadow-lg flex items-center justify-center cursor-grab active:cursor-grabbing z-10"
              style={{ transform: `translateX(${sliderValue}px)` }}
            >
              <Icon name="ArrowRight" size={24} className="text-gray-600" />
            </div>
          </div>
        ) : (
          // å¯†ç /å›¾æ¡ˆæ¨¡å¼æ˜¾ç¤ºåº•éƒ¨å°æ¨ªæ¡æç¤º
          <div className="flex flex-col items-center gap-2 animate-bounce-slow">
            <Icon name="ChevronUp" size={20} className="text-white/50" />
            <span className="text-white/60 text-sm font-medium tracking-wide">å‘ä¸Šæ»‘åŠ¨ä»¥è§£é”</span>
          </div>
        )}
      </div>
    </div>
  );
};

    // ==================== ä¸»å±å¹•ç»„ä»¶ ====================
    const HomeScreen = () => {
      const state = useStore();
      const [dragId, setDragId] = useState(null);
      const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
      const [isEditMode, setIsEditMode] = useState(false);
      const [startPos, setStartPos] = useState({ x: 0, y: 0 });
      const longPressTimer = useRef(null);
      const hasMoved = useRef(false);
      
      const topApps = [
        { id: 'worldbook', name: 'ä¸–ç•Œä¹¦', icon: 'BookOpen', color: 'bg-purple-500', screen: 'worldbook' },
        { id: 'xingyu', name: 'æ˜Ÿè¯­', icon: 'Star', color: 'bg-gradient-to-br from-orange-400 to-pink-500', screen: 'xingyu' },
      ];

      const dockApps = [
        { id: 'wechat', name: 'å¾®ä¿¡', icon: 'MessageCircle', color: 'bg-green-500', screen: 'wechat' },
        { id: 'contacts', name: 'é€šè®¯å½•', icon: 'Users', color: 'bg-orange-500', screen: 'contacts' },
        { id: 'settings', name: 'è®¾ç½®', icon: 'Settings', color: 'bg-gray-500', screen: 'settings' },
        { id: 'theme', name: 'è£…æ‰®', icon: 'Palette', color: 'bg-pink-500', screen: 'theme' },
      ];

      const getIconPosition = (appId) => {
        return state.themeSettings?.iconPositions?.[appId] || { x: 0, y: 0 };
      };

      const savePosition = (appId, x, y) => {
        const newPositions = {
          ...state.themeSettings?.iconPositions,
          [appId]: { x, y }
        };
        actions.updateThemeSettings({ iconPositions: newPositions });
      };

      const handlePointerDown = (e, appId) => {
        e.preventDefault();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        
        setStartPos({ x: clientX, y: clientY });
        hasMoved.current = false;
        
        longPressTimer.current = setTimeout(() => {
          setIsEditMode(true);
          setDragId(appId);
          setDragOffset({ x: 0, y: 0 });
        }, 400);
      };

      const handlePointerMove = (e) => {
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        
        const moveDistance = Math.sqrt(
          Math.pow(clientX - startPos.x, 2) + Math.pow(clientY - startPos.y, 2)
        );
        
        if (moveDistance > 5) {
          hasMoved.current = true;
          if (longPressTimer.current && !dragId) {
            clearTimeout(longPressTimer.current);
            longPressTimer.current = null;
          }
        }
        
        if (dragId) {
          const offsetX = clientX - startPos.x;
          const offsetY = clientY - startPos.y;
          setDragOffset({ x: offsetX, y: offsetY });
        }
      };

      const handlePointerUp = (appId) => {
        if (longPressTimer.current) {
          clearTimeout(longPressTimer.current);
          longPressTimer.current = null;
        }
        
        if (dragId) {
          const currentPos = getIconPosition(dragId);
          savePosition(dragId, currentPos.x + dragOffset.x, currentPos.y + dragOffset.y);
          setDragId(null);
          setDragOffset({ x: 0, y: 0 });
        } else if (!hasMoved.current && !isEditMode && appId) {
          const app = [...topApps, ...dockApps].find(a => a.id === appId);
          if (app) actions.setScreen(app.screen);
        }
      };

      const resetPositions = () => {
        actions.updateThemeSettings({ iconPositions: {} });
        setIsEditMode(false);
      };

      useEffect(() => {
        const handleGlobalUp = () => {
          if (dragId) {
            const currentPos = getIconPosition(dragId);
            savePosition(dragId, currentPos.x + dragOffset.x, currentPos.y + dragOffset.y);
            setDragId(null);
            setDragOffset({ x: 0, y: 0 });
          }
        };

        window.addEventListener('mouseup', handleGlobalUp);
        window.addEventListener('touchend', handleGlobalUp);
        
        return () => {
          window.removeEventListener('mouseup', handleGlobalUp);
          window.removeEventListener('touchend', handleGlobalUp);
        };
      }, [dragId, dragOffset]);

      const renderAppButton = (app, size = 'normal') => {
        const customIcon = state.themeSettings?.appIcons?.[app.id];
        const position = getIconPosition(app.id);
        const isDragging = dragId === app.id;
        
        const iconSize = size === 'normal' ? 'w-12 h-12' : 'w-10 h-10';
        const innerIconSize = size === 'normal' ? 28 : 24;
        
        const translateX = position.x + (isDragging ? dragOffset.x : 0);
        const translateY = position.y + (isDragging ? dragOffset.y : 0);

        return (
          <div
            key={app.id}
            className={`flex flex-col items-center gap-1 select-none touch-none ${isEditMode && !isDragging ? 'animate-pulse' : ''}`}
            style={{
              transform: `translate(${translateX}px, ${translateY}px)`,
              zIndex: isDragging ? 100 : 1,
              transition: isDragging ? 'none' : 'transform 0.15s ease-out',
              opacity: isDragging ? 0.9 : 1,
              scale: isDragging ? '1.1' : '1'
            }}
            onTouchStart={(e) => handlePointerDown(e, app.id)}
            onMouseDown={(e) => handlePointerDown(e, app.id)}
            onTouchEnd={() => handlePointerUp(app.id)}
            onMouseUp={() => handlePointerUp(app.id)}
          >
            {customIcon ? (
              <img 
                src={customIcon} 
                alt={app.name} 
                className={`${iconSize} object-contain drop-shadow-lg pointer-events-none`}
                draggable={false}
              />
            ) : (
              <div className={`${iconSize} ${app.color} rounded-xl flex items-center justify-center shadow-lg`}>
                <Icon name={app.icon} size={innerIconSize} className="text-white" />
              </div>
            )}
            {size === 'normal' && (
              <span className="text-white text-xs drop-shadow pointer-events-none">{app.name}</span>
            )}
          </div>
        );
      };

      return (
        <div 
          className="w-full h-full pt-8 px-4 relative touch-none"
          onTouchMove={handlePointerMove}
          onMouseMove={handlePointerMove}
        >
          {/* çŠ¶æ€æ  */}
          <div className="flex justify-between items-center text-white text-xs mb-6 px-2">
            <span>{new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false })}</span>
            <div className="flex items-center gap-1">
              <Icon name="Wifi" size={14} />
              <Icon name="Battery" size={16} />
            </div>
          </div>

          {/* ç¼–è¾‘æ¨¡å¼æç¤º */}
          {isEditMode && (
            <div className="absolute top-14 left-0 right-0 flex justify-center z-50">
              <div className="bg-black/80 text-white text-xs px-3 py-2 rounded-full flex items-center gap-2">
                <span>ç¼–è¾‘æ¨¡å¼</span>
                <button 
                  onClick={resetPositions}
                  className="bg-red-500 px-2 py-1 rounded text-xs"
                >
                  é‡ç½®
                </button>
                <button 
                  onClick={() => setIsEditMode(false)}
                  className="bg-green-500 px-2 py-1 rounded text-xs"
                >
                  å®Œæˆ
                </button>
              </div>
            </div>
          )}

          {/* ä¸Šæ–¹å›¾æ ‡åŒºåŸŸ */}
          <div className="flex justify-center mb-4">
            {topApps.map((app) => renderAppButton(app, 'normal'))}
          </div>

          {/* åº•éƒ¨Dockæ  */}
          <div className="absolute bottom-6 left-3 right-3">
            <div className="glass rounded-2xl p-3 flex justify-around">
              {dockApps.map((app) => renderAppButton(app, 'small'))}
            </div>
          </div>
        </div>
      );
    };
    
// ==================== å®‰å…¨ä¸é”å±è®¾ç½®ç»„ä»¶ (ä¿®å¤æ‰‹åŠ¿å½•åˆ¶) ====================
const SecuritySettings = ({ onBack }) => {
  const state = useStore();
  const [tempPass, setTempPass] = React.useState('');
  const [tempPattern, setTempPattern] = React.useState([]);
  const [confirmPattern, setConfirmPattern] = React.useState([]); 
  const [step, setStep] = React.useState(1); 
  const [mode, setMode] = React.useState('menu'); 
  const [isDrawing, setIsDrawing] = React.useState(false);
  
  const patternRef = React.useRef(null);
  const security = state.security || { type: 'slide' };

  // --- æ‰‹åŠ¿ç»˜åˆ¶æ ¸å¿ƒé€»è¾‘ ---
  const handlePatternStart = (e) => {
    setIsDrawing(true);
    // æ¸…ç©ºé‡ç”»
    if (step === 1) setTempPattern([]);
    else setConfirmPattern([]);
    
    // ç«‹å³æ£€æµ‹èµ·ç‚¹
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    detectPatternPoint(clientX, clientY);
  };

  const handlePatternMove = (e) => {
    if (!isDrawing || !patternRef.current) return;
    e.preventDefault(); // é˜²æ­¢é¡µé¢æ»šåŠ¨
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    detectPatternPoint(clientX, clientY);
  };

  const detectPatternPoint = (x, y) => {
    const dots = Array.from(patternRef.current.querySelectorAll('[data-dot-index]'));
    const currentList = step === 1 ? tempPattern : confirmPattern;
    
    dots.forEach(dot => {
      const rect = dot.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
      
      if (distance < 30) {
        const index = parseInt(dot.getAttribute('data-dot-index'));
        if (!currentList.includes(index)) {
          if (navigator.vibrate) navigator.vibrate(20);
          const newList = [...currentList, index];
          if (step === 1) setTempPattern(newList);
          else setConfirmPattern(newList);
        }
      }
    });
  };

  const handlePatternEnd = () => {
    setIsDrawing(false);
  };

  const savePassword = () => {
    if (tempPass.length === 4) {
      actions.setSecuritySettings({ type: 'password', password: tempPass });
      setMode('menu');
      setTempPass('');
    } else {
      alert('è¯·è¾“å…¥4ä½æ•°å­—');
    }
  };

  const savePattern = () => {
    if (step === 1) {
      if (tempPattern.length < 4) {
        alert('å›¾æ¡ˆè‡³å°‘éœ€è¦è¿æ¥4ä¸ªç‚¹');
        setTempPattern([]);
        return;
      }
      setStep(2);
    } else {
      if (JSON.stringify(tempPattern) === JSON.stringify(confirmPattern)) {
        actions.setSecuritySettings({ type: 'pattern', pattern: tempPattern });
        alert('å›¾æ¡ˆå¯†ç è®¾ç½®æˆåŠŸï¼');
        setMode('menu');
        setTempPattern([]);
        setConfirmPattern([]);
        setStep(1);
      } else {
        alert('ä¸¤æ¬¡ç»˜åˆ¶çš„å›¾æ¡ˆä¸ä¸€è‡´ï¼Œè¯·é‡æ–°ç»˜åˆ¶');
        setConfirmPattern([]);
        setStep(1);
        setTempPattern([]);
      }
    }
  };

  // æ¸²æŸ“å›¾æ¡ˆç»˜åˆ¶å™¨
  const renderPatternRecorder = () => {
    const currentList = step === 1 ? tempPattern : confirmPattern;
    return (
      <div className="flex flex-col items-center">
        <p className="mb-6 text-gray-500 font-medium">
          {step === 1 ? 'ç»˜åˆ¶è§£é”å›¾æ¡ˆ (è‡³å°‘4ç‚¹)' : 'å†æ¬¡ç»˜åˆ¶ä»¥ç¡®è®¤'}
        </p>
        <div 
          ref={patternRef}
          className="relative w-[280px] h-[280px] grid grid-cols-3 gap-0 p-4 bg-gray-50 rounded-2xl touch-none"
          onTouchStart={handlePatternStart}
          onTouchMove={handlePatternMove}
          onTouchEnd={handlePatternEnd}
          onMouseDown={handlePatternStart}
          onMouseMove={handlePatternMove}
          onMouseUp={handlePatternEnd}
          onMouseLeave={handlePatternEnd}
        >
          <svg className="absolute inset-0 w-full h-full pointer-events-none z-0">
            {currentList.map((dotIndex, i) => {
              if (i === 0) return null;
              const prev = currentList[i-1];
              const getCoord = (idx) => ({ x: 46 + (idx % 3) * 93, y: 46 + Math.floor(idx / 3) * 93 });
              const p1 = getCoord(prev);
              const p2 = getCoord(dotIndex);
              return <line key={i} x1={p1.x} y1={p1.y} x2={p2.x} y2={p2.y} stroke="#3b82f6" strokeWidth="4" strokeLinecap="round" />;
            })}
          </svg>
          {[0, 1, 2, 3, 4, 5, 6, 7, 8].map(i => (
            <div key={i} className="flex items-center justify-center z-10">
              <div 
                data-dot-index={i}
                className={`w-4 h-4 rounded-full transition-all duration-200 ${
                  currentList.includes(i) 
                    ? 'bg-blue-500 scale-150 ring-4 ring-blue-100' 
                    : 'bg-gray-300'
                }`} 
              />
            </div>
          ))}
        </div>
        <div className="flex gap-4 mt-8 w-full max-w-[240px]">
          <button 
            onClick={() => { setTempPattern([]); setConfirmPattern([]); setStep(1); }} 
            className="flex-1 py-2 text-gray-500 bg-white border border-gray-200 rounded-lg"
          >
            é‡ç»˜
          </button>
          <button 
            onClick={savePattern}
            className="flex-1 py-2 text-white bg-blue-500 rounded-lg shadow-sm"
          >
            {step === 1 ? 'ç»§ç»­' : 'ç¡®è®¤'}
          </button>
        </div>
      </div>
    );
  };

  if (mode === 'set_password') {
    // ... å¯†ç è®¾ç½®éƒ¨åˆ†ä¿æŒä¸å˜ (çœç•¥ä»¥èŠ‚çœç¯‡å¹…ï¼Œè¯·å¤åˆ¶ä¸Šä¸€æ¬¡çš„å¯†ç è®¾ç½®ä»£ç ) ...
    // ä¸ºäº†å®Œæ•´æ€§ï¼Œæˆ‘è¿˜æ˜¯å†™å‡ºæ¥ï¼š
    return (
      <div className="h-full bg-gray-50 flex flex-col">
        <div className="bg-white p-4 flex items-center gap-3 shadow-sm z-10">
          <button onClick={() => setMode('menu')}><Icon name="ArrowLeft" /></button>
          <h2 className="font-bold text-lg">è®¾ç½®æ•°å­—å¯†ç </h2>
        </div>
        <div className="p-8 flex flex-col items-center flex-1 justify-center">
          <p className="mb-6 text-gray-500">è¯·è¾“å…¥æ–°çš„4ä½æ•°å­—å¯†ç </p>
          <div className="text-4xl tracking-[1em] font-mono mb-12 h-12 text-gray-800 font-bold">
            {tempPass.padEnd(4, 'â€¢')}
          </div>
          <div className="grid grid-cols-3 gap-4 w-full max-w-[280px]">
            {[1, 2, 3, 4, 5, 6, 7, 8, 9, 0].map(num => (
              <button 
                key={num}
                onClick={() => setTempPass(prev => (prev + num).slice(0, 4))}
                className={`h-16 rounded-full bg-white shadow-sm text-2xl font-medium active:bg-gray-100 text-gray-700 ${num === 0 ? 'col-start-2' : ''}`}
              >
                {num}
              </button>
            ))}
            <div className="col-start-3 row-start-4 flex items-center justify-center">
               <button onClick={savePassword} className="w-16 h-16 rounded-full bg-blue-500 text-white flex items-center justify-center shadow-md active:scale-95 transition-transform">
                 <Icon name="Check" />
               </button>
            </div>
            <div className="col-start-1 row-start-4 flex items-center justify-center">
               <button onClick={() => setTempPass('')} className="text-sm text-gray-400 p-4">æ¸…ç©º</button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (mode === 'set_pattern') {
    return (
      <div className="h-full bg-gray-50 flex flex-col">
        <div className="bg-white p-4 flex items-center gap-3 shadow-sm z-10">
          <button onClick={() => { setMode('menu'); setTempPattern([]); }}><Icon name="ArrowLeft" /></button>
          <h2 className="font-bold text-lg">è®¾ç½®å›¾æ¡ˆå¯†ç </h2>
        </div>
        <div className="flex-1 flex flex-col justify-center">
          {renderPatternRecorder()}
        </div>
      </div>
    );
  }

  return (
    <div className="h-full bg-gray-50 flex flex-col animate-slide-right">
      <div className="bg-white p-4 flex items-center gap-3 shadow-sm z-10 sticky top-0">
        <button onClick={onBack}><Icon name="ArrowLeft" /></button>
        <h2 className="font-bold text-lg">é”å±ä¸å®‰å…¨</h2>
      </div>

      <div className="p-4 space-y-4">
        <div className="bg-white rounded-xl overflow-hidden shadow-sm">
          <div className="p-4 border-b border-gray-100 font-medium text-gray-500 text-xs uppercase tracking-wider">
            è§£é”æ–¹å¼
          </div>
          
          <button onClick={() => actions.setSecuritySettings({ type: 'slide' })} className="w-full p-4 flex items-center justify-between active:bg-gray-50 transition-colors">
            <span className="flex items-center gap-3 text-gray-700">
              <div className="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center text-blue-600">
                 <Icon name="Smartphone" size={18} />
              </div>
              æ»‘åŠ¨è§£é” (æ— å¯†ç )
            </span>
            {security.type === 'slide' && <Icon name="Check" size={18} className="text-blue-500" />}
          </button>

          <button onClick={() => setMode('set_password')} className="w-full p-4 flex items-center justify-between border-t border-gray-50 active:bg-gray-50 transition-colors">
            <span className="flex items-center gap-3 text-gray-700">
              <div className="w-8 h-8 rounded-lg bg-green-100 flex items-center justify-center text-green-600">
                 <Icon name="Lock" size={18} />
              </div>
              æ•°å­—å¯†ç 
            </span>
            {security.type === 'password' && <Icon name="Check" size={18} className="text-blue-500" />}
          </button>

          <button onClick={() => setMode('set_pattern')} className="w-full p-4 flex items-center justify-between border-t border-gray-50 active:bg-gray-50 transition-colors">
            <span className="flex items-center gap-3 text-gray-700">
               <div className="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600">
                 <Icon name="Grid" size={18} />
               </div>
              å›¾æ¡ˆè§£é”
            </span>
            {security.type === 'pattern' && <Icon name="Check" size={18} className="text-blue-500" />}
          </button>
        </div>
        
        <p className="text-xs text-center text-gray-400 px-4 leading-relaxed">
          è®¾ç½®æ–°çš„è§£é”æ–¹å¼åï¼Œä¸‹æ¬¡ç‚¹äº®å±å¹•æ—¶ç”Ÿæ•ˆã€‚
        </p>
      </div>
    </div>
  );
};
    
// ==================== è®¾ç½®ç»„ä»¶ (å®Œæ•´çš„ä¿®å¤ç‰ˆ) ====================
const Settings = () => {
  const state = useStore();
  const [localSettings, setLocalSettings] = useState(state.apiSettings);
  const [saveMessage, setSaveMessage] = useState('');
  const [isLoadingModels, setIsLoadingModels] = useState(false);
  const [modelList, setModelList] = useState(state.apiSettings.availableModels || []);
  const [currentPage, setCurrentPage] = useState('main'); // main, ai, prompts, security
  const importInputRef = useRef(null);

  useEffect(() => {
    setLocalSettings(state.apiSettings);
    setModelList(state.apiSettings.availableModels || []);
  }, [state.apiSettings]);

  // å¦‚æœå½“å‰é¡µé¢æ˜¯å®‰å…¨è®¾ç½®ï¼Œæ¸²æŸ“å­ç»„ä»¶
  if (currentPage === 'security') {
    return <SecuritySettings onBack={() => setCurrentPage('main')} />;
  }

  // --- å†…éƒ¨å‡½æ•°å®šä¹‰ ---
  const handleSave = () => {
    actions.updateApiSettings({ ...localSettings, availableModels: modelList });
    setSaveMessage('âœ… å·²ä¿å­˜');
    setTimeout(() => setSaveMessage(''), 2000);
  };

  const handleFetchModels = async () => {
    setIsLoadingModels(true);
    try {
      const models = await fetchAvailableModels(localSettings);
      setModelList(models);
      setSaveMessage(`è·å–åˆ° ${models.length} ä¸ªæ¨¡å‹`);
    } catch (e) {
      setSaveMessage('æ‹‰å–å¤±è´¥');
    }
    setIsLoadingModels(false);
    setTimeout(() => setSaveMessage(''), 2000);
  };

  const handleExport = () => {
    try {
      const data = actions.exportData();
      const blob = new Blob([data], { type: 'application/json;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `fake-phone-backup-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      setSaveMessage('âœ… å¯¼å‡ºæˆåŠŸ');
    } catch (e) {
      navigator.clipboard?.writeText(actions.exportData());
      setSaveMessage('ğŸ“‹ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }
    setTimeout(() => setSaveMessage(''), 2000);
  };

  const handleImportFile = async (e) => {
    const file = e.target.files?.[0];
    if (file) {
      const text = await file.text();
      if (actions.importData(text)) {
        setSaveMessage('âœ… å¯¼å…¥æˆåŠŸ');
        setLocalSettings(store.getState().apiSettings);
      } else {
        setSaveMessage('âŒ å¯¼å…¥å¤±è´¥');
      }
      setTimeout(() => setSaveMessage(''), 2000);
    }
    e.target.value = '';
  };

  const SettingRow = ({ icon, label, value, onClick, rightIcon = 'ChevronRight' }) => (
    <button 
      onClick={onClick}
      className="w-full flex items-center justify-between p-4 bg-white active:bg-gray-50 text-left"
    >
      <div className="flex items-center gap-3">
        {icon && <span className="text-lg">{icon}</span>}
        <span className="text-gray-800">{label}</span>
      </div>
      <div className="flex items-center gap-2 text-gray-400">
        {value && <span className="text-sm">{value}</span>}
        <Icon name={rightIcon} size={18} />
      </div>
    </button>
  );

  // AIæœåŠ¡è®¾ç½®é¡µé¢
  if (currentPage === 'ai') {
    const providers = [
      { id: 'openai', name: 'OpenAI', icon: 'ğŸ¤–' },
      { id: 'gemini', name: 'Google Gemini', icon: 'ğŸ’' },
      { id: 'claude', name: 'Anthropic Claude', icon: 'ğŸ§ ' },
      { id: 'custom', name: 'è‡ªå®šä¹‰/ä¸­è½¬', icon: 'ğŸ”§' },
    ];

    return (
      <div className="w-full h-full bg-gray-100 flex flex-col">
        <div className="bg-gray-100 pt-10 pb-2 px-4 border-b border-gray-200 flex items-center justify-between">
          <button onClick={() => setCurrentPage('main')} className="text-blue-500 flex items-center gap-1">
            <Icon name="ChevronLeft" size={20} /> è¿”å›
          </button>
          <h1 className="text-lg font-semibold">AI æœåŠ¡</h1>
          <div className="w-16"></div>
        </div>
        <div className="flex-1 overflow-y-auto p-4 space-y-4">
            <div className="bg-white rounded-xl p-4">
              <p className="text-sm text-gray-500 mb-3">é€‰æ‹©æœåŠ¡å•†</p>
              <div className="grid grid-cols-2 gap-2">
                {providers.map(p => (
                  <button
                    key={p.id}
                    onClick={() => setLocalSettings({ ...localSettings, provider: p.id })}
                    className={`p-3 rounded-xl border-2 text-left transition-all ${
                      localSettings.provider === p.id 
                        ? 'border-blue-500 bg-blue-50' 
                        : 'border-gray-200'
                    }`}
                  >
                    <span className="text-lg">{p.icon}</span>
                    <span className="ml-2 text-sm font-medium">{p.name}</span>
                  </button>
                ))}
              </div>
            </div>

            {(localSettings.provider === 'openai' || localSettings.provider === 'custom') && (
              <div className="bg-white rounded-xl p-4 space-y-3">
                <div>
                  <label className="text-sm text-gray-500">Base URL</label>
                  <input
                    type="text"
                    value={localSettings.baseUrl}
                    onChange={(e) => setLocalSettings({ ...localSettings, baseUrl: e.target.value })}
                    className="w-full p-3 bg-gray-100 rounded-xl text-sm mt-1"
                    placeholder="https://api.openai.com/v1"
                  />
                </div>
                <div>
                  <label className="text-sm text-gray-500">API Key</label>
                  <input
                    type="password"
                    value={localSettings.apiKey}
                    onChange={(e) => setLocalSettings({ ...localSettings, apiKey: e.target.value })}
                    className="w-full p-3 bg-gray-100 rounded-xl text-sm mt-1"
                    placeholder="sk-..."
                  />
                </div>
                <div>
                  <label className="text-sm text-gray-500">æ¨¡å‹</label>
                  <div className="flex gap-2 mt-1">
                    <input
                      type="text"
                      value={localSettings.modelName}
                      onChange={(e) => setLocalSettings({ ...localSettings, modelName: e.target.value })}
                      className="flex-1 p-3 bg-gray-100 rounded-xl text-sm"
                      placeholder="gpt-4"
                    />
                    <button
                      onClick={handleFetchModels}
                      disabled={isLoadingModels}
                      className="px-4 bg-blue-500 text-white rounded-xl text-sm"
                    >
                      {isLoadingModels ? '...' : 'æ‹‰å–'}
                    </button>
                  </div>
                  {modelList.length > 0 && (
                    <select
                      value={localSettings.modelName}
                      onChange={(e) => setLocalSettings({ ...localSettings, modelName: e.target.value })}
                      className="w-full p-3 bg-gray-100 rounded-xl text-sm mt-2"
                    >
                      {modelList.map(m => <option key={m} value={m}>{m}</option>)}
                    </select>
                  )}
                </div>
              </div>
            )}
            
            <button onClick={handleSave} className="w-full p-4 bg-blue-500 text-white rounded-xl font-medium">ä¿å­˜</button>
        </div>
        {saveMessage && <div className="fixed bottom-20 left-4 right-4 z-50"><div className="bg-black/80 text-white text-center py-3 px-4 rounded-xl text-sm">{saveMessage}</div></div>}
      </div>
    );
  }

  // æç¤ºè¯è®¾ç½®é¡µé¢ (ç›´æ¥æ¸²æŸ“ PromptsPage ç»„ä»¶)
  if (currentPage === 'prompts') {
    return (
      <div className="w-full h-full bg-gray-100 flex flex-col">
        <div className="bg-gray-100 pt-10 pb-2 px-4 border-b border-gray-200 flex items-center justify-between">
          <button onClick={() => setCurrentPage('main')} className="text-blue-500 flex items-center gap-1">
            <Icon name="ChevronLeft" size={20} /> è¿”å›
          </button>
          <h1 className="text-lg font-semibold">æç¤ºè¯</h1>
          <div className="w-16"></div>
        </div>
        <PromptsPage /> 
      </div>
    );
  }

  // ä¸»è®¾ç½®é¡µé¢
  return (
    <div className="w-full h-full bg-gray-100 flex flex-col">
      <div className="bg-gray-100 pt-10 pb-2 px-4 border-b border-gray-200">
        <div className="flex items-center justify-between">
          <button onClick={() => actions.setScreen('home')} className="text-blue-500 flex items-center gap-1">
            <Icon name="ChevronLeft" size={20} />
            <span>ä¸»å±å¹•</span>
          </button>
          <h1 className="text-lg font-semibold">è®¾ç½®</h1>
          <div className="w-16"></div>
        </div>
      </div>

      <div className="flex-1 overflow-y-auto">
        <div className="mt-6 mx-4">
          <div className="bg-white rounded-xl overflow-hidden divide-y divide-gray-100">
            <SettingRow icon="ğŸ¤–" label="AI æœåŠ¡" value={localSettings.provider} onClick={() => setCurrentPage('ai')} />
            <SettingRow icon="ğŸ“" label="æç¤ºè¯" onClick={() => setCurrentPage('prompts')} />
            <SettingRow icon="ğŸ”’" label="é”å±ä¸å®‰å…¨" onClick={() => setCurrentPage('security')} />
          </div>
        </div>

        <div className="mt-6 mx-4">
          <div className="bg-white rounded-xl overflow-hidden divide-y divide-gray-100">
            <SettingRow icon="ğŸ“¤" label="å¯¼å‡ºå…¨éƒ¨æ•°æ®" onClick={handleExport} rightIcon="Download" />
            <div>
              <input ref={importInputRef} type="file" accept=".json" onChange={handleImportFile} className="hidden" />
              <SettingRow icon="ğŸ“¥" label="å¯¼å…¥æ•°æ®" onClick={() => importInputRef.current?.click()} rightIcon="Upload" />
            </div>
          </div>
        </div>

        <p className="text-center text-gray-400 text-xs mt-8">Fake Phone v1.0</p>
      </div>
      
      {saveMessage && (
        <div className="fixed bottom-20 left-4 right-4 z-50">
          <div className="bg-black/80 text-white text-center py-3 px-4 rounded-xl text-sm">
            {saveMessage}
          </div>
        </div>
      )}
    </div>
  );
};
    
    // ==================== é€šè®¯å½•ç»„ä»¶ ====================
    const Contacts = () => {
      const state = useStore();
      const [activeTab, setActiveTab] = useState('characters');
      const [showEditor, setShowEditor] = useState(false);
      const [editingChar, setEditingChar] = useState(null);
      const [editingPersona, setEditingPersona] = useState(null);
      const avatarInputRef = useRef(null);
      
      const [charForm, setCharForm] = useState({
        name: '', avatar: '', gender: 'other', age: 20, sexuality: '', persona: '',
        // è£…æ‰®è®¾ç½®
        bubbleImage: '',      // æ°”æ³¡èƒŒæ™¯å›¾
        bubbleColor: '',      // æ°”æ³¡é¢œè‰²
        avatarFrame: '',      // å¤´åƒæŒ‚ä»¶
        textColor: '',        // æ–‡å­—é¢œè‰²
        fontSize: 14,         // å­—ä½“å¤§å°
        fontFamily: ''        // å­—ä½“
      });
      
      const [personaForm, setPersonaForm] = useState({
        name: '', avatar: '', gender: 'other', age: 20, persona: '',
        // è£…æ‰®è®¾ç½®
        bubbleImage: '',
        bubbleColor: '',
        avatarFrame: '',
        textColor: '',
        fontSize: 14,
        fontFamily: ''
      });

      const handleAvatarUpload = (e, type) => {
        const file = e.target.files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            if (type === 'char') {
              setCharForm({ ...charForm, avatar: event.target.result });
            } else {
              setPersonaForm({ ...personaForm, avatar: event.target.result });
            }
          };
          reader.readAsDataURL(file);
        }
      };

      const openCharEditor = (char) => {
        if (char) {
          setEditingChar(char);
          setCharForm({
            name: char.name, 
            avatar: char.avatar || '', 
            gender: char.gender,
            age: char.age, 
            sexuality: char.sexuality, 
            persona: char.persona,
            bubbleImage: char.bubbleImage || '',
            bubbleColor: char.bubbleColor || '',
            avatarFrame: char.avatarFrame || '',
            textColor: char.textColor || '',
            fontSize: char.fontSize || 14,
            fontFamily: char.fontFamily || ''
          });
        } else {
          setEditingChar(null);
          setCharForm({ 
            name: '', avatar: '', gender: 'other', age: 20, sexuality: '', persona: '',
            bubbleImage: '', bubbleColor: '', avatarFrame: '', textColor: '', fontSize: 14, fontFamily: ''
          });
        }
        setShowEditor(true);
        setActiveTab('characters');
      };

      const openPersonaEditor = (persona) => {
        if (persona) {
          setEditingPersona(persona);
          setPersonaForm({
            name: persona.name, 
            avatar: persona.avatar || '', 
            gender: persona.gender, 
            age: persona.age, 
            persona: persona.persona,
            bubbleImage: persona.bubbleImage || '',
            bubbleColor: persona.bubbleColor || '',
            avatarFrame: persona.avatarFrame || '',
            textColor: persona.textColor || '',
            fontSize: persona.fontSize || 14,
            fontFamily: persona.fontFamily || ''
          });
        } else {
          setEditingPersona(null);
          setPersonaForm({ 
            name: '', avatar: '', gender: 'other', age: 20, persona: '',
            bubbleImage: '', bubbleColor: '', avatarFrame: '', textColor: '', fontSize: 14, fontFamily: ''
          });
        }
        setShowEditor(true);
        setActiveTab('personas');
      };

      const saveCharacter = () => {
        if (editingChar) {
          actions.updateCharacter(editingChar.id, charForm);
        } else {
          actions.addCharacter(charForm);
        }
        setShowEditor(false);
      };

      const savePersona = () => {
        if (editingPersona) {
          actions.updateUserPersona(editingPersona.id, personaForm);
        } else {
          actions.addUserPersona(personaForm);
        }
        setShowEditor(false);
      };

      return (
        <div className="w-full h-full bg-gray-100 flex flex-col">
          <div className="bg-orange-500 pt-12 pb-4 px-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <button onClick={() => actions.setScreen('home')} className="text-white">
                  <Icon name="ChevronLeft" size={24} />
                </button>
                <h1 className="text-white text-xl font-semibold">é€šè®¯å½•</h1>
              </div>
              <button 
                onClick={() => activeTab === 'characters' ? openCharEditor() : openPersonaEditor()}
                className="text-white"
              >
                <Icon name="Plus" size={24} />
              </button>
            </div>

            <div className="flex mt-4 bg-white/20 rounded-lg p-1">
              <button
                onClick={() => setActiveTab('characters')}
                className={`flex-1 py-2 rounded-md text-sm font-medium transition-all ${
                  activeTab === 'characters' ? 'bg-white text-gray-800' : 'text-white'
                }`}
              >
                AIè§’è‰²
              </button>
              <button
                onClick={() => setActiveTab('personas')}
                className={`flex-1 py-2 rounded-md text-sm font-medium transition-all ${
                  activeTab === 'personas' ? 'bg-white text-gray-800' : 'text-white'
                }`}
              >
                ç”¨æˆ·äººè®¾
              </button>
            </div>
          </div>

          <div className="flex-1 overflow-y-auto p-4">
            {activeTab === 'characters' ? (
              <div className="space-y-3">
                {state.characters.length === 0 ? (
                  <div className="text-center text-gray-500 py-8">
                    <Icon name="User" size={48} className="mx-auto mb-2 opacity-50" />
                    <p>æš‚æ— è§’è‰²ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ </p>
                  </div>
                ) : (
                  state.characters.map((char) => (
                    <div key={char.id} className="bg-white rounded-2xl p-4 flex items-center gap-4">
                      <div className="w-14 h-14 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center text-white text-xl font-bold overflow-hidden">
                        {char.avatar ? (
                          <img src={char.avatar} alt="" className="w-full h-full object-cover" />
                        ) : char.name[0]}
                      </div>
                      <div className="flex-1">
                        <h3 className="font-semibold text-gray-800">{char.name}</h3>
                        <p className="text-sm text-gray-500">
                          {char.gender === 'male' ? 'ç”·' : char.gender === 'female' ? 'å¥³' : 'å…¶ä»–'} Â· {char.age}å²
                        </p>
                      </div>
                      <button onClick={() => openCharEditor(char)} className="p-2 text-gray-400">
                        <Icon name="Edit2" size={20} />
                      </button>
                      <button onClick={() => actions.deleteCharacter(char.id)} className="p-2 text-red-400">
                        <Icon name="Trash2" size={20} />
                      </button>
                    </div>
                  ))
                )}
              </div>
            ) : (
              <div className="space-y-3">
                {state.userPersonas.length === 0 ? (
                  <div className="text-center text-gray-500 py-8">
                    <Icon name="Users" size={48} className="mx-auto mb-2 opacity-50" />
                    <p>æš‚æ— ç”¨æˆ·äººè®¾ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ </p>
                  </div>
                ) : (
                  state.userPersonas.map((persona) => (
                    <div key={persona.id} className="bg-white rounded-2xl p-4 flex items-center gap-4">
                      <div className="w-14 h-14 bg-gradient-to-br from-blue-400 to-cyan-400 rounded-full flex items-center justify-center text-white text-xl font-bold overflow-hidden">
                        {persona.avatar ? (
                          <img src={persona.avatar} alt="" className="w-full h-full object-cover" />
                        ) : persona.name[0]}
                      </div>
                      <div className="flex-1">
                        <h3 className="font-semibold text-gray-800">{persona.name}</h3>
                        <p className="text-sm text-gray-500">
                          {persona.gender === 'male' ? 'ç”·' : persona.gender === 'female' ? 'å¥³' : 'å…¶ä»–'} Â· {persona.age}å²
                        </p>
                      </div>
                      <button onClick={() => openPersonaEditor(persona)} className="p-2 text-gray-400">
                        <Icon name="Edit2" size={20} />
                      </button>
                      <button onClick={() => actions.deleteUserPersona(persona.id)} className="p-2 text-red-400">
                        <Icon name="Trash2" size={20} />
                      </button>
                    </div>
                  ))
                )}
              </div>
            )}
          </div>

          {showEditor && (
            <div className="absolute inset-0 bg-black/50 flex items-end z-50">
              <div className="w-full bg-white rounded-t-3xl p-6 max-h-[85%] overflow-y-auto animate-slide-up">
                <h2 className="text-xl font-bold mb-4">
                  {activeTab === 'characters' 
                    ? (editingChar ? 'ç¼–è¾‘è§’è‰²' : 'æ·»åŠ è§’è‰²')
                    : (editingPersona ? 'ç¼–è¾‘äººè®¾' : 'æ·»åŠ äººè®¾')
                  }
                </h2>

                {activeTab === 'characters' ? (
                  <div className="space-y-4">
                    {/* å¤´åƒå’ŒæŒ‚ä»¶ */}
                    <div className="flex flex-col items-center">
                      <input
                        ref={avatarInputRef}
                        type="file"
                        accept="image/*"
                        onChange={(e) => handleAvatarUpload(e, 'char')}
                        className="hidden"
                      />
                      <div className="relative w-28 h-28 flex items-center justify-center">
                        {/* å¤´åƒ */}
                        <button
                          onClick={() => avatarInputRef.current?.click()}
                          className="w-20 h-20 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center overflow-hidden border-4 border-white shadow-lg"
                        >
                          {charForm.avatar ? (
                            <img src={charForm.avatar} alt="" className="w-full h-full object-cover" />
                          ) : (
                            <Icon name="Camera" size={28} className="text-white" />
                          )}
                        </button>
                        {/* å¤´åƒæŒ‚ä»¶ - å±…ä¸­è¦†ç›– */}
                        {charForm.avatarFrame && (
                          <img 
                            src={charForm.avatarFrame} 
                            alt="æŒ‚ä»¶" 
                            className="absolute inset-0 w-28 h-28 object-contain pointer-events-none z-10"
                          />
                        )}
                      </div>
                      <p className="text-sm text-gray-500 mt-2">ç‚¹å‡»ä¸Šä¼ å¤´åƒ</p>
                    </div>

                    <div>
                      <label className="block text-sm text-gray-600 mb-1">å§“å *</label>
                      <input
                        type="text"
                        value={charForm.name}
                        onChange={(e) => setCharForm({ ...charForm, name: e.target.value })}
                        className="w-full p-3 bg-gray-100 rounded-xl"
                        placeholder="è§’è‰²å§“å"
                      />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">å¤´åƒURLï¼ˆå¯é€‰ï¼‰</label>
                      <input
                        type="text"
                        value={charForm.avatar}
                        onChange={(e) => setCharForm({ ...charForm, avatar: e.target.value })}
                        className="w-full p-3 bg-gray-100 rounded-xl"
                        placeholder="æˆ–ç²˜è´´å›¾ç‰‡é“¾æ¥"
                      />
                    </div>
                    <div className="grid grid-cols-3 gap-4">
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">æ€§åˆ«</label>
                        <select
                          value={charForm.gender}
                          onChange={(e) => setCharForm({ ...charForm, gender: e.target.value })}
                          className="w-full p-3 bg-gray-100 rounded-xl"
                        >
                          <option value="male">ç”·</option>
                          <option value="female">å¥³</option>
                          <option value="other">å…¶ä»–</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">å¹´é¾„</label>
                        <input
                          type="number"
                          value={charForm.age}
                          onChange={(e) => setCharForm({ ...charForm, age: parseInt(e.target.value) || 0 })}
                          className="w-full p-3 bg-gray-100 rounded-xl"
                        />
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">æ€§å–å‘</label>
                        <input
                          type="text"
                          value={charForm.sexuality}
                          onChange={(e) => setCharForm({ ...charForm, sexuality: e.target.value })}
                          className="w-full p-3 bg-gray-100 rounded-xl"
                        />
                      </div>
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">äººè®¾æè¿° *</label>
                      <textarea
                        value={charForm.persona}
                        onChange={(e) => setCharForm({ ...charForm, persona: e.target.value })}
                        className="w-full h-24 p-3 bg-gray-100 rounded-xl resize-none"
                        placeholder="æè¿°è§’è‰²çš„æ€§æ ¼ã€èƒŒæ™¯ã€è¯´è¯æ–¹å¼ç­‰..."
                      />
                    </div>

                    {/* è£…æ‰®è®¾ç½®åˆ†å‰²çº¿ */}
                    <div className="border-t border-gray-200 pt-4">
                      <h3 className="text-sm font-semibold text-gray-700 mb-3">âœ¨ ä¸ªæ€§è£…æ‰®</h3>
                      
                      {/* æ°”æ³¡è®¾ç½® */}
                      <div className="space-y-3">
                        {/* æ°”æ³¡èƒŒæ™¯å›¾ä¸Šä¼  */}
                        <div>
                          <label className="block text-xs text-gray-500 mb-1">ğŸ’¬ æ°”æ³¡èƒŒæ™¯å›¾</label>
                          <div className="flex gap-2">
                            <input
                              type="text"
                              value={charForm.bubbleImage}
                              onChange={(e) => setCharForm({ ...charForm, bubbleImage: e.target.value })}
                              className="flex-1 p-2 bg-gray-100 rounded-lg text-sm"
                              placeholder="å›¾ç‰‡URLæˆ–ä¸Šä¼ "
                            />
                            <input
                              type="file"
                              accept="image/*"
                              onChange={(e) => {
                                const file = e.target.files?.[0];
                                if (file) {
                                  const reader = new FileReader();
                                  reader.onload = (ev) => setCharForm({ ...charForm, bubbleImage: ev.target.result });
                                  reader.readAsDataURL(file);
                                }
                              }}
                              className="hidden"
                              id="charBubbleUpload"
                            />
                            <label
                              htmlFor="charBubbleUpload"
                              className="px-3 py-2 bg-purple-500 text-white text-xs rounded-lg cursor-pointer"
                            >
                              ä¸Šä¼ 
                            </label>
                          </div>
                          {charForm.bubbleImage && (
                            <div className="mt-2 flex items-center gap-2">
                              <div 
                                className="w-24 h-12 rounded-lg bg-cover bg-center border"
                                style={{ backgroundImage: `url(${charForm.bubbleImage})` }}
                              />
                              <button
                                onClick={() => setCharForm({ ...charForm, bubbleImage: '' })}
                                className="text-red-500 text-xs"
                              >
                                æ¸…é™¤
                              </button>
                            </div>
                          )}
                        </div>
                        
                        <div className="flex gap-2">
                          <div className="flex-1">
                            <label className="block text-xs text-gray-500 mb-1">ğŸ¨ æ°”æ³¡é¢œè‰²</label>
                            <div className="flex gap-2">
                              <input
                                type="color"
                                value={charForm.bubbleColor || '#ffffff'}
                                onChange={(e) => setCharForm({ ...charForm, bubbleColor: e.target.value })}
                                className="w-10 h-10 rounded-lg cursor-pointer"
                              />
                              <input
                                type="text"
                                value={charForm.bubbleColor}
                                onChange={(e) => setCharForm({ ...charForm, bubbleColor: e.target.value })}
                                className="flex-1 p-2 bg-gray-100 rounded-lg text-sm"
                                placeholder="#ffffff"
                              />
                            </div>
                          </div>
                        </div>

                        {/* å¤´åƒæŒ‚ä»¶ä¸Šä¼  */}
                        <div>
                          <label className="block text-xs text-gray-500 mb-1">ğŸ–¼ï¸ å¤´åƒæŒ‚ä»¶</label>
                          <div className="flex gap-2">
                            <input
                              type="text"
                              value={charForm.avatarFrame}
                              onChange={(e) => setCharForm({ ...charForm, avatarFrame: e.target.value })}
                              className="flex-1 p-2 bg-gray-100 rounded-lg text-sm"
                              placeholder="æŒ‚ä»¶å›¾ç‰‡URLæˆ–ä¸Šä¼ ï¼ˆé€æ˜PNGï¼‰"
                            />
                            <input
                              type="file"
                              accept="image/*"
                              onChange={(e) => {
                                const file = e.target.files?.[0];
                                if (file) {
                                  const reader = new FileReader();
                                  reader.onload = (ev) => setCharForm({ ...charForm, avatarFrame: ev.target.result });
                                  reader.readAsDataURL(file);
                                }
                              }}
                              className="hidden"
                              id="charFrameUpload"
                            />
                            <label
                              htmlFor="charFrameUpload"
                              className="px-3 py-2 bg-purple-500 text-white text-xs rounded-lg cursor-pointer"
                            >
                              ä¸Šä¼ 
                            </label>
                          </div>
                          {charForm.avatarFrame && (
                            <div className="mt-2 flex items-center gap-2">
                              <div className="relative w-14 h-14">
                                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full" />
                                <img 
                                  src={charForm.avatarFrame} 
                                  alt="æŒ‚ä»¶é¢„è§ˆ" 
                                  className="absolute inset-0 w-14 h-14 object-contain"
                                />
                              </div>
                              <button
                                onClick={() => setCharForm({ ...charForm, avatarFrame: '' })}
                                className="text-red-500 text-xs"
                              >
                                æ¸…é™¤
                              </button>
                            </div>
                          )}
                        </div>

                        <div className="flex gap-2">
                          <div className="flex-1">
                            <label className="block text-xs text-gray-500 mb-1">ğŸ”¤ æ–‡å­—é¢œè‰²</label>
                            <div className="flex gap-2">
                              <input
                                type="color"
                                value={charForm.textColor || '#333333'}
                                onChange={(e) => setCharForm({ ...charForm, textColor: e.target.value })}
                                className="w-10 h-10 rounded-lg cursor-pointer"
                              />
                              <input
                                type="text"
                                value={charForm.textColor}
                                onChange={(e) => setCharForm({ ...charForm, textColor: e.target.value })}
                                className="flex-1 p-2 bg-gray-100 rounded-lg text-sm"
                                placeholder="#333333"
                              />
                            </div>
                          </div>
                          <div className="w-20">
                            <label className="block text-xs text-gray-500 mb-1">å­—å·</label>
                            <input
                              type="number"
                              value={charForm.fontSize}
                              onChange={(e) => setCharForm({ ...charForm, fontSize: parseInt(e.target.value) || 14 })}
                              className="w-full p-2 bg-gray-100 rounded-lg text-sm text-center"
                              min={10}
                              max={24}
                            />
                          </div>
                        </div>

                        <div>
                          <label className="block text-xs text-gray-500 mb-1">ğŸ…°ï¸ å­—ä½“</label>
                          <select
                            value={charForm.fontFamily}
                            onChange={(e) => setCharForm({ ...charForm, fontFamily: e.target.value })}
                            className="w-full p-2 bg-gray-100 rounded-lg text-sm"
                          >
                            <option value="">é»˜è®¤å­—ä½“</option>
                            <option value="serif">å®‹ä½“ Serif</option>
                            <option value="sans-serif">é»‘ä½“ Sans</option>
                            <option value="cursive">æ‰‹å†™ä½“ Cursive</option>
                            <option value="fantasy">è‰ºæœ¯ä½“ Fantasy</option>
                            <option value="monospace">ç­‰å®½å­—ä½“ Mono</option>
                            <option value="'KaiTi', æ¥·ä½“">æ¥·ä½“</option>
                            <option value="'FangSong', ä»¿å®‹">ä»¿å®‹</option>
                          </select>
                        </div>

                        {/* è‡ªå®šä¹‰CSS */}
                        <div>
                          <label className="block text-xs text-gray-500 mb-1">ğŸ’» è‡ªå®šä¹‰æ°”æ³¡CSS</label>
                          <textarea
                            value={charForm.customBubbleCSS || ''}
                            onChange={(e) => setCharForm({ ...charForm, customBubbleCSS: e.target.value })}
                            className="w-full h-24 p-2 bg-gray-100 rounded-lg text-xs font-mono resize-none"
                            placeholder={`/* æ°”æ³¡æ ·å¼ç¤ºä¾‹ */
border-radius: 20px;
box-shadow: 0 4px 15px rgba(0,0,0,0.2);
border: 2px solid gold;
backdrop-filter: blur(10px);`}
                          />
                          <p className="text-xs text-gray-400 mt-1">
                            ç›´æ¥å†™CSSå±æ€§ï¼Œåº”ç”¨åˆ°è¯¥è§’è‰²çš„æ°”æ³¡ä¸Š
                          </p>
                        </div>

                        {/* é¢„è§ˆ */}
                        <div>
                          <label className="block text-xs text-gray-500 mb-1">ğŸ‘ï¸ æ°”æ³¡é¢„è§ˆ</label>
                          <div className="bg-gray-200 rounded-xl p-4">
                            <div 
                              className="max-w-[200px] rounded-2xl px-3 py-2 text-sm"
                              style={{
                                backgroundColor: charForm.bubbleColor || '#ffffff',
                                backgroundImage: charForm.bubbleImage ? `url(${charForm.bubbleImage})` : 'none',
                                backgroundSize: 'cover',
                                backgroundPosition: 'center',
                                color: charForm.textColor || '#333333',
                                fontSize: `${charForm.fontSize || 14}px`,
                                fontFamily: charForm.fontFamily || 'inherit',
                                ...(charForm.customBubbleCSS ? (() => {
                                  try {
                                    const style = {};
                                    charForm.customBubbleCSS.split(';').forEach(rule => {
                                      const [prop, val] = rule.split(':').map(s => s.trim());
                                      if (prop && val) {
                                        const camelProp = prop.replace(/-([a-z])/g, g => g[1].toUpperCase());
                                        style[camelProp] = val;
                                      }
                                    });
                                    return style;
                                  } catch { return {}; }
                                })() : {})
                              }}
                            >
                              è¿™æ˜¯ä¸€æ¡é¢„è§ˆæ¶ˆæ¯~
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {/* å¤´åƒå’ŒæŒ‚ä»¶ */}
                    <div className="flex flex-col items-center">
                      <input
                        ref={avatarInputRef}
                        type="file"
                        accept="image/*"
                        onChange={(e) => handleAvatarUpload(e, 'persona')}
                        className="hidden"
                      />
                      <div className="relative w-28 h-28 flex items-center justify-center">
                        {/* å¤´åƒ */}
                        <button
                          onClick={() => avatarInputRef.current?.click()}
                          className="w-20 h-20 rounded-full bg-gradient-to-br from-blue-400 to-cyan-400 flex items-center justify-center overflow-hidden border-4 border-white shadow-lg"
                        >
                          {personaForm.avatar ? (
                            <img src={personaForm.avatar} alt="" className="w-full h-full object-cover" />
                          ) : (
                            <Icon name="Camera" size={28} className="text-white" />
                          )}
                        </button>
                        {/* å¤´åƒæŒ‚ä»¶ - å±…ä¸­è¦†ç›– */}
                        {personaForm.avatarFrame && (
                          <img 
                            src={personaForm.avatarFrame} 
                            alt="æŒ‚ä»¶" 
                            className="absolute inset-0 w-28 h-28 object-contain pointer-events-none z-10"
                          />
                        )}
                      </div>
                      <p className="text-sm text-gray-500 mt-2">ç‚¹å‡»ä¸Šä¼ å¤´åƒ</p>
                    </div>

                    <div>
                      <label className="block text-sm text-gray-600 mb-1">å§“å *</label>
                      <input
                        type="text"
                        value={personaForm.name}
                        onChange={(e) => setPersonaForm({ ...personaForm, name: e.target.value })}
                        className="w-full p-3 bg-gray-100 rounded-xl"
                        placeholder="ä½ çš„è§’è‰²å"
                      />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">å¤´åƒURLï¼ˆå¯é€‰ï¼‰</label>
                      <input
                        type="text"
                        value={personaForm.avatar}
                        onChange={(e) => setPersonaForm({ ...personaForm, avatar: e.target.value })}
                        className="w-full p-3 bg-gray-100 rounded-xl"
                        placeholder="æˆ–ç²˜è´´å›¾ç‰‡é“¾æ¥"
                      />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">æ€§åˆ«</label>
                        <select
                          value={personaForm.gender}
                          onChange={(e) => setPersonaForm({ ...personaForm, gender: e.target.value })}
                          className="w-full p-3 bg-gray-100 rounded-xl"
                        >
                          <option value="male">ç”·</option>
                          <option value="female">å¥³</option>
                          <option value="other">å…¶ä»–</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm text-gray-600 mb-1">å¹´é¾„</label>
                        <input
                          type="number"
                          value={personaForm.age}
                          onChange={(e) => setPersonaForm({ ...personaForm, age: parseInt(e.target.value) || 0 })}
                          className="w-full p-3 bg-gray-100 rounded-xl"
                        />
                      </div>
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">äººè®¾æè¿°</label>
                      <textarea
                        value={personaForm.persona}
                        onChange={(e) => setPersonaForm({ ...personaForm, persona: e.target.value })}
                        className="w-full h-24 p-3 bg-gray-100 rounded-xl resize-none"
                        placeholder="æè¿°ä½ æ‰®æ¼”çš„è§’è‰²..."
                      />
                    </div>

                    {/* è£…æ‰®è®¾ç½® */}
                    <div className="border-t border-gray-200 pt-4">
                      <h3 className="text-sm font-semibold text-gray-700 mb-3">âœ¨ ä¸ªæ€§è£…æ‰®</h3>
                      
                      <div className="space-y-3">
                        {/* æ°”æ³¡èƒŒæ™¯å›¾ä¸Šä¼  */}
                        <div>
                          <label className="block text-xs text-gray-500 mb-1">ğŸ’¬ æ°”æ³¡èƒŒæ™¯å›¾</label>
                          <div className="flex gap-2">
                            <input
                              type="text"
                              value={personaForm.bubbleImage}
                              onChange={(e) => setPersonaForm({ ...personaForm, bubbleImage: e.target.value })}
                              className="flex-1 p-2 bg-gray-100 rounded-lg text-sm"
                              placeholder="å›¾ç‰‡URLæˆ–ä¸Šä¼ "
                            />
                            <input
                              type="file"
                              accept="image/*"
                              onChange={(e) => {
                                const file = e.target.files?.[0];
                                if (file) {
                                  const reader = new FileReader();
                                  reader.onload = (ev) => setPersonaForm({ ...personaForm, bubbleImage: ev.target.result });
                                  reader.readAsDataURL(file);
                                }
                              }}
                              className="hidden"
                              id="personaBubbleUpload"
                            />
                            <label
                              htmlFor="personaBubbleUpload"
                              className="px-3 py-2 bg-blue-500 text-white text-xs rounded-lg cursor-pointer"
                            >
                              ä¸Šä¼ 
                            </label>
                          </div>
                          {personaForm.bubbleImage && (
                            <div className="mt-2 flex items-center gap-2">
                              <div 
                                className="w-24 h-12 rounded-lg bg-cover bg-center border"
                                style={{ backgroundImage: `url(${personaForm.bubbleImage})` }}
                              />
                              <button
                                onClick={() => setPersonaForm({ ...personaForm, bubbleImage: '' })}
                                className="text-red-500 text-xs"
                              >
                                æ¸…é™¤
                              </button>
                            </div>
                          )}
                        </div>
                        
                        <div className="flex gap-2">
                          <div className="flex-1">
                            <label className="block text-xs text-gray-500 mb-1">ğŸ¨ æ°”æ³¡é¢œè‰²</label>
                            <div className="flex gap-2">
                              <input
                                type="color"
                                value={personaForm.bubbleColor || '#07c160'}
                                onChange={(e) => setPersonaForm({ ...personaForm, bubbleColor: e.target.value })}
                                className="w-10 h-10 rounded-lg cursor-pointer"
                              />
                              <input
                                type="text"
                                value={personaForm.bubbleColor}
                                onChange={(e) => setPersonaForm({ ...personaForm, bubbleColor: e.target.value })}
                                className="flex-1 p-2 bg-gray-100 rounded-lg text-sm"
                                placeholder="#07c160"
                              />
                            </div>
                          </div>
                        </div>

                        {/* å¤´åƒæŒ‚ä»¶ä¸Šä¼  */}
                        <div>
                          <label className="block text-xs text-gray-500 mb-1">ğŸ–¼ï¸ å¤´åƒæŒ‚ä»¶</label>
                          <div className="flex gap-2">
                            <input
                              type="text"
                              value={personaForm.avatarFrame}
                              onChange={(e) => setPersonaForm({ ...personaForm, avatarFrame: e.target.value })}
                              className="flex-1 p-2 bg-gray-100 rounded-lg text-sm"
                              placeholder="æŒ‚ä»¶å›¾ç‰‡URLæˆ–ä¸Šä¼ ï¼ˆé€æ˜PNGï¼‰"
                            />
                            <input
                              type="file"
                              accept="image/*"
                              onChange={(e) => {
                                const file = e.target.files?.[0];
                                if (file) {
                                  const reader = new FileReader();
                                  reader.onload = (ev) => setPersonaForm({ ...personaForm, avatarFrame: ev.target.result });
                                  reader.readAsDataURL(file);
                                }
                              }}
                              className="hidden"
                              id="personaFrameUpload"
                            />
                            <label
                              htmlFor="personaFrameUpload"
                              className="px-3 py-2 bg-blue-500 text-white text-xs rounded-lg cursor-pointer"
                            >
                              ä¸Šä¼ 
                            </label>
                          </div>
                          {personaForm.avatarFrame && (
                            <div className="mt-2 flex items-center gap-2">
                              <div className="relative w-14 h-14">
                                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-gradient-to-br from-blue-400 to-cyan-400 rounded-full" />
                                <img 
                                  src={personaForm.avatarFrame} 
                                  alt="æŒ‚ä»¶é¢„è§ˆ" 
                                  className="absolute inset-0 w-14 h-14 object-contain"
                                />
                              </div>
                              <button
                                onClick={() => setPersonaForm({ ...personaForm, avatarFrame: '' })}
                                className="text-red-500 text-xs"
                              >
                                æ¸…é™¤
                              </button>
                            </div>
                          )}
                        </div>

                        <div className="flex gap-2">
                          <div className="flex-1">
                            <label className="block text-xs text-gray-500 mb-1">ğŸ”¤ æ–‡å­—é¢œè‰²</label>
                            <div className="flex gap-2">
                              <input
                                type="color"
                                value={personaForm.textColor || '#ffffff'}
                                onChange={(e) => setPersonaForm({ ...personaForm, textColor: e.target.value })}
                                className="w-10 h-10 rounded-lg cursor-pointer"
                              />
                              <input
                                type="text"
                                value={personaForm.textColor}
                                onChange={(e) => setPersonaForm({ ...personaForm, textColor: e.target.value })}
                                className="flex-1 p-2 bg-gray-100 rounded-lg text-sm"
                                placeholder="#ffffff"
                              />
                            </div>
                          </div>
                          <div className="w-20">
                            <label className="block text-xs text-gray-500 mb-1">å­—å·</label>
                            <input
                              type="number"
                              value={personaForm.fontSize}
                              onChange={(e) => setPersonaForm({ ...personaForm, fontSize: parseInt(e.target.value) || 14 })}
                              className="w-full p-2 bg-gray-100 rounded-lg text-sm text-center"
                              min={10}
                              max={24}
                            />
                          </div>
                        </div>

                        <div>
                          <label className="block text-xs text-gray-500 mb-1">ğŸ…°ï¸ å­—ä½“</label>
                          <select
                            value={personaForm.fontFamily}
                            onChange={(e) => setPersonaForm({ ...personaForm, fontFamily: e.target.value })}
                            className="w-full p-2 bg-gray-100 rounded-lg text-sm"
                          >
                            <option value="">é»˜è®¤å­—ä½“</option>
                            <option value="serif">å®‹ä½“ Serif</option>
                            <option value="sans-serif">é»‘ä½“ Sans</option>
                            <option value="cursive">æ‰‹å†™ä½“ Cursive</option>
                            <option value="fantasy">è‰ºæœ¯ä½“ Fantasy</option>
                            <option value="monospace">ç­‰å®½å­—ä½“ Mono</option>
                          </select>
                        </div>

                        {/* è‡ªå®šä¹‰CSS */}
                        <div>
                          <label className="block text-xs text-gray-500 mb-1">ğŸ’» è‡ªå®šä¹‰æ°”æ³¡CSS</label>
                          <textarea
                            value={personaForm.customBubbleCSS || ''}
                            onChange={(e) => setPersonaForm({ ...personaForm, customBubbleCSS: e.target.value })}
                            className="w-full h-24 p-2 bg-gray-100 rounded-lg text-xs font-mono resize-none"
                            placeholder={`/* æ°”æ³¡æ ·å¼ç¤ºä¾‹ */
border-radius: 20px;
box-shadow: 0 4px 15px rgba(0,0,0,0.2);
border: 2px solid gold;`}
                          />
                          <p className="text-xs text-gray-400 mt-1">
                            ç›´æ¥å†™CSSå±æ€§ï¼Œåº”ç”¨åˆ°ä½ çš„æ°”æ³¡ä¸Š
                          </p>
                        </div>

                        {/* é¢„è§ˆ */}
                        <div>
                          <label className="block text-xs text-gray-500 mb-1">ğŸ‘ï¸ æ°”æ³¡é¢„è§ˆ</label>
                          <div className="bg-gray-200 rounded-xl p-4 flex justify-end">
                            <div 
                              className="max-w-[200px] rounded-2xl px-3 py-2 text-sm"
                              style={{
                                backgroundColor: personaForm.bubbleColor || '#07c160',
                                backgroundImage: personaForm.bubbleImage ? `url(${personaForm.bubbleImage})` : 'none',
                                backgroundSize: 'cover',
                                backgroundPosition: 'center',
                                color: personaForm.textColor || '#ffffff',
                                fontSize: `${personaForm.fontSize || 14}px`,
                                fontFamily: personaForm.fontFamily || 'inherit',
                                ...(personaForm.customBubbleCSS ? (() => {
                                  try {
                                    const style = {};
                                    personaForm.customBubbleCSS.split(';').forEach(rule => {
                                      const [prop, val] = rule.split(':').map(s => s.trim());
                                      if (prop && val) {
                                        const camelProp = prop.replace(/-([a-z])/g, g => g[1].toUpperCase());
                                        style[camelProp] = val;
                                      }
                                    });
                                    return style;
                                  } catch { return {}; }
                                })() : {})
                              }}
                            >
                              è¿™æ˜¯æˆ‘å‘çš„æ¶ˆæ¯~
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                <div className="flex gap-4 mt-6">
                  <button onClick={() => setShowEditor(false)} className="flex-1 p-4 bg-gray-200 rounded-xl font-semibold">
                    å–æ¶ˆ
                  </button>
                  <button
                    onClick={activeTab === 'characters' ? saveCharacter : savePersona}
                    className="flex-1 p-4 bg-orange-500 text-white rounded-xl font-semibold"
                  >
                    ä¿å­˜
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };
    
    // ==================== å¾®ä¿¡ç»„ä»¶ ====================
    const WeChat = () => {
      const state = useStore();
      const [showCreateChat, setShowCreateChat] = useState(false);

      if (state.appState.currentChatId) {
        return <ChatRoom />;
      }

      const getLastMessage = (chatId) => {
        const chat = state.chats.find(c => c.id === chatId);
        if (!chat || chat.messages.length === 0) return 'æš‚æ— æ¶ˆæ¯';
        const lastMsg = chat.messages[chat.messages.length - 1];
        return lastMsg.content.slice(0, 30) + (lastMsg.content.length > 30 ? '...' : '');
      };

      const getChatName = (chat) => {
        if (chat.name) return chat.name;
        const char = state.characters.find(c => c.id === chat.characterIds[0]);
        return char?.name || 'æœªçŸ¥';
      };

      return (
        <div className="w-full h-full bg-gray-100 flex flex-col">
          <div className="bg-green-500 pt-12 pb-4 px-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <button onClick={() => actions.setScreen('home')} className="text-white">
                  <Icon name="ChevronLeft" size={24} />
                </button>
                <h1 className="text-white text-xl font-semibold">å¾®ä¿¡</h1>
              </div>
              <button onClick={() => setShowCreateChat(true)} className="text-white">
                <Icon name="Plus" size={24} />
              </button>
            </div>
          </div>

          <div className="flex-1 overflow-y-auto">
            {state.chats.length === 0 ? (
              <div className="text-center text-gray-500 py-16">
                <Icon name="MessageCircle" size={64} className="mx-auto mb-4 opacity-30" />
                <p>æš‚æ— èŠå¤©</p>
                <p className="text-sm mt-2">ç‚¹å‡»å³ä¸Šè§’ + å¼€å§‹æ–°å¯¹è¯</p>
              </div>
            ) : (
              <div className="divide-y divide-gray-200">
                {state.chats
  .sort((a, b) => b.updatedAt - a.updatedAt)
  .map((chat) => {
    const firstChar = state.characters.find(c => c.id === chat.characterIds?.[0]);
    const chatAvatar = chat.avatar || firstChar?.avatar;
    const chatName = getChatName(chat);
    const isReplying = state.pendingReplies?.[chat.id]?.isLoading;
    
    return (
                      <button
                        key={chat.id}
                        onClick={() => actions.setCurrentChat(chat.id)}
                        className="w-full p-4 flex items-center gap-3 bg-white hover:bg-gray-50 active:bg-gray-100"
                      >
                        {/* å¤´åƒ */}
                        <div className={`w-12 h-12 rounded-lg flex items-center justify-center overflow-hidden ${
                          chat.type === 'group' 
                            ? 'bg-gradient-to-br from-blue-400 to-purple-500' 
                            : 'bg-gradient-to-br from-green-400 to-teal-500'
                        }`}>
                          {chat.type === 'group' ? (
                            // ç¾¤èŠå¤´åƒï¼šæ˜¾ç¤ºå¤šä¸ªè§’è‰²å¤´åƒæ‹¼æ¥
                            (() => {
                              const groupChars = (chat.characterIds || [])
                                .map(id => state.characters.find(c => c.id === id))
                                .filter(Boolean)
                                .slice(0, 4);
                              
                              if (groupChars.length === 0) {
                                return <Icon name="Users" size={24} className="text-white" />;
                              }
                              
                              if (groupChars.length === 1) {
                                return groupChars[0].avatar ? (
                                  <img src={groupChars[0].avatar} alt="" className="w-full h-full object-cover" />
                                ) : (
                                  <span className="text-white text-lg font-bold">{groupChars[0].name[0]}</span>
                                );
                              }
                              
                              // å¤šäººå¤´åƒæ‹¼æ¥
                              return (
                                <div className="w-full h-full grid grid-cols-2 gap-0.5 p-0.5">
                                  {groupChars.slice(0, 4).map((char, idx) => (
                                    <div key={idx} className="w-full h-full bg-gray-300 overflow-hidden">
                                      {char.avatar ? (
                                        <img src={char.avatar} alt="" className="w-full h-full object-cover" />
                                      ) : (
                                        <div className="w-full h-full flex items-center justify-center bg-gradient-to-br from-purple-400 to-pink-400">
                                          <span className="text-white text-xs font-bold">{char.name[0]}</span>
                                        </div>
                                      )}
                                    </div>
                                  ))}
                                </div>
                              );
                            })()
                          )
 : (
                            // ç§èŠå¤´åƒ
                            chatAvatar ? (
                              <img src={chatAvatar} alt="" className="w-full h-full object-cover" />
                            ) : (
                              <span className="text-white text-lg font-bold">{chatName[0]}</span>
                            )
                          )}
                        </div>
                        
                        {/* èŠå¤©ä¿¡æ¯ */}
                        <div className="flex-1 text-left min-w-0">
                          <div className="flex items-center justify-between gap-2">
                            <h3 className="font-medium text-gray-800 truncate">{chatName}</h3>
                            <span className="text-xs text-gray-400 flex-shrink-0">
                              {new Date(chat.updatedAt).toLocaleDateString()}
                            </span>
                          </div>
                          {isReplying ? (
  <p className="text-sm text-green-500 flex items-center gap-1">
    <span className="inline-block w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
    æ­£åœ¨å›å¤ä¸­...
  </p>
) : (
  <p className="text-sm text-gray-500 truncate">{getLastMessage(chat.id)}</p>
)}
                        </div>
                        
                        {/* æ¨¡å¼æ ‡ç­¾ */}
                        <div className={`px-2 py-1 rounded text-xs flex-shrink-0 ${
                          chat.mode === 'online' ? 'bg-blue-100 text-blue-600' : 'bg-purple-100 text-purple-600'
                        }`}>
                          {chat.mode === 'online' ? 'çº¿ä¸Š' : 'çº¿ä¸‹'}
                        </div>
                      </button>
                    );
                  })}
              </div>
            )}
          </div>

          {showCreateChat && <CreateChat onClose={() => setShowCreateChat(false)} />}
        </div>
      );
    };

    // ==================== åˆ›å»ºèŠå¤©ç»„ä»¶ ====================
    const CreateChat = ({ onClose }) => {
      const state = useStore();
      const [chatType, setChatType] = useState('private');
      const [chatName, setChatName] = useState('');
      const [selectedChars, setSelectedChars] = useState([]);
      const [selectedPersona, setSelectedPersona] = useState('');
      const [selectedWorldBooks, setSelectedWorldBooks] = useState([]);
      const [chatMode, setChatMode] = useState('offline');

      const toggleChar = (id) => {
        if (chatType === 'private') {
          setSelectedChars([id]);
        } else {
          setSelectedChars(prev => prev.includes(id) ? prev.filter(c => c !== id) : [...prev, id]);
        }
      };

      const handleCreate = () => {
        if (selectedChars.length === 0) return;
        const char = state.characters.find(c => c.id === selectedChars[0]);
        const chatId = actions.createChat({
          type: chatType,
          name: chatType === 'private' ? char?.name || 'æ–°èŠå¤©' : chatName || 'ç¾¤èŠ',
          avatar: char?.avatar || '',
          characterIds: selectedChars,
          userPersonaId: selectedPersona,
          worldBookIds: selectedWorldBooks,
          mode: chatMode,
        });
        actions.setCurrentChat(chatId);
        onClose();
      };

      return (
        <div className="absolute inset-0 bg-black/50 flex items-end z-50">
          <div className="w-full bg-white rounded-t-3xl max-h-[90%] flex flex-col animate-slide-up">
            <div className="flex items-center justify-between p-4 border-b">
              <button onClick={onClose} className="text-gray-500">
                <Icon name="X" size={24} />
              </button>
              <h2 className="text-lg font-semibold">æ–°å»ºèŠå¤©</h2>
              <button 
                onClick={handleCreate}
                disabled={selectedChars.length === 0}
                className={`font-semibold ${selectedChars.length > 0 ? 'text-green-500' : 'text-gray-300'}`}
              >
                åˆ›å»º
              </button>
            </div>

            <div className="flex-1 overflow-y-auto p-4 space-y-6">
              {/* èŠå¤©ç±»å‹ */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">èŠå¤©ç±»å‹</label>
                <div className="flex gap-4">
                  <button
                    onClick={() => { setChatType('private'); setSelectedChars([]); }}
                    className={`flex-1 p-4 rounded-xl flex flex-col items-center gap-2 border-2 ${
                      chatType === 'private' ? 'border-green-500 bg-green-50' : 'border-gray-200'
                    }`}
                  >
                    <Icon name="User" size={32} className={chatType === 'private' ? 'text-green-500' : 'text-gray-400'} />
                    <span>ç§èŠ</span>
                  </button>
                  <button
                    onClick={() => { setChatType('group'); setSelectedChars([]); }}
                    className={`flex-1 p-4 rounded-xl flex flex-col items-center gap-2 border-2 ${
                      chatType === 'group' ? 'border-green-500 bg-green-50' : 'border-gray-200'
                    }`}
                  >
                    <Icon name="Users" size={32} className={chatType === 'group' ? 'text-green-500' : 'text-gray-400'} />
                    <span>ç¾¤èŠ</span>
                  </button>
                </div>
              </div>

              {chatType === 'group' && (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">ç¾¤èŠåç§°</label>
                  <input
                    type="text"
                    value={chatName}
                    onChange={(e) => setChatName(e.target.value)}
                    className="w-full p-3 bg-gray-100 rounded-xl"
                    placeholder="è¾“å…¥ç¾¤èŠåç§°"
                  />
                </div>
              )}

              {/* èŠå¤©æ¨¡å¼ */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">èŠå¤©æ¨¡å¼</label>
                <div className="flex gap-4">
                  <button
                    onClick={() => setChatMode('online')}
                    className={`flex-1 p-3 rounded-xl text-center border-2 ${
                      chatMode === 'online' ? 'border-blue-500 bg-blue-50 text-blue-600' : 'border-gray-200'
                    }`}
                  >
                    ğŸŒ çº¿ä¸Šæ¨¡å¼
                  </button>
                  <button
                    onClick={() => setChatMode('offline')}
                    className={`flex-1 p-3 rounded-xl text-center border-2 ${
                      chatMode === 'offline' ? 'border-purple-500 bg-purple-50 text-purple-600' : 'border-gray-200'
                    }`}
                  >
                    ğŸ“– çº¿ä¸‹æ¨¡å¼
                  </button>
                </div>
              </div>

              {/* é€‰æ‹©è§’è‰² */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©AIè§’è‰²</label>
                {state.characters.length === 0 ? (
                  <p className="text-gray-500 text-sm p-4 bg-gray-100 rounded-xl text-center">
                    è¯·å…ˆåœ¨é€šè®¯å½•ä¸­æ·»åŠ è§’è‰²
                  </p>
                ) : (
                  <div className="space-y-2 max-h-40 overflow-y-auto">
                    {state.characters.map((char) => (
                      <button
                        key={char.id}
                        onClick={() => toggleChar(char.id)}
                        className={`w-full p-3 rounded-xl flex items-center gap-3 border-2 ${
                          selectedChars.includes(char.id) ? 'border-green-500 bg-green-50' : 'border-gray-200'
                        }`}
                      >
                        <div className="w-10 h-10 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center text-white font-bold">
                          {char.name[0]}
                        </div>
                        <span className="flex-1 text-left font-medium">{char.name}</span>
                        {selectedChars.includes(char.id) && <Icon name="Check" size={20} className="text-green-500" />}
                      </button>
                    ))}
                  </div>
                )}
              </div>

              {/* é€‰æ‹©äººè®¾ */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©ä½ çš„äººè®¾</label>
                {state.userPersonas.length === 0 ? (
                  <p className="text-gray-500 text-sm p-4 bg-gray-100 rounded-xl text-center">
                    è¯·å…ˆåœ¨é€šè®¯å½•ä¸­æ·»åŠ ç”¨æˆ·äººè®¾
                  </p>
                ) : (
                  <div className="space-y-2 max-h-32 overflow-y-auto">
                    {state.userPersonas.map((persona) => (
                      <button
                        key={persona.id}
                        onClick={() => setSelectedPersona(persona.id)}
                        className={`w-full p-3 rounded-xl flex items-center gap-3 border-2 ${
                          selectedPersona === persona.id ? 'border-green-500 bg-green-50' : 'border-gray-200'
                        }`}
                      >
                        <div className="w-10 h-10 bg-gradient-to-br from-blue-400 to-cyan-400 rounded-full flex items-center justify-center text-white font-bold">
                          {persona.name[0]}
                        </div>
                        <span className="flex-1 text-left font-medium">{persona.name}</span>
                        {selectedPersona === persona.id && <Icon name="Check" size={20} className="text-green-500" />}
                      </button>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ==================== èŠå¤©å®¤ç»„ä»¶ ====================
    const ChatRoom = () => {
      const state = useStore();
      const [inputText, setInputText] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [streamingText, setStreamingText] = useState('');
      const [showSidebar, setShowSidebar] = useState(false);
      const [selectMode, setSelectMode] = useState(false);
      const [selectedMsgs, setSelectedMsgs] = useState([]);
      const [showMsgMenu, setShowMsgMenu] = useState(null);
      const [showWorldBookPicker, setShowWorldBookPicker] = useState(false);
      const [isSummarizing, setIsSummarizing] = useState(false);
      const [showSummaryModal, setShowSummaryModal] = useState(false);
      const [summaryRange, setSummaryRange] = useState({ start: 1, end: 50 });
      const [editingMessage, setEditingMessage] = useState(null);
      const [editText, setEditText] = useState('');
      const messagesEndRef = useRef(null);
      const longPressTimer = useRef(null);

      const chat = state.chats.find(c => c.id === state.appState.currentChatId);

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [chat?.messages, streamingText]);

      useEffect(() => {
        if (!selectMode) setSelectedMsgs([]);
      }, [selectMode]);

      if (!chat) return <div className="w-full h-full flex items-center justify-center">èŠå¤©ä¸å­˜åœ¨</div>;

      const chatCharacters = state.characters.filter(c => chat.characterIds.includes(c.id));
      const userPersona = state.userPersonas.find(p => p.id === chat.userPersonaId);
      
      // è·å–ç»‘å®šçš„ä¸–ç•Œä¹¦æ¡ç›®ï¼ˆåŒ…æ‹¬æ–‡ä»¶å¤¹å†…çš„æ¡ç›®ï¼‰
      const getWorldBookEntries = () => {
        const entries = [];
        const addedIds = new Set();
        
        const addEntry = (entry) => {
          if (addedIds.has(entry.id)) return;
          if (entry.type === 'entry') {
            entries.push(entry);
            addedIds.add(entry.id);
          } else if (entry.type === 'folder') {
            // é€’å½’æ·»åŠ æ–‡ä»¶å¤¹å†…çš„æ‰€æœ‰æ¡ç›®
            state.worldBook
              .filter(e => e.parentId === entry.id)
              .forEach(addEntry);
          }
        };
        
        (chat.worldBookIds || []).forEach(id => {
          const entry = state.worldBook.find(e => e.id === id);
          if (entry) addEntry(entry);
        });
        
        return entries;
      };
      
      const boundWorldBooks = getWorldBookEntries();

      const toggleMode = () => {
        const newMode = chat.mode === 'online' ? 'offline' : 'online';
        actions.updateChat(chat.id, { mode: newMode });
      };

      const toggleNarration = () => {
        actions.updateChat(chat.id, { allowNarration: !chat.allowNarration });
      };

      const toggleThoughts = () => {
        actions.updateChat(chat.id, { allowThoughts: !chat.allowThoughts });
      };

      // ä¸–ç•Œä¹¦ç»‘å®šåˆ‡æ¢
      const toggleWorldBookItem = (itemId) => {
        const currentIds = chat.worldBookIds || [];
        const newIds = currentIds.includes(itemId)
          ? currentIds.filter(id => id !== itemId)
          : [...currentIds, itemId];
        actions.updateChat(chat.id, { worldBookIds: newIds });
      };

      // æ‰“å¼€æ€»ç»“å¼¹çª—
      const openSummaryModal = () => {
        const msgCount = chat.messages.length;
        setSummaryRange({ 
          start: 1, 
          end: Math.min(msgCount, 50) 
        });
        setShowSummaryModal(true);
        setShowSidebar(false);
      };

      // æ‰§è¡Œæ€»ç»“
      const handleSummarize = async () => {
        if (chat.messages.length === 0) return;
        
        setIsSummarizing(true);
        setShowSummaryModal(false);
        
        try {
          const summaryPrompt = state.apiSettings.summaryPrompt || 'è¯·æ€»ç»“ä»¥ä¸‹å¯¹è¯å†…å®¹ã€‚';
          
          // è·å–æŒ‡å®šèŒƒå›´çš„æ¶ˆæ¯
          const startIdx = Math.max(0, summaryRange.start - 1);
          const endIdx = Math.min(chat.messages.length, summaryRange.end);
          const selectedMessages = chat.messages.slice(startIdx, endIdx);
          
          if (selectedMessages.length === 0) {
            alert('æ‰€é€‰èŒƒå›´å†…æ²¡æœ‰æ¶ˆæ¯');
            setIsSummarizing(false);
            return;
          }
          
          // æ„å»ºå¯¹è¯å†å²
          let conversationText = `ã€å¯¹è¯è®°å½•ï¼šç¬¬${summaryRange.start}æ¡ - ç¬¬${summaryRange.end}æ¡ï¼Œå…±${selectedMessages.length}æ¡æ¶ˆæ¯ã€‘\n\n`;
          
          selectedMessages.forEach((msg, idx) => {
            const msgNum = startIdx + idx + 1;
            if (msg.type === 'user') {
              conversationText += `[${msgNum}] ${userPersona?.name || 'ç”¨æˆ·'}: ${msg.content}\n`;
            } else if (msg.type === 'character') {
              const char = state.characters.find(c => c.id === msg.characterId);
              conversationText += `[${msgNum}] ${char?.name || 'AI'}: ${msg.content}\n`;
            } else if (msg.type === 'narration') {
              conversationText += `[${msgNum}] [æ—ç™½]: ${msg.content}\n`;
            }
          });

          const messages = [
            { role: 'system', content: summaryPrompt },
            { role: 'user', content: conversationText }
          ];

          const summary = await callChatCompletion(state.apiSettings, messages, null);
          
          // ä¿å­˜æ€»ç»“åˆ°èŠå¤©è®°å½•
          const summaryInfo = {
            content: summary,
            range: { start: summaryRange.start, end: summaryRange.end },
            createdAt: Date.now()
          };
          
          const existingSummaries = chat.summaries || [];
          actions.updateChat(chat.id, { 
            summaries: [...existingSummaries, summaryInfo],
            lastSummaryAt: Date.now()
          });
          
          // è‡ªåŠ¨ä¿å­˜åˆ°ä¸–ç•Œä¹¦
          await saveSummaryToWorldBook(summary, summaryRange.start, summaryRange.end);
          
          alert('âœ… æ€»ç»“å®Œæˆå¹¶å·²ä¿å­˜åˆ°ä¸–ç•Œä¹¦ï¼');
          
        } catch (error) {
          alert('æ€»ç»“å¤±è´¥: ' + error.message);
        } finally {
          setIsSummarizing(false);
        }
      };

      // ä¿å­˜æ€»ç»“åˆ°ä¸–ç•Œä¹¦
      const saveSummaryToWorldBook = async (summary, startNum, endNum) => {
        // è·å–æˆ–åˆ›å»ºèŠå¤©æ€»ç»“æ–‡ä»¶å¤¹
        const folderName = `ğŸ“š ${chat.name} - å‰§æƒ…æ€»ç»“`;
        let folder = state.worldBook.find(
          e => e.type === 'folder' && e.name === folderName && e.parentId === null
        );
        
        if (!folder) {
          const folderId = actions.createWorldBookEntry({
            type: 'folder',
            name: folderName,
            parentId: null
          });
          folder = { id: folderId };
        }
        
        // è·å–å‚ä¸è§’è‰²ä¿¡æ¯
        const charNames = chatCharacters.map(c => c.name).join('ã€');
        
        // è·å–æ€»ç»“çš„æ¶ˆæ¯æ—¶é—´èŒƒå›´
        const startIdx = Math.max(0, startNum - 1);
        const endIdx = Math.min(chat.messages.length, endNum);
        const selectedMessages = chat.messages.slice(startIdx, endIdx);
        
        let timeRange = '';
        if (selectedMessages.length > 0) {
          const firstTime = new Date(selectedMessages[0].timestamp).toLocaleString('zh-CN');
          const lastTime = new Date(selectedMessages[selectedMessages.length - 1].timestamp).toLocaleString('zh-CN');
          timeRange = `${firstTime} ~ ${lastTime}`;
        }
        
        // åˆ›å»ºæ€»ç»“æ¡ç›®
        const now = new Date();
        const dateStr = now.toLocaleDateString('zh-CN');
        const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        const entryName = `${dateStr} ${timeStr} | ç¬¬${startNum}-${endNum}æ¥¼`;
        
        const entryContent = `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ å‰§æƒ…æ€»ç»“å­˜æ¡£
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Œ åŸºæœ¬ä¿¡æ¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ èŠå¤©åç§°ï¼š${chat.name}
â€¢ èŠå¤©æ¨¡å¼ï¼š${chat.mode === 'online' ? 'çº¿ä¸Šæ¨¡å¼' : 'çº¿ä¸‹æ¨¡å¼'}
â€¢ å‚ä¸è§’è‰²ï¼š${charNames}
â€¢ ç”¨æˆ·äººè®¾ï¼š${userPersona?.name || 'æœªçŸ¥'}
â€¢ æ¶ˆæ¯èŒƒå›´ï¼šç¬¬${startNum}æ¡ - ç¬¬${endNum}æ¡ï¼ˆå…±${endNum - startNum + 1}æ¡ï¼‰
â€¢ å¯¹è¯æ—¶é—´ï¼š${timeRange}
â€¢ æ€»ç»“æ—¶é—´ï¼š${dateStr} ${timeStr}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${summary}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’¡ æ­¤æ€»ç»“ç”±AIè‡ªåŠ¨ç”Ÿæˆï¼Œå¯ä¾›åç»­å‰§æƒ…å‚è€ƒä½¿ç”¨ã€‚
å°†æ­¤æ¡ç›®ç»‘å®šåˆ°èŠå¤©ä¸­ï¼ŒAIå°†èƒ½å¤Ÿè¯»å–å¹¶å»¶ç»­å‰§æƒ…ã€‚`;
        
        actions.createWorldBookEntry({
          type: 'entry',
          name: entryName,
          content: entryContent,
          parentId: folder.id
        });
      };

      const handleMsgLongPress = (msgId) => {
        setShowMsgMenu(msgId);
      };

      const handleMsgTouchStart = (msgId) => {
        longPressTimer.current = setTimeout(() => {
          handleMsgLongPress(msgId);
        }, 500);
      };

      const handleMsgTouchEnd = () => {
        if (longPressTimer.current) {
          clearTimeout(longPressTimer.current);
          longPressTimer.current = null;
        }
      };

      const handleDeleteSingle = (msgId) => {
        actions.deleteMessage(chat.id, msgId);
        setShowMsgMenu(null);
      };

      const handleEditMessage = (msg) => {
        setEditingMessage(msg);
        setEditText(msg.content);
        setShowMsgMenu(null);
      };

      const saveEditedMessage = () => {
        if (!editingMessage || !editText.trim()) return;
        
        // æ›´æ–°æ¶ˆæ¯å†…å®¹
        const updatedMessages = chat.messages.map(m => 
          m.id === editingMessage.id 
            ? { ...m, content: editText.trim(), editedAt: Date.now() }
            : m
        );
        
        actions.updateChat(chat.id, { messages: updatedMessages });
        setEditingMessage(null);
        setEditText('');
      };

      const cancelEdit = () => {
        setEditingMessage(null);
        setEditText('');
      };

      const handleEnterSelectMode = (msgId) => {
        setSelectMode(true);
        setSelectedMsgs([msgId]);
        setShowMsgMenu(null);
      };

      const toggleSelectMsg = (msgId) => {
        setSelectedMsgs(prev => 
          prev.includes(msgId) 
            ? prev.filter(id => id !== msgId)
            : [...prev, msgId]
        );
      };

      const handleDeleteSelected = () => {
        if (selectedMsgs.length === 0) return;
        if (confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedMsgs.length} æ¡æ¶ˆæ¯ï¼Ÿ`)) {
          actions.deleteMessages(chat.id, selectedMsgs);
          setSelectMode(false);
        }
      };

      const handleSend = async () => {
  if (!inputText.trim() || isLoading) return;

  const userMessage = inputText.trim();
  const currentChatId = chat.id;
  const currentChatName = chat.name;
  setInputText('');

  actions.addMessage(currentChatId, { type: 'user', content: userMessage });

  setIsLoading(true);
  setStreamingText('');
  
  // è®¾ç½®å…¨å±€ pending çŠ¶æ€
  actions.setPendingReply(currentChatId, { isLoading: true });

  // ä½¿ç”¨å¼‚æ­¥å‡½æ•°ï¼Œå…è®¸åå°è¿è¡Œ
  const processReply = async () => {
    try {
      if (!userPersona) {
        throw new Error('è¯·å…ˆåœ¨ä¾§è¾¹æ ç»‘å®šç”¨æˆ·äººè®¾');
      }

      if (chat.type === 'group' && chatCharacters.length > 1) {
        await handleGroupReply(userMessage);
      } else {
        await handleSingleReply(chatCharacters[0], userMessage);
      }
      
      // å›å¤å®Œæˆåï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¿˜åœ¨è¿™ä¸ªèŠå¤©é¡µé¢
      const currentState = store.getState();
      const isStillInChat = currentState.appState.currentChatId === currentChatId;
      
      if (!isStillInChat) {
        // ç”¨æˆ·ä¸åœ¨è¿™ä¸ªèŠå¤©é¡µé¢ï¼Œå‘é€é€šçŸ¥
        const notifId = actions.addNotification({
          chatId: currentChatId,
          chatName: currentChatName,
          message: 'æ”¶åˆ°äº†æ–°æ¶ˆæ¯'
        });
        
        // 5ç§’åè‡ªåŠ¨ç§»é™¤é€šçŸ¥
        setTimeout(() => {
          actions.removeNotification(notifId);
        }, 5000);
      }

    } catch (error) {
      console.error('API error:', error);
      actions.addMessage(currentChatId, {
        type: 'system',
        content: `é”™è¯¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}`
      });
    } finally {
      setIsLoading(false);
      setStreamingText('');
      actions.clearPendingReply(currentChatId);
    }
  };

  // å¼€å§‹å¤„ç†å›å¤
  processReply();
};

      const handleSingleReply = async (character, userMessage) => {
  if (!character) throw new Error('ç¼ºå°‘è§’è‰²');

  // çº¿ä¸‹æ¨¡å¼ï¼šä½¿ç”¨ç¾¤èŠæ ¼å¼ï¼Œè®©AIç”¨ã€è§’è‰²åã€‘æ ¼å¼å›å¤
  let systemPrompt;
  
  if (chat.mode === 'offline') {
    // æ„å»ºç±»ä¼¼ç¾¤èŠçš„æç¤ºè¯
    // åˆå¹¶éšè—çš„æ ¸å¿ƒæç¤ºè¯ + ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯
systemPrompt = HIDDEN_CORE_PROMPT + '\n\n';
if (state.apiSettings.systemPrompt && state.apiSettings.systemPrompt.trim()) {
  systemPrompt += 'ã€ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™ã€‘\n' + state.apiSettings.systemPrompt + '\n\n';
}
    
    systemPrompt += `ã€è§’è‰²è®¾å®šã€‘\n`;
    systemPrompt += `\nã€${character.name}ã€‘\n`;
    systemPrompt += `æ€§åˆ«ï¼š${character.gender === 'male' ? 'ç”·' : character.gender === 'female' ? 'å¥³' : 'å…¶ä»–'}\n`;
    systemPrompt += `å¹´é¾„ï¼š${character.age}å²\n`;
    systemPrompt += `äººè®¾ï¼š${character.persona}\n`;
    
    systemPrompt += `\nã€ç”¨æˆ·ä¿¡æ¯ã€‘\n`;
    systemPrompt += `å§“åï¼š${userPersona.name}\n`;
    systemPrompt += `æ€§åˆ«ï¼š${userPersona.gender === 'male' ? 'ç”·' : userPersona.gender === 'female' ? 'å¥³' : 'å…¶ä»–'}\n`;
    systemPrompt += `å¹´é¾„ï¼š${userPersona.age}å²\n`;
    systemPrompt += `äººè®¾ï¼š${userPersona.persona}\n\n`;

    if (boundWorldBooks.length > 0) {
      systemPrompt += `ã€ä¸–ç•Œä¹¦/è®¾å®šã€‘\n`;
      boundWorldBooks.forEach(entry => {
        systemPrompt += `[${entry.name}]\n${entry.content}\n\n`;
      });
    }

        // ========== æ ¹æ®å¼€å…³åŠ¨æ€æ„å»ºæ ¼å¼æç¤ºè¯ ==========
    const allowNarration = chat.allowNarration !== false;
    const allowThoughts = chat.allowThoughts !== false;
    
    // æ„å»ºæœ€é«˜ä¼˜å…ˆçº§çš„è§„åˆ™ï¼ˆæ”¾åœ¨æç¤ºè¯æœ€å¼€å¤´ï¼‰
    let priorityRules = '';
    
    if (!allowNarration || !allowThoughts) {
      priorityRules = `
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!! ã€æœ€é«˜ä¼˜å…ˆçº§è§„åˆ™ã€‘ !!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
`;
      if (!allowThoughts) {
        priorityRules += `
ğŸš«ğŸš«ğŸš« ç¦æ­¢è¾“å‡ºå¿ƒå£° ğŸš«ğŸš«ğŸš«
- ç»å¯¹ä¸å…è®¸ä½¿ç”¨ *...* æ ¼å¼
- ç»å¯¹ä¸å…è®¸æå†™è§’è‰²å†…å¿ƒæƒ³æ³•
- çœ‹åˆ°æ˜Ÿå· * å°±æ˜¯è¿è§„ï¼
`;
      }
      if (!allowNarration) {
        priorityRules += `
ğŸš«ğŸš«ğŸš« ç¦æ­¢è¾“å‡ºæ—ç™½ ğŸš«ğŸš«ğŸš«
- ç»å¯¹ä¸å…è®¸åœºæ™¯ã€åŠ¨ä½œã€è¡¨æƒ…æå†™
- åªèƒ½è¾“å‡ºå¯¹è¯å†…å®¹
`;
      }
      priorityRules += `
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
`;
    }
    
    // æŠŠä¼˜å…ˆçº§è§„åˆ™æ’å…¥åˆ°ç³»ç»Ÿæç¤ºè¯æœ€å¼€å¤´
    systemPrompt = priorityRules + systemPrompt;
    
    // æ„å»ºè¾“å‡ºæ ¼å¼è¯´æ˜
    let formatGuide = '';
    let formatExample = '';
    let endReminder = ''; // ç»“å°¾å†æ¬¡æé†’
    
    if (allowNarration && allowThoughts) {
      // å…¨éƒ¨å¼€å¯
      formatGuide = `
ã€è¾“å‡ºå†…å®¹ã€‘
â‘  æ—ç™½/åŠ¨ä½œæå†™ - ç›´æ¥ä¹¦å†™
â‘¡ å¯¹è¯ - ä½¿ç”¨"..."åŒ…è£¹
â‘¢ å¿ƒå£° - ä½¿ç”¨*...*åŒ…è£¹`;
      
      formatExample = `
ã€${character.name}ã€‘
ä»–å¬åˆ°å£°éŸ³è½¬è¿‡å¤´æ¥ï¼Œçœ¼ç›äº®äº†èµ·æ¥
"ä½ æ¥äº†ï¼"
*å¤ªå¥½äº†~*`;

    } else if (allowNarration && !allowThoughts) {
      // æ—ç™½å¼€ï¼Œå¿ƒå£°å…³
      formatGuide = `
ã€è¾“å‡ºå†…å®¹ - ä»…é™ä»¥ä¸‹ä¸¤ç§ã€‘
â‘  æ—ç™½/åŠ¨ä½œæå†™ - ç›´æ¥ä¹¦å†™
â‘¡ å¯¹è¯ - ä½¿ç”¨"..."åŒ…è£¹

â›” ä¸è¦ä½¿ç”¨ *...*
â›” ä¸è¦å†™å†…å¿ƒæƒ³æ³•`;
      
      formatExample = `
ã€${character.name}ã€‘
ä»–å¬åˆ°å£°éŸ³è½¬è¿‡å¤´æ¥ï¼Œçœ¼ç›äº®äº†èµ·æ¥
"ä½ æ¥äº†ï¼"
"ç­‰ä½ å¥½ä¹…äº†~"`;
      
      endReminder = `

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â›” å†æ¬¡æé†’ï¼šæœ¬æ¬¡å›å¤ç¦æ­¢ä½¿ç”¨ *...* å¿ƒå£°æ ¼å¼ï¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;

    } else if (!allowNarration && allowThoughts) {
      // æ—ç™½å…³ï¼Œå¿ƒå£°å¼€
      formatGuide = `
ã€è¾“å‡ºå†…å®¹ - ä»…é™ä»¥ä¸‹ä¸¤ç§ã€‘
â‘  å¯¹è¯ - ä½¿ç”¨"..."åŒ…è£¹
â‘¡ å¿ƒå£° - ä½¿ç”¨*...*åŒ…è£¹

â›” ä¸è¦å†™åœºæ™¯æå†™
â›” ä¸è¦å†™åŠ¨ä½œæå†™`;
      
      formatExample = `
ã€${character.name}ã€‘
"ä½ æ¥äº†ï¼"
*å¤ªå¥½äº†~*
"ç­‰ä½ å¥½ä¹…äº†ï¼"`;
      
      endReminder = `

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â›” å†æ¬¡æé†’ï¼šæœ¬æ¬¡å›å¤ç¦æ­¢æ—ç™½å’ŒåŠ¨ä½œæå†™ï¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;

    } else {
      // å…¨éƒ¨å…³é—­
      formatGuide = `
ã€è¾“å‡ºå†…å®¹ - ä»…é™å¯¹è¯ã€‘
åªè¾“å‡ºå¯¹è¯ï¼Œä½¿ç”¨"..."åŒ…è£¹

â›” ä¸è¦ä½¿ç”¨ *...*
â›” ä¸è¦å†™æ—ç™½æå†™`;
      
      formatExample = `
ã€${character.name}ã€‘
"ä½ æ¥äº†ï¼"
"ç­‰ä½ å¥½ä¹…äº†~"
"ä»Šå¤©æ€ä¹ˆæ ·ï¼Ÿ"`;
      
      endReminder = `

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â›” å†æ¬¡æé†’ï¼šæœ¬æ¬¡å›å¤åªèƒ½æœ‰å¯¹è¯ï¼Œç¦æ­¢æ—ç™½å’Œ *...* ï¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;
    }

    systemPrompt += `
ã€é‡è¦ï¼šè¾“å‡ºæ ¼å¼è§„åˆ™ã€‘
1. æ¯ä¸ªè§’è‰²ç”¨ã€è§’è‰²åã€‘å¼€å¤´
2. ä¸»è§’è‰²æ˜¯ã€${character.name}ã€‘
3. é…è§’ç”¨ã€åå­—ã€‘æ ‡è®°

${formatGuide}

ã€æ ¼å¼ç¤ºä¾‹ã€‘
${formatExample}
${endReminder}`;

  } else {
    // çº¿ä¸Šæ¨¡å¼ï¼šçº¯å¯¹è¯æ¨¡å¼ï¼ˆæ¨¡æ‹Ÿå¾®ä¿¡èŠå¤©ï¼‰
    systemPrompt = HIDDEN_CORE_PROMPT + '\n\n';
    
    if (state.apiSettings.systemPrompt && state.apiSettings.systemPrompt.trim()) {
      systemPrompt += 'ã€ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™ã€‘\n' + state.apiSettings.systemPrompt + '\n\n';
    }
    
    systemPrompt += `ã€è§’è‰²è®¾å®šã€‘
å§“åï¼š${character.name}
æ€§åˆ«ï¼š${character.gender === 'male' ? 'ç”·' : character.gender === 'female' ? 'å¥³' : 'å…¶ä»–'}
å¹´é¾„ï¼š${character.age}å²
äººè®¾ï¼š${character.persona}

ã€ç”¨æˆ·ä¿¡æ¯ã€‘
å§“åï¼š${userPersona.name}
æ€§åˆ«ï¼š${userPersona.gender === 'male' ? 'ç”·' : userPersona.gender === 'female' ? 'å¥³' : 'å…¶ä»–'}
å¹´é¾„ï¼š${userPersona.age}å²
äººè®¾ï¼š${userPersona.persona}

`;

    if (boundWorldBooks.length > 0) {
      systemPrompt += `ã€ä¸–ç•Œä¹¦/è®¾å®šã€‘\n`;
      boundWorldBooks.forEach(entry => {
        systemPrompt += `[${entry.name}]\n${entry.content}\n\n`;
      });
    }

    // çº¿ä¸Šæ¨¡å¼ = çº¯å¯¹è¯ï¼Œç¦æ­¢æ—ç™½å’Œå¿ƒå£°
    systemPrompt += `
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!! ã€çº¿ä¸ŠèŠå¤©æ¨¡å¼ã€‘ !!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

è¿™æ˜¯çº¿ä¸Šç§ä¿¡æ¨¡å¼ï¼Œæ¨¡æ‹ŸçœŸå®çš„å¾®ä¿¡/QQèŠå¤©ã€‚
ä½ è¦åƒçœŸäººå‘æ¶ˆæ¯ä¸€æ ·å›å¤ï¼Œä¸æ˜¯å†™å°è¯´ã€‚

ğŸš« ç»å¯¹ç¦æ­¢ï¼š
- æ—ç™½ã€åœºæ™¯æå†™ã€åŠ¨ä½œæå†™
- ç¬¬ä¸‰äººç§°å™è¿°ï¼ˆä»–/å¥¹æ€æ ·æ€æ ·ï¼‰
- å¿ƒå£°æ ¼å¼ *...*

âœ… åªèƒ½è¾“å‡ºï¼š
- è§’è‰²å‘é€çš„èŠå¤©æ¶ˆæ¯
- å¯ä»¥ç”¨emojiã€è¯­æ°”è¯

ã€æ­£ç¡®ç¤ºä¾‹ã€‘
å˜¿~
åœ¨å¹²å˜›å‘¢ï¼Ÿ
ä»Šå¤©å¥½ç´¯å•ŠğŸ˜®â€ğŸ’¨
å“ˆå“ˆå“ˆå“ˆç¬‘æ­»æˆ‘äº†
æ™šå®‰ğŸ’¤

ã€é”™è¯¯ç¤ºä¾‹ã€‘
ä»–çœ‹ç€æ‰‹æœº â† ç¦æ­¢ï¼
*å¿ƒé‡Œå¼€å¿ƒ* â† ç¦æ­¢ï¼
å¥¹å¾®å¾®ä¸€ç¬‘ â† ç¦æ­¢ï¼

è®°ä½ï¼šä½ åœ¨å‘å¾®ä¿¡æ¶ˆæ¯ï¼Œä¸æ˜¯å†™å°è¯´ï¼
`;
  }

  const updatedChat = store.getState().chats.find(c => c.id === chat.id);
  const chatMessages = buildChatMessages(systemPrompt, updatedChat?.messages || [], state.characters);

  // çº¿ä¸‹æ¨¡å¼ï¼šè¾¹ç”Ÿæˆè¾¹å‘é€
  if (chat.mode === 'offline') {
    let sentBlocks = []; // å·²å‘é€çš„æ¶ˆæ¯å—
    let lastProcessedLength = 0;
    let currentBuffer = '';
    let currentRoleName = character.name;
    
    const response = await callChatCompletion(
      state.apiSettings,
      chatMessages,
      (fullText) => {
        // æ£€æµ‹æ‰€æœ‰ã€è§’è‰²åã€‘æ ‡ç­¾
        const tagRegex = /ã€([^ã€‘]+)ã€‘/g;
        const tags = [];
        let match;
        
        while ((match = tagRegex.exec(fullText)) !== null) {
          tags.push({ 
            name: match[1].trim(), 
            index: match.index, 
            endIndex: tagRegex.lastIndex 
          });
        }
        
        // å¦‚æœæœ‰å¤šä¸ªæ ‡ç­¾ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„å®Œæ•´æ®µè½å¯ä»¥å‘é€
        if (tags.length >= 2) {
          // éå†æ‰€æœ‰æ ‡ç­¾ï¼Œæ‰¾å‡ºè¿˜æ²¡å‘é€çš„å®Œæ•´æ®µè½
          for (let i = 0; i < tags.length - 1; i++) {
            const currentTag = tags[i];
            const nextTag = tags[i + 1];
            
            // è¿™ä¸ªæ®µè½çš„å†…å®¹
            const blockContent = fullText.slice(currentTag.endIndex, nextTag.index).trim();
            const blockKey = `${currentTag.name}:${currentTag.index}`;
            
            // å¦‚æœè¿™ä¸ªå—è¿˜æ²¡å‘é€è¿‡ï¼Œä¸”æœ‰å†…å®¹
            if (blockContent && !sentBlocks.includes(blockKey)) {
              sentBlocks.push(blockKey);
              
              const isMainCharacter = currentTag.name === character.name;
              
              // ç«‹å³å‘é€è¿™æ¡æ¶ˆæ¯ï¼
              if (isMainCharacter) {
                actions.addMessage(chat.id, {
                  type: 'character',
                  characterId: character.id,
                  content: blockContent
                });
              } else {
                actions.addMessage(chat.id, {
                  type: 'character',
                  characterId: character.id,
                  content: blockContent,
                  npcName: currentTag.name,
                  isNPC: true
                });
              }
              
              console.log(`âœ… å®æ—¶å‘é€: [${currentTag.name}] ${blockContent.slice(0, 30)}...`);
            }
          }
        }
        
        // æ˜¾ç¤ºæ­£åœ¨ç”Ÿæˆçš„éƒ¨åˆ†ï¼ˆæœ€åä¸€ä¸ªæ ‡ç­¾ä¹‹åçš„å†…å®¹ï¼‰
        if (tags.length > 0) {
          const lastTag = tags[tags.length - 1];
          const streamingPart = fullText.slice(lastTag.index);
          setStreamingText(streamingPart);
        } else {
          setStreamingText(fullText);
        }
      }
    );
    
    // ç”Ÿæˆå®Œæ¯•åï¼Œå¤„ç†æœ€åä¸€ä¸ªæ®µè½
    setStreamingText('');
    
    try {
      const tagRegex = /ã€([^ã€‘]+)ã€‘/g;
      const tags = [];
      let match;
      
      while ((match = tagRegex.exec(response)) !== null) {
        tags.push({ 
          name: match[1].trim(), 
          index: match.index, 
          endIndex: tagRegex.lastIndex 
        });
      }
      
      // å‘é€æœ€åä¸€ä¸ªæ®µè½ï¼ˆå¦‚æœæœ‰ï¼‰
      if (tags.length > 0) {
        const lastTag = tags[tags.length - 1];
        const lastContent = response.slice(lastTag.endIndex).trim();
        const lastBlockKey = `${lastTag.name}:${lastTag.index}`;
        
        if (lastContent && !sentBlocks.includes(lastBlockKey)) {
          const isMainCharacter = lastTag.name === character.name;
          
          if (isMainCharacter) {
            actions.addMessage(chat.id, {
              type: 'character',
              characterId: character.id,
              content: lastContent
            });
          } else {
            actions.addMessage(chat.id, {
              type: 'character',
              characterId: character.id,
              content: lastContent,
              npcName: lastTag.name,
              isNPC: true
            });
          }
        }
      } else if (response.trim() && sentBlocks.length === 0) {
        // æ²¡æœ‰ä»»ä½•æ ‡ç­¾ï¼Œæ•´ä½“ä½œä¸ºä¸»è§’è‰²æ¶ˆæ¯
        actions.addMessage(chat.id, {
          type: 'character',
          characterId: character.id,
          content: response.trim()
        });
      }
      
    } catch (parseError) {
      console.error('è§£ææœ€åä¸€æ®µå‡ºé”™:', parseError);
      if (sentBlocks.length === 0) {
        actions.addMessage(chat.id, {
          type: 'character',
          characterId: character.id,
          content: response || '(å›å¤è§£æå¤±è´¥)'
        });
      }
    }
    
    return; // æå‰è¿”å›ï¼Œä¸æ‰§è¡Œä¸‹é¢çš„çº¿ä¸Šæ¨¡å¼é€»è¾‘
  }
  
  // ========== çº¿ä¸Šæ¨¡å¼ ==========
  const response = await callChatCompletion(
    state.apiSettings,
    chatMessages,
    (text) => setStreamingText(text)
  );
  
  setStreamingText('');
  
  // çº¿ä¸Šæ¨¡å¼ï¼šç›´æ¥æ·»åŠ 
  actions.addMessage(chat.id, {
    type: 'character',
    characterId: character.id,
    content: response
  });
};

// è§£æç§èŠå›å¤ï¼ˆæ”¯æŒã€è§’è‰²åã€‘æ ¼å¼ï¼‰
const parsePrivateReplies = (text, mainCharacter) => {
  const replies = [];
  const regex = /ã€([^ã€‘]+)ã€‘([\s\S]*?)(?=ã€[^ã€‘]+ã€‘|$)/g;
  let match;
  
  while ((match = regex.exec(text)) !== null) {
    const name = match[1].trim();
    const content = match[2].trim();
    if (content) {
      replies.push({ 
        name, 
        content,
        isNPC: name !== mainCharacter.name
      });
    }
  }
  
  // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ã€ã€‘æ ¼å¼ï¼Œè¯´æ˜AIæ²¡æŒ‰æ ¼å¼å›å¤ï¼Œå½“ä½œä¸»è§’è‰²æ¶ˆæ¯
  if (replies.length === 0 && text.trim()) {
    replies.push({ 
      name: mainCharacter.name, 
      content: text.trim(),
      isNPC: false
    });
  }
  
  return replies;
};

      const handleGroupReply = async (userMessage) => {
        // åˆå¹¶éšè—çš„æ ¸å¿ƒæç¤ºè¯ + ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯
let groupSystemPrompt = HIDDEN_CORE_PROMPT + '\n\n';
if (state.apiSettings.systemPrompt && state.apiSettings.systemPrompt.trim()) {
  groupSystemPrompt += 'ã€ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™ã€‘\n' + state.apiSettings.systemPrompt + '\n\n';
}
        
        groupSystemPrompt += `ã€ç¾¤èŠè§’è‰²è®¾å®šã€‘\n`;
        chatCharacters.forEach(char => {
          groupSystemPrompt += `\nã€${char.name}ã€‘\n`;
          groupSystemPrompt += `æ€§åˆ«ï¼š${char.gender === 'male' ? 'ç”·' : char.gender === 'female' ? 'å¥³' : 'å…¶ä»–'}\n`;
          groupSystemPrompt += `å¹´é¾„ï¼š${char.age}å²\n`;
          groupSystemPrompt += `äººè®¾ï¼š${char.persona}\n`;
        });
        
        groupSystemPrompt += `\nã€ç”¨æˆ·ä¿¡æ¯ã€‘\n`;
        groupSystemPrompt += `å§“åï¼š${userPersona.name}\n`;
        groupSystemPrompt += `æ€§åˆ«ï¼š${userPersona.gender === 'male' ? 'ç”·' : userPersona.gender === 'female' ? 'å¥³' : 'å…¶ä»–'}\n`;
        groupSystemPrompt += `å¹´é¾„ï¼š${userPersona.age}å²\n`;
        groupSystemPrompt += `äººè®¾ï¼š${userPersona.persona}\n\n`;

        if (boundWorldBooks.length > 0) {
          groupSystemPrompt += `ã€ä¸–ç•Œä¹¦/è®¾å®šã€‘\n`;
          boundWorldBooks.forEach(entry => {
            groupSystemPrompt += `[${entry.name}]\n${entry.content}\n\n`;
          });
        }

        if (chat.mode === 'online') {
          groupSystemPrompt += `ã€é‡è¦ï¼šçº¿ä¸Šç¾¤èŠæ¨¡å¼è§„åˆ™ã€‘
è¿™æ˜¯çº¿ä¸Šç¾¤èŠï¼Œæ¨¡æ‹ŸçœŸå®å¾®ä¿¡/QQç¾¤èŠï¼š
1. è§’è‰²ä¹‹é—´å¯ä»¥äº’ç›¸å›å¤ã€äº’åŠ¨ã€åµæ¶ã€è°ƒä¾ƒ
2. æ¯ä¸ªè§’è‰²çš„å›å¤ç”¨ã€è§’è‰²åã€‘å¼€å¤´ï¼Œç„¶åç›´æ¥è¯´è¯
3. ä¸éœ€è¦å¼•å·""ï¼Œä¸éœ€è¦ä»»ä½•æå†™ï¼Œåªéœ€è¦çº¯å¯¹è¯
4. å¯ä»¥æœ‰å¤šè½®äº’åŠ¨ï¼Œè§’è‰²Aè¯´å®Œè§’è‰²Bå¯ä»¥æ¥è¯ã€åé©³ã€é™„å’Œ
5. æ¯ä¸ªè§’è‰²çš„æ€§æ ¼è¦é²œæ˜ï¼Œå¯¹è¯é£æ ¼è¦ä¸åŒ
6. å¯ä»¥æœ‰3-6æ¡ç”šè‡³æ›´å¤šå›å¤ï¼Œè®©å¯¹è¯è‡ªç„¶æµåŠ¨
7. ä¸æ˜¯æ¯æ¡éƒ½è¦ç”¨æˆ·å‚ä¸ï¼Œè§’è‰²ä¹‹é—´å¯ä»¥è‡ªå·±èŠèµ·æ¥

æ ¼å¼ç¤ºä¾‹ï¼š
ã€å´½å´½ã€‘éº»éº»ä½ å›æ¥å•¦ï¼
ã€çˆ¸çˆ¸ã€‘åˆæ’’å¨‡
ã€å´½å´½ã€‘æ‰æ²¡æœ‰ï¼çˆ¸çˆ¸ä½ æœ€çƒ¦äº†\n\n`;
        } else {
          const allowNarration = chat.allowNarration !== false;
          const allowThoughts = chat.allowThoughts !== false;
          
          groupSystemPrompt += `ã€é‡è¦ï¼šè¾“å‡ºæ ¼å¼è§„åˆ™ã€‘
è¿™æ˜¯çº¿ä¸‹/å‰§æœ¬æ¨¡å¼çš„ç¾¤èŠï¼Œä½ éœ€è¦ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

1. æ¯ä¸ªè§’è‰²çš„å†…å®¹å¿…é¡»ç”¨ã€è§’è‰²åã€‘å¼€å¤´
2. ä¸€ä¸ªã€è§’è‰²åã€‘æ ‡ç­¾åé¢æ˜¯è¯¥è§’è‰²çš„å®Œæ•´å†…å®¹ï¼ˆæ—ç™½+å¯¹è¯+å¿ƒå£°éƒ½å±äºè¿™ä¸ªè§’è‰²ï¼‰
3. åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè§’è‰²æ—¶ï¼Œå¿…é¡»æ–°èµ·ä¸€ä¸ªã€è§’è‰²åã€‘æ ‡ç­¾
4. é…è§’/NPCä¹Ÿç”¨ã€åå­—ã€‘æ ¼å¼

ã€æ­£ç¡®æ ¼å¼ç¤ºä¾‹ã€‘
ã€å´½å´½ã€‘
å°å®¶ä¼™æ‰‘è¿‡æ¥æŠ±ä½éº»éº»çš„è…¿ï¼Œçœ¼ç›äº®æ™¶æ™¶çš„ã€‚
"éº»éº»ï¼ä½ å›æ¥å•¦ï¼"
*ç»ˆäºç­‰åˆ°éº»éº»äº†ï¼Œå¥½å¼€å¿ƒï¼*

ã€çˆ¸çˆ¸ã€‘
ç”·äººæŒ‘äº†æŒ‘çœ‰ï¼Œå˜´è§’å¸¦ç€ä¸€ä¸ç¬‘æ„ã€‚
"åˆæ’’å¨‡ã€‚"

ã€å´½å´½ã€‘
ä»–é¼“èµ·å°è„¸ï¼Œæ°”å‘¼å‘¼åœ°çªç€çˆ¸çˆ¸ã€‚
"æ‰æ²¡æœ‰ï¼çˆ¸çˆ¸æœ€çƒ¦äº†ï¼"
*å“¼ï¼Œçˆ¸çˆ¸æ€»æ˜¯è¿™æ ·ï¼*`;

          if (allowNarration && allowThoughts) {
            groupSystemPrompt += `
3. å¯ä»¥åŒ…å«å¯¹è¯"..."ã€å¿ƒå£°*...*ã€åŠ¨ä½œå’Œåœºæ™¯æå†™`;
          } else if (allowNarration) {
            groupSystemPrompt += `
3. å¯ä»¥åŒ…å«å¯¹è¯"..."å’ŒåŠ¨ä½œåœºæ™¯æå†™ï¼Œç¦æ­¢å¿ƒå£°*...*`;
          } else if (allowThoughts) {
            groupSystemPrompt += `
3. å¯ä»¥åŒ…å«å¯¹è¯"..."å’Œå¿ƒå£°*...*ï¼Œå‡å°‘æ—ç™½`;
          } else {
            groupSystemPrompt += `
3. åªåŒ…å«å¯¹è¯"..."ï¼Œç¦æ­¢æ—ç™½å’Œå¿ƒå£°`;
          }

          groupSystemPrompt += `
4. å¯ä»¥æœ‰3-6æ¡ç”šè‡³æ›´å¤šå›å¤
5. ç»™ç”¨æˆ·ç•™æœ‰äº’åŠ¨ç©ºé—´
6. å‰§æƒ…ä¸­çš„ä¸´æ—¶NPCç”¨ ã€NPC:åå­—ã€‘ æ ¼å¼

æ ¼å¼ç¤ºä¾‹ï¼š
ã€å´½å´½ã€‘å°å›¢å­æ‰‘è¿‡æ¥æŠ±ä½éº»éº»çš„è…¿ã€‚"éº»éº»ï¼æƒ³ä½ äº†ï¼"
ã€çˆ¸çˆ¸ã€‘ç”·äººæŒ‘äº†æŒ‘çœ‰ã€‚"åˆæ’’å¨‡ã€‚"
ã€NPC:é‚»å±…é˜¿å§¨ã€‘"å“å‘€ï¼Œä½ ä»¬ä¸€å®¶äººçœŸå¹¸ç¦~"\n\n`;
        }

        const updatedChat = store.getState().chats.find(c => c.id === chat.id);
        const chatMessages = buildChatMessages(groupSystemPrompt, updatedChat?.messages || [], state.characters);

        const response = await callChatCompletion(
          state.apiSettings,
          chatMessages,
          (text) => setStreamingText(text)
        );

        const replies = parseGroupReplies(response);
        
        setStreamingText('');
        
        for (const reply of replies) {
          const char = chatCharacters.find(c => c.name === reply.name);
          if (char) {
            actions.addMessage(chat.id, {
              type: 'character',
              characterId: char.id,
              content: reply.content
            });
            await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 400));
          } else if (reply.content.trim()) {
            actions.addMessage(chat.id, {
              type: 'character',
              characterId: chatCharacters[0].id,
              content: reply.content
            });
          }
        }
      };

      const parseGroupReplies = (text) => {
        const replies = [];
        const regex = /ã€([^ã€‘]+)ã€‘([\s\S]*?)(?=ã€[^ã€‘]+ã€‘|$)/g;
        let match;
        
        while ((match = regex.exec(text)) !== null) {
          const name = match[1].trim();
          const content = match[2].trim();
          if (content) {
            replies.push({ name, content });
          }
        }
        
        if (replies.length === 0 && text.trim()) {
          replies.push({ name: '', content: text.trim() });
        }
        
        return replies;
      };

      const handleDeleteChat = () => {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèŠå¤©å—ï¼Ÿ')) {
          actions.deleteChat(chat.id);
          actions.setCurrentChat(null);
        }
      };

      const formatTime = (timestamp) => {
        const date = new Date(timestamp);
        const now = new Date();
        const isToday = date.toDateString() === now.toDateString();
        
        if (isToday) {
          return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }
        return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' }) + ' ' + 
               date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      };
      
      // æ¸²æŸ“å¸¦æŒ‚ä»¶çš„å¤´åƒ
      const renderAvatarWithFrame = (avatarUrl, avatarFrame, fallbackText, colorClass) => {
        const hasFrame = !!avatarFrame;
        return (
          <div className="relative flex-shrink-0 w-14 h-14">
            {/* å¤´åƒï¼šæœ‰æŒ‚ä»¶æ—¶ç¼©å°ï¼Œæ— æŒ‚ä»¶æ—¶æ­£å¸¸å¤§å° */}
            <div className={`absolute rounded-full ${colorClass} ${
              hasFrame 
                ? 'w-8 h-8 top-1/2 left-1/2 -translate-x-1/2 -translate-y-[65%]'  /* å¤´åƒä½ç½® */
                : 'w-10 h-10 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2'
            }`}>
              {avatarUrl ? (
                <img src={avatarUrl} alt="" className="w-full h-full object-cover rounded-full" />
              ) : (
                <div className="w-full h-full flex items-center justify-center text-white font-bold text-xs">
                  {fallbackText || '?'}
                </div>
              )}
            </div>
            {/* æŒ‚ä»¶ï¼šå¾€ä¸Šç§»åŠ¨ï¼Œè®©å¤´åƒè½åœ¨æŒ‚ä»¶åœ†æ¡†å†… */}
            {hasFrame && (
              <img 
                src={avatarFrame} 
                alt="" 
                className="absolute left-0 w-14 h-14 object-contain pointer-events-none z-10"
                style={{ top: '-13px' }}  /* æŒ‚ä»¶å¾€ä¸Šç§»åŠ¨ï¼Œå¯è°ƒæ•´è¿™ä¸ªå€¼ */
              />
            )}
          </div>
        );
      };
      
      // è§£ææ¶ˆæ¯å†…å®¹ï¼Œåˆ†ç¦»å¯¹è¯ã€æ—ç™½ã€å¿ƒå£°ã€NPC
const parseMessageContent = (content) => {
  const parts = [];
  
  // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰ã€è§’è‰²åã€‘æ ¼å¼
  const hasRoleMarker = /ã€[^ã€‘]+ã€‘/.test(content);
  
  if (!hasRoleMarker) {
    // æ²¡æœ‰è§’è‰²æ ‡è®°ï¼Œå°è¯•ä»å†…å®¹ä¸­è¯†åˆ«NPC
    // æ£€æŸ¥æ˜¯å¦æœ‰"xxxè¯´/é“"+"å¯¹è¯"çš„æ¨¡å¼
    const speakerPattern = /([^ï¼Œã€‚ï¼ï¼Ÿ\n]+(?:è¯´|é“|å–Š|å«|é—®|ç­”|ç¬‘ç€è¯´|ä½å£°è¯´|å¤§å£°è¯´))\s*[""]([^""]+)[""]/g;
    let speakerMatch;
    let lastEnd = 0;
    const segments = [];
    
    while ((speakerMatch = speakerPattern.exec(content)) !== null) {
      // æå–è¯´è¯è€…åå­—
      const speakerText = speakerMatch[1];
      // å°è¯•ä»"xxxè¯´"ä¸­æå–åå­—
      const nameMatch = speakerText.match(/([^\sï¼Œã€‚ã€]+?)(?:è¯´|é“|å–Š|å«|é—®|ç­”|ç¬‘ç€è¯´|ä½å£°è¯´|å¤§å£°è¯´)$/);
      
      if (nameMatch) {
        // æ‰¾åˆ°äº†è¯´è¯è€…
        if (speakerMatch.index > lastEnd) {
          // å‰é¢çš„éƒ¨åˆ†ä½œä¸ºæ—ç™½
          segments.push({ 
            type: 'narration', 
            content: content.slice(lastEnd, speakerMatch.index).trim() 
          });
        }
        
        // è¿™ä¸ªäººè¯´çš„è¯
        segments.push({
          type: 'speaker_dialogue',
          speaker: nameMatch[1],
          dialogue: speakerMatch[2]
        });
        
        lastEnd = speakerPattern.lastIndex;
      }
    }
    
    if (segments.length > 0) {
      // å¦‚æœè¯†åˆ«åˆ°äº†è¯´è¯è€…ï¼Œä½¿ç”¨è¯†åˆ«ç»“æœ
      if (lastEnd < content.length) {
        segments.push({ 
          type: 'narration', 
          content: content.slice(lastEnd).trim() 
        });
      }
      
      // è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
      segments.forEach(seg => {
        if (seg.type === 'speaker_dialogue') {
          // åˆ›å»ºä¸€ä¸ªå†…åµŒçš„NPC
          parts.push({
            type: 'npc',
            name: seg.speaker,
            parts: [{ type: 'dialogue', content: `"${seg.dialogue}"` }]
          });
        } else if (seg.type === 'narration' && seg.content) {
          const parsed = parseDialogueAndNarration(seg.content);
          parts.push(...parsed);
        }
      });
      
      return parts;
    }
    
    // æ²¡æœ‰è¯†åˆ«åˆ°ç‰¹æ®Šæ ¼å¼ï¼Œä½¿ç”¨æ™®é€šè§£æ
    return parseDialogueAndNarration(content);
  }
  
  // æœ‰ã€è§’è‰²åã€‘æ ¼å¼ï¼Œä½¿ç”¨åŸæ¥çš„è§£æé€»è¾‘
  // å…ˆæå–NPCå¯¹è¯
  const npcRegex = /\[NPC[ï¼š:]\s*([^\]]+)\]\s*([^\[]*?)(?=\[NPC[ï¼š:]|$)/g;
  let npcMatch;
  let lastNpcEnd = 0;
  const segments = [];
  
  while ((npcMatch = npcRegex.exec(content)) !== null) {
    if (npcMatch.index > lastNpcEnd) {
      segments.push({ type: 'mixed', content: content.slice(lastNpcEnd, npcMatch.index) });
    }
    segments.push({ type: 'npc', name: npcMatch[1].trim(), content: npcMatch[2].trim() });
    lastNpcEnd = npcRegex.lastIndex;
  }
  
  if (lastNpcEnd < content.length) {
    segments.push({ type: 'mixed', content: content.slice(lastNpcEnd) });
  }
  
  if (segments.length === 0) {
    segments.push({ type: 'mixed', content: content });
  }
  
  // å¤„ç†æ¯ä¸ªsegment
  segments.forEach(seg => {
    if (seg.type === 'npc') {
      const npcParts = parseDialogueAndNarration(seg.content);
      parts.push({ type: 'npc', name: seg.name, parts: npcParts });
    } else {
      const mixedParts = parseDialogueAndNarration(seg.content);
      parts.push(...mixedParts);
    }
  });
  
  return parts;
};
      
      // è§£æå¯¹è¯ã€å¿ƒå£°å’Œæ—ç™½
const parseDialogueAndNarration = (text) => {
  const parts = [];
  if (!text || !text.trim()) return parts;
  
  const regex = /("([^"]+)"|"([^"]+)"|ã€Œ([^ã€]+)ã€|\*([^*]+)\*)/g;
  let lastIndex = 0;
  let match;
  
  while ((match = regex.exec(text)) !== null) {
    const beforeText = text.slice(lastIndex, match.index).trim();
    
    if (match[0].startsWith('*')) {
      // å¿ƒå£°
      if (beforeText) {
        parts.push({ type: 'narration', content: cleanNarration(beforeText) });
      }
      parts.push({ type: 'thought', content: match[5] });
    } else {
      // å¼•å·å†…å®¹
      const quotedContent = match[2] || match[3] || match[4] || '';
      
      // è·å–å¼•å·åé¢çš„å†…å®¹
      const afterText = text.slice(regex.lastIndex).trim();
      
      // åˆ¤æ–­æ˜¯å¦æ˜¯çœŸæ­£çš„å¯¹è¯
      const result = checkIsDialogue(quotedContent, beforeText, afterText);
      const isRealDialogue = result.isDialogue;
      
      if (isRealDialogue) {
        if (beforeText) {
          parts.push({ type: 'narration', content: cleanNarration(beforeText) });
        }
        parts.push({ type: 'dialogue', content: match[0] });
      } else {
        // çŸ­å¼•å·å†…å®¹åˆå¹¶åˆ°æ—ç™½
        const combined = beforeText + match[0];
        parts.push({ type: 'narration', content: combined });
      }
    }
    
    lastIndex = regex.lastIndex;
  }
  
  if (lastIndex < text.length) {
    const remaining = text.slice(lastIndex).trim();
    if (remaining) {
      parts.push({ type: 'narration', content: cleanNarration(remaining) });
    }
  }
  
  // åˆå¹¶è¿ç»­çš„æ—ç™½
  const merged = [];
  for (const part of parts) {
    if (part.type === 'narration' && merged.length > 0 && merged[merged.length - 1].type === 'narration') {
      merged[merged.length - 1].content += ' ' + part.content;
    } else if (part.content) {
      merged.push(part);
    }
  }
  
  return merged;
};

// åˆ¤æ–­å¼•å·å†…å®¹æ˜¯å¦æ˜¯çœŸæ­£çš„å¯¹è¯
// åˆ¤æ–­å¼•å·å†…å®¹æ˜¯å¦æ˜¯çœŸæ­£çš„å¯¹è¯ï¼Œä»¥åŠå¯èƒ½çš„è¯´è¯è€…
const checkIsDialogue = (content, beforeText, afterText = '') => {
  const cleanContent = content.replace(/\.{2,}|â€¦+|ã€‚{2,}/g, '');
  
  // 1. å¸¸è§å›åº”è¯/è¯­æ°”è¯ -> ä¸€å®šæ˜¯å¯¹è¯
  if (/^[å—¯å•Šå“¦å‘ƒå””å“¼å˜¿è¯¶][\?ï¼Ÿ!ï¼~ï½ã€‚]*$/.test(content)) return { isDialogue: true };
  if (/^(å¥½|è¡Œ|æ˜¯|å¯¹|ä¸|æ²¡|èµ°|æ¥|å»|æ»š|å—¯å“¼|å¥½çš„|å¥½å§|æ˜¯çš„|ä¸è¦|ä¸è¡Œ|çŸ¥é“äº†?)[\?ï¼Ÿ!ï¼~ï½ã€‚]*$/.test(content)) return { isDialogue: true };
  
  // 2. å‰é¢æœ‰è¯´è¯åŠ¨è¯
  if (/[è¯´é“å–Šå«é—®ç­”åš·å˜Ÿå›”å¿µå¨å“¼å”±]ç€?[""]?$/.test(beforeText)) return { isDialogue: true };
  if (/å«ç³Š|ä½å£°|è½»å£°|å†·å†·|æ·¡æ·¡/.test(beforeText)) return { isDialogue: true };
  
  // 3. åµŒåœ¨å¥å­ä¸­é—´çš„çŸ­å†…å®¹ -> æ—ç™½å¼•ç”¨
  // åˆ¤æ–­ï¼šåé¢è¿˜æœ‰ä¸­æ–‡å­—ç¬¦ï¼ˆä¸æ˜¯æ ‡ç‚¹ç»“å°¾ï¼‰
  const isEmbedded = afterText && /^[^""\*\n]*[\u4e00-\u9fa5]/.test(afterText);
  if (isEmbedded && cleanContent.length <= 5 && !/[ï¼ï¼Ÿ!?~ï½å‘€å•Šå‘¢å§å“¦å˜›]/.test(content)) {
    return { isDialogue: false };
  }
  
  // 4. å†…å®¹åŒ…å«çœç•¥å·ä¸”æœ‰å®é™…å†…å®¹
  if (/\.{2,}|â€¦/.test(content) && cleanContent.length >= 2) return { isDialogue: true };
  
  // 5. åŒ…å«è¯­æ°”è¯/æ ‡ç‚¹
  if (/[ï¼ï¼Ÿ!?~ï½å‘€å•Šå‘¢å§å“¦å˜›å‘å“’]/.test(content)) return { isDialogue: true };
  
  // 6. åŒ…å«ç§°å‘¼
  if (/éº»éº»|å¦ˆå¦ˆ|çˆ¸çˆ¸|ç²‘ç²‘|å“¥å“¥|å§å§|å®è´|å°è´¢è¿·/.test(content)) return { isDialogue: true };
  
  // 7. å†…å®¹>=6å­—ï¼Œå¤§æ¦‚ç‡æ˜¯å¯¹è¯
  if (cleanContent.length >= 6) return { isDialogue: true };
  
  // 8. çŸ­å†…å®¹ï¼ˆ<=4å­—ï¼‰ä¸”åé¢è¿˜æœ‰å†…å®¹ -> å¯èƒ½æ˜¯å¼•ç”¨
  if (cleanContent.length <= 4 && afterText.length > 0) return { isDialogue: false };
  
  // 9. å†…å®¹>=4å­—
  if (cleanContent.length >= 4) return { isDialogue: true };
  
  return { isDialogue: false };
};

// æ¸…ç†æ—ç™½æ–‡æœ¬
const cleanNarration = (text) => {
  return text
    .replace(/[,ï¼Œ]\s*$/, '')
    .replace(/[:ï¼š]\s*$/, '')
    .replace(/è¯´é“\s*$/, '')
    .replace(/è¯´\s*$/, '')
    .replace(/é“\s*$/, '')
    .trim();
};

      const renderMessage = (msg, index, prevMsg) => {
        const char = state.characters.find(c => c.id === msg.characterId);
        const showTime = !prevMsg || (msg.timestamp - prevMsg.timestamp > 300000);
        const isSelected = selectedMsgs.includes(msg.id);

        if (msg.type === 'system') {
          return (
            <div key={msg.id} className="text-center py-2">
              <span className="text-xs text-gray-500 bg-gray-200/50 px-3 py-1 rounded-full">
                {msg.content}
              </span>
            </div>
          );
        }
        
        // åˆ†äº«çš„å¸–å­æ¶ˆæ¯
if (msg.type === 'shared_post' && msg.sharedPost) {
  const post = msg.sharedPost;
  
  return (
    <React.Fragment key={msg.id}>
      {showTime && (
        <div className="text-center py-2">
          <span className="text-xs text-gray-400">{formatTime(msg.timestamp)}</span>
        </div>
      )}
      
      <div className={`flex gap-2 px-3 py-1 flex-row-reverse relative ${isSelected ? 'bg-blue-100' : ''}`}>
        {/* é•¿æŒ‰èœå• - æ˜¾ç¤ºåœ¨æ¶ˆæ¯ä¸Šæ–¹ */}
        {showMsgMenu === msg.id && (
          <div className="absolute right-3 -top-10 z-50 animate-fade-in">
            <div className="bg-gray-800 rounded-xl flex overflow-hidden shadow-lg">
              <button
                onClick={() => {
                  navigator.clipboard?.writeText(msg.sharedPost?.content || msg.content);
                  setShowMsgMenu(null);
                }}
                className="px-3 py-2 text-white text-sm flex items-center gap-1 hover:bg-gray-700"
              >
                <Icon name="Copy" size={14} />
                å¤åˆ¶
              </button>
              <div className="w-px bg-gray-600" />
              <button
                onClick={() => handleDeleteSingle(msg.id)}
                className="px-3 py-2 text-white text-sm flex items-center gap-1 hover:bg-gray-700"
              >
                <Icon name="Trash2" size={14} />
                åˆ é™¤
              </button>
              <div className="w-px bg-gray-600" />
              <button
                onClick={() => handleEnterSelectMode(msg.id)}
                className="px-3 py-2 text-white text-sm flex items-center gap-1 hover:bg-gray-700"
              >
                <Icon name="CheckSquare" size={14} />
                å¤šé€‰
              </button>
              <div className="w-px bg-gray-600" />
              <button
                onClick={() => setShowMsgMenu(null)}
                className="px-3 py-2 text-gray-400 text-sm hover:bg-gray-700"
              >
                âœ•
              </button>
            </div>
          </div>
        )}
        
        {selectMode && (
          <div className="flex items-center">
            <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${isSelected ? 'bg-green-500 border-green-500' : 'border-gray-300'}`}>
              {isSelected && <Icon name="Check" size={12} className="text-white" />}
            </div>
          </div>
        )}
        
        {renderAvatarWithFrame(
          userPersona?.avatar,
          userPersona?.avatarFrame,
          userPersona?.name?.[0],
          'bg-gradient-to-br from-blue-400 to-cyan-400'
        )}
        
        <div className="max-w-[75%]">
          {/* åˆ†äº«æ ‡ç­¾ */}
          <div className="flex items-center gap-1 mb-1 justify-end">
            <Icon name="Share2" size={12} className="text-orange-500" />
            <span className="text-xs text-orange-500">åˆ†äº«äº†ä¸€æ¡æ˜Ÿè¯­</span>
          </div>
          
          {/* å¸–å­å¡ç‰‡ */}
          <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            {/* å¸–å­å¤´éƒ¨ */}
            <div className="p-3 border-b border-gray-50">
              <div className="flex items-center gap-2">
                <div className="w-8 h-8 rounded-full bg-gradient-to-br from-orange-400 to-pink-500 flex items-center justify-center">
                  {post.authorAvatar ? (
                    <img src={post.authorAvatar} alt="" className="w-full h-full object-cover rounded-full" />
                  ) : (
                    <span className="text-white text-xs font-bold">{post.authorName?.[0] || '?'}</span>
                  )}
                </div>
                <div>
                  <p className="text-sm font-medium text-gray-800">{post.authorName}</p>
                  <p className="text-xs text-gray-400">æ¥è‡ªæ˜Ÿè¯­</p>
                </div>
              </div>
            </div>
            
            {/* å¸–å­å†…å®¹ */}
            <div className="p-3">
              <p className="text-sm text-gray-700 line-clamp-4">{post.content}</p>
              {post.topic && (
                <span className="text-xs text-orange-500 mt-2 inline-block">#{post.topic}#</span>
              )}
            </div>
            
            {/* å¸–å­æ•°æ® */}
            <div className="px-3 pb-3 flex items-center gap-4 text-xs text-gray-400">
              <span className="flex items-center gap-1">
                <Icon name="Heart" size={12} />
                {post.likes || 0}
              </span>
              <span className="flex items-center gap-1">
                <Icon name="MessageCircle" size={12} />
                {post.comments || 0}
              </span>
            </div>
          </div>
        </div>
      </div>
    </React.Fragment>
  );
}
        
        // åˆ†äº«çš„å¸–å­æ¶ˆæ¯
if (msg.type === 'shared_post' && msg.sharedPost) {
  const post = msg.sharedPost;
  
  return (
    <React.Fragment key={msg.id}>
      {showTime && (
        <div className="text-center py-2">
          <span className="text-xs text-gray-400">{formatTime(msg.timestamp)}</span>
        </div>
      )}
      
      <div 
        className={`flex gap-2 px-3 py-1 flex-row-reverse ${isSelected ? 'bg-blue-100' : ''}`}
        onTouchStart={() => handleMsgTouchStart(msg.id)}
        onTouchEnd={handleMsgTouchEnd}
        onMouseDown={() => handleMsgTouchStart(msg.id)}
        onMouseUp={handleMsgTouchEnd}
        onMouseLeave={handleMsgTouchEnd}
        onClick={() => selectMode && toggleSelectMsg(msg.id)}
      >
        {selectMode && (
          <div className="flex items-center">
            <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${isSelected ? 'bg-green-500 border-green-500' : 'border-gray-300'}`}>
              {isSelected && <Icon name="Check" size={12} className="text-white" />}
            </div>
          </div>
        )}
        
        {renderAvatarWithFrame(
          userPersona?.avatar,
          userPersona?.avatarFrame,
          userPersona?.name?.[0],
          'bg-gradient-to-br from-blue-400 to-cyan-400'
        )}
        
        <div className="max-w-[75%]">
          {/* åˆ†äº«æ ‡ç­¾ */}
          <div className="flex items-center gap-1 mb-1 justify-end">
            <Icon name="Share2" size={12} className="text-orange-500" />
            <span className="text-xs text-orange-500">åˆ†äº«äº†ä¸€æ¡æ˜Ÿè¯­</span>
          </div>
          
          {/* å¸–å­å¡ç‰‡ */}
          <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            {/* å¸–å­å¤´éƒ¨ */}
            <div className="p-3 border-b border-gray-50">
              <div className="flex items-center gap-2">
                <div className="w-8 h-8 rounded-full bg-gradient-to-br from-orange-400 to-pink-500 flex items-center justify-center">
                  {post.authorAvatar ? (
                    <img src={post.authorAvatar} alt="" className="w-full h-full object-cover rounded-full" />
                  ) : (
                    <span className="text-white text-xs font-bold">{post.authorName?.[0] || '?'}</span>
                  )}
                </div>
                <div>
                  <p className="text-sm font-medium text-gray-800">{post.authorName}</p>
                  <p className="text-xs text-gray-400">æ¥è‡ªæ˜Ÿè¯­</p>
                </div>
              </div>
            </div>
            
            {/* å¸–å­å†…å®¹ */}
            <div className="p-3">
              <p className="text-sm text-gray-700 line-clamp-4">{post.content}</p>
              {post.topic && (
                <span className="text-xs text-orange-500 mt-2 inline-block">#{post.topic}#</span>
              )}
            </div>
            
            {/* å¸–å­æ•°æ® */}
            <div className="px-3 pb-3 flex items-center gap-4 text-xs text-gray-400">
              <span className="flex items-center gap-1">
                <Icon name="Heart" size={12} />
                {post.likes || 0}
              </span>
              <span className="flex items-center gap-1">
                <Icon name="MessageCircle" size={12} />
                {post.comments || 0}
              </span>
            </div>
          </div>
        </div>
      </div>
      
          </React.Fragment>
  );
}
        
        if (msg.type === 'narration') {
          return (
            <div 
              key={msg.id} 
              className={`px-6 py-2 ${isSelected ? 'bg-blue-100' : ''}`}
              onTouchStart={() => handleMsgTouchStart(msg.id)}
              onTouchEnd={handleMsgTouchEnd}
              onMouseDown={() => handleMsgTouchStart(msg.id)}
              onMouseUp={handleMsgTouchEnd}
              onMouseLeave={handleMsgTouchEnd}
              onClick={() => selectMode && toggleSelectMsg(msg.id)}
            >
              <div className="bg-black/5 text-gray-600 text-sm italic px-4 py-3 rounded-xl text-center">
                {msg.content}
              </div>
            </div>
          );
        }

        const isUser = msg.type === 'user';
        const avatar = isUser 
          ? (userPersona?.avatar || userPersona?.name?.[0]) 
          : (char?.avatar || char?.name?.[0]);
        
        // è§£æAIæ¶ˆæ¯å†…å®¹
        const parsedContent = (!isUser && chat.mode === 'offline') ? parseMessageContent(msg.content) : null;
        
        // æ¸²æŸ“å¯¹è¯æ°”æ³¡çš„è¾…åŠ©å‡½æ•°
        const renderBubble = (content, styleOwner, isUserBubble) => {
          const textStyle = {};
          if (styleOwner?.textColor) textStyle.color = styleOwner.textColor;
          if (styleOwner?.fontSize) textStyle.fontSize = `${styleOwner.fontSize}px`;
          if (styleOwner?.fontFamily) textStyle.fontFamily = styleOwner.fontFamily;
          
          const hasBubbleImage = !!styleOwner?.bubbleImage;
          const hasBubbleColor = !!styleOwner?.bubbleColor;
          
          let customCSS = {};
          if (styleOwner?.customBubbleCSS) {
            try {
              styleOwner.customBubbleCSS.split(';').forEach(rule => {
                const colonIndex = rule.indexOf(':');
                if (colonIndex > 0) {
                  const prop = rule.slice(0, colonIndex).trim();
                  const val = rule.slice(colonIndex + 1).trim();
                  if (prop && val) {
                    const camelProp = prop.replace(/-([a-z])/g, g => g[1].toUpperCase());
                    customCSS[camelProp] = val;
                  }
                }
              });
            } catch (e) {}
          }
          
          if (hasBubbleImage) {
            return (
              <div 
                className="relative inline-block"
                style={{
                  // æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨ border-image å®ç°ä¹å®«æ ¼æ‹‰ä¼¸
                  borderStyle: 'solid',
                  // è¿™å››ä¸ªæ•°å€¼å†³å®šäº†è¾¹æ¡†å ç”¨çš„ç©ºé—´ï¼Œä½ å¯ä»¥æ ¹æ®æ•ˆæœå¾®è°ƒ
                  borderWidth: '25px 30px 35px 45px', 
                  // 60-120 è¿™äº›æ•°å€¼å†³å®šäº†ä¿æŠ¤å¤šå°‘åƒç´ ä¸è¢«æ‹‰ä¼¸ï¼ˆå¯¹åº”æ˜Ÿæ˜Ÿå’Œå°¾å·´çš„ä½ç½®ï¼‰
                  borderImageSource: `url(${styleOwner.bubbleImage})`,
                  borderImageSlice: '80 100 100 130 fill', 
                  borderImageRepeat: 'stretch',
                  // ç¡®ä¿æ°”æ³¡ä¸ä¼šå¤ªçª„
                  minWidth: '100px',
                  filter: 'drop-shadow(0 2px 5px rgba(0,0,0,0.1))',
                  ...customCSS
                }}
              >
                {/* æ–‡å­—å†…å®¹ï¼šé€šè¿‡è´Ÿè¾¹è·æŠµæ¶ˆæ‰ border å ç”¨çš„ç©ºé—´ï¼Œè®©æ–‡å­—å›åˆ°ä¸­é—´ */}
                <p 
                  className="relative whitespace-pre-wrap break-words leading-relaxed" 
                  style={{ 
                    margin: '-10px -10px -15px -15px',
                    ...textStyle 
                  }}
                >
                  {content}
                </p>
              </div>
            );
          }
          
          const bubbleStyle = {};
          if (hasBubbleColor) {
            if (styleOwner.bubbleColor.includes('gradient')) {
              bubbleStyle.background = styleOwner.bubbleColor;
            } else {
              bubbleStyle.backgroundColor = styleOwner.bubbleColor;
            }
          }
          
          const hasCustom = hasBubbleColor || styleOwner?.customBubbleCSS;
          
          return (
            <div 
              className={hasCustom ? 'rounded-2xl inline-block' : (isUserBubble ? 'chat-bubble-user' : 'chat-bubble-ai')}
              style={{ ...bubbleStyle, ...customCSS }}
            >
              <p className="px-3 py-2 whitespace-pre-wrap break-words leading-relaxed" style={textStyle}>
                {content}
              </p>
            </div>
          );
        };

        return (
          <React.Fragment key={msg.id}>
            {showTime && (
              <div className="text-center py-2">
                <span className="text-xs text-gray-400">{formatTime(msg.timestamp)}</span>
              </div>
            )}
            
            {/* ç”¨æˆ·æ¶ˆæ¯ */}
            {isUser ? (
              <div 
                className={`flex gap-2 px-3 py-1 flex-row-reverse relative ${isSelected ? 'bg-blue-100' : ''}`}
                onTouchStart={() => handleMsgTouchStart(msg.id)}
                onTouchEnd={handleMsgTouchEnd}
                onMouseDown={() => handleMsgTouchStart(msg.id)}
                onMouseUp={handleMsgTouchEnd}
                onMouseLeave={handleMsgTouchEnd}
                onClick={() => selectMode && toggleSelectMsg(msg.id)}
              >
                {/* é•¿æŒ‰èœå• - æ˜¾ç¤ºåœ¨æ¶ˆæ¯ä¸Šæ–¹ */}
                {showMsgMenu === msg.id && (
                  <div className="absolute right-3 -top-10 z-50 animate-fade-in">
                    <div className="bg-gray-800 rounded-xl flex overflow-hidden shadow-lg">
                      <button
                        onClick={() => handleEditMessage(msg)}
                        className="px-3 py-2 text-white text-sm flex items-center gap-1 hover:bg-gray-700"
                      >
                        <Icon name="Pencil" size={14} />
                        ç¼–è¾‘
                      </button>
                      <div className="w-px bg-gray-600" />
                      <button
                        onClick={() => {
                          navigator.clipboard?.writeText(msg.content);
                          setShowMsgMenu(null);
                        }}
                        className="px-3 py-2 text-white text-sm flex items-center gap-1 hover:bg-gray-700"
                      >
                        <Icon name="Copy" size={14} />
                        å¤åˆ¶
                      </button>
                      <div className="w-px bg-gray-600" />
                      <button
                        onClick={() => handleDeleteSingle(msg.id)}
                        className="px-3 py-2 text-white text-sm flex items-center gap-1 hover:bg-gray-700"
                      >
                        <Icon name="Trash2" size={14} />
                        åˆ é™¤
                      </button>
                      <div className="w-px bg-gray-600" />
                      <button
                        onClick={() => handleEnterSelectMode(msg.id)}
                        className="px-3 py-2 text-white text-sm flex items-center gap-1 hover:bg-gray-700"
                      >
                        <Icon name="CheckSquare" size={14} />
                        å¤šé€‰
                      </button>
                      <div className="w-px bg-gray-600" />
                      <button
                        onClick={() => setShowMsgMenu(null)}
                        className="px-3 py-2 text-gray-400 text-sm hover:bg-gray-700"
                      >
                        âœ•
                      </button>
                    </div>
                  </div>
                )}
                
                {selectMode && (
                  <div className="flex items-center">
                    <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${isSelected ? 'bg-green-500 border-green-500' : 'border-gray-300'}`}>
                      {isSelected && <Icon name="Check" size={12} className="text-white" />}
                    </div>
                  </div>
                )}
                
                {renderAvatarWithFrame(
                  userPersona?.avatar,
                  userPersona?.avatarFrame,
                  userPersona?.name?.[0],
                  'bg-gradient-to-br from-blue-400 to-cyan-400'
                )}
                
                <div className="max-w-[70%] flex flex-col items-end">
                  {renderBubble(msg.content, userPersona, true)}
                  {msg.editedAt && <span className="text-xs text-gray-400 mt-1">å·²ç¼–è¾‘</span>}
                </div>
              </div>
            ) : (
              /* AIè§’è‰²æ¶ˆæ¯ */
              <div 
                className={`px-3 py-1 relative ${isSelected ? 'bg-blue-100' : ''}`}
                onTouchStart={() => handleMsgTouchStart(msg.id)}
                onTouchEnd={handleMsgTouchEnd}
                onMouseDown={() => handleMsgTouchStart(msg.id)}
                onMouseUp={handleMsgTouchEnd}
                onMouseLeave={handleMsgTouchEnd}
                onClick={() => selectMode && toggleSelectMsg(msg.id)}
              >
                {/* é•¿æŒ‰èœå• - æ˜¾ç¤ºåœ¨æ¶ˆæ¯ä¸Šæ–¹ */}
                {showMsgMenu === msg.id && (
                  <div className="absolute left-3 -top-10 z-50 animate-fade-in">
                    <div className="bg-gray-800 rounded-xl flex overflow-hidden shadow-lg">
                      <button
                        onClick={() => {
                          // é‡è¯´ï¼šåˆ é™¤è¿™æ¡æ¶ˆæ¯å¹¶é‡æ–°ç”Ÿæˆ
                          setShowMsgMenu(null);
                          // æ‰¾åˆ°è¿™æ¡æ¶ˆæ¯ä¹‹å‰çš„ç”¨æˆ·æ¶ˆæ¯
                          const msgs = chat.messages || [];
                          const msgIndex = msgs.findIndex(m => m.id === msg.id);
                          if (msgIndex > 0) {
                            // åˆ é™¤å½“å‰AIæ¶ˆæ¯
                            actions.deleteMessages(chat.id, [msg.id]);
                            // é‡æ–°å‘é€
                            setTimeout(() => handleSend(''), 100);
                          }
                        }}
                        className="px-3 py-2 text-white text-sm flex items-center gap-1 hover:bg-gray-700"
                      >
                        <Icon name="RefreshCw" size={14} />
                        é‡è¯´
                      </button>
                      <div className="w-px bg-gray-600" />
                      <button
                        onClick={() => handleEditMessage(msg)}
                        className="px-3 py-2 text-white text-sm flex items-center gap-1 hover:bg-gray-700"
                      >
                        <Icon name="Pencil" size={14} />
                        ç¼–è¾‘
                      </button>
                      <div className="w-px bg-gray-600" />
                      <button
                        onClick={() => {
                          navigator.clipboard?.writeText(msg.content);
                          setShowMsgMenu(null);
                        }}
                        className="px-3 py-2 text-white text-sm flex items-center gap-1 hover:bg-gray-700"
                      >
                        <Icon name="Copy" size={14} />
                        å¤åˆ¶
                      </button>
                      <div className="w-px bg-gray-600" />
                      <button
                        onClick={() => handleDeleteSingle(msg.id)}
                        className="px-3 py-2 text-white text-sm flex items-center gap-1 hover:bg-gray-700"
                      >
                        <Icon name="Trash2" size={14} />
                        åˆ é™¤
                      </button>
                      <div className="w-px bg-gray-600" />
                      <button
                        onClick={() => handleEnterSelectMode(msg.id)}
                        className="px-3 py-2 text-white text-sm flex items-center gap-1 hover:bg-gray-700"
                      >
                        <Icon name="CheckSquare" size={14} />
                        å¤šé€‰
                      </button>
                      <div className="w-px bg-gray-600" />
                      <button
                        onClick={() => setShowMsgMenu(null)}
                        className="px-3 py-2 text-gray-400 text-sm hover:bg-gray-700"
                      >
                        âœ•
                      </button>
                    </div>
                  </div>
                )}
                
                {selectMode && (
    <div className="flex items-center mb-2">
      <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${isSelected ? 'bg-green-500 border-green-500' : 'border-gray-300'}`}>
        {isSelected && <Icon name="Check" size={12} className="text-white" />}
      </div>
    </div>
  )}
  
  {/* åˆ¤æ–­æ˜¯å¦æ˜¯NPCæ¶ˆæ¯ */}
  {msg.isNPC ? (
  // NPCæ¶ˆæ¯ï¼šç‹¬ç«‹æ°”æ³¡
  <div className="flex gap-2">
    <div className="w-10 h-10 rounded-full bg-gradient-to-br from-gray-400 to-gray-500 flex items-center justify-center flex-shrink-0">
      <span className="text-white font-bold text-sm">{msg.npcName?.[0] || '?'}</span>
    </div>
    <div className="max-w-[70%]">
      <p className="text-xs text-gray-500 mb-1 ml-1">{msg.npcName || 'NPC'}</p>
      <div className="chat-bubble-ai">
        <p className="px-3 py-2 whitespace-pre-wrap break-words leading-relaxed text-sm">
          {msg.content}
        </p>
      </div>
    </div>
  </div>
) : (
  // ä¸»è§’è‰²æ¶ˆæ¯ï¼šæ—ç™½ã€å¯¹è¯ã€å¿ƒå£°å…¨éƒ¨åˆå¹¶åœ¨ä¸€ä¸ªæ°”æ³¡é‡Œ
  <div className="flex gap-2">
    {renderAvatarWithFrame(
      char?.avatar,
      char?.avatarFrame,
      char?.name?.[0],
      'bg-gradient-to-br from-purple-400 to-pink-400'
    )}
    <div className="max-w-[70%] flex flex-col items-start">
      {chat.type === 'group' && <p className="text-xs text-gray-500 mb-1 ml-1">{char?.name}</p>}
      {renderBubble(msg.content, char, false)}
      {msg.editedAt && <span className="text-xs text-gray-400 mt-1">å·²ç¼–è¾‘</span>}
    </div>
  </div>
)}
</div>
            )}
          </React.Fragment>
        );
      };

      // ä¸–ç•Œä¹¦é€‰æ‹©å™¨ç»„ä»¶
      const WorldBookPicker = () => {
        const renderItems = (parentId = null, level = 0) => {
          const items = state.worldBook.filter(e => e.parentId === parentId);
          
          return items.map(item => {
            const isSelected = (chat.worldBookIds || []).includes(item.id);
            const isFolder = item.type === 'folder';
            const childItems = state.worldBook.filter(e => e.parentId === item.id);
            
            return (
              <div key={item.id}>
                <button
                  onClick={() => toggleWorldBookItem(item.id)}
                  className={`w-full flex items-center gap-3 p-3 rounded-lg transition-all ${
                    isSelected ? 'bg-purple-100' : 'hover:bg-gray-100'
                  }`}
                  style={{ paddingLeft: `${12 + level * 16}px` }}
                >
                  <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${
                    isFolder ? 'bg-yellow-100' : 'bg-blue-100'
                  }`}>
                    <Icon 
                      name={isFolder ? 'Folder' : 'FileText'} 
                      size={16} 
                      className={isFolder ? 'text-yellow-600' : 'text-blue-500'} 
                    />
                  </div>
                  <span className="flex-1 text-left text-sm">{item.name}</span>
                  {isSelected && (
                    <Icon name="Check" size={18} className="text-purple-500" />
                  )}
                </button>
                {isFolder && childItems.length > 0 && renderItems(item.id, level + 1)}
              </div>
            );
          });
        };

        return (
          <div className="absolute inset-0 bg-black/50 z-50 flex items-end">
            <div className="w-full bg-white rounded-t-3xl max-h-[70%] flex flex-col animate-slide-up">
              <div className="flex items-center justify-between p-4 border-b">
                <h3 className="font-semibold">ç»‘å®šä¸–ç•Œä¹¦</h3>
                <button onClick={() => setShowWorldBookPicker(false)} className="text-gray-500">
                  <Icon name="X" size={24} />
                </button>
              </div>
              <div className="flex-1 overflow-y-auto p-2">
                {state.worldBook.length === 0 ? (
                  <p className="text-center text-gray-500 py-8">æš‚æ— ä¸–ç•Œä¹¦æ¡ç›®</p>
                ) : (
                  renderItems()
                )}
              </div>
              <div className="p-4 border-t">
                <p className="text-xs text-gray-500 text-center">
                  å·²ç»‘å®š {(chat.worldBookIds || []).length} ä¸ªæ¡ç›®/æ–‡ä»¶å¤¹
                </p>
              </div>
            </div>
          </div>
        );
      };

      // ä¾§è¾¹æ ç»„ä»¶
      const Sidebar = () => (
        <div className={`absolute inset-0 z-50 transition-all duration-300 ${showSidebar ? 'visible' : 'invisible'}`}>
          <div 
            className={`absolute inset-0 bg-black/50 transition-opacity ${showSidebar ? 'opacity-100' : 'opacity-0'}`}
            onClick={() => setShowSidebar(false)}
          />
          
          <div className={`absolute right-0 top-0 bottom-0 w-[80%] bg-gray-900 transition-transform ${
            showSidebar ? 'translate-x-0' : 'translate-x-full'
          }`}>
            <div className="h-full flex flex-col">
              <div className="p-4 pt-12 border-b border-gray-700">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-white text-lg font-semibold">èŠå¤©è®¾ç½®</h2>
                  <button onClick={() => setShowSidebar(false)} className="text-gray-400">
                    <Icon name="X" size={24} />
                  </button>
                </div>
                
                <div className="flex items-center gap-3 p-3 bg-gray-800 rounded-xl">
                  <div className="w-14 h-14 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center overflow-hidden">
                    {chatCharacters[0]?.avatar ? (
                      <img src={chatCharacters[0].avatar} alt="" className="w-full h-full object-cover" />
                    ) : (
                      <span className="text-white text-xl font-bold">{chatCharacters[0]?.name?.[0]}</span>
                    )}
                  </div>
                  <div className="flex-1">
                    <h3 className="text-white font-medium">{chat.name}</h3>
                    <p className="text-gray-400 text-sm">{chatCharacters.length}ä¸ªè§’è‰²</p>
                  </div>
                </div>
              </div>

              <div className="flex-1 overflow-y-auto p-4 space-y-3">
                {/* èŠå¤©æ¨¡å¼ */}
                <div className="bg-gray-800 rounded-xl p-4 space-y-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <h3 className="text-white font-medium">èŠå¤©æ¨¡å¼</h3>
                      <p className="text-gray-400 text-xs mt-1">
                        {chat.mode === 'online' ? 'çº¿ä¸Šï¼šçº¯å¯¹è¯' : 'çº¿ä¸‹ï¼šå‰§æœ¬æ¨¡å¼'}
                      </p>
                    </div>
                    <button
                      onClick={toggleMode}
                      className={`w-16 h-8 rounded-full flex items-center px-1 transition-all ${
                        chat.mode === 'offline' ? 'bg-purple-500' : 'bg-blue-500'
                      }`}
                    >
                      <div className={`w-6 h-6 bg-white rounded-full shadow transition-transform ${
                        chat.mode === 'offline' ? 'translate-x-8' : 'translate-x-0'
                      }`} />
                    </button>
                  </div>

                  {chat.mode === 'offline' && (
                    <div className="pt-3 border-t border-gray-700 space-y-3">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <span>ğŸ“</span>
                          <span className="text-white text-sm">æ—ç™½æå†™</span>
                        </div>
                        <button
                          onClick={toggleNarration}
                          className={`w-12 h-6 rounded-full flex items-center px-0.5 ${
                            chat.allowNarration !== false ? 'bg-green-500' : 'bg-gray-600'
                          }`}
                        >
                          <div className={`w-5 h-5 bg-white rounded-full transition-transform ${
                            chat.allowNarration !== false ? 'translate-x-6' : 'translate-x-0'
                          }`} />
                        </button>
                      </div>

                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <span>ğŸ’­</span>
                          <span className="text-white text-sm">å¿ƒå£°æå†™</span>
                        </div>
                        <button
                          onClick={toggleThoughts}
                          className={`w-12 h-6 rounded-full flex items-center px-0.5 ${
                            chat.allowThoughts !== false ? 'bg-green-500' : 'bg-gray-600'
                          }`}
                        >
                          <div className={`w-5 h-5 bg-white rounded-full transition-transform ${
                            chat.allowThoughts !== false ? 'translate-x-6' : 'translate-x-0'
                          }`} />
                        </button>
                      </div>
                    </div>
                  )}
                </div>
                
                {/* ç”¨æˆ·äººè®¾ */}
<div className="bg-gray-800 rounded-xl p-4">
  <div className="flex items-center justify-between mb-3">
    <h3 className="text-white font-medium">ğŸ‘¤ ç”¨æˆ·äººè®¾</h3>
  </div>
  
  {/* å½“å‰äººè®¾ */}
  {userPersona ? (
    <div className="flex items-center gap-3 p-2 bg-gray-700/50 rounded-lg mb-3">
      <div className="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-cyan-400 flex items-center justify-center overflow-hidden">
        {userPersona.avatar ? (
          <img src={userPersona.avatar} alt="" className="w-full h-full object-cover" />
        ) : (
          <span className="text-white font-bold">{userPersona.name[0]}</span>
        )}
      </div>
      <div className="flex-1">
        <p className="text-white text-sm">{userPersona.name}</p>
        <p className="text-gray-400 text-xs">å½“å‰ä½¿ç”¨</p>
      </div>
    </div>
  ) : (
    <div className="p-3 bg-red-500/20 rounded-lg mb-3">
      <p className="text-red-400 text-sm text-center">âš ï¸ æœªç»‘å®šç”¨æˆ·äººè®¾</p>
      <p className="text-red-300 text-xs text-center mt-1">è¯·é€‰æ‹©ä¸€ä¸ªäººè®¾ä»¥ç»§ç»­å¯¹è¯</p>
    </div>
  )}
  
  {/* äººè®¾åˆ—è¡¨ */}
  <div className="space-y-2 max-h-40 overflow-y-auto">
    {state.userPersonas.length === 0 ? (
      <p className="text-gray-500 text-sm text-center py-2">
        æš‚æ— äººè®¾ï¼Œè¯·å…ˆåœ¨é€šè®¯å½•åˆ›å»º
      </p>
    ) : (
      state.userPersonas.map(persona => (
        <button
          key={persona.id}
          onClick={() => {
            actions.updateChat(chat.id, { userPersonaId: persona.id });
          }}
          className={`w-full flex items-center gap-3 p-2 rounded-lg transition-all ${
            chat.userPersonaId === persona.id 
              ? 'bg-blue-500/30 border border-blue-500' 
              : 'bg-gray-700/30 hover:bg-gray-700/50'
          }`}
        >
          <div className="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-cyan-400 flex items-center justify-center overflow-hidden">
            {persona.avatar ? (
              <img src={persona.avatar} alt="" className="w-full h-full object-cover" />
            ) : (
              <span className="text-white font-bold text-xs">{persona.name[0]}</span>
            )}
          </div>
          <div className="flex-1 text-left">
            <p className="text-white text-sm">{persona.name}</p>
            <p className="text-gray-400 text-xs truncate">
              {persona.gender === 'male' ? 'ç”·' : persona.gender === 'female' ? 'å¥³' : 'å…¶ä»–'} Â· {persona.age}å²
            </p>
          </div>
          {chat.userPersonaId === persona.id && (
            <Icon name="Check" size={16} className="text-blue-400" />
          )}
        </button>
      ))
    )}
  </div>
</div>
                
                {/* ä¸–ç•Œä¹¦ç»‘å®š */}
                <div className="bg-gray-800 rounded-xl p-4">
                  <div className="flex items-center justify-between mb-3">
                    <h3 className="text-white font-medium">ğŸ“š ä¸–ç•Œä¹¦</h3>
                    <button
                      onClick={() => { setShowSidebar(false); setShowWorldBookPicker(true); }}
                      className="text-purple-400 text-sm"
                    >
                      ç¼–è¾‘
                    </button>
                  </div>
                  {boundWorldBooks.length === 0 ? (
                    <p className="text-gray-500 text-sm">æœªç»‘å®šä¸–ç•Œä¹¦æ¡ç›®</p>
                  ) : (
                    <div className="space-y-2">
                      {boundWorldBooks.slice(0, 3).map(entry => (
                        <div key={entry.id} className="flex items-center gap-2 text-sm">
                          <Icon name="FileText" size={14} className="text-blue-400" />
                          <span className="text-gray-300 truncate">{entry.name}</span>
                        </div>
                      ))}
                      {boundWorldBooks.length > 3 && (
                        <p className="text-gray-500 text-xs">è¿˜æœ‰ {boundWorldBooks.length - 3} ä¸ª...</p>
                      )}
                    </div>
                  )}
                </div>

                {/* æ€»ç»“åŠŸèƒ½ */}
                <div className="bg-gray-800 rounded-xl p-4">
                  <div className="flex items-center justify-between mb-3">
                    <h3 className="text-white font-medium">ğŸ“‹ å¯¹è¯æ€»ç»“</h3>
                    <span className="text-gray-500 text-xs">å…±{chat.messages.length}æ¡æ¶ˆæ¯</span>
                  </div>
                  
                  {/* å†å²æ€»ç»“åˆ—è¡¨ */}
                  {(chat.summaries && chat.summaries.length > 0) ? (
                    <div className="mb-3 space-y-2 max-h-32 overflow-y-auto">
                      {chat.summaries.slice(-3).map((s, idx) => (
                        <div key={idx} className="bg-gray-700/50 rounded-lg p-2">
                          <p className="text-gray-300 text-xs line-clamp-2">{s.content}</p>
                          <p className="text-gray-500 text-xs mt-1">
                            {s.range.start}-{s.range.end}æ¥¼ Â· {new Date(s.createdAt).toLocaleDateString()}
                          </p>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-gray-500 text-sm mb-3">æš‚æ— æ€»ç»“è®°å½•</p>
                  )}
                  
                  <button
                    onClick={openSummaryModal}
                    disabled={isSummarizing || chat.messages.length === 0}
                    className={`w-full py-2 rounded-lg text-sm ${
                      isSummarizing || chat.messages.length === 0
                        ? 'bg-gray-700 text-gray-500'
                        : 'bg-purple-500 text-white'
                    }`}
                  >
                    {isSummarizing ? 'æ€»ç»“ä¸­...' : 'æ–°å»ºæ€»ç»“'}
                  </button>
                </div>

                {/* å‚ä¸è§’è‰² */}
                <div className="bg-gray-800 rounded-xl p-4">
                  <h3 className="text-white font-medium mb-3">å‚ä¸è§’è‰²</h3>
                  <div className="space-y-2">
                    {chatCharacters.map(char => (
                      <div key={char.id} className="flex items-center gap-3 p-2 bg-gray-700/50 rounded-lg">
                        <div className="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center overflow-hidden">
                          {char.avatar ? (
                            <img src={char.avatar} alt="" className="w-full h-full object-cover" />
                          ) : (
                            <span className="text-white font-bold">{char.name[0]}</span>
                          )}
                        </div>
                        <div className="flex-1">
                          <p className="text-white text-sm">{char.name}</p>
                          <p className="text-gray-400 text-xs">{char.gender === 'male' ? 'ç”·' : char.gender === 'female' ? 'å¥³' : 'å…¶ä»–'} Â· {char.age}å²</p>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                {/* æ¶ˆæ¯ç»Ÿè®¡ */}
                <div className="bg-gray-800 rounded-xl p-4">
                  <h3 className="text-white font-medium mb-2">æ¶ˆæ¯ç»Ÿè®¡</h3>
                  <div className="grid grid-cols-2 gap-2 text-center">
                    <div className="bg-gray-700/50 rounded-lg p-3">
                      <p className="text-2xl text-white font-bold">{chat.messages.length}</p>
                      <p className="text-gray-400 text-xs">æ€»æ¶ˆæ¯</p>
                    </div>
                    <div className="bg-gray-700/50 rounded-lg p-3">
                      <p className="text-2xl text-white font-bold">
                        {chat.messages.filter(m => m.type === 'user').length}
                      </p>
                      <p className="text-gray-400 text-xs">æˆ‘çš„æ¶ˆæ¯</p>
                    </div>
                  </div>
                </div>

                {/* åˆ é™¤èŠå¤© */}
                <div className="bg-gray-800 rounded-xl p-4">
                  <button
                    onClick={handleDeleteChat}
                    className="w-full py-3 bg-red-500/20 text-red-400 rounded-lg flex items-center justify-center gap-2"
                  >
                    <Icon name="Trash2" size={18} />
                    åˆ é™¤èŠå¤©è®°å½•
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      );

      return (
        <div className="w-full h-full bg-gray-100 flex flex-col relative">
          {/* å¤´éƒ¨ */}
          <div className="bg-gradient-to-r from-green-500 to-green-600 pt-10 pb-3 px-3">
            {selectMode ? (
              <div className="flex items-center justify-between">
                <button onClick={() => setSelectMode(false)} className="text-white p-1">
                  <Icon name="X" size={22} />
                </button>
                <span className="text-white font-medium">å·²é€‰æ‹© {selectedMsgs.length} æ¡</span>
                <button 
                  onClick={handleDeleteSelected}
                  disabled={selectedMsgs.length === 0}
                  className={`px-3 py-1 rounded ${selectedMsgs.length > 0 ? 'bg-red-500 text-white' : 'bg-white/20 text-white/50'}`}
                >
                  åˆ é™¤
                </button>
              </div>
            ) : (
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <button onClick={() => actions.setCurrentChat(null)} className="text-white p-1">
                    <Icon name="ChevronLeft" size={22} />
                  </button>
                  <div className="flex items-center gap-2">
                    <div className="w-9 h-9 rounded-full bg-white/20 flex items-center justify-center overflow-hidden">
                      {chatCharacters[0]?.avatar ? (
                        <img src={chatCharacters[0].avatar} alt="" className="w-full h-full object-cover" />
                      ) : (
                        <span className="text-white font-bold text-sm">{chatCharacters[0]?.name?.[0]}</span>
                      )}
                    </div>
                    <div>
                      <h1 className="text-white font-medium text-sm">{chat.name}</h1>
                      <div className="flex items-center gap-1">
                        <span className={`w-2 h-2 rounded-full ${chat.mode === 'online' ? 'bg-blue-300' : 'bg-purple-300'}`} />
                        <span className="text-white/70 text-xs">
                          {chat.mode === 'online' ? 'çº¿ä¸Š' : 'çº¿ä¸‹'} Â· {chatCharacters.length}è§’è‰²
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
                <button onClick={() => setShowSidebar(true)} className="text-white p-2">
                  <Icon name="Menu" size={22} />
                </button>
              </div>
            )}
          </div>

          {/* æ¶ˆæ¯åˆ—è¡¨ */}
          <div 
            className="flex-1 overflow-y-auto py-2 bg-gradient-to-b from-gray-100 to-gray-50 select-none-deep"
            onClick={() => showMsgMenu && setShowMsgMenu(null)}
          >
            {chat.messages.length === 0 ? (
              <div className="h-full flex flex-col items-center justify-center text-gray-400">
                <div className="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center mb-3">
                  <Icon name="MessageCircle" size={32} className="text-gray-300" />
                </div>
                <p className="text-sm">å¼€å§‹ä½ ä»¬çš„å¯¹è¯å§</p>
              </div>
            ) : (
              chat.messages.map((msg, index) => renderMessage(msg, index, chat.messages[index - 1]))
            )}
            
            {streamingText && (
              <div className="flex gap-2 px-3 py-1">
                {renderAvatarWithFrame(
                  chatCharacters[0]?.avatar,
                  chatCharacters[0]?.avatarFrame,
                  chatCharacters[0]?.name?.[0],
                  'bg-gradient-to-br from-purple-400 to-pink-400'
                )}
                <div className="max-w-[70%]">
                  {(() => {
                    const char = chatCharacters[0];
                    const hasBubbleImage = !!char?.bubbleImage;
                    const textStyle = {};
                    if (char?.textColor) textStyle.color = char.textColor;
                    if (char?.fontSize) textStyle.fontSize = `${char.fontSize}px`;
                    if (char?.fontFamily) textStyle.fontFamily = char.fontFamily;
                    
                    if (hasBubbleImage) {
                      return (
                        <div className="relative">
                          <div 
                            className="absolute inset-0 pointer-events-none"
                            style={{
                              backgroundImage: `url(${char.bubbleImage})`,
                              backgroundSize: '100% 100%',
                              backgroundRepeat: 'no-repeat',
                            }}
                          />
                          <p className="relative px-4 py-3 whitespace-pre-wrap" style={textStyle}>
                            {streamingText}
                          </p>
                        </div>
                      );
                    }
                    
                    const bubbleStyle = {};
                    if (char?.bubbleColor) {
                      if (char.bubbleColor.includes('gradient')) {
                        bubbleStyle.background = char.bubbleColor;
                      } else {
                        bubbleStyle.backgroundColor = char.bubbleColor;
                      }
                    }
                    
                    return (
                      <div 
                        className={char?.bubbleColor ? 'rounded-2xl' : 'chat-bubble-ai'}
                        style={bubbleStyle}
                      >
                        <p className="px-3 py-2 whitespace-pre-wrap" style={textStyle}>{streamingText}</p>
                      </div>
                    );
                  })()}
                </div>
              </div>
            )}
            
            <div ref={messagesEndRef} />
          </div>

          {/* è¾“å…¥æ¡† */}
          {!selectMode && (
            <div className="bg-white border-t border-gray-200 p-2 flex items-end gap-2">
              <div className="flex-1 bg-gray-100 rounded-2xl px-3 py-2">
                <textarea
                  value={inputText}
                  onChange={(e) => setInputText(e.target.value)}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                      e.preventDefault();
                      handleSend();
                    }
                  }}
                  placeholder="è¾“å…¥æ¶ˆæ¯..."
                  className="w-full bg-transparent resize-none max-h-24 text-sm outline-none"
                  rows={1}
                  disabled={isLoading}
                />
              </div>
              <button
                onClick={handleSend}
                disabled={isLoading || !inputText.trim()}
                className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${
                  inputText.trim() && !isLoading 
                    ? 'bg-green-500 text-white' 
                    : 'bg-gray-200 text-gray-400'
                }`}
              >
                {isLoading ? (
                  <Icon name="Loader2" size={18} className="animate-spin" />
                ) : (
                  <Icon name="Send" size={18} />
                )}
              </button>
            </div>
          )}

          {/* å¤šé€‰æ¨¡å¼åº•éƒ¨æ  */}
          {selectMode && (
            <div className="bg-white border-t border-gray-200 p-3 flex justify-around">
              <button 
                onClick={() => setSelectedMsgs(chat.messages.map(m => m.id))}
                className="flex flex-col items-center gap-1 text-gray-600"
              >
                <Icon name="CheckCircle" size={24} />
                <span className="text-xs">å…¨é€‰</span>
              </button>
              <button 
                onClick={() => setSelectedMsgs([])}
                className="flex flex-col items-center gap-1 text-gray-600"
              >
                <Icon name="Circle" size={24} />
                <span className="text-xs">å–æ¶ˆå…¨é€‰</span>
              </button>
              <button 
                onClick={handleDeleteSelected}
                disabled={selectedMsgs.length === 0}
                className={`flex flex-col items-center gap-1 ${selectedMsgs.length > 0 ? 'text-red-500' : 'text-gray-300'}`}
              >
                <Icon name="Trash2" size={24} />
                <span className="text-xs">åˆ é™¤({selectedMsgs.length})</span>
              </button>
            </div>
          )}

          <Sidebar />
          {showWorldBookPicker && <WorldBookPicker />}
          
          {/* ç¼–è¾‘æ¶ˆæ¯å¼¹çª— */}
          {editingMessage && (
            <div className="absolute inset-0 bg-black/50 z-50 flex items-end">
              <div className="w-full bg-white rounded-t-3xl animate-slide-up">
                <div className="p-4 border-b border-gray-200">
                  <div className="flex items-center justify-between">
                    <button onClick={cancelEdit} className="text-gray-500">
                      å–æ¶ˆ
                    </button>
                    <h3 className="font-semibold">ç¼–è¾‘æ¶ˆæ¯</h3>
                    <button 
                      onClick={saveEditedMessage}
                      disabled={!editText.trim()}
                      className={`font-semibold ${editText.trim() ? 'text-blue-500' : 'text-gray-300'}`}
                    >
                      ä¿å­˜
                    </button>
                  </div>
                </div>
                
                <div className="p-4">
                  {/* æ˜¾ç¤ºæ˜¯è°çš„æ¶ˆæ¯ */}
                  <div className="flex items-center gap-2 mb-3">
                    {editingMessage.type === 'user' ? (
                      <>
                        <div className="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-cyan-400 flex items-center justify-center overflow-hidden">
                          {userPersona?.avatar ? (
                            <img src={userPersona.avatar} alt="" className="w-full h-full object-cover" />
                          ) : (
                            <span className="text-white font-bold text-xs">{userPersona?.name?.[0]}</span>
                          )}
                        </div>
                        <span className="text-sm text-gray-600">{userPersona?.name || 'æˆ‘'}</span>
                      </>
                    ) : (
                      <>
                        <div className="w-8 h-8 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center overflow-hidden">
                          {(() => {
                            const char = state.characters.find(c => c.id === editingMessage.characterId);
                            return char?.avatar ? (
                              <img src={char.avatar} alt="" className="w-full h-full object-cover" />
                            ) : (
                              <span className="text-white font-bold text-xs">{char?.name?.[0]}</span>
                            );
                          })()}
                        </div>
                        <span className="text-sm text-gray-600">
                          {state.characters.find(c => c.id === editingMessage.characterId)?.name || 'AI'}
                        </span>
                      </>
                    )}
                  </div>
                  
                  <textarea
                    value={editText}
                    onChange={(e) => setEditText(e.target.value)}
                    className="w-full h-48 p-3 bg-gray-100 rounded-xl text-sm resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹..."
                    autoFocus
                  />
                  
                  <p className="text-xs text-gray-400 mt-2 text-right">
                    {editText.length} å­—
                  </p>
                </div>
              </div>
            </div>
          )}
          
          {/* æ€»ç»“èŒƒå›´é€‰æ‹©å¼¹çª— */}
          {showSummaryModal && (
            <div className="absolute inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl w-full max-w-sm p-5 animate-fade-in">
                <h3 className="text-lg font-semibold text-center mb-4">ğŸ“‹ é€‰æ‹©æ€»ç»“èŒƒå›´</h3>
                
                <div className="bg-gray-100 rounded-xl p-4 mb-4">
                  <p className="text-sm text-gray-600 mb-3">
                    å½“å‰å…± <span className="font-bold text-purple-600">{chat.messages.length}</span> æ¡æ¶ˆæ¯
                  </p>
                  
                  <div className="flex items-center gap-3">
                    <div className="flex-1">
                      <label className="text-xs text-gray-500">ä»ç¬¬</label>
                      <input
                        type="number"
                        min={1}
                        max={chat.messages.length}
                        value={summaryRange.start}
                        onChange={(e) => setSummaryRange({
                          ...summaryRange,
                          start: Math.max(1, Math.min(parseInt(e.target.value) || 1, summaryRange.end))
                        })}
                        className="w-full p-2 bg-white rounded-lg text-center font-medium"
                      />
                    </div>
                    <span className="text-gray-400 mt-4">â€”</span>
                    <div className="flex-1">
                      <label className="text-xs text-gray-500">åˆ°ç¬¬</label>
                      <input
                        type="number"
                        min={summaryRange.start}
                        max={chat.messages.length}
                        value={summaryRange.end}
                        onChange={(e) => setSummaryRange({
                          ...summaryRange,
                          end: Math.max(summaryRange.start, Math.min(parseInt(e.target.value) || 1, chat.messages.length))
                        })}
                        className="w-full p-2 bg-white rounded-lg text-center font-medium"
                      />
                    </div>
                    <span className="text-gray-500 mt-4 text-sm">æ¡</span>
                  </div>
                  
                  <p className="text-xs text-gray-500 mt-3 text-center">
                    å°†æ€»ç»“ {summaryRange.end - summaryRange.start + 1} æ¡æ¶ˆæ¯
                  </p>
                </div>
                
                {/* å¿«æ·é€‰æ‹© */}
                <div className="flex gap-2 mb-4">
                  <button
                    onClick={() => setSummaryRange({ start: 1, end: Math.min(50, chat.messages.length) })}
                    className="flex-1 py-2 bg-gray-100 rounded-lg text-sm text-gray-600"
                  >
                    å‰50æ¡
                  </button>
                  <button
                    onClick={() => setSummaryRange({ start: 1, end: Math.min(100, chat.messages.length) })}
                    className="flex-1 py-2 bg-gray-100 rounded-lg text-sm text-gray-600"
                  >
                    å‰100æ¡
                  </button>
                  <button
                    onClick={() => setSummaryRange({ start: 1, end: chat.messages.length })}
                    className="flex-1 py-2 bg-gray-100 rounded-lg text-sm text-gray-600"
                  >
                    å…¨éƒ¨
                  </button>
                </div>
                
                <div className="flex gap-3">
                  <button
                    onClick={() => setShowSummaryModal(false)}
                    className="flex-1 py-3 bg-gray-200 rounded-xl font-medium"
                  >
                    å–æ¶ˆ
                  </button>
                  <button
                    onClick={handleSummarize}
                    className="flex-1 py-3 bg-purple-500 text-white rounded-xl font-medium"
                  >
                    å¼€å§‹æ€»ç»“
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };
    
        // ==================== æ˜Ÿè¯­APPç»„ä»¶ ====================
    const XingYuApp = () => {
      const state = useStore();
      const [currentTab, setCurrentTab] = useState('follow'); // follow | recommend | hot
      const [currentPage, setCurrentPage] = useState('home'); // home | hot | profile | post | detail | createAccount
      const [showCreatePost, setShowCreatePost] = useState(false);
            const [editingAccount, setEditingAccount] = useState(null);
      const [postContent, setPostContent] = useState('');
      const [postTopic, setPostTopic] = useState('');
      const [selectedPost, setSelectedPost] = useState(null);
      const [commentText, setCommentText] = useState('');
      const [isGenerating, setIsGenerating] = useState(false);
            const [showAccountPicker, setShowAccountPicker] = useState(false);
      const [viewingProfile, setViewingProfile] = useState(null); // æŸ¥çœ‹çš„ç”¨æˆ·ä¸»é¡µ
      const [replyingTo, setReplyingTo] = useState(null); // æ­£åœ¨å›å¤çš„è¯„è®º
      const [showShareModal, setShowShareModal] = useState(false); // è½¬å‘å¼¹çª—
const [sharingPost, setSharingPost] = useState(null); // è¦è½¬å‘çš„å¸–å­
      
      // è·å–å½“å‰ç”¨æˆ·è´¦å·
      const activeAccount = state.socialMedia?.userAccounts?.find(
        a => a.id === state.socialMedia?.activeAccount
      ) || state.socialMedia?.userAccounts?.[0];
      
      // è·å–æ‰€æœ‰è´¦å·ï¼ˆç”¨äºå‘å¸–è€…ä¿¡æ¯æ˜¾ç¤ºï¼‰
      const getAllAccounts = () => {
        return [
          ...(state.socialMedia?.userAccounts || []).map(a => ({ ...a, accountType: 'user' })),
          ...(state.socialMedia?.characterAccounts || []).map(a => ({ ...a, accountType: 'character' })),
          ...(state.socialMedia?.npcAccounts || []).map(a => ({ ...a, accountType: 'npc' }))
        ];
      };
      
      // æ ¹æ®IDè·å–è´¦å·ä¿¡æ¯
      const getAccountById = (accountId, accountType) => {
        if (accountType === 'user') {
          return state.socialMedia?.userAccounts?.find(a => a.id === accountId);
        } else if (accountType === 'character') {
          return state.socialMedia?.characterAccounts?.find(a => a.id === accountId);
        } else if (accountType === 'npc') {
          return state.socialMedia?.npcAccounts?.find(a => a.id === accountId);
        }
        return null;
      };
      
      // è·å–å…³æ³¨çš„å¸–å­
      const getFollowingPosts = () => {
        if (!activeAccount) return [];
        const following = activeAccount.following || [];
        return (state.socialMedia?.posts || [])
          .filter(p => p.platform === 'xingyu' && following.includes(p.authorId))
          .sort((a, b) => b.createdAt - a.createdAt);
      };
      
      // æ ¹æ®å½“å‰è´¦å·ç»‘å®šè§’è‰²è¿‡æ»¤å¸–å­ï¼ˆæŒ‰@å’Œ#è¿‡æ»¤ï¼‰
const getFilteredPosts = (posts) => {
  const boundIds = activeAccount?.boundCharacterIds || [];
  
  // å¦‚æœæ²¡æœ‰ç»‘å®šè§’è‰²ï¼Œæ˜¾ç¤ºæ‰€æœ‰å¸–å­
  if (boundIds.length === 0) return posts;
  
  // è·å–ç»‘å®šè§’è‰²çš„åå­—åˆ—è¡¨
  const boundCharNames = boundIds.map(id => {
    const char = state.characters.find(c => c.id === id);
    return char?.name;
  }).filter(Boolean);
  
  // è·å–ç»‘å®šè§’è‰²çš„æ˜Ÿè¯­è´¦å·IDåˆ—è¡¨
  const boundCharAccountIds = boundIds.map(id => {
    const charAccount = state.socialMedia?.characterAccounts?.find(
      a => a.characterId === id && a.platform === 'xingyu'
    );
    return charAccount?.id;
  }).filter(Boolean);
  
  return posts.filter(p => {
    // 1. å½“å‰ç”¨æˆ·è‡ªå·±å‘çš„å¸–å­ - æ˜¾ç¤º
    if (p.authorType === 'user' && p.authorId === activeAccount?.id) return true;
    
    // 2. ç»‘å®šè§’è‰²å‘çš„å¸–å­ - æ˜¾ç¤º
    if (p.authorType === 'character' && boundCharAccountIds.includes(p.authorId)) return true;
    
    // 3. æ£€æŸ¥å¸–å­æ˜¯å¦@äº†ç»‘å®šè§’è‰² æˆ– è¯é¢˜#åŒ…å«ç»‘å®šè§’è‰²
    const content = p.content || '';
    const topic = (p.topic || '').toLowerCase();
    
    for (const name of boundCharNames) {
      // æ£€æŸ¥ @è§’è‰²å
      if (content.includes(`@${name}`)) return true;
      
      // æ£€æŸ¥ #è§’è‰²å# æˆ– è¯é¢˜å­—æ®µ
      if (content.includes(`#${name}#`) || content.includes(`#${name}`)) return true;
      if (topic.includes(name.toLowerCase())) return true;
    }
    
    return false;
  });
};

// è·å–æ¨èå¸–å­ï¼ˆæ ¹æ®ç»‘å®šè§’è‰²è¿‡æ»¤ï¼‰
const getRecommendPosts = () => {
  const allPosts = (state.socialMedia?.posts || [])
    .filter(p => p.platform === 'xingyu')
    .sort((a, b) => b.createdAt - a.createdAt);
  
  return getFilteredPosts(allPosts);
};

// è·å–çƒ­é—¨å¸–å­ï¼ˆæ ¹æ®ç»‘å®šè§’è‰²è¿‡æ»¤ï¼‰
const getHotPosts = () => {
  const allPosts = (state.socialMedia?.posts || [])
    .filter(p => p.platform === 'xingyu')
    .sort((a, b) => (b.likes + b.comments.length * 2) - (a.likes + a.comments.length * 2));
  
  return getFilteredPosts(allPosts).slice(0, 20);
};
      
            // æ·»åŠ éšæœºç²‰ä¸ï¼ˆå‘å¸–/å›å¤æ—¶è§¦å‘ï¼‰
      const addRandomFollower = (accountId, accountType) => {
        // ç”Ÿæˆéšæœºç²‰ä¸æ˜µç§°
        const fanNames = [
          'æ–°ç²‰æŠ¥åˆ°', 'è·¯è½¬ç²‰äº†', 'è¢«åœˆç²‰çš„è·¯äºº', 'ä»Šæ—¥ä»½å…³æ³¨', 
          'å†²æµªé€‰æ‰‹', 'è¿½æ˜Ÿæ—¥è®°', 'å°é€æ˜ç²‰ä¸', 'å®‰é™å›´è§‚',
          'åˆ·åˆ°å°±å…³æ³¨', 'ç¼˜åˆ†åˆ°äº†', 'å¥½æ„Ÿåº¦+1', 'å…³æ³¨ä¸€ä¸‹'
        ];
        const randomName = fanNames[Math.floor(Math.random() * fanNames.length)] + Math.floor(Math.random() * 10000);
        
        // åˆ›å»ºNPCç²‰ä¸
        const fanId = actions.createNPCAccount({
          platform: 'xingyu',
          username: randomName,
          avatar: '',
          type: 'fan'
        });
        
        // è®©è¿™ä¸ªç²‰ä¸å…³æ³¨è´¦å·
        store.setState(s => {
          let userAccounts = [...(s.socialMedia.userAccounts || [])];
          let characterAccounts = [...(s.socialMedia.characterAccounts || [])];
          
          if (accountType === 'user') {
            userAccounts = userAccounts.map(acc => {
              if (acc.id === accountId) {
                const followers = acc.followers || [];
                return { ...acc, followers: [...followers, fanId] };
              }
              return acc;
            });
          } else if (accountType === 'character') {
            characterAccounts = characterAccounts.map(acc => {
              if (acc.id === accountId) {
                const followers = acc.followers || [];
                return { ...acc, followers: [...followers, fanId] };
              }
              return acc;
            });
          }
          
          return {
            ...s,
            socialMedia: {
              ...s.socialMedia,
              userAccounts,
              characterAccounts
            }
          };
        });
      };
      
      // è§’è‰²å‘å¸–/å›å¤æ—¶å¢åŠ æ›´å¤šç²‰ä¸ï¼ˆç«¥æ˜Ÿç²‰ä¸æ›´å¤šï¼‰
      const addCharacterFollowers = (characterAccountId, character) => {
        // æ ¹æ®è§’è‰²ç±»å‹å†³å®šç²‰ä¸å¢é•¿æ•°é‡
        let fanCount = 1;
        const persona = character?.persona?.toLowerCase() || '';
        
        if (persona.includes('ç«¥æ˜Ÿ') || persona.includes('å°å­©') || persona.includes('å¯çˆ±')) {
          fanCount = Math.floor(Math.random() * 3) + 2; // 2-4ä¸ªç²‰ä¸
        } else if (persona.includes('æ˜æ˜Ÿ') || persona.includes('å¶åƒ') || persona.includes('æ¼”å‘˜')) {
          fanCount = Math.floor(Math.random() * 2) + 1; // 1-2ä¸ªç²‰ä¸
        } else {
          fanCount = Math.random() > 0.5 ? 1 : 0; // 50%æ¦‚ç‡1ä¸ªç²‰ä¸
        }
        
        for (let i = 0; i < fanCount; i++) {
          addRandomFollower(characterAccountId, 'character');
        }
      };
      
      // å‘å¸ƒå¸–å­
      const handleCreatePost = () => {
        if (!postContent.trim() || !activeAccount) return;
        
        actions.createPost({
          platform: 'xingyu',
          authorType: 'user',
          authorId: activeAccount.id,
          content: postContent.trim(),
          topic: postTopic.trim() || null,
          images: []
        });
        
        // å‘å¸–åå¢åŠ ç²‰ä¸ï¼ˆç»‘å®šè§’è‰²çš„è´¦å·æ¶¨æ›´å¤šç²‰ä¸ï¼‰
        const boundCharCount = (activeAccount.boundCharacterIds || []).length;
        if (boundCharCount > 0) {
          // ç»‘å®šäº†è§’è‰²çš„è´¦å·ï¼šå¿…æ¶¨ç²‰ä¸ï¼Œæ•°é‡1-3ä¸ª
          const fanCount = Math.floor(Math.random() * 3) + 1;
          for (let i = 0; i < fanCount; i++) {
            addRandomFollower(activeAccount.id, 'user');
          }
        } else if (Math.random() > 0.5) {
          // æ™®é€šè´¦å·ï¼š50%æ¦‚ç‡æ¶¨1ä¸ª
          addRandomFollower(activeAccount.id, 'user');
        }
        
        setPostContent('');
        setPostTopic('');
        setShowCreatePost(false);
      };
      
      // ç‚¹èµ
      const handleLike = (postId) => {
        if (!activeAccount) return;
        actions.likePost(postId, activeAccount.id);
      };
      
      // è¯„è®º
      const handleComment = (postId) => {
        if (!commentText.trim() || !activeAccount) return;
        
        actions.commentPost(postId, {
          authorType: 'user',
          authorId: activeAccount.id,
          content: commentText.trim()
        });
        
        setCommentText('');
      };
      
      // å…³æ³¨/å–æ¶ˆå…³æ³¨
      const handleToggleFollow = (targetId) => {
        if (!activeAccount) return;
        
        const isFollowing = (activeAccount.following || []).includes(targetId);
        if (isFollowing) {
          actions.unfollowAccount(activeAccount.id, targetId);
        } else {
          actions.followAccount(activeAccount.id, targetId);
        }
      };
      
      // AIç”Ÿæˆè§’è‰²å¸–å­
      const handleGenerateCharacterPost = async (characterAccount) => {
        if (isGenerating) return;
        setIsGenerating(true);
        
        try {
          const character = state.characters.find(c => c.id === characterAccount.characterId);
          if (!character) throw new Error('æ‰¾ä¸åˆ°è§’è‰²');
          
          // è·å–æœ€è¿‘çš„èŠå¤©å†…å®¹ä½œä¸ºå‰§æƒ…å‚è€ƒ
          const recentChats = state.chats
            .filter(c => c.characterIds?.includes(character.id))
            .slice(-1)[0]?.messages?.slice(-10)
            .map(m => m.content)
            .join('\n') || '';
          
          const prompt = `ä½ ç°åœ¨è¦æ¨¡æ‹Ÿè§’è‰²ã€Œ${character.name}ã€åœ¨ç¤¾äº¤å¹³å°ã€Œæ˜Ÿè¯­ã€ä¸Šå‘å¸–ã€‚

ã€è§’è‰²è®¾å®šã€‘
${character.persona || character.name}

ã€è¿‘æœŸå‰§æƒ…/èŠå¤©å†…å®¹æ‘˜è¦ã€‘
${recentChats || 'æš‚æ— '}

ã€å‘å¸–è¦æ±‚ã€‘
1. å®Œå…¨ç¬¦åˆè§’è‰²çš„è¯´è¯é£æ ¼å’Œæ€§æ ¼
2. å†…å®¹è¦åƒçœŸå®çš„ç¤¾äº¤åª’ä½“å¸–å­ï¼Œè‡ªç„¶ã€å£è¯­åŒ–
3. å¯ä»¥é€‚å½“æåŠè¿‘æœŸå‰§æƒ…ä¸­çš„äº‹ä»¶
4. å­—æ•°æ§åˆ¶åœ¨20-150å­—ä¹‹é—´
5. å¯ä»¥ä½¿ç”¨emojiï¼Œä½†ä¸è¦è¿‡å¤š
6. å¯ä»¥å¸¦è¯é¢˜æ ‡ç­¾#xxx#
7. åªèƒ½æåŠèŠå¤©è®°å½•ä¸­å‡ºç°è¿‡çš„äººç‰©ï¼Œä¸è¦ç¼–é€ å…¶ä»–è§’è‰²

ã€è¾“å‡ºæ ¼å¼ã€‘
ç›´æ¥è¾“å‡ºå¸–å­å†…å®¹ï¼Œä¸è¦ä»»ä½•è§£é‡Šã€‚`;

          const messages = [
            { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªè§’è‰²æ‰®æ¼”åŠ©æ‰‹ï¼Œéœ€è¦æ¨¡æ‹Ÿè§’è‰²å‘å¸ƒç¤¾äº¤åª’ä½“å¸–å­ã€‚' },
            { role: 'user', content: prompt }
          ];
          
          const response = await callChatCompletion(state.apiSettings, messages, null);
          
          // æå–è¯é¢˜æ ‡ç­¾
          const topicMatch = response.match(/#([^#]+)#/);
          const topic = topicMatch ? topicMatch[1] : null;
          const content = response.replace(/#[^#]+#/g, '').trim();
          
          actions.createPost({
            platform: 'xingyu',
            authorType: 'character',
            authorId: characterAccount.id,
            content: content,
            topic: topic,
            images: []
          });
          
          // è§’è‰²å‘å¸–åå¢åŠ ç²‰ä¸
          addCharacterFollowers(characterAccount.id, character);
          
        } catch (error) {
          console.error('ç”Ÿæˆå¸–å­å¤±è´¥:', error);
          alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
        } finally {
          setIsGenerating(false);
        }
      };
      
      // AIç”Ÿæˆçƒ­æœ
      const handleGenerateHotSearches = async () => {
        if (isGenerating) return;
        setIsGenerating(true);
        
        try {
          // è·å–å½“å‰è´¦å·ç»‘å®šçš„è§’è‰²
          const boundIds = activeAccount?.boundCharacterIds || [];
          
          // åªè·å–å·²åˆ›å»ºæ˜Ÿè¯­è´¦å·ä¸”åœ¨ç»‘å®šåˆ—è¡¨ä¸­çš„è§’è‰²
          let charactersWithAccount = state.characters.filter(c => 
            state.socialMedia?.characterAccounts?.some(
              acc => acc.characterId === c.id && acc.platform === 'xingyu'
            )
          );
          
          // å¦‚æœå½“å‰è´¦å·æœ‰ç»‘å®šè§’è‰²ï¼Œåˆ™åªä½¿ç”¨ç»‘å®šçš„è§’è‰²
          if (boundIds.length > 0) {
            charactersWithAccount = charactersWithAccount.filter(c => boundIds.includes(c.id));
          }
          
          const characterNames = charactersWithAccount.map(c => `${c.name}: ${c.persona?.slice(0, 50) || ''}`).join('\n') || 'æš‚æ— è§’è‰²';
          
          const prompt = `ä½ ç°åœ¨è¦ä¸ºç¤¾äº¤å¹³å°ã€Œæ˜Ÿè¯­ã€ç”Ÿæˆä»Šæ—¥çƒ­æœæ¦œã€‚

ã€ä¸–ç•Œè§‚ä¸­çš„ä¸»è¦è§’è‰²ã€‘
${characterNames || 'æš‚æ— è§’è‰²'}

ã€ç”Ÿæˆè¦æ±‚ã€‘
1. ç”Ÿæˆ8æ¡çƒ­æœè¯é¢˜
2. è¯é¢˜è¦å¤šæ ·åŒ–ï¼šè§’è‰²ç›¸å…³ã€æ—¥å¸¸è¶£äº‹ã€å¨±ä¹å…«å¦ç­‰
3. éƒ¨åˆ†è¯é¢˜ä¸è§’è‰²ç›¸å…³ï¼Œéƒ¨åˆ†æ˜¯é€šç”¨çƒ­ç‚¹
4. æ¯æ¡çƒ­æœé…ä¸Šçƒ­åº¦æ ‡ç­¾ï¼šhot(çƒ­)ã€new(æ–°)ã€boom(çˆ†)
5. çƒ­åº¦æ•°å€¼ç”¨æ•´æ•°ï¼ŒèŒƒå›´100-9999

ã€è¾“å‡ºæ ¼å¼ã€‘
ç”¨JSONæ•°ç»„æ ¼å¼è¾“å‡ºï¼Œä¸è¦å…¶ä»–å†…å®¹ï¼š
[{"title": "çƒ­æœæ ‡é¢˜", "heat": 999, "tag": "hot"}]`;

          const messages = [
            { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªç¤¾äº¤åª’ä½“çƒ­æœç”ŸæˆåŠ©æ‰‹ï¼Œåªè¾“å‡ºJSONæ ¼å¼æ•°æ®ã€‚' },
            { role: 'user', content: prompt }
          ];
          
          const response = await callChatCompletion(state.apiSettings, messages, null);
          
          // è§£æJSON
          const jsonMatch = response.match(/\[[\s\S]*\]/);
          if (jsonMatch) {
            const hotSearches = JSON.parse(jsonMatch[0]);
            actions.updateHotSearches('xingyu', hotSearches.map((h, i) => ({
              ...h,
              rank: i + 1
            })));
          }
          
        } catch (error) {
          console.error('ç”Ÿæˆçƒ­æœå¤±è´¥:', error);
          alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
        } finally {
          setIsGenerating(false);
        }
      };
      
      // æ ¼å¼åŒ–æ—¶é—´
      const formatTime = (timestamp) => {
        const now = Date.now();
        const diff = now - timestamp;
        
        if (diff < 60000) return 'åˆšåˆš';
        if (diff < 3600000) return `${Math.floor(diff / 60000)}åˆ†é’Ÿå‰`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}å°æ—¶å‰`;
        return new Date(timestamp).toLocaleDateString('zh-CN');
      };
      
      // æ ¼å¼åŒ–æ•°å­—
      const formatNumber = (num) => {
        if (num >= 10000) return (num / 10000).toFixed(1) + 'ä¸‡';
        return num.toString();
      };
      
      // åˆ›å»ºè´¦å·é¡µé¢
      const CreateAccountPage = () => {
        const [accountName, setAccountName] = useState('');
        const [accountBio, setAccountBio] = useState('');
        const [selectedPersona, setSelectedPersona] = useState(null);
        const [boundCharacterIds, setBoundCharacterIds] = useState([]);
        const [showCharacterSection, setShowCharacterSection] = useState(false);
        
        const handleCreate = () => {
          if (!accountName.trim()) return;
          
          const accountId = actions.createUserAccount({
            platform: 'xingyu',
            personaId: selectedPersona,
            username: accountName.trim(),
            avatar: state.userPersonas.find(p => p.id === selectedPersona)?.avatar || '',
            bio: accountBio.trim(),
            following: [],
            followers: [],
            boundCharacterIds: boundCharacterIds
          });
          
          // è®¾ç½®ä¸ºå½“å‰è´¦å·
          actions.setActiveAccount(accountId);
          
          // è‡ªåŠ¨å…³æ³¨å·²ç»‘å®šçš„è§’è‰²è´¦å·
          boundCharacterIds.forEach(charId => {
            const charAccount = state.socialMedia?.characterAccounts?.find(
              a => a.characterId === charId && a.platform === 'xingyu'
            );
            if (charAccount) {
              actions.followAccount(accountId, charAccount.id);
            }
          });
          
          setCurrentPage('home');
        };
        
        // ä¸ºè§’è‰²åˆ›å»ºè´¦å·ï¼ˆä¸å½±å“ç”¨æˆ·è¾“å…¥ï¼‰
        const handleCreateCharacterAccount = (char) => {
          const charAccountId = actions.createCharacterAccount({
            platform: 'xingyu',
            characterId: char.id,
            username: `${char.name}official`,
            avatar: char.avatar || '',
            bio: char.persona?.slice(0, 50) || '',
            isVerified: true,
            following: [],
            followers: []
          });
          
          // ä¸ºè§’è‰²ç”Ÿæˆä¸€äº›åˆå§‹ç²‰ä¸
          const fanCount = Math.floor(Math.random() * 5) + 3;
          const fanNames = ['å°è¿·å¦¹', 'å¤´å·ç²‰ä¸', 'è¿½æ˜Ÿå°‘å¥³', 'æ°¸è¿œæ”¯æŒä½ ', 'é¢œæ§æœ¬æ§', 'è€ç²‰æŠ¥åˆ°', 'æ–°æ™‹é¥­åœˆäºº', 'åº”æ´ç«™', 'æ•°æ®ç»„'];
          
          for (let i = 0; i < fanCount; i++) {
            const fanName = fanNames[Math.floor(Math.random() * fanNames.length)] + Math.floor(Math.random() * 10000);
            const fanId = actions.createNPCAccount({
              platform: 'xingyu',
              username: fanName,
              avatar: '',
              type: 'fan'
            });
            
            store.setState(s => ({
              ...s,
              socialMedia: {
                ...s.socialMedia,
                characterAccounts: s.socialMedia.characterAccounts.map(acc => {
                  if (acc.id === charAccountId) {
                    const followers = acc.followers || [];
                    return { ...acc, followers: [...followers, fanId] };
                  }
                  return acc;
                })
              }
            }));
          }
          
          // å¦‚æœå½“å‰æœ‰æ´»è·ƒè´¦å·ï¼Œè‡ªåŠ¨å…³æ³¨è¿™ä¸ªè§’è‰²
          // if (activeAccount) {
          // actions.followAccount(activeAccount.id, charAccountId);
          // }
        };
        
        return (
          <div className="flex-1 overflow-y-auto p-4">
            {/* ç¬¬ä¸€éƒ¨åˆ†ï¼šåˆ›å»ºç”¨æˆ·è´¦å· */}
            <div className="bg-white rounded-2xl p-6 space-y-4 shadow-sm">
              <h2 className="text-xl font-bold text-center mb-2">âœ¨ åˆ›å»ºæ˜Ÿè¯­è´¦å·</h2>
              <p className="text-xs text-gray-400 text-center mb-4">åˆ›å»ºä½ è‡ªå·±çš„ç¤¾äº¤è´¦å·</p>
              
              <div>
                <label className="block text-sm text-gray-600 mb-1">è´¦å·åç§° *</label>
                <input
                  type="text"
                  value={accountName}
                  onChange={(e) => setAccountName(e.target.value)}
                  className="w-full p-3 bg-gray-100 rounded-xl"
                  placeholder="ç»™ä½ çš„è´¦å·èµ·ä¸ªåå­—"
                />
              </div>
              
              <div>
                <label className="block text-sm text-gray-600 mb-1">ä¸ªäººç®€ä»‹</label>
                <textarea
                  value={accountBio}
                  onChange={(e) => setAccountBio(e.target.value)}
                  className="w-full p-3 bg-gray-100 rounded-xl h-20 resize-none"
                  placeholder="ä»‹ç»ä¸€ä¸‹è‡ªå·±å§~"
                />
              </div>
              
              <div>
                <label className="block text-sm text-gray-600 mb-2">å…³è”ç”¨æˆ·äººè®¾ï¼ˆå¯é€‰ï¼‰</label>
                <div className="space-y-2 max-h-32 overflow-y-auto">
                  {state.userPersonas.length === 0 ? (
                    <p className="text-gray-400 text-sm text-center py-2">æš‚æ— ç”¨æˆ·äººè®¾ï¼Œè¯·å…ˆåœ¨é€šè®¯å½•åˆ›å»º</p>
                  ) : (
                    state.userPersonas.map(persona => (
                      <button
                        key={persona.id}
                        onClick={() => setSelectedPersona(selectedPersona === persona.id ? null : persona.id)}
                        className={`w-full p-3 rounded-xl flex items-center gap-3 border-2 ${
                          selectedPersona === persona.id ? 'border-orange-500 bg-orange-50' : 'border-gray-200'
                        }`}
                      >
                        <div className="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-cyan-400 flex items-center justify-center overflow-hidden">
                          {persona.avatar ? (
                            <img src={persona.avatar} alt="" className="w-full h-full object-cover" />
                          ) : (
                            <span className="text-white font-bold">{persona.name[0]}</span>
                          )}
                        </div>
                        <span className="flex-1 text-left">{persona.name}</span>
                        {selectedPersona === persona.id && (
                          <Icon name="Check" size={20} className="text-orange-500" />
                        )}
                      </button>
                    ))
                  )}
                </div>
              </div>
              
              {/* ç»‘å®šAIè§’è‰² */}
              <div>
                <label className="block text-sm text-gray-600 mb-1">ğŸ­ ç»‘å®šAIè§’è‰²ï¼ˆå†³å®šèƒ½çœ‹åˆ°å“ªäº›å†…å®¹ï¼‰</label>
                <p className="text-xs text-gray-400 mb-2">é€‰æ‹©åï¼Œåˆ·æ–°å¸–å­åªä¼šå‡ºç°è¿™äº›è§’è‰²ç›¸å…³çš„å†…å®¹</p>
                <div className="space-y-2 max-h-40 overflow-y-auto">
                  {state.characters.length === 0 ? (
                    <p className="text-gray-400 text-sm text-center py-2">æš‚æ— AIè§’è‰²ï¼Œè¯·å…ˆåœ¨é€šè®¯å½•åˆ›å»º</p>
                  ) : (
                    state.characters.map(char => {
                      const isSelected = boundCharacterIds.includes(char.id);
                      return (
                        <button
                          key={char.id}
                          onClick={() => {
                            if (isSelected) {
                              setBoundCharacterIds(boundCharacterIds.filter(id => id !== char.id));
                            } else {
                              setBoundCharacterIds([...boundCharacterIds, char.id]);
                            }
                          }}
                          className={`w-full p-3 rounded-xl flex items-center gap-3 border-2 ${
                            isSelected ? 'border-purple-500 bg-purple-50' : 'border-gray-200'
                          }`}
                        >
                          <div className="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center overflow-hidden">
                            {char.avatar ? (
                              <img src={char.avatar} alt="" className="w-full h-full object-cover" />
                            ) : (
                              <span className="text-white font-bold">{char.name[0]}</span>
                            )}
                          </div>
                          <div className="flex-1 text-left">
                            <span className="font-medium">{char.name}</span>
                          </div>
                          {isSelected && (
                            <Icon name="Check" size={20} className="text-purple-500" />
                          )}
                        </button>
                      );
                    })
                  )}
                </div>
                {boundCharacterIds.length === 0 ? (
                  <p className="text-xs text-orange-500 mt-2">âš ï¸ æœªç»‘å®šè§’è‰²ï¼Œå°†çœ‹åˆ°æ‰€æœ‰å†…å®¹</p>
                ) : (
                  <p className="text-xs text-purple-500 mt-2">âœ“ å·²ç»‘å®š {boundCharacterIds.length} ä¸ªè§’è‰²</p>
                )}
              </div>
              
              <button
                onClick={handleCreate}
                disabled={!accountName.trim()}
                className={`w-full py-3 rounded-xl font-semibold ${
                  accountName.trim() 
                    ? 'bg-gradient-to-r from-orange-400 to-pink-500 text-white' 
                    : 'bg-gray-200 text-gray-400'
                }`}
              >
                åˆ›å»ºæˆ‘çš„è´¦å·
              </button>
            </div>
            
            {/* åˆ†éš”çº¿ */}
            <div className="flex items-center gap-4 my-6">
              <div className="flex-1 h-px bg-gray-300"></div>
              <span className="text-gray-400 text-sm">æˆ–</span>
              <div className="flex-1 h-px bg-gray-300"></div>
            </div>
            
            {/* ç¬¬äºŒéƒ¨åˆ†ï¼šä¸ºè§’è‰²åˆ›å»ºè´¦å·ï¼ˆç‹¬ç«‹åŒºå—ï¼‰ */}
            <div className="bg-white rounded-2xl p-6 shadow-sm">
              <div 
                className="flex items-center justify-between cursor-pointer"
                onClick={() => setShowCharacterSection(!showCharacterSection)}
              >
                <div>
                  <h3 className="font-semibold text-lg">ğŸ­ ä¸ºAIè§’è‰²åˆ›å»ºè´¦å·</h3>
                  <p className="text-sm text-gray-500">è®©ä½ çš„AIè§’è‰²ä¹Ÿèƒ½å‘å¸–äº’åŠ¨</p>
                </div>
                <Icon 
                  name={showCharacterSection ? "ChevronUp" : "ChevronDown"} 
                  size={24} 
                  className="text-gray-400" 
                />
              </div>
              
              {showCharacterSection && (
                <div className="mt-4 space-y-2 border-t pt-4">
                  {state.characters.length === 0 ? (
                    <p className="text-gray-400 text-sm text-center py-4">æš‚æ— AIè§’è‰²ï¼Œè¯·å…ˆåœ¨é€šè®¯å½•åˆ›å»º</p>
                  ) : (
                    state.characters.map(char => {
                      const hasAccount = state.socialMedia?.characterAccounts?.some(
                        a => a.characterId === char.id && a.platform === 'xingyu'
                      );
                      
                      return (
                        <div key={char.id} className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                          <div className="w-12 h-12 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center overflow-hidden">
                            {char.avatar ? (
                              <img src={char.avatar} alt="" className="w-full h-full object-cover" />
                            ) : (
                              <span className="text-white font-bold">{char.name[0]}</span>
                            )}
                          </div>
                          <div className="flex-1">
                            <span className="font-medium">{char.name}</span>
                            <p className="text-xs text-gray-400 truncate">{char.persona?.slice(0, 25) || 'æš‚æ— ç®€ä»‹'}</p>
                          </div>
                          {hasAccount ? (
                            <span className="text-green-500 text-sm font-medium">âœ“ å·²åˆ›å»º</span>
                          ) : (
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                handleCreateCharacterAccount(char);
                              }}
                              className="px-4 py-2 bg-purple-500 text-white text-sm rounded-lg font-medium"
                            >
                              åˆ›å»º
                            </button>
                          )}
                        </div>
                      );
                    })
                  )}
                </div>
              )}
            </div>
            
            {/* åº•éƒ¨è¯´æ˜ */}
            <div className="mt-6 p-4 bg-blue-50 rounded-xl">
              <h4 className="font-medium text-blue-700 mb-2">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h4>
              <ul className="text-xs text-blue-600 space-y-1">
                <li>â€¢ <strong>ç”¨æˆ·è´¦å·</strong>ï¼šä½ è‡ªå·±çš„èº«ä»½ï¼Œå¯ä»¥å‘å¸–ã€è¯„è®º</li>
                <li>â€¢ <strong>ç»‘å®šè§’è‰²</strong>ï¼šå†³å®šåˆ·æ–°æ—¶çœ‹åˆ°å“ªäº›è§’è‰²çš„å†…å®¹ï¼ˆé˜²æ­¢ä¸²å°ï¼‰</li>
                <li>â€¢ <strong>è§’è‰²è´¦å·</strong>ï¼šAIè§’è‰²çš„ç¤¾äº¤è´¦å·ï¼Œå¯ä»¥AIè‡ªåŠ¨å‘å¸–</li>
                <li>â€¢ ä½ å¯ä»¥åˆ›å»ºå¤šä¸ªå°å·ï¼Œåˆ‡æ¢ä¸åŒä¸–ç•Œè§‚</li>
                <li>â€¢ <strong>æ³¨æ„</strong>ï¼šåœ¨åˆ›å»ºè§’è‰²æ—¶å¦‚æœä½ å·²ç»è¾“å…¥äº†å†…å®¹ä¸è¦ç‚¹å‡»ç»™aiåˆ›å»ºè§’è‰²ï¼Œä¼šæ¸…ç©ºä½ å·²ç»è¾“å…¥çš„å†…å®¹ï¼Œå¦‚æœå·²ç»è¿›å…¥éœ€è¦ç»™æ–°è§’è‰²åˆ›å»ºè´¦å·ä¹Ÿå¯ä»¥ç‚¹å‡»åˆ›å»ºå°å·æ¥ç»™æ–°è§’è‰²åˆ›å»ºè´¦å·</li>
              </ul>
            </div>
            
            {/* åº•éƒ¨é—´è· */}
            <div className="h-8"></div>
          </div>
        );
      };
      
      // å¸–å­å¡ç‰‡ç»„ä»¶
      const PostCard = ({ post, showFull = false }) => {
        const account = getAccountById(post.authorId, post.authorType);
        const isLiked = activeAccount && post.likedBy?.includes(activeAccount.id);
        const isFollowing = activeAccount && (activeAccount.following || []).includes(post.authorId);
        
        // ç‚¹å‡»å¤´åƒ/ç”¨æˆ·åæŸ¥çœ‹ä¸»é¡µ
        const handleViewProfile = (e) => {
          e.stopPropagation();
          if (post.authorType !== 'user' || post.authorId !== activeAccount?.id) {
            setViewingProfile({ accountId: post.authorId, accountType: post.authorType });
            setCurrentPage('userProfile');
          }
        };
        
        return (
          <div className="bg-white p-4 border-b border-gray-100">
            {/* ä½œè€…ä¿¡æ¯ */}
            <div className="flex items-start gap-3">
              <button 
                onClick={handleViewProfile}
                className="w-10 h-10 rounded-full bg-gradient-to-br from-orange-400 to-pink-500 flex items-center justify-center overflow-hidden flex-shrink-0"
              >
                {account?.avatar ? (
                  <img src={account.avatar} alt="" className="w-full h-full object-cover" />
                ) : (
                  <span className="text-white font-bold text-sm">{account?.username?.[0] || '?'}</span>
                )}
              </button>
              
              <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2">
                  <button 
                    onClick={handleViewProfile}
                    className="font-semibold text-gray-800 truncate hover:text-orange-500"
                  >
                    {account?.username || 'æœªçŸ¥ç”¨æˆ·'}
                  </button>
                  {account?.isVerified && (
                    <span className="text-orange-500 text-xs">âœ“</span>
                  )}
                  {post.authorType === 'character' && (
                    <span className="text-xs bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded">è§’è‰²</span>
                  )}
                </div>
                <p className="text-xs text-gray-400">{formatTime(post.createdAt)}</p>
              </div>
              
              {/* å…³æ³¨æŒ‰é’® */}
              {activeAccount && post.authorId !== activeAccount.id && (
                <button
                  onClick={(e) => { e.stopPropagation(); handleToggleFollow(post.authorId); }}
                  className={`px-3 py-1 rounded-full text-xs font-medium ${
                    isFollowing 
                      ? 'bg-gray-100 text-gray-600' 
                      : 'bg-orange-500 text-white'
                  }`}
                >
                  {isFollowing ? 'å·²å…³æ³¨' : 'å…³æ³¨'}
                </button>
              )}
            </div>
            
            {/* å¸–å­å†…å®¹ */}
            <div 
              className="mt-3 text-gray-800 text-sm leading-relaxed cursor-pointer"
              onClick={() => { setSelectedPost(post); setCurrentPage('detail'); }}
            >
              <p className={showFull ? '' : 'line-clamp-6'}>{post.content}</p>
              {post.topic && (
                <span className="text-orange-500 mt-1 inline-block">#{post.topic}#</span>
              )}
            </div>
            
            {/* äº’åŠ¨æ  */}
            <div className="flex items-center gap-6 mt-3 pt-3 border-t border-gray-50">
              <button 
                onClick={(e) => { e.stopPropagation(); handleLike(post.id); }}
                className={`flex items-center gap-1 text-sm ${isLiked ? 'text-red-500' : 'text-gray-400'}`}
              >
                <Icon name="Heart" size={18} className={isLiked ? 'fill-current' : ''} />
                <span>{formatNumber(post.likes || 0)}</span>
              </button>
              
              <button 
                onClick={(e) => { e.stopPropagation(); setSelectedPost(post); setCurrentPage('detail'); }}
                className="flex items-center gap-1 text-sm text-gray-400"
              >
                <Icon name="MessageCircle" size={18} />
                <span>{post.comments?.length || 0}</span>
              </button>
              
              <button 
  onClick={(e) => { 
    e.stopPropagation(); 
    setSharingPost(post);
    setShowShareModal(true);
  }}
  className="flex items-center gap-1 text-sm text-gray-400 active:text-orange-500"
>
  <Icon name="Repeat2" size={18} />
  <span>{formatNumber(post.reposts || 0)}</span>
</button>
              
              <span className="text-xs text-gray-300 ml-auto">{formatNumber(post.views || 0)}é˜…è¯»</span>
            </div>
          </div>
        );
      };
      
      // çƒ­æœé¡µé¢
      const HotSearchPage = () => {
        const hotSearches = state.socialMedia?.hotSearches?.xingyu || [];
        
        return (
          <div className="flex-1 overflow-y-auto">
            {/* ç”Ÿæˆçƒ­æœæŒ‰é’® */}
            <div className="p-4 bg-white border-b">
              <button
                onClick={handleGenerateHotSearches}
                disabled={isGenerating}
                className="w-full py-3 bg-gradient-to-r from-orange-400 to-pink-500 text-white rounded-xl font-medium flex items-center justify-center gap-2"
              >
                {isGenerating ? (
                  <>
                    <Icon name="Loader2" size={18} className="animate-spin" />
                    ç”Ÿæˆä¸­...
                  </>
                ) : (
                  <>
                    <Icon name="Sparkles" size={18} />
                    AIç”Ÿæˆä»Šæ—¥çƒ­æœ
                  </>
                )}
              </button>
            </div>
            
            {/* çƒ­æœåˆ—è¡¨ */}
            <div className="bg-white">
              <h2 className="px-4 py-3 font-semibold border-b flex items-center gap-2">
                <span className="text-orange-500">ğŸ”¥</span>
                æ˜Ÿè¯­çƒ­æœ
              </h2>
              
              {hotSearches.length === 0 ? (
                <div className="p-8 text-center text-gray-400">
                  <Icon name="TrendingUp" size={48} className="mx-auto mb-2 opacity-30" />
                  <p>æš‚æ— çƒ­æœ</p>
                  <p className="text-sm mt-1">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆ</p>
                </div>
              ) : (
                <div className="divide-y divide-gray-50">
                  {hotSearches.map((item, index) => (
                    <div key={index} className="flex items-center gap-3 p-4 active:bg-gray-50">
                      <span className={`w-6 text-center font-bold ${
                        index < 3 ? 'text-orange-500' : 'text-gray-400'
                      }`}>
                        {index + 1}
                      </span>
                      <span className="flex-1 text-gray-800">{item.title}</span>
                      {item.tag === 'hot' && (
                        <span className="text-xs bg-red-100 text-red-500 px-1.5 py-0.5 rounded">çƒ­</span>
                      )}
                      {item.tag === 'new' && (
                        <span className="text-xs bg-blue-100 text-blue-500 px-1.5 py-0.5 rounded">æ–°</span>
                      )}
                      {item.tag === 'boom' && (
                        <span className="text-xs bg-orange-100 text-orange-500 px-1.5 py-0.5 rounded">çˆ†</span>
                      )}
                      <span className="text-xs text-gray-400">{formatNumber(item.heat)}çƒ­åº¦</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        );
      };
      
                  // å¸–å­è¯¦æƒ…é¡µ
      const PostDetailPage = () => {
  const [isLoadingComments, setIsLoadingComments] = useState(false);
  const [hasGeneratedComments, setHasGeneratedComments] = useState(false);
  const [localCommentText, setLocalCommentText] = useState('');
  const [isAIReplying, setIsAIReplying] = useState(false);
  const [aiReplyingTo, setAiReplyingTo] = useState(null);
  const [showShareModalDetail, setShowShareModalDetail] = useState(false);
  const [replyNotification, setReplyNotification] = useState(null); // å›å¤æç¤º
        
        if (!selectedPost) return null;
        const account = getAccountById(selectedPost.authorId, selectedPost.authorType);
        
        const currentPost = state.socialMedia?.posts?.find(p => p.id === selectedPost.id) || selectedPost;
        
        // è·å–å¸–å­ä½œè€…çš„è§’è‰²ä¿¡æ¯
        const getPostAuthorCharacter = () => {
          if (selectedPost.authorType === 'character') {
            const charAccount = state.socialMedia?.characterAccounts?.find(a => a.id === selectedPost.authorId);
            if (charAccount) {
              return state.characters.find(c => c.id === charAccount.characterId);
            }
          }
          return null;
        };
        
        // AIè§’è‰²å›å¤è¯„è®º
        const handleAIReplyToComment = async (targetComment, character, charAccount, skipStateManagement = false) => {
          if (!skipStateManagement) {
            if (isAIReplying) return false;
            setIsAIReplying(true);
            setAiReplyingTo(targetComment.id);
          }
          
          try {
            // è·å–è¢«å›å¤è€…çš„çœŸå®ç”¨æˆ·å
const commenterAccount = getAccountById(targetComment.authorId, targetComment.authorType) ||
  state.socialMedia?.npcAccounts?.find(a => a.id === targetComment.authorId);
const commenterName = commenterAccount?.username || 'ç½‘å‹';
            
            // ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯æˆ–é»˜è®¤æç¤ºè¯
            const customPrompt = state.apiSettings.xingyuCharacterReplyPrompt || `ã€è§’è‰²å›å¤è¯„è®ºè§„åˆ™ã€‘
1. åˆ¤æ–­æ˜¯å¦å›å¤ï¼šæ˜æ˜Ÿ/é«˜å†·äººè®¾çº¦30%æ¦‚ç‡å›å¤ï¼Œäº²æ°‘äººè®¾çº¦70%æ¦‚ç‡å›å¤
2. æ¶æ„è¯„è®ºä¸å›å¤ï¼Œå¤ªæ™®é€šçš„è¯„è®ºå¯èƒ½ä¸å›å¤
3. å›å¤è¦ç¬¦åˆè§’è‰²æ€§æ ¼ï¼Œ5-50å­—
4. ä¸å›å¤åˆ™è¾“å‡ºï¼š[ä¸å›å¤]`;
            
            // åˆ¤æ–­è¯„è®ºè€…å’Œå¸–å­ä½œè€…çš„å…³ç³»
            const postAuthorAccount = getAccountById(currentPost.authorId, currentPost.authorType) ||
              state.socialMedia?.npcAccounts?.find(a => a.id === currentPost.authorId);
            const isCommentFromPostAuthor = currentPost.authorId === targetComment.authorId;
            const postAuthorName = postAuthorAccount?.username || 'æŸç½‘å‹';
            
            // è·å–è¯„è®ºè€…çš„äººè®¾ï¼ˆå¦‚æœæ˜¯ç”¨æˆ·ï¼‰
            let commenterPersonaInfo = '';
            if (targetComment.authorType === 'user') {
              const commenterUserAccount = state.socialMedia?.userAccounts?.find(a => a.id === targetComment.authorId);
              if (commenterUserAccount?.personaId) {
                const persona = state.userPersonas.find(p => p.id === commenterUserAccount.personaId);
                if (persona) {
                  commenterPersonaInfo = `\nâš ï¸ ã€é‡è¦ã€‘${commenterName}çš„çœŸå®èº«ä»½æ˜¯ï¼š${persona.persona || persona.name}\nä½ è®¤è¯†è¿™ä¸ªäººï¼è¯·æ ¹æ®å…³ç³»ç§°å‘¼ï¼ˆå¦‚æœæ˜¯å¦ˆå¦ˆå°±å«"éº»éº»"ï¼Œå¦‚æœæ˜¯çˆ¸çˆ¸å°±å«"ç²‘ç²‘"ç­‰ï¼‰`;
                }
              }
              if (!commenterPersonaInfo && commenterUserAccount?.bio) {
                commenterPersonaInfo = `\nã€è¯„è®ºè€…ç®€ä»‹ã€‘${commenterUserAccount.bio}`;
              }
            }
            
            // è·å–è§’è‰²å¹´é¾„æç¤º
            const charAge = character.age || 20;
            let ageHint = '';
            if (charAge <= 6) {
              ageHint = `\nã€å¹´é¾„æç¤ºã€‘ä½ æ˜¯${charAge}å²çš„å°å®å®ï¼Œè¯´è¯è¦å¥¶å£°å¥¶æ°”ã€å¯çˆ±æ’’å¨‡ï¼Œå«å¦ˆå¦ˆä¸º"éº»éº»"ï¼Œå«çˆ¸çˆ¸ä¸º"ç²‘ç²‘"`;
            } else if (charAge <= 12) {
              ageHint = `\nã€å¹´é¾„æç¤ºã€‘ä½ æ˜¯${charAge}å²çš„å°æœ‹å‹ï¼Œè¯´è¯æ´»æ³¼å¯çˆ±`;
            }
            
            const prompt = `ä½ ç°åœ¨æ‰®æ¼”è§’è‰²ã€Œ${character.name}ã€ï¼Œéœ€è¦å†³å®šæ˜¯å¦å›å¤è¯„è®ºã€‚
${ageHint}

ã€è§’è‰²è®¾å®šã€‘
${character.persona || character.name}

ã€å¸–å­ä¿¡æ¯ã€‘
- å¸–å­ä½œè€…ï¼š${postAuthorName}
- å¸–å­å†…å®¹ï¼š${currentPost.content.slice(0, 100)}

ã€è¦å›å¤çš„è¯„è®ºã€‘
- è¯„è®ºè€…ï¼š${commenterName}${isCommentFromPostAuthor ? 'ï¼ˆå°±æ˜¯å¸–å­ä½œè€…ï¼‰' : 'ï¼ˆè¯„è®ºåŒºçš„ç½‘å‹ï¼‰'}
- è¯„è®ºå†…å®¹ï¼š${targetComment.content}
${commenterPersonaInfo}

ã€é‡è¦æç¤ºã€‘
- ä½ è¦å›å¤çš„æ˜¯ã€Œ${commenterName}ã€çš„è¿™æ¡è¯„è®ºï¼Œä¸æ˜¯å¸–å­æœ¬èº«
- ${commenterName}${isCommentFromPostAuthor ? 'æ˜¯å‘å¸–çš„äºº' : 'æ˜¯è¯„è®ºåŒºçš„ä¸€ä¸ªç½‘å‹/ç²‰ä¸'}
- å›å¤è¦é’ˆå¯¹è¯„è®ºå†…å®¹ï¼Œä¸è¦é‡å¤å›å¤å¸–å­å†…å®¹

${customPrompt}`;

            const messages = [
              { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªè§’è‰²æ‰®æ¼”åŠ©æ‰‹ï¼Œæ¨¡æ‹Ÿè§’è‰²åœ¨ç¤¾äº¤åª’ä½“ä¸Šå›å¤è¯„è®ºã€‚' },
              { role: 'user', content: prompt }
            ];
            
            const response = await callChatCompletion(state.apiSettings, messages, null);
            
            // æ£€æŸ¥æ˜¯å¦å†³å®šå›å¤
            if (response.trim() === '[ä¸å›å¤]' || response.includes('[ä¸å›å¤]')) {
              return false;
            }
            
            // å»¶è¿Ÿæ¨¡æ‹ŸçœŸå®å›å¤
            await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
            
            // æ·»åŠ è§’è‰²çš„å›å¤
            actions.commentPost(currentPost.id, {
              authorType: 'character',
              authorId: charAccount.id,
              content: response.trim().replace('[ä¸å›å¤]', '').slice(0, 100),
              replyTo: {
                commentId: targetComment.id,
                username: commenterName
              }
            });
            
            // å¦‚æœå›å¤çš„æ˜¯å½“å‰ç”¨æˆ·çš„è¯„è®ºï¼Œæ˜¾ç¤ºæç¤º
            if (targetComment.authorType === 'user' && targetComment.authorId === activeAccount?.id) {
              setReplyNotification({
                characterName: character.name,
                content: response.trim().replace('[ä¸å›å¤]', '').slice(0, 50)
              });
              // 3ç§’åè‡ªåŠ¨éšè—
              setTimeout(() => setReplyNotification(null), 4000);
            }
            
            return true;
            
          } catch (error) {
            console.error('AIå›å¤å¤±è´¥:', error);
            return false;
          } finally {
            if (!skipStateManagement) {
              setIsAIReplying(false);
              setAiReplyingTo(null);
            }
          }
        };
        
        // æ‰¹é‡è®©è§’è‰²å›å¤å¤šæ¡è¯„è®º
        const handleAIReplyToMultipleComments = async (comments, character, charAccount) => {
          // éšæœºæ‰“ä¹±è¯„è®ºé¡ºåº
          const shuffled = [...comments].sort(() => Math.random() - 0.5);
          
          // æ ¹æ®è§’è‰²äººè®¾å†³å®šå›å¤æ•°é‡ï¼ˆ1-3æ¡ï¼‰
          const maxReplies = Math.floor(Math.random() * 3) + 1;
          let repliedCount = 0;
          
          for (const comment of shuffled) {
            if (repliedCount >= maxReplies) break;
            
            // è·³è¿‡è§’è‰²è‡ªå·±çš„è¯„è®º
            if (comment.authorType === 'character' && comment.authorId === charAccount.id) continue;
            
            const replied = await handleAIReplyToComment(comment, character, charAccount);
            if (replied) {
              repliedCount++;
              // å›å¤ä¹‹é—´é—´éš”ä¸€ä¸‹
              await new Promise(resolve => setTimeout(resolve, 500));
            }
          }
        };
        
        // è‡ªåŠ¨ç”Ÿæˆè¯„è®º
        const generateComments = async () => {
          if (isLoadingComments || hasGeneratedComments) return;
          if ((currentPost.comments?.length || 0) >= 3) {
            setHasGeneratedComments(true);
            return;
          }
          
          setIsLoadingComments(true);
          
          try {
            // è·å–å½“å‰è´¦å·ç»‘å®šçš„è§’è‰²
            const boundIds = activeAccount?.boundCharacterIds || [];
            
            // åªè·å–å·²åˆ›å»ºæ˜Ÿè¯­è´¦å·ä¸”åœ¨ç»‘å®šåˆ—è¡¨ä¸­çš„è§’è‰²
            let charactersWithAccount = state.characters.filter(c => 
              state.socialMedia?.characterAccounts?.some(
                acc => acc.characterId === c.id && acc.platform === 'xingyu'
              )
            );
            
            // å¦‚æœå½“å‰è´¦å·æœ‰ç»‘å®šè§’è‰²ï¼Œåˆ™åªä½¿ç”¨ç»‘å®šçš„è§’è‰²
            if (boundIds.length > 0) {
              charactersWithAccount = charactersWithAccount.filter(c => boundIds.includes(c.id));
            }
            
            const characterNames = charactersWithAccount.map(c => c.name).join('ã€') || 'æš‚æ— ';
            const postAuthorChar = getPostAuthorCharacter();
            
            const customPrompt = state.apiSettings.xingyuCommentPrompt || '';
            
            // è·å–è§’è‰²å¹´é¾„ï¼Œå†³å®šç²‰ä¸ç±»å‹
            let fanTypeDescription = 'ç²‰ä¸ç±»å‹å¤šæ ·ï¼šç‹‚çƒ­ç²‰ä¸ã€æ™®é€šè·¯äººã€åƒç“œç¾¤ä¼—ç­‰';
            if (postAuthorChar) {
              const charAge = postAuthorChar.age || 20;
              if (charAge <= 6) {
                fanTypeDescription = `ã€é‡è¦ã€‘${postAuthorChar.name}æ‰${charAge}å²ï¼Œæ˜¯ä¸ªå°å®å®/å°ç«¥æ˜Ÿï¼
ç²‰ä¸ç±»å‹åº”è¯¥æ˜¯ï¼šå¦ˆå¦ˆç²‰ã€é˜¿å§¨ç²‰ã€å§¨æ¯ç¬‘ç²‰ä¸
ç§°å‘¼è‡ªå·±ä¸ºï¼šé˜¿å§¨ã€å”å”ã€å§¨å§¨
ç²‰ä¸è¯­æ°”ï¼šç–¼çˆ±ã€å¿ƒè½¯ã€æ¯çˆ±æ³›æ»¥ï¼Œå¦‚"æˆ‘çš„å°å®è´""é˜¿å§¨çœ‹äº†å¿ƒéƒ½åŒ–äº†""å¤ªå¯çˆ±äº†å‘œå‘œå‘œ"`;
              } else if (charAge <= 12) {
                fanTypeDescription = `ã€é‡è¦ã€‘${postAuthorChar.name}æ‰${charAge}å²ï¼Œæ˜¯ä¸ªå°æœ‹å‹/å°ç«¥æ˜Ÿï¼
ç²‰ä¸ç±»å‹åº”è¯¥æ˜¯ï¼šå§å§ç²‰ã€å¦ˆå¦ˆç²‰ã€é˜¿å§¨ç²‰
ç§°å‘¼è‡ªå·±ä¸ºï¼šå§å§ã€å“¥å“¥ã€é˜¿å§¨ã€å”å”
ç²‰ä¸è¯­æ°”ï¼šå® æººã€ä¿æŠ¤æ¬²å¼º`;
              } else if (charAge <= 18) {
                fanTypeDescription = `${postAuthorChar.name}æ˜¯${charAge}å²çš„å°‘å¹´/å°‘å¥³
ç²‰ä¸ç±»å‹ï¼šå§å§ç²‰ã€å¦ˆå¦ˆç²‰ã€åŒé¾„ç²‰ä¸éƒ½æœ‰`;
              } else {
                // æˆå¹´è§’è‰² (18+)
                const gender = postAuthorChar.gender;
                if (gender === 'male') {
                  fanTypeDescription = `${postAuthorChar.name}æ˜¯${charAge}å²çš„æˆå¹´ç”·æ€§
ç²‰ä¸ç±»å‹ï¼šå¥³å‹ç²‰ï¼ˆæŠŠä»–å½“è€å…¬/ç”·å‹ï¼‰ã€é¢œç²‰ï¼ˆèˆ”é¢œï¼‰ã€äº‹ä¸šç²‰ã€å¦¹å¦¹ç²‰ï¼ˆæ’’å¨‡å‹ï¼‰
ç²‰ä¸ç§°å‘¼ï¼šè€å…¬ã€å“¥å“¥ã€å®è´ã€ç”·ç¥
ç²‰ä¸è¯­æ°”ï¼šèŠ±ç—´ã€å¿ƒåŠ¨ã€èˆ”ç‹—å¼å¤¸èµ`;
                } else if (gender === 'female') {
                  fanTypeDescription = `${postAuthorChar.name}æ˜¯${charAge}å²çš„æˆå¹´å¥³æ€§
ç²‰ä¸ç±»å‹ï¼šè€å…¬ç²‰ï¼ˆæŠŠå¥¹å½“è€å©†ï¼‰ã€å§å§ç²‰ã€é¢œç²‰ã€äº‹ä¸šç²‰
ç²‰ä¸ç§°å‘¼ï¼šè€å©†ã€å§å§ã€å¥³ç¥ã€å®è´
ç²‰ä¸è¯­æ°”ï¼šå´‡æ‹œã€å—‘é¢œã€èŠ±ç—´`;
                } else {
                  fanTypeDescription = `${postAuthorChar.name}æ˜¯${charAge}å²
ç²‰ä¸ç±»å‹ï¼šé¢œç²‰ã€äº‹ä¸šç²‰ã€CPç²‰ç­‰
ç²‰ä¸ç§°å‘¼ï¼šå®è´ã€å¤§å¤§ã€ç¥ä»™`;
                }
              }
            }
            
            const prompt = `æœ‰ä¸€æ¡å¸–å­å†…å®¹å¦‚ä¸‹ï¼š
"${currentPost.content}"
å‘å¸–äººï¼š${account?.username || 'æŸç½‘å‹'}${postAuthorChar ? `ï¼ˆè§’è‰²ï¼š${postAuthorChar.name}ï¼Œ${postAuthorChar.age || '?'}å²ï¼‰` : ''}

ã€ç›¸å…³è§’è‰²ã€‘${characterNames || 'æš‚æ— '}

ã€ç²‰ä¸ç±»å‹æŒ‡å—ã€‘
${fanTypeDescription}

${customPrompt}

è¯·ç”Ÿæˆ3-5æ¡çœŸå®çš„ç½‘å‹è¯„è®ºã€‚æ¯æ¡è¯„è®ºç”¨ ===è¯„è®º=== åˆ†éš”ï¼Œæ ¼å¼ï¼š
===è¯„è®º===
æ˜µç§°ï¼šxxx
å†…å®¹ï¼šxxx`;

            const messages = [
              { role: 'system', content: 'ç”ŸæˆçœŸå®çš„ç¤¾äº¤åª’ä½“è¯„è®ºã€‚' },
              { role: 'user', content: prompt }
            ];
            
            const response = await callChatCompletion(state.apiSettings, messages, null);
            
            let commentBlocks = response.split(/===\s*è¯„è®º\s*===/).filter(b => b.trim());
            if (commentBlocks.length <= 1) {
              commentBlocks = response.split('\n\n').filter(b => b.trim().length > 5);
            }
            
            const addedCommentIds = [];
            
            for (const block of commentBlocks.slice(0, 5)) {
              const usernameMatch = block.match(/æ˜µç§°[ï¼š:]\s*(.+?)(?:\n|$)/);
              const contentMatch = block.match(/å†…å®¹[ï¼š:]\s*([\s\S]*?)$/);
              
              let username = usernameMatch?.[1]?.trim();
              let content = contentMatch?.[1]?.trim() || block.replace(/æ˜µç§°[ï¼š:].*?\n?/g, '').trim();
              
              if (!content || content.length < 2) continue;
              
              if (!username) {
                username = ['çƒ­å¿ƒç½‘å‹', 'åƒç“œç¾¤ä¼—', 'è·¯è¿‡çš„', 'å°ç²‰ä¸', 'å›´è§‚ç¾¤ä¼—'][Math.floor(Math.random() * 5)] + Math.floor(Math.random() * 1000);
              }
              
              const commenterId = actions.createNPCAccount({
                platform: 'xingyu',
                username: username,
                avatar: '',
                type: Math.random() > 0.5 ? 'fan' : 'passerby'
              });
              
              const commentId = actions.commentPost(currentPost.id, {
                authorType: 'npc',
                authorId: commenterId,
                content: content.slice(0, 100),
                replyTo: null
              });
              
              addedCommentIds.push(commentId);
              
              // å¦‚æœå¸–å­æ˜¯å½“å‰ç”¨æˆ·å‘çš„ï¼Œæ˜¾ç¤ºè¯„è®ºé€šçŸ¥
              if (currentPost.authorType === 'user' && currentPost.authorId === activeAccount?.id) {
                if (!replyNotification) {  // åªæ˜¾ç¤ºç¬¬ä¸€æ¡é€šçŸ¥ï¼Œé¿å…åˆ·å±
                  setReplyNotification({
                    characterName: username,
                    content: `è¯„è®ºäº†ä½ çš„å¸–å­ï¼š${content.slice(0, 30)}...`
                  });
                  setTimeout(() => setReplyNotification(null), 4000);
                }
              }
            }
            
            setHasGeneratedComments(true);

            // è®©ç²‰ä¸å’Œé»‘ç²‰/è·¯äººäº’åŠ¨ï¼ˆå¯¹çº¿ï¼‰
            await new Promise(resolve => setTimeout(resolve, 800));
            await handleFanInteractions();
            
            // å¦‚æœå¸–å­é‡Œæåˆ°äº†è§’è‰²ï¼Œè®©è§’è‰²æ¥äº’åŠ¨ï¼Œç„¶åç²‰ä¸æ¿€åŠ¨å›å¤
            const mentionedCharForNPC = checkMentionedCharacter();
            if (mentionedCharForNPC && currentPost.authorType === 'npc') {
              await new Promise(resolve => setTimeout(resolve, 1000));
              
              const latestPostForChar = store.getState().socialMedia?.posts?.find(p => p.id === currentPost.id);
              const commentsForChar = latestPostForChar?.comments || [];
              
              // è§’è‰²å›å¤ä¸€äº›è¯„è®º
              await handleAIReplyToMultipleComments(commentsForChar, mentionedCharForNPC.character, mentionedCharForNPC.account);
              
              // ç²‰ä¸æ¿€åŠ¨å›å¤è§’è‰²
              await new Promise(resolve => setTimeout(resolve, 1500));
              await handleFanReplyBackToCharacter(mentionedCharForNPC.character, mentionedCharForNPC.account);
            }

// æ£€æŸ¥å¸–å­å†…å®¹æ˜¯å¦@äº†æŸä¸ªè§’è‰²
const checkMentionedCharacter = () => {
  const content = currentPost.content || '';
  const topic = currentPost.topic || '';
  // è·å–å½“å‰è´¦å·ç»‘å®šçš„è§’è‰²
  const boundIds = activeAccount?.boundCharacterIds || [];
  
  for (const char of state.characters) {
    // åªæ£€æŸ¥ç»‘å®šçš„è§’è‰²ï¼ˆå¦‚æœæœ‰ç»‘å®šçš„è¯ï¼‰
    if (boundIds.length > 0 && !boundIds.includes(char.id)) continue;
    
    // æ£€æŸ¥ @è§’è‰²å
    const hasAtMention = content.includes(`@${char.name}`) || content.includes(`@ ${char.name}`);
    
    // æ£€æŸ¥ #è§’è‰²å# æˆ– #è§’è‰²åxxx# è¯é¢˜æ ‡ç­¾
    const hashtagPattern = new RegExp(`#[^#]*${char.name}[^#]*#`, 'i');
    const hasHashtag = hashtagPattern.test(content);
    
    // æ£€æŸ¥è¯é¢˜å­—æ®µ
    const topicHasName = topic.toLowerCase().includes(char.name.toLowerCase());
    
    // æ£€æŸ¥å†…å®¹ç›´æ¥æåˆ°è§’è‰²åï¼ˆä¸å¸¦@å’Œ#ï¼‰
    const directMention = content.includes(char.name);
    
    if (hasAtMention || hasHashtag || topicHasName || directMention) {
      const charAccount = state.socialMedia?.characterAccounts?.find(
        a => a.characterId === char.id && a.platform === 'xingyu'
      );
      if (charAccount) {
        return { character: char, account: charAccount };
      }
    }
  }
  return null;
};

// æƒ…å†µ1ï¼šå¸–å­æ˜¯è§’è‰²å‘çš„ -> å¸–å­ä½œè€…å›å¤è¯„è®º
if (postAuthorChar) {
  const charAccount = state.socialMedia?.characterAccounts?.find(
    a => a.characterId === postAuthorChar.id && a.platform === 'xingyu'
  );
  
  if (charAccount) {
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    const latestPost = store.getState().socialMedia?.posts?.find(p => p.id === currentPost.id);
    const allComments = latestPost?.comments || [];
    
    // è§’è‰²å›å¤è¯„è®º
    await handleAIReplyToMultipleComments(allComments, postAuthorChar, charAccount);
    
    // ç­‰å¾…ä¸€ä¸‹ï¼Œç„¶åè®©è¢«è§’è‰²å›å¤çš„ç²‰ä¸å†å›å¤è§’è‰²ï¼ˆä¸€æ¥ä¸€å›ï¼‰
    await new Promise(resolve => setTimeout(resolve, 1500));
    await handleFanReplyBackToCharacter(postAuthorChar, charAccount);
    
    // 30%æ¦‚ç‡è§’è‰²çœ‹åˆ°äº‰åµåå‘è¡¨æ€åº¦
    if (Math.random() > 0.7) {
      await new Promise(resolve => setTimeout(resolve, 2000));
      await handleCharacterMediateDispute(postAuthorChar, charAccount);
    }
  }
} else {
  // æƒ…å†µ2ï¼šå¸–å­ä¸æ˜¯è§’è‰²å‘çš„
  // é¦–å…ˆæ£€æŸ¥æ˜¯å¦@äº†è§’è‰²
  const mentionedChar = checkMentionedCharacter();
  
  // å¦‚æœæ²¡æœ‰@è§’è‰²ï¼Œä½†å¸–å­å‘å¸ƒè€…æ˜¯ç”¨æˆ·ä¸”ç»‘å®šäº†è§’è‰²ï¼Œè®©ç»‘å®šçš„è§’è‰²æ¥äº’åŠ¨
  if (!mentionedChar && selectedPost.authorType === 'user' && selectedPost.authorId === activeAccount?.id) {
    const boundIds = activeAccount?.boundCharacterIds || [];
    if (boundIds.length > 0) {
      // éšæœºé€‰æ‹©ä¸€ä¸ªç»‘å®šçš„è§’è‰²æ¥è¯„è®º
      const randomBoundId = boundIds[Math.floor(Math.random() * boundIds.length)];
      const boundChar = state.characters.find(c => c.id === randomBoundId);
      const boundCharAccount = state.socialMedia?.characterAccounts?.find(
        a => a.characterId === randomBoundId && a.platform === 'xingyu'
      );
      
      if (boundChar && boundCharAccount) {
        await new Promise(resolve => setTimeout(resolve, 1200));
        
        try {
          // è·å–ç”¨æˆ·äººè®¾
          let userPersonaInfo = '';
          let userRelation = 'ç²‰ä¸';
          if (activeAccount?.personaId) {
            const persona = state.userPersonas.find(p => p.id === activeAccount.personaId);
            if (persona) {
              userPersonaInfo = persona.persona || persona.name;
              // æ£€æµ‹å…³ç³»
              if (userPersonaInfo.includes('å¦ˆ') || userPersonaInfo.includes('æ¯äº²') || userPersonaInfo.includes('å¦ˆå’ª')) {
                userRelation = 'å¦ˆå¦ˆ/éº»éº»';
              } else if (userPersonaInfo.includes('çˆ¸') || userPersonaInfo.includes('çˆ¶äº²')) {
                userRelation = 'çˆ¸çˆ¸/ç²‘ç²‘';
              }
            }
          }
          if (!userPersonaInfo && activeAccount?.bio) {
            userPersonaInfo = activeAccount.bio;
            if (userPersonaInfo.includes('å¦ˆ') || userPersonaInfo.includes('æ¯äº²')) {
              userRelation = 'å¦ˆå¦ˆ/éº»éº»';
            }
          }
          
          // è·å–è§’è‰²å¹´é¾„
          const charAge = boundChar.age || 20;
          let ageHint = '';
          if (charAge <= 6) {
            ageHint = `ï¼ˆä½ æ˜¯${charAge}å²çš„å°å®å®ï¼Œè¯´è¯å¥¶å£°å¥¶æ°”ï¼Œå«å¦ˆå¦ˆä¸º"éº»éº»"ï¼‰`;
          }
          
          const replyPrompt = `ä½ ç°åœ¨æ‰®æ¼”è§’è‰²ã€Œ${boundChar.name}ã€${ageHint}ï¼Œ${userRelation !== 'ç²‰ä¸' ? `ä½ çš„${userRelation}` : 'ä½ çš„ç²‰ä¸'}å‘äº†ä¸€æ¡å¸–å­ã€‚

ã€è§’è‰²è®¾å®šã€‘
${boundChar.persona || boundChar.name}

ã€å‘å¸–äººèº«ä»½ã€‘
ç”¨æˆ·åï¼š${activeAccount?.username}
${userPersonaInfo ? `çœŸå®èº«ä»½ï¼š${userPersonaInfo}\nâš ï¸ è¿™æ˜¯ä½ è®¤è¯†çš„äººï¼è¯·ç”¨æ­£ç¡®çš„ç§°å‘¼ï¼ˆå¦‚"éº»éº»""ç²‘ç²‘"ï¼‰` : 'å…³ç³»ï¼šç²‰ä¸'}

ã€å¸–å­å†…å®¹ã€‘
${currentPost.content}

ã€å›å¤è¦æ±‚ã€‘
1. ä½œä¸ºè§’è‰²ï¼Œä½ éœ€è¦åœ¨è¯„è®ºåŒºå’Œç²‰ä¸/å¦ˆå¦ˆäº’åŠ¨
2. å›å¤è¦ç¬¦åˆè§’è‰²æ€§æ ¼ï¼Œäº²åˆ‡å¯çˆ±
3. 10-60å­—
4. å¯ä»¥ç”¨emoji
5. åƒçœŸå®æ˜æ˜Ÿåœ¨ç²‰ä¸å¸–å­ä¸‹è¯„è®ºä¸€æ ·

ç›´æ¥è¾“å‡ºè¯„è®ºå†…å®¹ã€‚`;

          const messages = [
            { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªè§’è‰²æ‰®æ¼”åŠ©æ‰‹ï¼Œæ¨¡æ‹Ÿè§’è‰²åœ¨ç²‰ä¸å¸–å­ä¸‹è¯„è®ºã€‚' },
            { role: 'user', content: replyPrompt }
          ];
          
          const response = await callChatCompletion(state.apiSettings, messages, null);
          
          if (response && !response.includes('[ä¸å›å¤]')) {
        actions.commentPost(currentPost.id, {
          authorType: 'character',
          authorId: boundCharAccount.id,
          content: response.trim().slice(0, 100),
          replyTo: null
        });
        
        // è§’è‰²è¯„è®ºåå¢åŠ ç²‰ä¸
        addCharacterFollowers(boundCharAccount.id, boundChar);
        
        // æ˜¾ç¤ºé€šçŸ¥
        setReplyNotification({
          characterName: boundChar.name,
          content: response.trim().slice(0, 50)
        });
        setTimeout(() => setReplyNotification(null), 4000);
        
        // è§’è‰²å›å¤ä¸€äº›å…¶ä»–è¯„è®º
        await new Promise(resolve => setTimeout(resolve, 800));
        const latestPost2 = store.getState().socialMedia?.posts?.find(p => p.id === currentPost.id);
        const allComments2 = latestPost2?.comments || [];
        
        if (allComments2.length > 1) {
          await handleAIReplyToMultipleComments(allComments2, boundChar, boundCharAccount);
          
          // ç²‰ä¸æ¿€åŠ¨å›å¤è§’è‰²
          await new Promise(resolve => setTimeout(resolve, 1500));
          await handleFanReplyBackToCharacter(boundChar, boundCharAccount);
        }
      }
    } catch (error) {
      console.error('è§’è‰²è¯„è®ºå¸–å­å¤±è´¥:', error);
        }
      }
    }
  }
  
  if (mentionedChar) {
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    const latestPost = store.getState().socialMedia?.posts?.find(p => p.id === currentPost.id);
    const allComments = latestPost?.comments || [];
    
    // è®©è¢«@çš„è§’è‰²å›å¤è¯„è®ºï¼ˆåŒ…æ‹¬ç›´æ¥å›å¤å¸–å­æœ¬èº«ï¼‰
    // é¦–å…ˆè®©è§’è‰²å¯¹å¸–å­æœ¬èº«å‘ä¸€æ¡è¯„è®º
    try {
      // è·å–å¸–å­ä½œè€…ä¿¡æ¯
              const postAuthorAccount = getAccountById(currentPost.authorId, currentPost.authorType) ||
                state.socialMedia?.npcAccounts?.find(a => a.id === currentPost.authorId);
              const postAuthorName = postAuthorAccount?.username || 'ç½‘å‹';
              
              // è·å–ç”¨æˆ·äººè®¾ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
              let userPersonaInfo = '';
              if (currentPost.authorType === 'user') {
                const userAccount = state.socialMedia?.userAccounts?.find(a => a.id === currentPost.authorId);
                if (userAccount?.personaId) {
                  const persona = state.userPersonas.find(p => p.id === userAccount.personaId);
                  if (persona) {
                    userPersonaInfo = `\nã€é‡è¦ï¼šå‘å¸–äººèº«ä»½ã€‘\n${postAuthorName}çš„çœŸå®èº«ä»½æ˜¯ï¼š${persona.persona || persona.name}\nä½ è®¤è¯†è¿™ä¸ªäººï¼è¯·æ ¹æ®ä½ ä»¬çš„å…³ç³»æ¥å›å¤ã€‚`;
                  }
                }
                // ä¹Ÿæ£€æŸ¥è´¦å·ç®€ä»‹
                if (!userPersonaInfo && userAccount?.bio) {
                  userPersonaInfo = `\nã€å‘å¸–äººç®€ä»‹ã€‘${userAccount.bio}`;
                }
              }
              
              // è·å–è§’è‰²å¹´é¾„ï¼Œå†³å®šç²‰ä¸ç±»å‹
              const charAge = mentionedChar.character.age || 20;
              let fanTypeHint = '';
              if (charAge <= 6) {
                fanTypeHint = 'ï¼ˆæ³¨æ„ï¼šä½ æ˜¯${charAge}å²çš„å°æœ‹å‹ï¼Œç²‰ä¸éƒ½æ˜¯å”å”é˜¿å§¨è¾ˆçš„ï¼Œè¦ç”¨å°å­©å­çš„è¯­æ°”ï¼‰';
              } else if (charAge <= 12) {
                fanTypeHint = 'ï¼ˆæ³¨æ„ï¼šä½ æ˜¯${charAge}å²çš„å°æœ‹å‹ï¼Œç²‰ä¸å¾ˆå¤šæ˜¯å“¥å“¥å§å§æˆ–å”å”é˜¿å§¨ï¼‰';
              }
              
              const replyPrompt = `ä½ ç°åœ¨æ‰®æ¼”è§’è‰²ã€Œ${mentionedChar.character.name}ã€ï¼Œæœ‰äººåœ¨å¸–å­é‡Œæåˆ°äº†ä½ ã€‚
${fanTypeHint}

ã€è§’è‰²è®¾å®šã€‘
${mentionedChar.character.persona || mentionedChar.character.name}
${userPersonaInfo}

ã€å¸–å­ä½œè€…ã€‘${postAuthorName}${userPersonaInfo ? 'ï¼ˆä½ è®¤è¯†çš„äººï¼Œæ ¹æ®ä¸Šé¢çš„èº«ä»½ä¿¡æ¯å›å¤ï¼‰' : 'ï¼ˆæ™®é€šç²‰ä¸/ç½‘å‹ï¼‰'}

ã€å¸–å­å†…å®¹ã€‘
${currentPost.content}

ã€å›å¤è¦æ±‚ã€‘
1. ä½ æ˜¯æ¥è¯„è®ºåŒºäº’åŠ¨çš„ï¼Œå›å¤è¿™ä¸ªç²‰ä¸çš„å¸–å­
2. ç§°å‘¼å¯¹æ–¹å¯ä»¥ç”¨"å°å§å§/å°å“¥å“¥/è¿™ä½æœ‹å‹"ç­‰ï¼Œä¸è¦ç”¨"ä½ "å¼€å¤´
3. æ„Ÿè°¢ç²‰ä¸çš„å–œæ¬¢ï¼Œæˆ–è€…å¯çˆ±åœ°å›åº”
4. 10-80å­—
5. å¯ä»¥ç”¨emoji
6. åƒçœŸå®æ˜æ˜Ÿç©ºé™ç²‰ä¸å¸–å­è¯„è®ºåŒºä¸€æ ·

ç›´æ¥è¾“å‡ºè¯„è®ºå†…å®¹ã€‚`;

      const messages = [
        { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªè§’è‰²æ‰®æ¼”åŠ©æ‰‹ï¼Œæ¨¡æ‹Ÿè§’è‰²å›å¤è¢«@çš„å¸–å­ã€‚' },
        { role: 'user', content: replyPrompt }
      ];
      
      const response = await callChatCompletion(state.apiSettings, messages, null);
      
      if (response && !response.includes('[ä¸å›å¤]')) {
        actions.commentPost(currentPost.id, {
          authorType: 'character',
          authorId: mentionedChar.account.id,
          content: response.trim().slice(0, 100),
          replyTo: null
        });
        
        // è§’è‰²å›å¤åå¢åŠ ç²‰ä¸
        addCharacterFollowers(mentionedChar.account.id, mentionedChar.character);
      }
      
      // ç„¶åå†å›å¤ä¸€äº›å…¶ä»–è¯„è®º
      await new Promise(resolve => setTimeout(resolve, 800));
      const updatedPost = store.getState().socialMedia?.posts?.find(p => p.id === currentPost.id);
      const updatedComments = updatedPost?.comments || [];
      
      await handleAIReplyToMultipleComments(updatedComments, mentionedChar.character, mentionedChar.account);
      
      // ç­‰å¾…ä¸€ä¸‹ï¼Œç„¶åè®©è¢«è§’è‰²å›å¤çš„ç²‰ä¸å†å›å¤è§’è‰²ï¼ˆæ¿€åŠ¨å›å¤ï¼‰
      await new Promise(resolve => setTimeout(resolve, 1500));
      await handleFanReplyBackToCharacter(mentionedChar.character, mentionedChar.account);
      
      // 30%æ¦‚ç‡è§’è‰²çœ‹åˆ°äº‰åµåå‘è¡¨æ€åº¦
      if (Math.random() > 0.7) {
        await new Promise(resolve => setTimeout(resolve, 2000));
        await handleCharacterMediateDispute(mentionedChar.character, mentionedChar.account);
      }
      
    } catch (error) {
      console.error('è§’è‰²å›å¤å¸–å­å¤±è´¥:', error);
    }
  }
}

// å¦‚æœå¸–å­æ˜¯NPCå‘çš„ä¸”æåˆ°äº†è§’è‰²ï¼Œä¹Ÿè§¦å‘ç²‰ä¸äº’åŠ¨
if (!postAuthorChar && !mentionedChar) {
  // æ£€æŸ¥å¸–å­ä½œè€…æ˜¯å¦æ˜¯NPCï¼Œä¸”å¸–å­å†…å®¹æåˆ°äº†ç»‘å®šçš„è§’è‰²
  if (currentPost.authorType === 'npc') {
    const boundIds = activeAccount?.boundCharacterIds || [];
    for (const charId of boundIds) {
      const char = state.characters.find(c => c.id === charId);
      if (char && currentPost.content.includes(char.name)) {
        const charAccount = state.socialMedia?.characterAccounts?.find(
          a => a.characterId === charId && a.platform === 'xingyu'
        );
        if (charAccount) {
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          const latestPost = store.getState().socialMedia?.posts?.find(p => p.id === currentPost.id);
          const allComments = latestPost?.comments || [];
          
          // è§’è‰²æ¥è¯„è®ºåŒºäº’åŠ¨
          await handleAIReplyToMultipleComments(allComments, char, charAccount);
          
          // ç²‰ä¸æ¿€åŠ¨å›å¤è§’è‰²
          await new Promise(resolve => setTimeout(resolve, 1500));
          await handleFanReplyBackToCharacter(char, charAccount);
          
          break;
        }
      }
    }
  }
}
            
          } catch (error) {
            console.error('ç”Ÿæˆè¯„è®ºå¤±è´¥:', error);
          } finally {
            setIsLoadingComments(false);
          }
        };
        
        useEffect(() => {
          if (selectedPost && !hasGeneratedComments) {
            const timer = setTimeout(generateComments, 800);
            return () => clearTimeout(timer);
          }
        }, [selectedPost?.id]);
        
        // ç”¨æˆ·å‘é€è¯„è®º
        const handleSendComment = async () => {
          if (!localCommentText.trim() || !activeAccount) return;
          
          const savedText = localCommentText.trim();
          const savedReplyTo = replyingTo;
          
          // ç«‹å³æ¸…ç©ºè¾“å…¥æ¡†
          setLocalCommentText('');
          setReplyingTo(null);
          
          // æ·»åŠ è¯„è®º
          actions.commentPost(currentPost.id, {
            authorType: 'user',
            authorId: activeAccount.id,
            content: savedText,
            replyTo: savedReplyTo ? {
              commentId: savedReplyTo.id,
              username: getAccountById(savedReplyTo.authorId, savedReplyTo.authorType)?.username || 'æŸäºº'
            } : null
          });
          
          // è¯„è®ºåå¢åŠ ç²‰ä¸ï¼ˆç»‘å®šè§’è‰²çš„è´¦å·æ¶¨æ›´å¤šï¼‰
          const boundCharCount = (activeAccount.boundCharacterIds || []).length;
          if (boundCharCount > 0) {
            // ç»‘å®šäº†è§’è‰²ï¼š50%æ¦‚ç‡æ¶¨ç²‰ä¸
            if (Math.random() > 0.5) {
              addRandomFollower(activeAccount.id, 'user');
            }
          } else if (Math.random() > 0.7) {
            // æ™®é€šè´¦å·ï¼š30%æ¦‚ç‡æ¶¨ç²‰ä¸
            addRandomFollower(activeAccount.id, 'user');
          }
          
          // æ˜¾ç¤º"æ­£åœ¨å›å¤"çŠ¶æ€
          setIsAIReplying(true);
          
          await new Promise(resolve => setTimeout(resolve, 800));
          
          try {
            // è·å–æœ€æ–°çš„å¸–å­æ•°æ®
            const latestPost = store.getState().socialMedia?.posts?.find(p => p.id === currentPost.id);
            const userComment = (latestPost?.comments || []).find(
              c => c.authorType === 'user' && c.content === savedText
            );
            
            if (!userComment) {
              setIsAIReplying(false);
              return;
            }
            
            setAiReplyingTo(userComment.id);
            
            // å†³å®šè°æ¥å›å¤
            let replierType = 'npc'; // é»˜è®¤æ˜¯è·¯äºº/ç²‰ä¸å›å¤
            let replierInfo = null;
            
            // æƒ…å†µ1ï¼šå›å¤çš„æ˜¯è§’è‰²çš„è¯„è®º -> è§’è‰²å›å¤
            if (savedReplyTo && savedReplyTo.authorType === 'character') {
              const repliedCharAccount = state.socialMedia?.characterAccounts?.find(
                a => a.id === savedReplyTo.authorId
              );
              if (repliedCharAccount) {
                const repliedChar = state.characters.find(c => c.id === repliedCharAccount.characterId);
                if (repliedChar) {
                  replierType = 'character';
                  replierInfo = { character: repliedChar, account: repliedCharAccount };
                }
              }
            }
            
            // æƒ…å†µ2ï¼šå¸–å­æ˜¯è§’è‰²å‘çš„ï¼Œä¸”æ²¡æœ‰å›å¤ç‰¹å®šäºº -> å¸–å­ä½œè€…ï¼ˆè§’è‰²ï¼‰å›å¤
            if (replierType === 'npc' && !savedReplyTo) {
              const postAuthorChar = getPostAuthorCharacter();
              if (postAuthorChar) {
                const charAccount = state.socialMedia?.characterAccounts?.find(
                  a => a.characterId === postAuthorChar.id && a.platform === 'xingyu'
                );
                if (charAccount) {
                  replierType = 'character';
                  replierInfo = { character: postAuthorChar, account: charAccount };
                }
              }
            }
            
            // æƒ…å†µ3ï¼šå›å¤çš„æ˜¯NPCçš„è¯„è®º -> é‚£ä¸ªNPCå›å¤
            if (replierType === 'npc' && savedReplyTo && savedReplyTo.authorType === 'npc') {
              const repliedNPC = state.socialMedia?.npcAccounts?.find(a => a.id === savedReplyTo.authorId);
              if (repliedNPC) {
                replierType = 'npc_reply';
                replierInfo = { npc: repliedNPC };
              }
            }
            
            // æƒ…å†µ4ï¼šè¯„è®ºå†…å®¹@äº†æŸä¸ªè§’è‰² æˆ– #äº†æŸä¸ªè§’è‰² -> é‚£ä¸ªè§’è‰²å›å¤
            if (replierType === 'npc') {
              for (const char of state.characters) {
                // æ£€æŸ¥ @è§’è‰²å
                const hasAtMention = savedText.includes(`@${char.name}`) || 
                  savedText.toLowerCase().includes(`@${char.name.toLowerCase()}`);
                
                // æ£€æŸ¥ #è§’è‰²å# è¯é¢˜æ ‡ç­¾
                const hashtagPattern = new RegExp(`#[^#]*${char.name}[^#]*#`, 'i');
                const hasHashtag = hashtagPattern.test(savedText);
                
                // ç›´æ¥æåˆ°è§’è‰²å
                const directMention = savedText.includes(char.name);
                
                if (hasAtMention || hasHashtag || directMention) {
                  const charAccount = state.socialMedia?.characterAccounts?.find(
                    a => a.characterId === char.id && a.platform === 'xingyu'
                  );
                  if (charAccount) {
                    replierType = 'character';
                    replierInfo = { character: char, account: charAccount, isFromComment: true, commentContent: savedText };
                    break;
                  }
                }
              }
            }
            
            // æ ¹æ®å›å¤è€…ç±»å‹ç”Ÿæˆå›å¤
            if (replierType === 'character' && replierInfo) {
              // å¦‚æœæ˜¯ç”¨æˆ·è¯„è®º@/æåˆ°äº†è§’è‰²ï¼Œä½¿ç”¨ç‰¹æ®Šçš„å›å¤é€»è¾‘
              if (replierInfo.isFromComment) {
                await handleCharacterReplyToUserComment(userComment, replierInfo.character, replierInfo.account);
              } else {
                // æ™®é€šå›å¤
                const replied = await handleAIReplyToComment(userComment, replierInfo.character, replierInfo.account);
                
                // å¦‚æœè§’è‰²å›å¤äº†ï¼Œæ˜¾ç¤ºé€šçŸ¥
                if (replied) {
                  setReplyNotification({
                    characterName: replierInfo.character.name,
                    content: 'å›å¤äº†ä½ çš„è¯„è®º'
                  });
                  setTimeout(() => setReplyNotification(null), 4000);
                }
              }
            } else if (replierType === 'npc_reply' && replierInfo) {
              // è¢«å›å¤çš„NPCå›å¤
              await handleNPCReplyToComment(userComment, replierInfo.npc);
            } else {
              // éšæœºè·¯äºº/ç²‰ä¸å›å¤
              await handleRandomNPCReply(userComment);
            }
            
            // é¢å¤–ï¼šæœ‰æ¦‚ç‡è¿˜æœ‰å…¶ä»–è·¯äººä¹Ÿæ¥å›å¤ï¼ˆè®©è¯„è®ºåŒºæ›´çƒ­é—¹ï¼‰
            if (Math.random() > 0.6) {
              await new Promise(resolve => setTimeout(resolve, 1000));
              await handleRandomNPCReply(userComment, true);
            }
            
          } catch (error) {
            console.error('å›å¤å‡ºé”™:', error);
          } finally {
            setIsAIReplying(false);
            setAiReplyingTo(null);
          }
        };
        
        // NPCå›å¤è¯„è®ºï¼ˆè¢«å›å¤çš„NPCï¼‰
        const handleNPCReplyToComment = async (targetComment, npc) => {
          try {
            const prompt = `ä½ ç°åœ¨æ¨¡æ‹Ÿä¸€ä¸ªæ™®é€šç½‘å‹ã€Œ${npc.username}ã€å›å¤åˆ«äººçš„è¯„è®ºã€‚

ã€ç½‘å‹ä¿¡æ¯ã€‘
æ˜µç§°ï¼š${npc.username}
ç±»å‹ï¼š${npc.type === 'fan' ? 'ç²‰ä¸' : 'è·¯äºº'}

ã€åˆ«äººå¯¹ä½ çš„è¯„è®ºã€‘
${targetComment.content}

ã€å›å¤è¦æ±‚ã€‘
1. åƒçœŸå®ç½‘å‹ä¸€æ ·å›å¤ï¼Œå£è¯­åŒ–ã€éšæ„
2. å¯ä»¥å‹å¥½ã€è°ƒä¾ƒã€å¼€ç©ç¬‘ã€é™„å’Œç­‰
3. 5-40å­—å·¦å³
4. å¯ä»¥ç”¨emoji
5. ä¸è¦å¤ªæ­£å¼

ç›´æ¥è¾“å‡ºå›å¤å†…å®¹ã€‚`;

            const messages = [
              { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªæ™®é€šç½‘å‹ï¼Œåœ¨ç¤¾äº¤åª’ä½“ä¸Šå›å¤è¯„è®ºã€‚' },
              { role: 'user', content: prompt }
            ];
            
            const response = await callChatCompletion(state.apiSettings, messages, null);
            
            await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
            
            actions.commentPost(currentPost.id, {
              authorType: 'npc',
              authorId: npc.id,
              content: response.trim().slice(0, 80),
              replyTo: {
                commentId: targetComment.id,
                username: getAccountById(targetComment.authorId, targetComment.authorType)?.username || 'ç½‘å‹'
              }
            });
            
          } catch (error) {
            console.error('NPCå›å¤å¤±è´¥:', error);
          }
        };
        
        // ç²‰ä¸ä¹‹é—´äº’åŠ¨ï¼ˆå¯¹çº¿ã€ç»´æŠ¤å¶åƒç­‰ï¼‰
        const handleFanInteractions = async () => {
          try {
            const latestPost = store.getState().socialMedia?.posts?.find(p => p.id === currentPost.id);
            const allComments = latestPost?.comments || [];
            
            if (allComments.length < 2) return;
            
            // æ‰¾å‡ºä¸åŒç±»å‹çš„è¯„è®º
            const negativeKeywords = ['æ²¹è…»', 'åšä½œ', 'é»‘ç²‰', 'è·¯äºº', 'ä¸€èˆ¬', 'æ™®é€š', 'ä¸å–œæ¬¢', 'è®¨åŒ', 'å°¬', 'æ— è¯­', 'éš¾çœ‹', 'éš¾å¬', 'è£…'];
            const positiveKeywords = ['å¯çˆ±', 'å–œæ¬¢', 'çˆ±', 'å¥½çœ‹', 'æ¼‚äº®', 'å¸…', 'æ£’', 'å‰å®³', 'æ”¯æŒ', 'å®è´', 'å´½å´½', 'å¤ªå¯äº†'];
            
            const negativeComments = allComments.filter(c => {
              const content = c.content.toLowerCase();
              return negativeKeywords.some(k => content.includes(k)) && c.authorType === 'npc';
            });
            
            const positiveComments = allComments.filter(c => {
              const content = c.content.toLowerCase();
              return positiveKeywords.some(k => content.includes(k)) && c.authorType === 'npc';
            });
            
            // å¦‚æœæœ‰è´Ÿé¢è¯„è®ºï¼Œè®©ç²‰ä¸å»å¯¹çº¿
            if (negativeComments.length > 0 && positiveComments.length > 0) {
              const targetNegative = negativeComments[Math.floor(Math.random() * negativeComments.length)];
              const defender = positiveComments[Math.floor(Math.random() * positiveComments.length)];
              
              const defenderAccount = state.socialMedia?.npcAccounts?.find(a => a.id === defender.authorId);
              if (!defenderAccount) return;
              
              // è·å–è§’è‰²ä¿¡æ¯
              const boundIds = activeAccount?.boundCharacterIds || [];
              let characterName = 'å¶åƒ';
              if (boundIds.length > 0) {
                const char = state.characters.find(c => c.id === boundIds[0]);
                if (char) characterName = char.name;
              }
              
              const targetNegativeAccount = state.socialMedia?.npcAccounts?.find(a => a.id === targetNegative.authorId);
              const targetNegativeName = targetNegativeAccount?.username || 'æ¥¼ä¸Šçš„';
              
              const prompt = `ä½ ç°åœ¨æ¨¡æ‹Ÿä¸€ä¸ªç²‰ä¸ã€Œ${defenderAccount.username}ã€åœ¨è¯„è®ºåŒºç»´æŠ¤å¶åƒã€Œ${characterName}ã€ã€‚

ã€æœ‰äººè¯´äº†è¿™æ ·çš„è¯ï¼ˆè´Ÿé¢è¯„è®ºï¼‰ã€‘
${targetNegativeName}ï¼š${targetNegative.content}

ã€ä½ ä¹‹å‰çš„è¯„è®ºï¼ˆä½ æ˜¯ç²‰ä¸ï¼‰ã€‘
${defender.content}

ã€å›å¤è¦æ±‚ã€‘
1. ä½ è¦åé©³/æ€¼å›å»ï¼Œç»´æŠ¤ä½ çš„å¶åƒ
2. å›å¤å¼€å¤´è¦@å¯¹æ–¹ï¼Œæ ¼å¼ï¼š@${targetNegativeName} ä½ çš„å›å¤å†…å®¹
3. å¯ä»¥è®½åˆºã€åé—®ã€æ®ç†åŠ›äº‰
4. ä¸è¦å¤ªè¿‡æ¿€ï¼ˆä¸èƒ½éª‚äººï¼‰ï¼Œä½†å¯ä»¥é˜´é˜³æ€ªæ°”
5. 15-80å­—
6. è¦æœ‰æ°”åŠ¿ï¼ŒåƒçœŸæ­£çš„ç²‰ä¸æŠ¤ä¸»

ç›´æ¥è¾“å‡ºå›å¤å†…å®¹ï¼ˆè®°å¾—å¼€å¤´@å¯¹æ–¹ï¼‰ã€‚`;

              const messages = [
                { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªå¿ å®ç²‰ä¸ï¼Œæ­£åœ¨è¯„è®ºåŒºå’Œé»‘ç²‰/è·¯äººå¯¹çº¿ç»´æŠ¤å¶åƒã€‚' },
                { role: 'user', content: prompt }
              ];
              
              const response = await callChatCompletion(state.apiSettings, messages, null);
              
              await new Promise(resolve => setTimeout(resolve, 600 + Math.random() * 1000));
              
              actions.commentPost(currentPost.id, {
                authorType: 'npc',
                authorId: defender.authorId,
                content: response.trim().slice(0, 120),
                replyTo: {
                  commentId: targetNegative.id,
                  username: state.socialMedia?.npcAccounts?.find(a => a.id === targetNegative.authorId)?.username || 'ç½‘å‹'
                }
              });
              
              // 50%æ¦‚ç‡é»‘ç²‰/è·¯äººå†å›å˜´
              if (Math.random() > 0.5) {
                await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 1200));
                await handleHaterReplyBack(targetNegative, response.trim(), characterName);
              }
            }
            
            // ä¹Ÿå¯èƒ½æœ‰è·¯äººé™„å’Œæˆ–è€…åƒç“œ
            if (Math.random() > 0.6 && allComments.length >= 3) {
              await new Promise(resolve => setTimeout(resolve, 500));
              await handleBystanderComment(allComments);
            }
            
          } catch (error) {
            console.error('ç²‰ä¸äº’åŠ¨å¤±è´¥:', error);
          }
        };
        
        // é»‘ç²‰/è·¯äººè¢«æ€¼åå›å˜´
        const handleHaterReplyBack = async (originalComment, fanResponse, characterName) => {
          try {
            const haterAccount = state.socialMedia?.npcAccounts?.find(a => a.id === originalComment.authorId);
            if (!haterAccount) return;
            
            // æ‰¾åˆ°æ€¼æˆ‘çš„ç²‰ä¸ç”¨æˆ·å
              const latestPostTemp = store.getState().socialMedia?.posts?.find(p => p.id === currentPost.id);
              const fanReplyTemp = (latestPostTemp?.comments || []).find(c => 
                c.content.includes(fanResponse.slice(0, 20))
              );
              const fanAccountTemp = fanReplyTemp ? 
                (state.socialMedia?.npcAccounts?.find(a => a.id === fanReplyTemp.authorId) || 
                 getAccountById(fanReplyTemp.authorId, fanReplyTemp.authorType)) : null;
              const fanName = fanAccountTemp?.username || 'æ¥¼ä¸Šçš„';
              
              const prompt = `ä½ ç°åœ¨æ¨¡æ‹Ÿä¸€ä¸ªå¯¹ã€Œ${characterName}ã€æŒè´Ÿé¢æ€åº¦çš„ç½‘å‹ã€Œ${haterAccount.username}ã€ã€‚

ã€ä½ ä¹‹å‰è¯´çš„è¯ã€‘
${originalComment.content}

ã€æœ‰ç²‰ä¸ã€Œ${fanName}ã€è¿™æ ·æ€¼ä½ ã€‘
${fanResponse}

ã€å›å¤è¦æ±‚ã€‘
1. ä½ å¯ä»¥é€‰æ‹©ï¼šç»§ç»­æ ã€é˜´é˜³æ€ªæ°”ã€æˆ–è€…æ‡’å¾—ç†
2. å›å¤å¼€å¤´è¦@å¯¹æ–¹ï¼Œæ ¼å¼ï¼š@${fanName} ä½ çš„å›å¤å†…å®¹
3. ä¸è¦è®¤è¾“å¤ªå¿«ï¼Œä½†ä¹Ÿä¸è¦å¤ªè¿‡åˆ†
4. å¯ä»¥è¯´"æˆ‘å°±è¯´è¯´æ€ä¹ˆäº†""è·¯äººå‘è¡¨æ„è§éƒ½ä¸è¡Œï¼Ÿ"
5. 10-60å­—
6. ä¿æŒä½ çš„ç«‹åœºï¼Œä½†ä¸è¦éª‚äºº

å¦‚æœä½ è§‰å¾—æ‡’å¾—ç»§ç»­æ äº†ï¼Œè¾“å‡ºï¼š[ç®—äº†ä¸ç†äº†]
å¦åˆ™ç›´æ¥è¾“å‡ºå›å¤å†…å®¹ï¼ˆè®°å¾—å¼€å¤´@å¯¹æ–¹ï¼‰ã€‚`;

            const messages = [
              { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªå¯¹æŸæ˜æ˜ŸæŒè´Ÿé¢æ€åº¦çš„ç½‘å‹ï¼Œæ­£åœ¨å’Œç²‰ä¸å¯¹çº¿ã€‚' },
              { role: 'user', content: prompt }
            ];
            
            const response = await callChatCompletion(state.apiSettings, messages, null);
            
            if (response.includes('[ç®—äº†ä¸ç†äº†]')) return;
            
            // è·å–æœ€æ–°è¯„è®ºåˆ—è¡¨æ‰¾åˆ°ç²‰ä¸çš„å›å¤
            const latestPost = store.getState().socialMedia?.posts?.find(p => p.id === currentPost.id);
            const fanReplyComment = (latestPost?.comments || []).find(c => 
              c.content === fanResponse.slice(0, 120) || c.content.includes(fanResponse.slice(0, 30))
            );
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            actions.commentPost(currentPost.id, {
              authorType: 'npc',
              authorId: originalComment.authorId,
              content: response.trim().slice(0, 100),
              replyTo: {
                commentId: fanReplyComment?.id || originalComment.id,
                username: 'ç²‰ä¸'
              }
            });
            
          } catch (error) {
            console.error('é»‘ç²‰å›å˜´å¤±è´¥:', error);
          }
        };
        
        // è§’è‰²å›å¤ç”¨æˆ·çš„@/æåˆ°è¯„è®ºï¼ˆç”¨æˆ·ä¸»åŠ¨äº’åŠ¨ï¼‰
        const handleCharacterReplyToUserComment = async (userComment, character, charAccount) => {
          try {
            setIsAIReplying(true);
            setAiReplyingTo(userComment.id);
            
            const userAccount = state.socialMedia?.userAccounts?.find(a => a.id === userComment.authorId);
            const userName = userAccount?.username || 'ç½‘å‹';
            
            // è·å–ç”¨æˆ·äººè®¾ä¿¡æ¯
            let userPersonaInfo = '';
            let userRelation = 'æ™®é€šç²‰ä¸/ç½‘å‹';
            if (userAccount?.personaId) {
              const persona = state.userPersonas.find(p => p.id === userAccount.personaId);
              if (persona) {
                userPersonaInfo = persona.persona || persona.name;
                userRelation = userPersonaInfo;
              }
            }
            if (!userPersonaInfo && userAccount?.bio) {
              userPersonaInfo = userAccount.bio;
              userRelation = userAccount.bio;
            }
            
            // è·å–è§’è‰²å¹´é¾„
            const charAge = character.age || 20;
            let ageHint = '';
            if (charAge <= 6) {
              ageHint = `ï¼ˆä½ æ˜¯${charAge}å²çš„å°å®å®ï¼Œè¯´è¯è¦å¥¶å£°å¥¶æ°”ã€å¯çˆ±æ’’å¨‡ï¼‰`;
            } else if (charAge <= 12) {
              ageHint = `ï¼ˆä½ æ˜¯${charAge}å²çš„å°æœ‹å‹ï¼Œè¯´è¯æ´»æ³¼å¯çˆ±ï¼‰`;
            }
            
            // åˆ¤æ–­å¸–å­ä½œè€…ä¿¡æ¯
            const postAuthorAccount = getAccountById(currentPost.authorId, currentPost.authorType) ||
              state.socialMedia?.npcAccounts?.find(a => a.id === currentPost.authorId);
            const postAuthorName = postAuthorAccount?.username || 'æŸäºº';
            const isUserPostAuthor = currentPost.authorId === userComment.authorId;
            
            const prompt = `ä½ ç°åœ¨æ‰®æ¼”è§’è‰²ã€Œ${character.name}ã€${ageHint}ï¼Œæœ‰äººåœ¨è¯„è®ºåŒº@ä½ æˆ–æåˆ°ä½ ã€‚

ã€è§’è‰²è®¾å®šã€‘
${character.persona || character.name}

ã€è¯„è®ºè€…èº«ä»½ã€‘
ç”¨æˆ·åï¼š${userName}
${userPersonaInfo ? `çœŸå®èº«ä»½ï¼š${userPersonaInfo}\nâš ï¸ ä½ è®¤è¯†è¿™ä¸ªäººï¼è¯·æ ¹æ®ä½ ä»¬çš„å…³ç³»æ¥å›å¤ï¼ˆæ¯”å¦‚å¦‚æœæ˜¯å¦ˆå¦ˆå°±å«"éº»éº»"ï¼‰` : 'èº«ä»½ï¼šæ™®é€šç²‰ä¸/ç½‘å‹'}

ã€åœºæ™¯è¯´æ˜ã€‘
- è¿™æ˜¯ä¸€æ¡å¸–å­çš„è¯„è®ºåŒº
- å¸–å­ä½œè€…æ˜¯ï¼š${postAuthorName}
- ${isUserPostAuthor ? `ã€Œ${userName}ã€å°±æ˜¯è¿™ä¸ªå¸–å­çš„ä½œè€…ï¼Œå‘å¸–å¤¸ä½ /æåˆ°ä½ ` : `ã€Œ${userName}ã€æ˜¯è¯„è®ºåŒºçš„ä¸€ä¸ªç²‰ä¸`}

ã€å¸–å­å†…å®¹æ‘˜è¦ã€‘
${currentPost.content.slice(0, 80)}...

ã€${userName}çš„è¯„è®ºå†…å®¹ã€‘
${userComment.content}

ã€å›å¤è¦æ±‚ã€‘
1. ä½ è¦å›å¤ã€Œ${userName}ã€çš„è¿™æ¡è¯„è®º
2. å›å¤è¦é’ˆå¯¹è¯„è®ºå†…å®¹ï¼Œäº²åˆ‡å¯çˆ±
3. å¯ä»¥æ„Ÿè°¢å¯¹æ–¹ã€æ’’å¨‡ã€å¼€ç©ç¬‘ç­‰
4. 10-60å­—
5. ç”¨emojiå¢åŠ å¯çˆ±åº¦
6. åƒçœŸå®æ˜æ˜Ÿå›å¤ç²‰ä¸è¯„è®ºä¸€æ ·

ç›´æ¥è¾“å‡ºå›å¤å†…å®¹ã€‚`;

            const messages = [
              { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªè§’è‰²ï¼Œæ­£åœ¨ç¤¾äº¤åª’ä½“è¯„è®ºåŒºå’Œç²‰ä¸äº’åŠ¨ã€‚' },
              { role: 'user', content: prompt }
            ];
            
            const response = await callChatCompletion(state.apiSettings, messages, null);
            
            await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
            
            actions.commentPost(currentPost.id, {
              authorType: 'character',
              authorId: charAccount.id,
              content: response.trim().slice(0, 100),
              replyTo: {
                commentId: userComment.id,
                username: userName
              }
            });
            
            // è§’è‰²å›å¤åå¢åŠ ç²‰ä¸
            addCharacterFollowers(charAccount.id, character);
            
            // æ˜¾ç¤ºé€šçŸ¥
            setReplyNotification({
              characterName: character.name,
              content: response.trim().slice(0, 50)
            });
            setTimeout(() => setReplyNotification(null), 4000);
            
          } catch (error) {
            console.error('è§’è‰²å›å¤ç”¨æˆ·è¯„è®ºå¤±è´¥:', error);
          } finally {
            setIsAIReplying(false);
            setAiReplyingTo(null);
          }
        };
        
        // è§’è‰²çœ‹åˆ°äº‰åµåå¯èƒ½å‘è¡¨æ€åº¦
        const handleCharacterMediateDispute = async (character, charAccount) => {
          try {
            const latestPost = store.getState().socialMedia?.posts?.find(p => p.id === currentPost.id);
            const allComments = latestPost?.comments || [];
            
            // æ‰¾å‡ºå¯¹çº¿çš„è¯„è®º
            const disputeComments = allComments.filter(c => 
              c.replyTo && (
                c.content.includes('?') || 
                c.content.includes('ï¼Ÿ') || 
                c.content.includes('æ€ä¹ˆ') ||
                c.content.includes('å‡­ä»€ä¹ˆ') ||
                c.content.length > 30
              )
            ).slice(-4);
            
            if (disputeComments.length < 2) return;
            
            const disputeText = disputeComments.map(c => {
              const author = state.socialMedia?.npcAccounts?.find(a => a.id === c.authorId)?.username || 'ç½‘å‹';
              return `${author}ï¼š${c.content}`;
            }).join('\n');
            
            const prompt = `ä½ ç°åœ¨æ‰®æ¼”è§’è‰²ã€Œ${character.name}ã€ï¼Œå‘ç°è¯„è®ºåŒºæœ‰äººåœ¨åµæ¶/å¯¹çº¿ã€‚

ã€è§’è‰²è®¾å®šã€‘
${character.persona || character.name}

ã€è¯„è®ºåŒºçš„äº‰åµå†…å®¹ã€‘
${disputeText}

ã€å›å¤è¦æ±‚ã€‘
1. ä½œä¸ºè§’è‰²ï¼Œä½ å¯ä»¥é€‰æ‹©ï¼š
   - å‡ºæ¥æ‰“åœ†åœºï¼Œè®©å¤§å®¶åˆ«åµäº†
   - æ„Ÿè°¢ç²‰ä¸ç»´æŠ¤è‡ªå·±
   - ç”¨å¯çˆ±/æç¬‘çš„æ–¹å¼åŒ–è§£å°´å°¬
   - æˆ–è€…å‡è£…æ²¡çœ‹åˆ°ï¼ˆè¾“å‡º[ä¸ä»‹å…¥]ï¼‰
2. å¦‚æœä»‹å…¥ï¼Œè¦ç¬¦åˆè§’è‰²æ€§æ ¼
3. 15-80å­—
4. å¯ä»¥ç”¨emoji

å¦‚æœå†³å®šä¸ä»‹å…¥ï¼Œè¾“å‡ºï¼š[ä¸ä»‹å…¥]
å¦åˆ™ç›´æ¥è¾“å‡ºè¯„è®ºå†…å®¹ã€‚`;

            const messages = [
              { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªè§’è‰²ï¼Œå‘ç°è¯„è®ºåŒºæœ‰äººä¸ºä½ åµæ¶ï¼Œéœ€è¦å†³å®šæ˜¯å¦ä»‹å…¥ã€‚' },
              { role: 'user', content: prompt }
            ];
            
            const response = await callChatCompletion(state.apiSettings, messages, null);
            
            if (response.includes('[ä¸ä»‹å…¥]')) return;
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            actions.commentPost(currentPost.id, {
              authorType: 'character',
              authorId: charAccount.id,
              content: response.trim().replace('[ä¸ä»‹å…¥]', '').slice(0, 100),
              replyTo: null  // ä¸å›å¤ç‰¹å®šäººï¼Œæ˜¯å•ç‹¬å‘è¡¨æ€åº¦
            });
            
            // æ˜¾ç¤ºé€šçŸ¥
            setReplyNotification({
              characterName: character.name,
              content: response.trim().slice(0, 50)
            });
            setTimeout(() => setReplyNotification(null), 4000);
            
          } catch (error) {
            console.error('è§’è‰²è°ƒè§£äº‰åµå¤±è´¥:', error);
          }
        };
        
        // åƒç“œç¾¤ä¼—/è·¯äººè¯„è®º
        const handleBystanderComment = async (allComments) => {
          try {
            // éšæœºé€‰æ‹©ä¸€æ¡è¯„è®ºæ¥å›´è§‚/é™„å’Œ/åæ§½
            const targetComment = allComments[Math.floor(Math.random() * allComments.length)];
            const targetAccount = state.socialMedia?.npcAccounts?.find(a => a.id === targetComment.authorId) ||
              getAccountById(targetComment.authorId, targetComment.authorType);
            
            const bystanderNames = ['åƒç“œç¬¬ä¸€å', 'å‰æ’å›´è§‚', 'è·¯è¿‡çœ‹æˆ', 'ç“œç”°é€‰æ‰‹', 'ä¸“ä¸šåƒç“œ', 'æ¿å‡³å·²å¤‡å¥½'];
            const username = bystanderNames[Math.floor(Math.random() * bystanderNames.length)] + Math.floor(Math.random() * 1000);
            
            const targetUsername = targetAccount?.username || 'æ¥¼ä¸Š';
              
              const prompt = `ä½ ç°åœ¨æ¨¡æ‹Ÿä¸€ä¸ªåƒç“œç¾¤ä¼—ã€Œ${username}ã€åœ¨è¯„è®ºåŒºå›´è§‚ã€‚

ã€ä½ çœ‹åˆ°çš„è¯„è®ºã€‘
${targetUsername}ï¼š${targetComment.content}

ã€å›å¤è¦æ±‚ã€‘
1. çº¯ç²¹åƒç“œå¿ƒæ€ï¼Œçœ‹çƒ­é—˜ä¸å«Œäº‹å¤§
2. å›å¤å¼€å¤´å¯ä»¥@å¯¹æ–¹æˆ–è€…è¯´"æ¥¼ä¸Šçš„"ï¼Œæ ¼å¼ï¼š@${targetUsername} ä½ çš„å†…å®¹
3. å¯ä»¥è¯´"å“ˆå“ˆå“ˆç¬‘æ­»""å‰æ’åƒç“œ""è¿™ä¸‹çƒ­é—˜äº†""æ‡‚äº†æ‡‚äº†"
4. æˆ–è€…é™„å’Œå…¶ä¸­ä¸€æ–¹ï¼Œç«ä¸Šæµ‡æ²¹
5. 5-40å­—ï¼Œç®€çŸ­æœ‰è¶£
6. ç”¨emojiå¢åŠ è¶£å‘³æ€§

ç›´æ¥è¾“å‡ºå›å¤å†…å®¹ã€‚`;

            const messages = [
              { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªåƒç“œç¾¤ä¼—ï¼Œåœ¨è¯„è®ºåŒºçœ‹çƒ­é—¹ã€‚' },
              { role: 'user', content: prompt }
            ];
            
            const response = await callChatCompletion(state.apiSettings, messages, null);
            
            const npcId = actions.createNPCAccount({
              platform: 'xingyu',
              username: username,
              avatar: '',
              type: 'passerby'
            });
            
            await new Promise(resolve => setTimeout(resolve, 300));
            
            actions.commentPost(currentPost.id, {
              authorType: 'npc',
              authorId: npcId,
              content: response.trim().slice(0, 60),
              replyTo: {
                commentId: targetComment.id,
                username: targetAccount?.username || 'ç½‘å‹'
              }
            });
            
          } catch (error) {
            console.error('åƒç“œç¾¤ä¼—è¯„è®ºå¤±è´¥:', error);
          }
        };
        
        // ç²‰ä¸è¢«è§’è‰²å›å¤åï¼Œå†å›å¤è§’è‰²ï¼ˆä¸€æ¥ä¸€å›ï¼‰
        const handleFanReplyBackToCharacter = async (character, charAccount) => {
          try {
            // è·å–æœ€æ–°çš„å¸–å­æ•°æ®
            const latestPost = store.getState().socialMedia?.posts?.find(p => p.id === currentPost.id);
            const allComments = latestPost?.comments || [];
            
            console.log('æ£€æŸ¥ç²‰ä¸å›å¤è§’è‰²ï¼Œå½“å‰è¯„è®ºæ•°:', allComments.length);
            
            // æ‰¾å‡ºè§’è‰²å›å¤è¿‡çš„è¯„è®ºï¼ˆå¸¦æœ‰replyToå­—æ®µçš„ï¼‰
            const charReplies = allComments.filter(c => 
              c.authorType === 'character' && 
              c.authorId === charAccount.id && 
              c.replyTo
            );
            
            console.log('è§’è‰²å›å¤çš„è¯„è®ºæ•°:', charReplies.length);
            
            if (charReplies.length === 0) {
              console.log('è§’è‰²æ²¡æœ‰å›å¤ä»»ä½•è¯„è®ºï¼Œè·³è¿‡');
              return;
            }
            
            // æ‰€æœ‰è¢«è§’è‰²å›å¤çš„ç²‰ä¸éƒ½ä¼šæ¿€åŠ¨å›å¤ï¼ˆçœŸå®æƒ…å†µå°±æ˜¯è¿™æ ·ï¼ï¼‰
            const replyCount = charReplies.length;
            const shuffledReplies = [...charReplies];
            
            console.log('å°†æœ‰', replyCount, 'ä¸ªç²‰ä¸æ¿€åŠ¨å›å¤è§’è‰²');
            
            for (const charReply of shuffledReplies) {
              // æ‰¾åˆ°åŸå§‹è¢«å›å¤çš„è¯„è®º
              const originalComment = allComments.find(c => c.id === charReply.replyTo?.commentId);
              if (!originalComment) continue;
              
              // è·å–åŸè¯„è®ºè€…ä¿¡æ¯
              const originalCommenter = getAccountById(originalComment.authorId, originalComment.authorType) ||
                state.socialMedia?.npcAccounts?.find(a => a.id === originalComment.authorId);
              
              if (!originalCommenter) continue;
              
              // ç”¨æˆ·çš„è¯„è®ºä¸è‡ªåŠ¨å›å¤ï¼ˆè®©ç”¨æˆ·è‡ªå·±å†³å®šï¼‰
              // ä½†NPCç²‰ä¸ä¼šæ¿€åŠ¨åœ°å›å¤è§’è‰²
              if (originalComment.authorType === 'user') {
                // ç”¨æˆ·æ”¶åˆ°è§’è‰²å›å¤ä¼šæœ‰é€šçŸ¥ï¼Œç”±ç”¨æˆ·è‡ªå·±å†³å®šæ˜¯å¦å›å¤
                continue;
              }
              
              // è·å–è§’è‰²å¹´é¾„ï¼Œå†³å®šç²‰ä¸ç±»å‹
              const charAge = character.age || 20;
              let fanType = 'ç²‰ä¸';
              if (charAge <= 6) {
                fanType = 'é˜¿å§¨ç²‰/å¦ˆå¦ˆç²‰';
              } else if (charAge <= 12) {
                fanType = 'å§å§ç²‰/é˜¿å§¨ç²‰';
              } else if (character.gender === 'male') {
                fanType = 'å¥³å‹ç²‰/å¦¹å¦¹ç²‰';
              } else {
                fanType = 'å§å§ç²‰/è€å…¬ç²‰';
              }
              
              // ç”Ÿæˆç²‰ä¸æ¿€åŠ¨å›å¤
              const prompt = `ä½ ç°åœ¨æ¨¡æ‹Ÿä¸€ä¸ª${fanType}ã€Œ${originalCommenter.username}ã€æ”¶åˆ°å¶åƒã€Œ${character.name}ã€ï¼ˆ${charAge}å²ï¼‰çš„å›å¤åï¼Œæ¿€åŠ¨åœ°å†æ¬¡å›å¤ã€‚

ã€å¶åƒçš„å›å¤å†…å®¹ã€‘
${charReply.content}

ã€ä½ ä¹‹å‰è¯´çš„è¯ã€‘
${originalComment.content}

ã€å›å¤è¦æ±‚ã€‘
1. å›å¤å¼€å¤´è¦@å¶åƒï¼Œæ ¼å¼ï¼š@${character.name} ä½ çš„å†…å®¹
2. éå¸¸æ¿€åŠ¨ã€å¼€å¿ƒã€å—å® è‹¥æƒŠ
3. å¯èƒ½ä¼šè¯´"å•Šå•Šå•Šå±…ç„¶å›æˆ‘äº†""å¤©å“ª""æˆ‘æ­»äº†""å‘œå‘œå‘œ${charAge <= 6 ? 'å°å®è´' : 'å®è´'}å›æˆ‘äº†"
4. 15-60å­—
5. ç”¨å¾ˆå¤šemojiå’Œæ„Ÿå¹å·
6. ${charAge <= 6 ? 'ä½œä¸ºå¦ˆå¦ˆç²‰/é˜¿å§¨ç²‰ï¼Œè¡¨è¾¾å§¨æ¯ç¬‘ã€å¿ƒéƒ½åŒ–äº†çš„æ„Ÿè§‰' : 'ç²‰ä¸è§åˆ°å¶åƒå›å¤çš„é‚£ç§ç–¯ç‹‚åŠ²'}

ç›´æ¥è¾“å‡ºå›å¤å†…å®¹ï¼ˆè®°å¾—å¼€å¤´@å¶åƒï¼‰ã€‚`;

              const messages = [
                { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªç‹‚çƒ­ç²‰ä¸ï¼Œå¶åƒåˆšåˆšå›å¤äº†ä½ ï¼Œä½ æ¿€åŠ¨åäº†ã€‚' },
                { role: 'user', content: prompt }
              ];
              
              const response = await callChatCompletion(state.apiSettings, messages, null);
              
              await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 1200));
              
              actions.commentPost(currentPost.id, {
                authorType: 'npc',
                authorId: originalComment.authorId,
                content: response.trim().slice(0, 100),
                replyTo: {
                  commentId: charReply.id,
                  username: character.name
                }
              });
            }
          } catch (error) {
            console.error('ç²‰ä¸å›å¤è§’è‰²å¤±è´¥:', error);
          }
        };
        
        // éšæœºè·¯äºº/ç²‰ä¸å›å¤
        const handleRandomNPCReply = async (targetComment, isExtra = false) => {
          try {
            const isFan = Math.random() > 0.4;
            const npcType = isFan ? 'fan' : 'passerby';
            
            const fanNames = ['å°ç²‰ä¸', 'è¿½æ˜Ÿå¥³å­©', 'é¢œæ§', 'è·¯è½¬ç²‰', 'è€ç²‰', 'æ–°é¥­', 'ç«™å§æ—¥å¸¸'];
            const passerbyNames = ['åƒç“œç¾¤ä¼—', 'è·¯è¿‡çš„', 'å›´è§‚ç½‘å‹', 'çœ‹çƒ­é—¹çš„', 'æ‘¸é±¼äºº', 'å†²æµªé€‰æ‰‹'];
            
            const nameList = isFan ? fanNames : passerbyNames;
            const username = nameList[Math.floor(Math.random() * nameList.length)] + Math.floor(Math.random() * 1000);
            
            // è·å–å½“å‰è´¦å·ç»‘å®šçš„è§’è‰²
            const boundIds = activeAccount?.boundCharacterIds || [];
            
            // åªè·å–å·²åˆ›å»ºæ˜Ÿè¯­è´¦å·ä¸”åœ¨ç»‘å®šåˆ—è¡¨ä¸­çš„è§’è‰²
            let charactersWithAccount = state.characters.filter(c => 
              state.socialMedia?.characterAccounts?.some(
                acc => acc.characterId === c.id && acc.platform === 'xingyu'
              )
            );
            
            // å¦‚æœå½“å‰è´¦å·æœ‰ç»‘å®šè§’è‰²ï¼Œåˆ™åªä½¿ç”¨ç»‘å®šçš„è§’è‰²
            if (boundIds.length > 0) {
              charactersWithAccount = charactersWithAccount.filter(c => boundIds.includes(c.id));
            }
            
            const characterNames = charactersWithAccount.map(c => c.name).join('ã€') || 'æš‚æ— ';
            
            const prompt = `ä½ ç°åœ¨æ¨¡æ‹Ÿä¸€ä¸ª${isFan ? 'ç²‰ä¸' : 'æ™®é€šç½‘å‹'}åœ¨ç¤¾äº¤åª’ä½“ä¸Šå›å¤è¯„è®ºã€‚

ã€ä½ çš„èº«ä»½ã€‘
æ˜µç§°ï¼š${username}
ç±»å‹ï¼š${isFan ? 'ç²‰ä¸ï¼ˆçƒ­æƒ…ã€å–œæ¬¢ç›¸å…³å†…å®¹ï¼‰' : 'è·¯äººï¼ˆéšä¾¿çœ‹çœ‹ã€åƒç“œå¿ƒæ€ï¼‰'}

ã€å¸–å­å†…å®¹ã€‘
${currentPost.content}

ã€ä½ è¦å›å¤çš„è¯„è®ºã€‘
${getAccountById(targetComment.authorId, targetComment.authorType)?.username || 'ç½‘å‹'}ï¼š${targetComment.content}

ã€ç›¸å…³è§’è‰²ã€‘
${characterNames || 'æš‚æ— '}

ã€å›å¤è¦æ±‚ã€‘
1. ${isFan ? 'çƒ­æƒ…ã€å‹å¥½ï¼Œå¯èƒ½ä¼šå¤¸èµã€é™„å’Œã€ç©æ¢—' : 'éšæ„ã€å¯èƒ½åæ§½ã€è°ƒä¾ƒã€å‡‘çƒ­é—¹'}
2. åƒçœŸå®ç½‘å‹çš„å›å¤ï¼Œå£è¯­åŒ–
3. 5-50å­—
4. å¯ä»¥ç”¨emojiã€ç½‘ç»œç”¨è¯­
5. ${isExtra ? 'å¯ä»¥æ˜¯è¡¥å……ã€é™„å’Œã€ç©æ¢—' : 'ç›´æ¥å›åº”å¯¹æ–¹'}

ç›´æ¥è¾“å‡ºå›å¤å†…å®¹ã€‚`;

            const messages = [
              { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªçœŸå®çš„ç½‘å‹ï¼Œåœ¨ç¤¾äº¤åª’ä½“è¯„è®ºåŒºäº’åŠ¨ã€‚' },
              { role: 'user', content: prompt }
            ];
            
            const response = await callChatCompletion(state.apiSettings, messages, null);
            
            // åˆ›å»ºNPCè´¦å·
            const npcId = actions.createNPCAccount({
              platform: 'xingyu',
              username: username,
              avatar: '',
              type: npcType
            });
            
            await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1500));
            
            actions.commentPost(currentPost.id, {
              authorType: 'npc',
              authorId: npcId,
              content: response.trim().slice(0, 80),
              replyTo: {
                commentId: targetComment.id,
                username: getAccountById(targetComment.authorId, targetComment.authorType)?.username || 'ç½‘å‹'
              }
            });
            
          } catch (error) {
            console.error('éšæœºNPCå›å¤å¤±è´¥:', error);
          }
        };
        
        const handleReply = (comment) => {
          setReplyingTo(comment);
        };
        
        const latestPost = state.socialMedia?.posts?.find(p => p.id === selectedPost.id) || currentPost;
        const postAuthorChar = getPostAuthorCharacter();
        
        return (
          <div className="w-full h-full bg-gray-100 flex flex-col overflow-hidden">
            {/* å¤´éƒ¨ */}
            <div 
              className="pt-12 pb-4 px-4 flex-shrink-0"
              style={{
                backgroundImage: 'url(https://cdn.mujian.me/tuchuang/696e25d002154.jpg)',
                backgroundSize: 'cover',
                backgroundPosition: 'center'
              }}
            >
              <div className="flex items-center gap-3">
                <button 
                  onClick={() => { setCurrentPage('home'); setHasGeneratedComments(false); setSelectedPost(null); setReplyingTo(null); }}
                  className="text-white drop-shadow-lg"
                >
                  <Icon name="ChevronLeft" size={24} />
                </button>
                <span className="font-semibold text-white text-lg drop-shadow-lg">å¸–å­è¯¦æƒ…</span>
              </div>
            </div>
            
            {/* å¯æ»šåŠ¨å†…å®¹ */}
<div className="flex-1 overflow-y-auto min-h-0">
  <div className="bg-white p-4">
    {/* ä½œè€…ä¿¡æ¯ */}
    <div className="flex items-start gap-3">
      <button 
        onClick={() => {
          if (selectedPost.authorType !== 'user' || selectedPost.authorId !== activeAccount?.id) {
            setViewingProfile({ accountId: selectedPost.authorId, accountType: selectedPost.authorType });
            setCurrentPage('userProfile');
          }
        }}
        className="w-10 h-10 rounded-full bg-gradient-to-br from-orange-400 to-pink-500 flex items-center justify-center overflow-hidden flex-shrink-0"
      >
        {account?.avatar ? (
          <img src={account.avatar} alt="" className="w-full h-full object-cover" />
        ) : (
          <span className="text-white font-bold text-sm">{account?.username?.[0] || '?'}</span>
        )}
      </button>
      
      <div className="flex-1 min-w-0">
        <div className="flex items-center gap-2">
          <span className="font-semibold text-gray-800 truncate">
            {account?.username || 'æœªçŸ¥ç”¨æˆ·'}
          </span>
          {account?.isVerified && (
            <span className="text-orange-500 text-xs">âœ“</span>
          )}
          {selectedPost.authorType === 'character' && (
            <span className="text-xs bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded">è§’è‰²</span>
          )}
        </div>
        <p className="text-xs text-gray-400">{formatTime(selectedPost.createdAt)}</p>
      </div>
      
      {/* å…³æ³¨æŒ‰é’® */}
      {activeAccount && selectedPost.authorId !== activeAccount.id && (
        <button
          onClick={() => {
            const isFollowing = (activeAccount.following || []).includes(selectedPost.authorId);
            if (isFollowing) {
              actions.unfollowAccount(activeAccount.id, selectedPost.authorId);
            } else {
              actions.followAccount(activeAccount.id, selectedPost.authorId);
            }
          }}
          className={`px-3 py-1 rounded-full text-xs font-medium ${
            (activeAccount.following || []).includes(selectedPost.authorId)
              ? 'bg-gray-100 text-gray-600' 
              : 'bg-orange-500 text-white'
          }`}
        >
          {(activeAccount.following || []).includes(selectedPost.authorId) ? 'å·²å…³æ³¨' : 'å…³æ³¨'}
        </button>
      )}
    </div>
    
    {/* å¸–å­å†…å®¹ */}
    <div className="mt-3 text-gray-800 text-sm leading-relaxed">
      <p className="whitespace-pre-wrap">{latestPost.content}</p>
      {latestPost.topic && (
        <span className="text-orange-500 mt-2 inline-block">#{latestPost.topic}#</span>
      )}
    </div>
    
    {/* äº’åŠ¨æ  */}
    <div className="flex items-center gap-6 mt-3 pt-3 border-t border-gray-50">
      <button 
        onClick={() => {
          if (activeAccount) {
            actions.likePost(latestPost.id, activeAccount.id);
          }
        }}
        className={`flex items-center gap-1 text-sm ${
          activeAccount && latestPost.likedBy?.includes(activeAccount.id) ? 'text-red-500' : 'text-gray-400'
        }`}
      >
        <Icon name="Heart" size={18} className={
          activeAccount && latestPost.likedBy?.includes(activeAccount.id) ? 'fill-current' : ''
        } />
        <span>{formatNumber(latestPost.likes || 0)}</span>
      </button>
      
      <button className="flex items-center gap-1 text-sm text-gray-400">
        <Icon name="MessageCircle" size={18} />
        <span>{latestPost.comments?.length || 0}</span>
      </button>
      
      <button 
        onClick={() => setShowShareModalDetail(true)}
        className="flex items-center gap-1 text-sm text-gray-400 active:text-orange-500"
      >
        <Icon name="Repeat2" size={18} />
        <span>{formatNumber(latestPost.reposts || 0)}</span>
      </button>
      
      <span className="text-xs text-gray-300 ml-auto">{formatNumber(latestPost.views || 0)}é˜…è¯»</span>
    </div>
  </div>
              
              {/* è¯„è®ºåŒº */}
              <div className="p-4 bg-gray-50">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="font-semibold text-gray-800">è¯„è®º ({latestPost.comments?.length || 0})</h3>
                  <div className="flex items-center gap-2">
                    {isAIReplying && (
                      <div className="flex items-center gap-1 text-purple-500 text-xs bg-purple-50 px-2 py-1 rounded-full">
                        <Icon name="Loader2" size={12} className="animate-spin" />
                        <span>{postAuthorChar?.name}å›å¤ä¸­...</span>
                      </div>
                    )}
                    {isLoadingComments && (
                      <div className="flex items-center gap-1 text-orange-500 text-sm">
                        <Icon name="Loader2" size={14} className="animate-spin" />
                        <span>åŠ è½½ä¸­...</span>
                      </div>
                    )}
                  </div>
                </div>
                
                {(latestPost.comments || []).length === 0 && !isLoadingComments ? (
                  <div className="text-center text-gray-400 py-8 bg-white rounded-xl">
                    <Icon name="MessageCircle" size={32} className="mx-auto mb-2 opacity-30" />
                    <p>æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘~</p>
                  </div>
                ) : (
                  <div className="space-y-3 bg-white rounded-xl p-3">
                    {(latestPost.comments || []).map((comment, idx) => {
  const commenter = getAccountById(comment.authorId, comment.authorType) || 
    state.socialMedia?.npcAccounts?.find(a => a.id === comment.authorId);
  const isCharacterReply = comment.authorType === 'character';
  const isBeingReplied = aiReplyingTo === comment.id;
  
  // åˆ¤æ–­æ˜¯å¦æ˜¯å¸–å­ä½œè€…ï¼ˆåªæœ‰å¸–å­ä½œè€…æ‰æ˜¾ç¤º"ä½œè€…"æ ‡ç­¾ï¼‰
  const isPostAuthor = comment.authorType === selectedPost.authorType && 
    comment.authorId === selectedPost.authorId;
  
  // è·å–è¢«å›å¤è€…çš„ç”¨æˆ·å
  const getReplyToUsername = () => {
    if (!comment.replyTo) return null;
    if (comment.replyTo.username && comment.replyTo.username !== 'ç½‘å‹' && comment.replyTo.username !== 'æŸäºº') {
      return comment.replyTo.username;
    }
    // å°è¯•ä»è¯„è®ºåˆ—è¡¨ä¸­æŸ¥æ‰¾è¢«å›å¤çš„è¯„è®º
    const repliedComment = (latestPost.comments || []).find(c => c.id === comment.replyTo.commentId);
    if (repliedComment) {
      const repliedAccount = getAccountById(repliedComment.authorId, repliedComment.authorType) ||
        state.socialMedia?.npcAccounts?.find(a => a.id === repliedComment.authorId);
      return repliedAccount?.username || 'æŸäºº';
    }
    return comment.replyTo.username || 'æŸäºº';
  };
  
  return (
    <div 
      key={comment.id || idx} 
      className={`pb-3 border-b border-gray-100 last:border-0 transition-all ${
        isPostAuthor ? 'bg-purple-50 -mx-3 px-3 py-2 rounded-lg' : 
        isCharacterReply ? 'bg-blue-50 -mx-3 px-3 py-2 rounded-lg' : ''
      } ${isBeingReplied ? 'ring-2 ring-purple-300 rounded-lg' : ''}`}
    >
      <div className="flex gap-3">
        <button
          onClick={() => {
            if (comment.authorId !== activeAccount?.id) {
              setViewingProfile({ accountId: comment.authorId, accountType: comment.authorType });
              setCurrentPage('userProfile');
            }
          }}
          className={`w-8 h-8 rounded-full flex items-center justify-center overflow-hidden flex-shrink-0 ${
            isPostAuthor 
              ? 'bg-gradient-to-br from-purple-400 to-pink-500 ring-2 ring-purple-300' 
              : isCharacterReply
                ? 'bg-gradient-to-br from-blue-400 to-indigo-500 ring-2 ring-blue-300'
                : 'bg-gradient-to-br from-gray-400 to-gray-500'
          }`}
        >
          {commenter?.avatar ? (
            <img src={commenter.avatar} alt="" className="w-full h-full object-cover" />
          ) : (
            <span className="text-white font-bold text-xs">{commenter?.username?.[0] || '?'}</span>
          )}
        </button>
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2 flex-wrap">
            <span className={`font-medium text-sm ${
              isPostAuthor ? 'text-purple-700' : 
              isCharacterReply ? 'text-blue-700' : 'text-gray-800'
            }`}>
              {commenter?.username || 'ç½‘å‹'}
            </span>
            {isPostAuthor && (
              <span className="text-xs bg-purple-200 text-purple-700 px-1.5 py-0.5 rounded">ä½œè€…</span>
            )}
            {isCharacterReply && !isPostAuthor && (
              <span className="text-xs bg-blue-200 text-blue-700 px-1.5 py-0.5 rounded">è§’è‰²</span>
            )}
            {comment.authorType === 'user' && comment.authorId === activeAccount?.id && (
              <span className="text-xs bg-orange-100 text-orange-600 px-1 rounded">æˆ‘</span>
            )}
            <span className="text-xs text-gray-400">{formatTime(comment.createdAt)}</span>
          </div>
          
          {comment.replyTo && (
            <p className="text-xs text-blue-500 mt-1">
              å›å¤ @{getReplyToUsername()}
            </p>
          )}
          
          <p className={`text-sm mt-1 break-words ${
            isPostAuthor ? 'text-purple-800' : 
            isCharacterReply ? 'text-blue-800' : 'text-gray-700'
          }`}>
            {comment.content}
          </p>
          
          <button 
            onClick={() => handleReply(comment)}
            className="text-xs text-gray-400 mt-2 hover:text-orange-500"
          >
            å›å¤
          </button>
        </div>
      </div>
    </div>
  );
})}
                  </div>
                )}
                
                <div className="h-20"></div>
              </div>
            </div>
            
            {/* å›å¤æç¤ºé€šçŸ¥ */}
            {replyNotification && (
              <div className="absolute top-20 left-4 right-4 z-50 animate-slide-down">
                <div className="bg-gradient-to-r from-purple-500 to-pink-500 rounded-2xl p-4 shadow-lg text-white">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                      <span className="text-lg">ğŸ’¬</span>
                    </div>
                    <div className="flex-1">
                      <p className="font-semibold">{replyNotification.characterName} å›å¤äº†ä½ </p>
                      <p className="text-sm text-white/80 truncate">{replyNotification.content}</p>
                    </div>
                    <button 
                      onClick={() => setReplyNotification(null)}
                      className="text-white/60 hover:text-white"
                    >
                      <Icon name="X" size={18} />
                    </button>
                  </div>
                </div>
              </div>
            )}
            
            {/* è¯„è®ºè¾“å…¥æ¡† */}
            <div className="p-3 border-t bg-white flex-shrink-0">
              {replyingTo && (
                <div className="flex items-center justify-between mb-2 px-2 py-1 bg-gray-100 rounded-lg">
                  <span className="text-xs text-gray-600">
                    å›å¤ @{getAccountById(replyingTo.authorId, replyingTo.authorType)?.username || 'æŸäºº'}
                  </span>
                  <button onClick={() => setReplyingTo(null)} className="text-gray-400">
                    <Icon name="X" size={14} />
                  </button>
                </div>
              )}
              
              {/* å›å¤æç¤º */}
              <p className="text-xs text-gray-400 mb-2 px-2">
                ğŸ’¬ å‘é€è¯„è®ºåä¼šæœ‰äººå›å¤ä½ å“¦~
              </p>
              
              <div className="flex gap-2">
                <input
                  type="text"
                  value={localCommentText}
                  onChange={(e) => setLocalCommentText(e.target.value)}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                      e.preventDefault();
                      handleSendComment();
                    }
                  }}
                  placeholder={replyingTo ? 'å†™å›å¤...' : 'å†™è¯„è®º...'}
                  className="flex-1 px-4 py-2 bg-gray-100 rounded-full text-sm outline-none focus:ring-2 focus:ring-orange-300"
                />
                <button
                  onClick={handleSendComment}
                  disabled={!localCommentText.trim()}
                  className={`px-4 py-2 rounded-full text-sm font-medium ${
                    localCommentText.trim() ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-400'
                  }`}
                >
                  å‘é€
                </button>
              </div>
            </div>
            {/* è½¬å‘å¼¹çª— */}
{showShareModalDetail && (
  <div className="absolute inset-0 bg-black/50 z-[60] flex items-end">
    <div className="w-full bg-white rounded-t-3xl animate-slide-up max-h-[70%] flex flex-col">
      <div className="flex items-center justify-between p-4 border-b flex-shrink-0">
        <span className="font-semibold">è½¬å‘åˆ°èŠå¤©</span>
        <button onClick={() => setShowShareModalDetail(false)}>
          <Icon name="X" size={24} className="text-gray-500" />
        </button>
      </div>
      
      {/* å¸–å­é¢„è§ˆ */}
      <div className="p-4 border-b bg-gray-50 flex-shrink-0">
        <div className="bg-white rounded-xl p-3 shadow-sm">
          <div className="flex items-center gap-2 mb-2">
            <div className="w-6 h-6 rounded-full bg-gradient-to-br from-orange-400 to-pink-500 flex items-center justify-center">
              <span className="text-white text-xs font-bold">
                {account?.username?.[0] || '?'}
              </span>
            </div>
            <span className="text-sm font-medium text-gray-800">
              {account?.username || 'ç”¨æˆ·'}
            </span>
          </div>
          <p className="text-sm text-gray-600 line-clamp-2">{latestPost.content}</p>
        </div>
      </div>
      
      {/* èŠå¤©åˆ—è¡¨ */}
      <div className="flex-1 overflow-y-auto p-4">
        {state.chats.length === 0 ? (
          <div className="text-center text-gray-400 py-8">
            <Icon name="MessageCircle" size={48} className="mx-auto mb-2 opacity-30" />
            <p>æš‚æ— èŠå¤©</p>
            <p className="text-sm mt-1">å…ˆå»å¾®ä¿¡åˆ›å»ºä¸€ä¸ªèŠå¤©å§</p>
          </div>
        ) : (
          <div className="space-y-2">
            {state.chats.map(chatItem => {
              const firstChar = state.characters.find(c => c.id === chatItem.characterIds?.[0]);
              const chatAvatar = chatItem.avatar || firstChar?.avatar;
              const chatName = chatItem.name || firstChar?.name || 'èŠå¤©';
              
              return (
                <button
                  key={chatItem.id}
                  onClick={() => {
                    // è½¬å‘å¸–å­åˆ°èŠå¤©
                    const shareMessage = {
                      type: 'shared_post',
                      content: latestPost.content,
                      sharedPost: {
                        id: latestPost.id,
                        authorName: account?.username || 'ç”¨æˆ·',
                        authorAvatar: account?.avatar || '',
                        content: latestPost.content,
                        topic: latestPost.topic,
                        likes: latestPost.likes,
                        comments: latestPost.comments?.length || 0,
                        platform: 'xingyu'
                      }
                    };
                    
                    actions.addMessage(chatItem.id, shareMessage);
                    
                    // å¢åŠ è½¬å‘æ•°
                    store.setState(s => ({
                      ...s,
                      socialMedia: {
                        ...s.socialMedia,
                        posts: s.socialMedia.posts.map(p => 
                          p.id === latestPost.id 
                            ? { ...p, reposts: (p.reposts || 0) + 1 }
                            : p
                        )
                      }
                    }));
                    
                    setShowShareModalDetail(false);
                    
                    // æç¤ºå¹¶è·³è½¬
                    if (confirm('è½¬å‘æˆåŠŸï¼æ˜¯å¦ç«‹å³æŸ¥çœ‹ï¼Ÿ')) {
                      actions.setScreen('wechat');
                      actions.setCurrentChat(chatItem.id);
                    }
                  }}
                  className="w-full flex items-center gap-3 p-3 bg-gray-50 rounded-xl active:bg-gray-100"
                >
                  <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-green-400 to-teal-500 flex items-center justify-center overflow-hidden">
                    {chatAvatar ? (
                      <img src={chatAvatar} alt="" className="w-full h-full object-cover" />
                    ) : (
                      <span className="text-white font-bold">{chatName[0]}</span>
                    )}
                  </div>
                  <div className="flex-1 text-left">
                    <p className="font-medium text-gray-800">{chatName}</p>
                    <p className="text-xs text-gray-400">
                      {chatItem.type === 'group' ? 'ç¾¤èŠ' : 'ç§èŠ'} Â· {chatItem.messages?.length || 0}æ¡æ¶ˆæ¯
                    </p>
                  </div>
                  <Icon name="Send" size={20} className="text-gray-400" />
                </button>
              );
            })}
          </div>
        )}
      </div>
    </div>
  </div>
)}
          </div>
        );
      };
      
            // ç”¨æˆ·/è§’è‰²ä¸»é¡µï¼ˆæŸ¥çœ‹ä»–äººï¼‰
      const UserProfilePage = () => {
        if (!viewingProfile) return null;
        
        const { accountId, accountType } = viewingProfile;
        const account = getAccountById(accountId, accountType);
        
        if (!account) {
          return (
            <div className="flex-1 flex items-center justify-center">
              <p className="text-gray-500">ç”¨æˆ·ä¸å­˜åœ¨</p>
            </div>
          );
        }
        
        // è·å–è¯¥ç”¨æˆ·çš„å¸–å­
        const userPosts = (state.socialMedia?.posts || [])
          .filter(p => p.authorId === accountId)
          .sort((a, b) => b.createdAt - a.createdAt);
        
        // è·å–è§’è‰²ä¿¡æ¯ï¼ˆå¦‚æœæ˜¯è§’è‰²è´¦å·ï¼‰
        const character = accountType === 'character' 
          ? state.characters.find(c => c.id === account.characterId)
          : null;
        
        // æ˜¯å¦å·²å…³æ³¨
        const isFollowing = activeAccount && (activeAccount.following || []).includes(accountId);
        
        // æ˜¯å¦æ˜¯è‡ªå·±
        const isSelf = activeAccount?.id === accountId;
        
        return (
          <div className="w-full h-full bg-gray-100 flex flex-col overflow-hidden">
            {/* å¤´éƒ¨èƒŒæ™¯ */}
            <div 
              className="relative pt-12 pb-20 px-4 flex-shrink-0"
              style={{
                backgroundImage: 'url(https://cdn.mujian.me/tuchuang/696e25d002154.jpg)',
                backgroundSize: 'cover',
                backgroundPosition: 'center'
              }}
            >
            <button 
              onClick={() => { 
                setViewingProfile(null); 
                setCurrentPage('home'); 
              }}
              className="text-white drop-shadow-lg"
            >
              <Icon name="ChevronLeft" size={24} />
            </button>
            </div>
            
            {/* ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ */}
            <div className="relative px-4 -mt-16 flex-shrink-0">
              <div className="bg-white rounded-2xl p-4 shadow-lg">
                <div className="flex items-start gap-4">
                  {/* å¤´åƒ */}
                  <div className="w-20 h-20 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center overflow-hidden border-4 border-white shadow-lg -mt-10">
                    {account.avatar ? (
                      <img src={account.avatar} alt="" className="w-full h-full object-cover" />
                    ) : (
                      <span className="text-white text-2xl font-bold">{account.username?.[0]}</span>
                    )}
                  </div>
                  
                  <div className="flex-1 pt-2">
                    <div className="flex items-center gap-2">
                      <h2 className="text-xl font-bold text-gray-800">{account.username}</h2>
                      {account.isVerified && (
                        <span className="text-orange-500">âœ“</span>
                      )}
                      {accountType === 'character' && (
                        <span className="text-xs bg-purple-100 text-purple-600 px-2 py-0.5 rounded-full">è§’è‰²</span>
                      )}
                    </div>
                    <p className="text-sm text-gray-500 mt-1">{account.bio || 'è¿™ä¸ªäººå¾ˆç¥ç§˜ï¼Œä»€ä¹ˆéƒ½æ²¡å†™~'}</p>
                  </div>
                </div>
                
                {/* å…³æ³¨/ç²‰ä¸æ•° */}
                <div className="flex gap-6 mt-4 pt-4 border-t">
                  <div className="text-center">
                    <p className="text-xl font-bold text-gray-800">{(account.following || []).length}</p>
                    <p className="text-xs text-gray-500">å…³æ³¨</p>
                  </div>
                  <div className="text-center">
                    <p className="text-xl font-bold text-gray-800">{(account.followers || []).length}</p>
                    <p className="text-xs text-gray-500">ç²‰ä¸</p>
                  </div>
                  <div className="text-center">
                    <p className="text-xl font-bold text-gray-800">{userPosts.length}</p>
                    <p className="text-xs text-gray-500">å¸–å­</p>
                  </div>
                  
                  {/* å…³æ³¨æŒ‰é’® */}
                  {!isSelf && activeAccount && (
                    <div className="flex-1 flex justify-end">
                      <button
                        onClick={() => handleToggleFollow(accountId)}
                        className={`px-6 py-2 rounded-full text-sm font-medium ${
                          isFollowing 
                            ? 'bg-gray-100 text-gray-600' 
                            : 'bg-gradient-to-r from-orange-400 to-pink-500 text-white'
                        }`}
                      >
                        {isFollowing ? 'å·²å…³æ³¨' : '+ å…³æ³¨'}
                      </button>
                    </div>
                  )}
                </div>
                
                {/* è§’è‰²ç®€ä»‹ */}
                {character && (
                  <div className="mt-4 p-3 bg-purple-50 rounded-xl">
                    <p className="text-xs text-purple-600 font-medium mb-1">ğŸ­ è§’è‰²è®¾å®š</p>
                    <p className="text-sm text-gray-600 line-clamp-3">{character.persona}</p>
                  </div>
                )}
              </div>
            </div>
            
            {/* å¸–å­åˆ—è¡¨ */}
            <div className="flex-1 overflow-y-auto mt-4">
              <div className="px-4 pb-2">
                <h3 className="font-semibold text-gray-700">Taçš„å¸–å­</h3>
              </div>
              
              {userPosts.length === 0 ? (
                <div className="text-center text-gray-400 py-12">
                  <Icon name="FileText" size={48} className="mx-auto mb-2 opacity-30" />
                  <p>æš‚æ— å¸–å­</p>
                </div>
              ) : (
                userPosts.map(post => (
                  <PostCard key={post.id} post={post} />
                ))
              )}
            </div>
          </div>
        );
      };
      
            // è´¦å·è®¾ç½®é¡µé¢
      const AccountSettingsPage = () => {
        const account = editingAccount;
        if (!account) return null;
        
        const [editName, setEditName] = useState(account.username || '');
        const [editBio, setEditBio] = useState(account.bio || '');
        const [editAvatar, setEditAvatar] = useState(account.avatar || '');
        const [editBoundIds, setEditBoundIds] = useState(account.boundCharacterIds || []);
        const avatarInputRef = useRef(null);
        
        // ä¿å­˜ä¿®æ”¹
        const handleSave = () => {
          store.setState(s => ({
            ...s,
            socialMedia: {
              ...s.socialMedia,
              userAccounts: s.socialMedia.userAccounts.map(acc => {
                if (acc.id === account.id) {
                  return {
                    ...acc,
                    username: editName.trim() || acc.username,
                    bio: editBio.trim(),
                    avatar: editAvatar,
                    boundCharacterIds: editBoundIds
                  };
                }
                return acc;
              })
            }
          }));
          setEditingAccount(null);
          setCurrentPage('profile');
        };
        
        // ä¸Šä¼ å¤´åƒ
        const handleAvatarUpload = (e) => {
          const file = e.target.files?.[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              setEditAvatar(event.target.result);
            };
            reader.readAsDataURL(file);
          }
        };
        
        // åˆ é™¤è´¦å·
        const handleDeleteAccount = () => {
          if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´¦å·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
          
          const isActive = account.id === activeAccount?.id;
          
          store.setState(s => {
            const newAccounts = s.socialMedia.userAccounts.filter(a => a.id !== account.id);
            return {
              ...s,
              socialMedia: {
                ...s.socialMedia,
                userAccounts: newAccounts,
                activeAccount: isActive ? (newAccounts[0]?.id || null) : s.socialMedia.activeAccount
              }
            };
          });
          
          setEditingAccount(null);
          setCurrentPage('profile');
        };
        
        // åˆ‡æ¢ç»‘å®šè§’è‰²
        const toggleBoundCharacter = (charId) => {
          if (editBoundIds.includes(charId)) {
            setEditBoundIds(editBoundIds.filter(id => id !== charId));
          } else {
            setEditBoundIds([...editBoundIds, charId]);
          }
        };
        
        return (
          <div className="flex-1 overflow-y-auto bg-gray-100">
            {/* å¤´éƒ¨ */}
            <div 
              className="pt-12 pb-6 px-4"
              style={{
                backgroundImage: 'url(https://cdn.mujian.me/tuchuang/696e25d002154.jpg)',
                backgroundSize: 'cover',
                backgroundPosition: 'center'
              }}
            >
              <div className="flex items-center gap-3 mb-4">
                <button 
                  onClick={() => { setEditingAccount(null); setCurrentPage('profile'); }}
                  className="text-white drop-shadow-lg"
                >
                  <Icon name="ChevronLeft" size={24} />
                </button>
                <span className="text-white font-semibold text-lg drop-shadow-lg">è´¦å·è®¾ç½®</span>
              </div>
              
              {/* å¤´åƒç¼–è¾‘ */}
              <div className="flex flex-col items-center">
                <input
                  ref={avatarInputRef}
                  type="file"
                  accept="image/*"
                  onChange={handleAvatarUpload}
                  className="hidden"
                />
                <button
                  onClick={() => avatarInputRef.current?.click()}
                  className="relative group"
                >
                  <div className="w-24 h-24 rounded-full bg-gradient-to-br from-orange-400 to-pink-500 flex items-center justify-center overflow-hidden border-4 border-white shadow-lg">
                    {editAvatar ? (
                      <img src={editAvatar} alt="" className="w-full h-full object-cover" />
                    ) : (
                      <span className="text-white text-3xl font-bold">{editName?.[0] || '?'}</span>
                    )}
                  </div>
                  <div className="absolute inset-0 rounded-full bg-black/40 flex items-center justify-center opacity-0 group-active:opacity-100 transition-opacity">
                    <Icon name="Camera" size={28} className="text-white" />
                  </div>
                </button>
                <p className="text-white/80 text-xs mt-2 drop-shadow">ç‚¹å‡»æ›´æ¢å¤´åƒ</p>
              </div>
            </div>
            
            {/* åŸºæœ¬ä¿¡æ¯ */}
            <div className="p-4 space-y-4">
              <div className="bg-white rounded-xl p-4 space-y-4">
                <h3 className="font-semibold text-gray-800">ğŸ“ åŸºæœ¬ä¿¡æ¯</h3>
                
                <div>
                  <label className="block text-sm text-gray-600 mb-1">è´¦å·åç§°</label>
                  <input
                    type="text"
                    value={editName}
                    onChange={(e) => setEditName(e.target.value)}
                    className="w-full p-3 bg-gray-100 rounded-xl"
                    placeholder="è´¦å·åç§°"
                  />
                </div>
                
                <div>
                  <label className="block text-sm text-gray-600 mb-1">ä¸ªäººç®€ä»‹</label>
                  <textarea
                    value={editBio}
                    onChange={(e) => setEditBio(e.target.value)}
                    className="w-full p-3 bg-gray-100 rounded-xl h-20 resize-none"
                    placeholder="ä»‹ç»ä¸€ä¸‹è‡ªå·±å§~"
                  />
                </div>
                
                <div>
                  <label className="block text-sm text-gray-600 mb-1">å¤´åƒURLï¼ˆå¯é€‰ï¼‰</label>
                  <input
                    type="text"
                    value={editAvatar}
                    onChange={(e) => setEditAvatar(e.target.value)}
                    className="w-full p-3 bg-gray-100 rounded-xl text-sm"
                    placeholder="æˆ–ç²˜è´´å›¾ç‰‡é“¾æ¥"
                  />
                </div>
              </div>
              
              {/* ç»‘å®šè§’è‰²ç®¡ç† */}
              <div className="bg-white rounded-xl p-4">
                <div className="flex items-center justify-between mb-3">
                  <h3 className="font-semibold text-gray-800">ğŸ­ ç»‘å®šçš„AIè§’è‰²</h3>
                  <span className="text-xs text-gray-400">å·²ç»‘å®š {editBoundIds.length} ä¸ª</span>
                </div>
                <p className="text-xs text-gray-500 mb-3">ç»‘å®šåï¼Œåˆ·æ–°å¸–å­åªä¼šå‡ºç°è¿™äº›è§’è‰²ç›¸å…³çš„å†…å®¹</p>
                
                {state.characters.length === 0 ? (
                  <p className="text-gray-400 text-sm text-center py-4">æš‚æ— AIè§’è‰²</p>
                ) : (
                  <div className="space-y-2 max-h-60 overflow-y-auto">
                    {state.characters.map(char => {
                      const isBound = editBoundIds.includes(char.id);
                      return (
                        <button
                          key={char.id}
                          onClick={() => toggleBoundCharacter(char.id)}
                          className={`w-full p-3 rounded-xl flex items-center gap-3 border-2 transition-all ${
                            isBound ? 'border-purple-500 bg-purple-50' : 'border-gray-200 bg-gray-50'
                          }`}
                        >
                          <div className="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center overflow-hidden">
                            {char.avatar ? (
                              <img src={char.avatar} alt="" className="w-full h-full object-cover" />
                            ) : (
                              <span className="text-white font-bold">{char.name[0]}</span>
                            )}
                          </div>
                          <div className="flex-1 text-left">
                            <span className="font-medium">{char.name}</span>
                            <p className="text-xs text-gray-400 truncate">{char.persona?.slice(0, 25) || ''}</p>
                          </div>
                          {isBound ? (
                            <span className="text-purple-500 text-xs font-medium bg-purple-100 px-2 py-1 rounded-full">å·²ç»‘å®š</span>
                          ) : (
                            <span className="text-gray-400 text-xs">ç‚¹å‡»ç»‘å®š</span>
                          )}
                        </button>
                      );
                    })}
                  </div>
                )}
                
                {editBoundIds.length === 0 && (
                  <p className="text-xs text-orange-500 mt-3 text-center">âš ï¸ æœªç»‘å®šä»»ä½•è§’è‰²ï¼Œå°†çœ‹åˆ°æ‰€æœ‰å†…å®¹</p>
                )}
              </div>
              
              {/* ä¿å­˜æŒ‰é’® */}
              <button
                onClick={handleSave}
                className="w-full py-4 bg-gradient-to-r from-orange-400 to-pink-500 text-white rounded-xl font-semibold"
              >
                ä¿å­˜ä¿®æ”¹
              </button>
              
              {/* å±é™©æ“ä½œåŒº */}
              <div className="bg-red-50 rounded-xl p-4 border border-red-200">
                <h3 className="font-semibold text-red-600 mb-3">âš ï¸ å±é™©æ“ä½œ</h3>
                <button
                  onClick={handleDeleteAccount}
                  className="w-full py-3 bg-red-500 text-white rounded-xl font-medium"
                >
                  åˆ é™¤æ­¤è´¦å·
                </button>
                <p className="text-xs text-red-400 text-center mt-2">åˆ é™¤åä¸å¯æ¢å¤</p>
              </div>
              
              {/* åº•éƒ¨é—´è· */}
              <div className="h-8"></div>
            </div>
          </div>
        );
      };
      
      // ä¸ªäººä¸­å¿ƒé¡µé¢
      const ProfilePage = () => {
        const characterAccounts = (state.socialMedia?.characterAccounts || [])
          .filter(a => a.platform === 'xingyu');
        
        return (
          <div className="flex-1 overflow-y-auto">
            {/* å½“å‰è´¦å·ä¿¡æ¯ */}
            {activeAccount ? (
              <div className="bg-gradient-to-br from-orange-400 to-pink-500 p-6 text-white">
                <div className="flex items-center gap-4">
                  <div className="w-16 h-16 rounded-full bg-white/20 flex items-center justify-center overflow-hidden">
                    {activeAccount.avatar ? (
                      <img src={activeAccount.avatar} alt="" className="w-full h-full object-cover" />
                    ) : (
                      <span className="text-2xl font-bold">{activeAccount.username?.[0]}</span>
                    )}
                  </div>
                  <div className="flex-1">
                    <h2 className="text-xl font-bold">{activeAccount.username}</h2>
                    <p className="text-white/80 text-sm mt-1">{activeAccount.bio || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™~'}</p>
                  </div>
                </div>
                
                <div className="flex gap-6 mt-4">
                  <div className="text-center">
                    <p className="text-xl font-bold">{(activeAccount.following || []).length}</p>
                    <p className="text-xs text-white/70">å…³æ³¨</p>
                  </div>
                  <div className="text-center">
                    <p className="text-xl font-bold">{(activeAccount.followers || []).length}</p>
                    <p className="text-xs text-white/70">ç²‰ä¸</p>
                  </div>
                </div>
              </div>
            ) : (
              <div className="bg-gray-100 p-6 text-center">
                <Icon name="User" size={48} className="mx-auto mb-2 text-gray-300" />
                <p className="text-gray-500">æš‚æ— è´¦å·</p>
                <button
                  onClick={() => setCurrentPage('createAccount')}
                  className="mt-3 px-6 py-2 bg-orange-500 text-white rounded-full text-sm"
                >
                  åˆ›å»ºè´¦å·
                </button>
              </div>
            )}
            
            {/* è´¦å·ç®¡ç† */}
            <div className="bg-white p-4 mt-2 rounded-xl mx-4">
              <div className="flex items-center justify-between mb-3">
                <h3 className="font-semibold text-gray-800">ğŸ”„ è´¦å·ç®¡ç†</h3>
              </div>
              
              {/* å½“å‰è´¦å·åˆ—è¡¨ */}
              <div className="space-y-2 mb-3">
                {(state.socialMedia?.userAccounts || [])
                  .filter(a => a.platform === 'xingyu')
                  .map(acc => (
                    <div 
                      key={acc.id}
                      className={`flex items-center gap-3 p-3 rounded-xl ${
                        acc.id === activeAccount?.id 
                          ? 'bg-orange-50 border-2 border-orange-400' 
                          : 'bg-gray-50'
                      }`}
                    >
                      <div className="w-10 h-10 rounded-full bg-gradient-to-br from-orange-400 to-pink-500 flex items-center justify-center overflow-hidden">
                        {acc.avatar ? (
                          <img src={acc.avatar} alt="" className="w-full h-full object-cover" />
                        ) : (
                          <span className="text-white font-bold">{acc.username?.[0]}</span>
                        )}
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="font-medium text-sm truncate">{acc.username}</p>
                        <p className="text-xs text-gray-400 truncate">
                          {acc.boundCharacterIds?.length > 0 
                            ? `ç»‘å®š${acc.boundCharacterIds.length}ä¸ªè§’è‰²` 
                            : 'æœªç»‘å®šè§’è‰²'}
                        </p>
                      </div>
                      
                      {/* è®¾ç½®æŒ‰é’® */}
                      <button
                        onClick={() => { setEditingAccount(acc); setCurrentPage('accountSettings'); }}
                        className="p-2 text-gray-400 hover:text-orange-500"
                      >
                        <Icon name="Settings" size={18} />
                      </button>
                      
                      {acc.id === activeAccount?.id ? (
                        <span className="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full">å½“å‰</span>
                      ) : (
                        <button
                          onClick={() => actions.setActiveAccount(acc.id)}
                          className="text-xs bg-gray-200 text-gray-600 px-3 py-1 rounded-full"
                        >
                          åˆ‡æ¢
                        </button>
                      )}
                    </div>
                  ))}
              </div>
              
              {/* åˆ›å»ºå°å·æŒ‰é’® */}
              <button
                onClick={() => setCurrentPage('createAccount')}
                className="w-full py-3 border-2 border-dashed border-orange-300 rounded-xl text-orange-500 text-sm font-medium flex items-center justify-center gap-2"
              >
                <Icon name="Plus" size={16} />
                åˆ›å»ºå°å·
              </button>
            </div>
            
            {/* è§’è‰²è´¦å·ç®¡ç† */}
            <div className="bg-white mt-2 p-4">
              <div className="flex items-center justify-between mb-3">
                <h3 className="font-semibold">ğŸ­ è§’è‰²è´¦å·</h3>
                <button
                  onClick={() => { setEditingAccount(activeAccount); setCurrentPage('accountSettings'); }}
                  className="text-orange-500 text-sm"
                >
                  ç®¡ç†ç»‘å®š
                </button>
              </div>
              
              {characterAccounts.length === 0 ? (
                <p className="text-gray-400 text-sm text-center py-4">æš‚æ— è§’è‰²è´¦å·</p>
              ) : (
                <div className="space-y-2">
                  {characterAccounts.map(acc => (
                    <div key={acc.id} className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                      <div className="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center overflow-hidden">
                        {acc.avatar ? (
                          <img src={acc.avatar} alt="" className="w-full h-full object-cover" />
                        ) : (
                          <span className="text-white font-bold">{acc.username?.[0]}</span>
                        )}
                      </div>
                      <div className="flex-1">
                        <p className="font-medium text-sm">{acc.username}</p>
                        <p className="text-xs text-gray-400">
                          {state.socialMedia?.posts?.filter(p => p.authorId === acc.id).length || 0} å¸–å­
                        </p>
                      </div>
                      <button
                        onClick={() => handleGenerateCharacterPost(acc)}
                        disabled={isGenerating}
                        className="px-3 py-1 bg-purple-500 text-white text-xs rounded-lg"
                      >
                        {isGenerating ? '...' : 'AIå‘å¸–'}
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>
            
            {/* æ•°æ®ç®¡ç† */}
            <div className="bg-white mt-2 p-4 rounded-xl mx-4 mb-4">
              <h3 className="font-semibold text-gray-800 mb-3">âš™ï¸ æ•°æ®ç®¡ç†</h3>
              
              <div className="space-y-2">
                {/* æ¸…é™¤æ‰€æœ‰å¸–å­ */}
                <button
                  onClick={() => {
                    if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¸–å­å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                      store.setState(s => ({
                        ...s,
                        socialMedia: {
                          ...s.socialMedia,
                          posts: []
                        }
                      }));
                      alert('å·²æ¸…é™¤æ‰€æœ‰å¸–å­');
                    }
                  }}
                  className="w-full py-3 bg-gray-100 rounded-xl text-sm text-gray-600 flex items-center justify-center gap-2"
                >
                  <Icon name="Trash2" size={16} />
                  æ¸…é™¤æ‰€æœ‰å¸–å­
                </button>
                
                {/* æ¸…é™¤æ‰€æœ‰NPCè´¦å· */}
                <button
                  onClick={() => {
                    if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è·¯äºº/ç²‰ä¸è´¦å·å—ï¼Ÿ')) {
                      store.setState(s => ({
                        ...s,
                        socialMedia: {
                          ...s.socialMedia,
                          npcAccounts: []
                        }
                      }));
                      alert('å·²æ¸…é™¤æ‰€æœ‰è·¯äºº/ç²‰ä¸è´¦å·');
                    }
                  }}
                  className="w-full py-3 bg-gray-100 rounded-xl text-sm text-gray-600 flex items-center justify-center gap-2"
                >
                  <Icon name="Users" size={16} />
                  æ¸…é™¤è·¯äºº/ç²‰ä¸è´¦å·
                </button>
                
                {/* æ¸…é™¤çƒ­æœ */}
                <button
                  onClick={() => {
                    if (confirm('ç¡®å®šè¦æ¸…é™¤çƒ­æœæ¦œå—ï¼Ÿ')) {
                      actions.updateHotSearches('xingyu', []);
                      alert('å·²æ¸…é™¤çƒ­æœ');
                    }
                  }}
                  className="w-full py-3 bg-gray-100 rounded-xl text-sm text-gray-600 flex items-center justify-center gap-2"
                >
                  <Icon name="TrendingUp" size={16} />
                  æ¸…é™¤çƒ­æœæ¦œ
                </button>
                
                {/* é‡ç½®æ˜Ÿè¯­ï¼ˆæ¸…é™¤æ‰€æœ‰æ•°æ®ï¼‰ */}
                <button
                  onClick={() => {
                    if (confirm('âš ï¸ ç¡®å®šè¦é‡ç½®æ˜Ÿè¯­å—ï¼Ÿ\n\nè¿™å°†æ¸…é™¤ï¼š\n- æ‰€æœ‰å¸–å­\n- æ‰€æœ‰è´¦å·ï¼ˆåŒ…æ‹¬ä½ çš„å°å·ï¼‰\n- æ‰€æœ‰è§’è‰²è´¦å·\n- çƒ­æœæ¦œ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                      store.setState(s => ({
                        ...s,
                        socialMedia: {
                          userAccounts: [],
                          characterAccounts: [],
                          npcAccounts: [],
                          posts: [],
                          hotSearches: {
                            xingyu: [],
                            wendao: [],
                            shiguang: [],
                            chaguan: []
                          },
                          activeAccount: null
                        }
                      }));
                      setCurrentPage('home');
                      alert('æ˜Ÿè¯­å·²é‡ç½®');
                    }
                  }}
                  className="w-full py-3 bg-red-50 rounded-xl text-sm text-red-500 flex items-center justify-center gap-2 border border-red-200"
                >
                  <Icon name="RefreshCcw" size={16} />
                  é‡ç½®æ˜Ÿè¯­ï¼ˆæ¸…é™¤æ‰€æœ‰æ•°æ®ï¼‰
                </button>
              </div>
            </div>
          </div>
        );
      };
      
      // é¦–é¡µ
      const HomePage = () => {
        const posts = currentTab === 'follow' 
          ? getFollowingPosts()
          : currentTab === 'hot'
            ? getHotPosts()
            : getRecommendPosts();
        
        // AIç”Ÿæˆç²‰ä¸/è·¯äººå¸–å­ï¼ˆ2-3æ¡ï¼‰
        const handleGenerateNPCPosts = async () => {
          if (isGenerating) return;
          setIsGenerating(true);
          
          try {
            // è·å–å½“å‰è´¦å·ç»‘å®šçš„è§’è‰²
            const boundIds = activeAccount?.boundCharacterIds || [];
            
            // åªè·å–å·²åˆ›å»ºæ˜Ÿè¯­è´¦å·ä¸”åœ¨ç»‘å®šåˆ—è¡¨ä¸­çš„è§’è‰²
            let charactersWithAccount = state.characters.filter(c => 
              state.socialMedia?.characterAccounts?.some(
                acc => acc.characterId === c.id && acc.platform === 'xingyu'
              )
            );
            
            // å¦‚æœå½“å‰è´¦å·æœ‰ç»‘å®šè§’è‰²ï¼Œåˆ™åªä½¿ç”¨ç»‘å®šçš„è§’è‰²
            if (boundIds.length > 0) {
              charactersWithAccount = charactersWithAccount.filter(c => boundIds.includes(c.id));
            }
            
            const characterNames = charactersWithAccount.map(c => c.name).join('ã€') || 'æš‚æ— ';
            const characterInfo = charactersWithAccount.map(c => {
              const age = c.age || 'æœªçŸ¥';
              const gender = c.gender === 'male' ? 'ç”·' : c.gender === 'female' ? 'å¥³' : 'æœªçŸ¥';
              let ageDescription = '';
              if (c.age <= 3) {
                ageDescription = 'ï¼ˆå°å®å®/å°å¥¶å¨ƒï¼Œè¿˜ä¸å¤ªä¼šè¯´è¯ï¼Œå¥¶å£°å¥¶æ°”ï¼‰';
              } else if (c.age <= 6) {
                ageDescription = 'ï¼ˆå¹¼å„¿å›­å°æœ‹å‹ï¼Œå¤©çœŸå¯çˆ±ï¼‰';
              } else if (c.age <= 12) {
                ageDescription = 'ï¼ˆå°å­¦ç”Ÿï¼Œæ´»æ³¼å¥½åŠ¨ï¼‰';
              } else if (c.age <= 18) {
                ageDescription = 'ï¼ˆé’å°‘å¹´ï¼‰';
              }
              return `ã€${c.name}ã€‘
- å¹´é¾„ï¼š${age}å²${ageDescription}
- æ€§åˆ«ï¼š${gender}
- äººè®¾ï¼š${c.persona?.slice(0, 150) || 'æš‚æ— '}`;
            }).join('\n\n') || 'æš‚æ— è§’è‰²ä¿¡æ¯';
           
            // ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯æˆ–é»˜è®¤æç¤ºè¯
            const customPrompt = state.apiSettings.xingyuPostPrompt || `ã€ç”Ÿæˆå¸–å­è¦æ±‚ã€‘
1. ç”Ÿæˆ2-3æ¡ä¸åŒç½‘å‹çš„å¸–å­
2. ç½‘å‹ç±»å‹éšæœºï¼šç‹‚çƒ­ç²‰ä¸ã€æ™®é€šè·¯äººã€åƒç“œç¾¤ä¼—ç­‰
3. ä½¿ç”¨çœŸå®çš„ç½‘ç»œç”¨è¯­å’Œè¡¨æƒ…
4. æ¯æ¡å¸–å­20-120å­—
5. å¯ä»¥@è§’è‰²ã€å¸¦è¯é¢˜æ ‡ç­¾#xxx#

ã€è¾“å‡ºæ ¼å¼ã€‘
æ¯æ¡å¸–å­ç”¨ ===å¸–å­=== åˆ†éš”ï¼Œæ ¼å¼ï¼š
===å¸–å­===
æ˜µç§°ï¼šxxx
ç±»å‹ï¼šfan/passerby
å†…å®¹ï¼šxxx
è¯é¢˜ï¼šxxxï¼ˆå¯é€‰ï¼‰`;
            
            // è·å–è§’è‰²å¹´é¾„ä¿¡æ¯æ¥å†³å®šç²‰ä¸ç±»å‹
            let fanTypeGuide = '';
            const mainChar = charactersWithAccount[0];
            if (mainChar) {
              const charAge = mainChar.age || 20;
              if (charAge <= 3) {
                fanTypeGuide = `ã€âš ï¸ é‡è¦ï¼š${mainChar.name}æ‰${charAge}å²ï¼Œæ˜¯ä¸ªå°å®å®/å°å¥¶å¨ƒï¼ã€‘
- ç²‰ä¸ç±»å‹å¿…é¡»æ˜¯ï¼šå¦ˆå¦ˆç²‰ã€é˜¿å§¨ç²‰ã€å§¨æ¯ç¬‘
- ç²‰ä¸ç§°å‘¼è‡ªå·±ä¸ºï¼šé˜¿å§¨ã€å”å”ã€å§¨å§¨ã€å¦ˆå¦ˆç²‰
- ç²‰ä¸ç§°å‘¼è§’è‰²ä¸ºï¼šå°å®è´ã€å°å¯çˆ±ã€å´½å´½ã€å°å¤©ä½¿
- å¸–å­å†…å®¹åº”è¯¥æ˜¯ï¼šå¿ƒç–¼å°æœ‹å‹ã€æ¯çˆ±æ³›æ»¥ã€çœ‹ç€å°±æƒ³rua
- âŒ ç¦æ­¢å‡ºç°ï¼šè¿½æ˜Ÿã€è·¯é€ã€é•¿é«˜äº†ã€å°‘å¹´æ„Ÿã€æ‹çˆ±ã€CPè¿™äº›æˆå¹´å¶åƒçš„å†…å®¹
- âŒ ç¦æ­¢æŠŠå°å®å®å½“æˆé’å°‘å¹´å¶åƒæ¥è¿½`;
              } else if (charAge <= 6) {
                fanTypeGuide = `ã€âš ï¸ é‡è¦ï¼š${mainChar.name}æ‰${charAge}å²ï¼Œæ˜¯ä¸ªå¹¼å„¿å›­å°æœ‹å‹ï¼ã€‘
- ç²‰ä¸ç±»å‹å¿…é¡»æ˜¯ï¼šå¦ˆå¦ˆç²‰ã€é˜¿å§¨ç²‰ã€å§å§ç²‰
- ç²‰ä¸ç§°å‘¼è‡ªå·±ä¸ºï¼šé˜¿å§¨ã€å§å§ã€å§¨å§¨
- å¸–å­å†…å®¹åº”è¯¥æ˜¯ï¼šå¤¸å¯çˆ±ã€å¿ƒç–¼ã€æƒ³æè„¸ã€çœ‹èŠ‚ç›®/æ—¥å¸¸
- âŒ ç¦æ­¢å‡ºç°ï¼šè·¯é€ã€è¿½æ˜Ÿã€å°‘å¹´æ„Ÿã€æ‹çˆ±ã€CP`;
              } else if (charAge <= 12) {
                fanTypeGuide = `ã€${mainChar.name}æ˜¯${charAge}å²çš„å°æœ‹å‹ã€‘
- ç²‰ä¸ç±»å‹ï¼šå§å§ç²‰ã€å¦ˆå¦ˆç²‰ã€é˜¿å§¨ç²‰
- å¯ä»¥æœ‰è¿½æ˜Ÿå†…å®¹ï¼Œä½†è¦ç¬¦åˆå°æœ‹å‹çš„ç‰¹ç‚¹`;
              } else if (charAge <= 18) {
                fanTypeGuide = `ã€${mainChar.name}æ˜¯${charAge}å²çš„é’å°‘å¹´ã€‘
- ç²‰ä¸ç±»å‹ï¼šå§å§ç²‰ã€å¦ˆå¦ˆç²‰ã€åŒé¾„ç²‰
- å¯ä»¥æœ‰æ­£å¸¸è¿½æ˜Ÿå†…å®¹`;
              } else if (mainChar.gender === 'male') {
                fanTypeGuide = `ã€${mainChar.name}æ˜¯${charAge}å²çš„æˆå¹´ç”·æ€§ã€‘
- ç²‰ä¸ç±»å‹ï¼šå¥³å‹ç²‰ã€å¦¹å¦¹ç²‰ã€é¢œç²‰
- å¯ä»¥æœ‰èŠ±ç—´ã€å—‘é¢œç­‰å†…å®¹`;
              } else {
                fanTypeGuide = `ã€${mainChar.name}æ˜¯${charAge}å²çš„æˆå¹´å¥³æ€§ã€‘
- ç²‰ä¸ç±»å‹ï¼šè€å…¬ç²‰ã€å§å§ç²‰ã€é¢œç²‰`;
              }
            }
            
            const prompt = `ä½ ç°åœ¨è¦æ¨¡æ‹Ÿå¤šä¸ªç½‘å‹åœ¨ç¤¾äº¤å¹³å°ã€Œæ˜Ÿè¯­ã€ä¸Šå‘å¸–ã€‚

ã€ç›¸å…³è§’è‰²/æ˜æ˜Ÿä¿¡æ¯ã€‘
${characterInfo || 'æš‚æ— è§’è‰²'}

${fanTypeGuide}

ã€é‡è¦ã€‘ç”Ÿæˆçš„å¸–å­å†…å®¹å¿…é¡»ï¼š
1. æ˜ç¡®æåˆ°ä»¥ä¸‹è§’è‰²ä¹‹ä¸€ï¼š${characterNames}
2. âš ï¸ ä¸¥æ ¼ç¬¦åˆè§’è‰²çš„å¹´é¾„è®¾å®šï¼ä¸è¦æŠŠå°å­©å½“æˆæˆå¹´å¶åƒæ¥å†™ï¼
3. å¦‚æœè§’è‰²æ˜¯å°å®å®/å°æœ‹å‹ï¼Œå¸–å­åº”è¯¥æ˜¯å¦ˆå¦ˆç²‰/é˜¿å§¨ç²‰è§†è§’ï¼Œå†…å®¹æ˜¯æ—¥å¸¸ã€å¯çˆ±ã€å¿ƒç–¼ç­‰
4. å¯ä»¥ç”¨@è§’è‰²åã€#è§’è‰²å#è¯é¢˜æ ‡ç­¾

${customPrompt}

è¯·ä¸¥æ ¼æŒ‰ç…§æ ¼å¼ç”Ÿæˆ2-3æ¡ä¸åŒé£æ ¼çš„å¸–å­ã€‚æ¯æ¡å¸–å­å¿…é¡»ç”¨ ===å¸–å­=== å¼€å¤´åˆ†éš”ã€‚`;

            const messages = [
              { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªç¤¾äº¤åª’ä½“ç”¨æˆ·æ¨¡æ‹Ÿå™¨ï¼Œéœ€è¦ç”Ÿæˆå¤šæ¡çœŸå®çš„ç½‘å‹å¸–å­ã€‚ä¸¥æ ¼æŒ‰ç…§æŒ‡å®šæ ¼å¼è¾“å‡ºï¼Œæ¯æ¡å¸–å­å¿…é¡»ä»¥ ===å¸–å­=== å¼€å¤´ã€‚' },
              { role: 'user', content: prompt }
            ];
            
            const response = await callChatCompletion(state.apiSettings, messages, null);
            
            console.log('AIå“åº”:', response); // è°ƒè¯•ç”¨
            
            // è§£æå¤šæ¡å¸–å­ - æ”¹è¿›è§£æé€»è¾‘
            let postBlocks = response.split(/===\s*å¸–å­\s*===/).filter(b => b.trim());
            
            // å¦‚æœæ²¡æœ‰æŒ‰æ ¼å¼åˆ†éš”ï¼Œå°è¯•å…¶ä»–åˆ†éš”æ–¹å¼
            if (postBlocks.length <= 1) {
              // å°è¯•ç”¨æ•°å­—åºå·åˆ†éš”
              postBlocks = response.split(/(?=\d+\.\s*æ˜µç§°|(?=å¸–å­\s*\d+)|(?=ã€å¸–å­\d+ã€‘))/).filter(b => b.trim());
            }
            
            // å¦‚æœè¿˜æ˜¯åªæœ‰ä¸€æ¡ï¼Œå°è¯•æŒ‰åŒæ¢è¡Œåˆ†éš”
            if (postBlocks.length <= 1 && response.includes('\n\n')) {
              const sections = response.split('\n\n').filter(s => s.trim().length > 20);
              if (sections.length >= 2) {
                postBlocks = sections.slice(0, 3);
              }
            }
            
            console.log('è§£æåˆ°çš„å¸–å­å—æ•°:', postBlocks.length); // è°ƒè¯•ç”¨
            
            let createdCount = 0;
            
            for (const block of postBlocks) {
              if (createdCount >= 3) break; // æœ€å¤š3æ¡
              
              // è§£ææ¯æ¡å¸–å­
              const usernameMatch = block.match(/æ˜µç§°[ï¼š:]\s*(.+?)(?:\n|$)/);
              const typeMatch = block.match(/ç±»å‹[ï¼š:]\s*(.+?)(?:\n|$)/);
              const contentMatch = block.match(/å†…å®¹[ï¼š:]\s*([\s\S]*?)(?=(?:è¯é¢˜[ï¼š:]|$))/);
              const topicMatch = block.match(/è¯é¢˜[ï¼š:]\s*(.+?)(?:\n|$)/);
              
              let username = usernameMatch?.[1]?.trim();
              let npcType = typeMatch?.[1]?.trim()?.toLowerCase() || 'fan';
              let content = contentMatch?.[1]?.trim();
              let topic = topicMatch?.[1]?.trim()?.replace(/#/g, '');
              
              // å¦‚æœæ ¼å¼è§£æå¤±è´¥ï¼Œå°è¯•ç®€å•æå–
              if (!content && block.trim().length > 10) {
                // ç§»é™¤å¯èƒ½çš„æ ‡ç­¾è¡Œï¼Œå‰©ä¸‹çš„å°±æ˜¯å†…å®¹
                let cleanBlock = block
                  .replace(/æ˜µç§°[ï¼š:].*?\n?/g, '')
                  .replace(/ç±»å‹[ï¼š:].*?\n?/g, '')
                  .replace(/è¯é¢˜[ï¼š:].*?\n?/g, '')
                  .replace(/å†…å®¹[ï¼š:]/g, '')
                  .trim();
                
                if (cleanBlock.length > 10) {
                  content = cleanBlock;
                }
              }
              
              if (!content || content.length < 5) continue;
              
              // ä»å†…å®¹ä¸­æå–è¯é¢˜
              const inlineTopicMatch = content.match(/#([^#]+)#/);
              if (inlineTopicMatch && !topic) {
                topic = inlineTopicMatch[1];
              }
              content = content.replace(/#[^#]+#/g, '').trim();
              
              // ç”Ÿæˆéšæœºç”¨æˆ·å
              if (!username) {
                const fanNames = ['è¿½æ˜Ÿå°‘å¥³', 'å°è¿·å¦¹', 'æ°¸è¿œçˆ±ä½ ', 'å¤´å·ç²‰ä¸', 'åº”æ´ç«™', 'ä»Šå¤©ä¹Ÿå¾ˆçˆ±', 'é¢œæ§æœ¬æ§', 'è¿½æ˜Ÿæ—¥è®°', 'é¥­åœˆå¥³å­©'];
                const passerbyNames = ['åƒç“œç¾¤ä¼—', 'è·¯è¿‡çš„', 'çœ‹çƒ­é—¹çš„', 'æ™®é€šç½‘å‹', 'éšä¾¿çœ‹çœ‹', 'å›´è§‚ç¾¤ä¼—', 'åƒç“œer'];
                
                const isFan = npcType.includes('fan') || Math.random() > 0.4;
                const nameList = isFan ? fanNames : passerbyNames;
                username = nameList[Math.floor(Math.random() * nameList.length)] + Math.floor(Math.random() * 1000);
                npcType = isFan ? 'fan' : 'passerby';
              }
              
              // åˆ›å»ºNPCè´¦å·
              const npcId = actions.createNPCAccount({
                platform: 'xingyu',
                username: username,
                avatar: '',
                type: npcType.includes('fan') ? 'fan' : npcType.includes('hater') ? 'hater' : 'passerby'
              });
              
              // éšæœºç”Ÿæˆäº’åŠ¨æ•°æ®
              const isFanPost = npcType.includes('fan');
              const baseLikes = isFanPost ? 300 : 80;
              const likes = Math.floor(Math.random() * baseLikes) + Math.floor(Math.random() * 200) + 20;
              const reposts = Math.floor(Math.random() * 30) + (isFanPost ? 10 : 2);
              const views = Math.floor(Math.random() * 5000) + 500;
              
              // å‘å¸ƒå¸–å­ï¼ˆå¸¦äº’åŠ¨æ•°æ®ï¼‰
              actions.createPost({
                platform: 'xingyu',
                authorType: 'npc',
                authorId: npcId,
                content: content,
                topic: topic || null,
                images: [],
                likes: likes,
                reposts: reposts,
                views: views,
                comments: []
              });
              
              createdCount++;
              
              // ç¨å¾®å»¶è¿Ÿï¼Œè®©å¸–å­æŒ‰é¡ºåºå‡ºç°
              await new Promise(resolve => setTimeout(resolve, 150));
            }
            
            // å¦‚æœæ²¡æœ‰è§£æåˆ°ä»»ä½•å¸–å­ï¼Œç”Ÿæˆé»˜è®¤çš„2æ¡
            if (createdCount === 0) {
              // ç”Ÿæˆ2æ¡é»˜è®¤å¸–å­
              for (let i = 0; i < 2; i++) {
                const isFan = i === 0;
                const username = isFan 
                  ? 'è¿½æ˜Ÿå°‘å¥³' + Math.floor(Math.random() * 1000)
                  : 'åƒç“œç¾¤ä¼—' + Math.floor(Math.random() * 1000);
                
                const npcId = actions.createNPCAccount({
                  platform: 'xingyu',
                  username: username,
                  avatar: '',
                  type: isFan ? 'fan' : 'passerby'
                });
                
                // åˆ†å‰²å“åº”å†…å®¹ä½œä¸ºå¸–å­
                const contentParts = response.split('\n\n').filter(p => p.trim().length > 10);
                const content = contentParts[i] || response.slice(i * 100, (i + 1) * 100 + 50);
                
                actions.createPost({
                  platform: 'xingyu',
                  authorType: 'npc',
                  authorId: npcId,
                  content: content.slice(0, 150).trim(),
                  topic: null,
                  images: [],
                  likes: Math.floor(Math.random() * 300) + 50,
                  reposts: Math.floor(Math.random() * 30) + 5,
                  views: Math.floor(Math.random() * 3000) + 200,
                  comments: []
                });
                
                await new Promise(resolve => setTimeout(resolve, 100));
              }
            }
            
            console.log('æˆåŠŸåˆ›å»ºå¸–å­æ•°:', createdCount || 2);
            
          } catch (error) {
            console.error('ç”Ÿæˆå¸–å­å¤±è´¥:', error);
            alert('ç”Ÿæˆå¤±è´¥: ' + error.message);
          } finally {
            setIsGenerating(false);
          }
        };
        
        return (
          <>
            {/* æ ‡ç­¾åˆ‡æ¢ */}
            <div className="flex bg-white border-b sticky top-0 z-10">
              {[
                { id: 'follow', label: 'å…³æ³¨' },
                { id: 'recommend', label: 'æ¨è' },
                { id: 'hot', label: 'çƒ­é—¨' }
              ].map(tab => (
                <button
                  key={tab.id}
                  onClick={() => setCurrentTab(tab.id)}
                  className={`flex-1 py-3 text-sm font-medium relative ${
                    currentTab === tab.id ? 'text-orange-500' : 'text-gray-500'
                  }`}
                >
                  {tab.label}
                  {currentTab === tab.id && (
                    <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-6 h-0.5 bg-orange-500 rounded-full" />
                  )}
                </button>
              ))}
            </div>
            
            {/* åˆ·æ–°/ç”ŸæˆæŒ‰é’® - æ¨èå’Œçƒ­é—¨é¡µæ˜¾ç¤º */}
            {(currentTab === 'recommend' || currentTab === 'hot') && (
              <div className="bg-white px-4 py-2 border-b">
                <button
                  onClick={handleGenerateNPCPosts}
                  disabled={isGenerating}
                  className="w-full py-2 bg-gradient-to-r from-orange-100 to-pink-100 text-orange-600 rounded-xl text-sm font-medium flex items-center justify-center gap-2"
                >
                  {isGenerating ? (
                    <>
                      <Icon name="Loader2" size={16} className="animate-spin" />
                      ç”Ÿæˆä¸­...
                    </>
                  ) : (
                    <>
                      <Icon name="RefreshCw" size={16} />
                      åˆ·æ–° Â· AIç”Ÿæˆæ–°å¸–å­
                    </>
                  )}
                </button>
              </div>
            )}
            
            {/* å…³æ³¨é¡µæç¤º - å¦‚æœæ²¡æœ‰å…³æ³¨ä»»ä½•äºº */}
            {currentTab === 'follow' && posts.length === 0 && (
              <div className="bg-orange-50 mx-4 mt-4 p-4 rounded-xl">
                <p className="text-orange-600 text-sm text-center mb-2">ğŸ’¡ è¿˜æ²¡æœ‰å…³æ³¨ä»»ä½•äºº</p>
                <p className="text-orange-500 text-xs text-center">å»ã€Œæ¨èã€æˆ–ã€Œçƒ­é—¨ã€é¡µé¢å…³æ³¨è§’è‰²å§~</p>
                <p className="text-orange-400 text-xs text-center mt-2">å…³æ³¨åï¼Œä»–ä»¬çš„å¸–å­ä¼šå‡ºç°åœ¨è¿™é‡Œ</p>
              </div>
            )}
            
            {/* å¸–å­åˆ—è¡¨ */}
            <div className="flex-1 overflow-y-auto">
              {posts.length === 0 && currentTab !== 'follow' ? (
                <div className="p-8 text-center text-gray-400">
                  <Icon name="FileText" size={48} className="mx-auto mb-2 opacity-30" />
                  <p>æš‚æ— å¸–å­</p>
                  <p className="text-sm mt-1">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆæ–°å¸–å­</p>
                </div>
              ) : posts.length === 0 ? null : (
                posts.map(post => <PostCard key={post.id} post={post} />)
              )}
            </div>
          </>
        );
      };
      
      // æ²¡æœ‰è´¦å·æ—¶çš„å¼•å¯¼
      if (!activeAccount && currentPage !== 'createAccount') {
        return (
          <div className="w-full h-full bg-gray-100 flex flex-col">
            <div 
              className="pt-12 pb-4 px-4"
              style={{
                backgroundImage: 'url(https://cdn.mujian.me/tuchuang/696e25d002154.jpg)',
                backgroundSize: 'cover',
                backgroundPosition: 'center top'
              }}
            >
              <div className="flex items-center gap-4">
                <button onClick={() => actions.setScreen('home')} className="text-white">
                  <Icon name="ChevronLeft" size={24} />
                </button>
                <h1 className="text-white text-xl font-semibold">â­ æ˜Ÿè¯­</h1>
              </div>
            </div>
            
            <div className="flex-1 flex flex-col items-center justify-center p-8">
              <div className="w-24 h-24 rounded-full bg-gradient-to-br from-orange-400 to-pink-500 flex items-center justify-center mb-4">
                <Icon name="Star" size={48} className="text-white" />
              </div>
              <h2 className="text-xl font-bold mb-2">æ¬¢è¿æ¥åˆ°æ˜Ÿè¯­</h2>
              <p className="text-gray-500 text-center mb-6">åˆ›å»ºä½ çš„è´¦å·ï¼Œå¼€å§‹åˆ†äº«ç²¾å½©ç¬é—´</p>
              <button
                onClick={() => setCurrentPage('createAccount')}
                className="px-8 py-3 bg-gradient-to-r from-orange-400 to-pink-500 text-white rounded-full font-medium"
              >
                åˆ›å»ºè´¦å·
              </button>
            </div>
          </div>
        );
      }

      // å¸–å­è¯¦æƒ…é¡µ - å…¨å±è¦†ç›–
      if (currentPage === 'detail') {
        return <PostDetailPage />;
      }
      
      // ç”¨æˆ·ä¸»é¡µ - å…¨å±è¦†ç›–
      if (currentPage === 'userProfile') {
        return <UserProfilePage />;
      }
      
            // è´¦å·è®¾ç½®é¡µé¢ - å…¨å±è¦†ç›–
      if (currentPage === 'accountSettings') {
        return (
          <div className="w-full h-full bg-gray-100 flex flex-col">
            <AccountSettingsPage />
          </div>
        );
      }
      
      // æ²¡æœ‰è´¦å·æ—¶çš„å¼•å¯¼
      if (!activeAccount && currentPage !== 'createAccount') {
        return (
          <div className="w-full h-full bg-gray-100 flex flex-col">
            <div 
              className="pt-12 pb-4 px-4"
              style={{
                backgroundImage: 'url(https://cdn.mujian.me/tuchuang/696e25d002154.jpg)',
                backgroundSize: 'cover',
                backgroundPosition: 'center top'
              }}
            >
              <div className="flex items-center gap-4">
                <button onClick={() => actions.setScreen('home')} className="text-white">
                  <Icon name="ChevronLeft" size={24} />
                </button>
                <h1 className="text-white text-xl font-semibold drop-shadow-lg">â­ æ˜Ÿè¯­</h1>
              </div>
            </div>
            
            <div className="flex-1 flex flex-col items-center justify-center p-8">
              <div className="w-24 h-24 rounded-full bg-gradient-to-br from-orange-400 to-pink-500 flex items-center justify-center mb-4">
                <Icon name="Star" size={48} className="text-white" />
              </div>
              <h2 className="text-xl font-bold mb-2">æ¬¢è¿æ¥åˆ°æ˜Ÿè¯­</h2>
              <p className="text-gray-500 text-center mb-6">åˆ›å»ºä½ çš„è´¦å·ï¼Œå¼€å§‹åˆ†äº«ç²¾å½©ç¬é—´</p>
              <button
                onClick={() => setCurrentPage('createAccount')}
                className="px-8 py-3 bg-gradient-to-r from-orange-400 to-pink-500 text-white rounded-full font-medium"
              >
                åˆ›å»ºè´¦å·
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="w-full h-full bg-gray-100 flex flex-col">
          {/* å¤´éƒ¨ - æ˜Ÿç©ºèƒŒæ™¯ */}
          <div 
            className="pt-12 pb-4 px-4"
            style={{
              backgroundImage: 'url(https://cdn.mujian.me/tuchuang/696e25d002154.jpg)',
              backgroundSize: 'cover',
              backgroundPosition: 'center top'
            }}
          >
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <button onClick={() => actions.setScreen('home')} className="text-white drop-shadow-lg">
                  <Icon name="ChevronLeft" size={24} />
                </button>
                <h1 className="text-white text-xl font-semibold drop-shadow-lg">ğŸŒŸ æ˜Ÿè¯­</h1>
              </div>
              {currentPage === 'home' && (
                <button 
                  onClick={() => setShowCreatePost(true)}
                  className="text-white drop-shadow-lg"
                >
                  <Icon name="PenSquare" size={22} />
                </button>
              )}
            </div>
          </div>

          {/* å†…å®¹åŒºåŸŸ */}
          {currentPage === 'createAccount' && <CreateAccountPage />}
          {currentPage === 'home' && <HomePage />}
          {currentPage === 'hot' && <HotSearchPage />}
          {currentPage === 'profile' && <ProfilePage />}

          {/* åº•éƒ¨å¯¼èˆª */}
          {currentPage !== 'createAccount' && (
            <div className="bg-white border-t flex flex-shrink-0">
              <button
                onClick={() => setCurrentPage('home')}
                className={`flex-1 py-3 flex flex-col items-center gap-1 ${
                  currentPage === 'home' ? 'text-orange-500' : 'text-gray-400'
                }`}
              >
                <Icon name="Home" size={22} />
                <span className="text-xs">é¦–é¡µ</span>
              </button>
              <button
                onClick={() => setCurrentPage('hot')}
                className={`flex-1 py-3 flex flex-col items-center gap-1 ${
                  currentPage === 'hot' ? 'text-orange-500' : 'text-gray-400'
                }`}
              >
                <Icon name="TrendingUp" size={22} />
                <span className="text-xs">çƒ­æœ</span>
              </button>
              <button
                onClick={() => setCurrentPage('profile')}
                className={`flex-1 py-3 flex flex-col items-center gap-1 ${
                  currentPage === 'profile' ? 'text-orange-500' : 'text-gray-400'
                }`}
              >
                <Icon name="User" size={22} />
                <span className="text-xs">æˆ‘çš„</span>
              </button>
            </div>
          )}

          {/* å‘å¸–å¼¹çª— */}
          {showCreatePost && (
            <div className="absolute inset-0 bg-black/50 z-50 flex items-end">
              <div className="w-full bg-white rounded-t-3xl animate-slide-up">
                <div className="flex items-center justify-between p-4 border-b">
                  <button onClick={() => setShowCreatePost(false)} className="text-gray-500">
                    å–æ¶ˆ
                  </button>
                  <span className="font-semibold">å‘å¸–</span>
                  <button
                    onClick={handleCreatePost}
                    disabled={!postContent.trim()}
                    className={`font-semibold ${postContent.trim() ? 'text-orange-500' : 'text-gray-300'}`}
                  >
                    å‘å¸ƒ
                  </button>
                </div>
                
                <div className="p-4">
                  <textarea
                    value={postContent}
                    onChange={(e) => setPostContent(e.target.value)}
                    placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..."
                    className="w-full h-32 resize-none text-sm outline-none"
                    autoFocus
                  />
                  
                  <div className="flex items-center gap-2 mt-2">
                    <span className="text-gray-400">#</span>
                    <input
                      type="text"
                      value={postTopic}
                      onChange={(e) => setPostTopic(e.target.value)}
                      placeholder="æ·»åŠ è¯é¢˜"
                      className="flex-1 text-sm text-orange-500 outline-none"
                    />
                  </div>
                </div>
              </div>
            </div>
          )}
          
          {/* è½¬å‘åˆ°èŠå¤©å¼¹çª— */}
{showShareModal && sharingPost && (
  <div className="absolute inset-0 bg-black/50 z-50 flex items-end">
    <div className="w-full bg-white rounded-t-3xl animate-slide-up max-h-[70%] flex flex-col">
      <div className="flex items-center justify-between p-4 border-b flex-shrink-0">
        <span className="font-semibold">è½¬å‘åˆ°èŠå¤©</span>
        <button onClick={() => { setShowShareModal(false); setSharingPost(null); }}>
          <Icon name="X" size={24} className="text-gray-500" />
        </button>
      </div>
      
      {/* å¸–å­é¢„è§ˆ */}
      <div className="p-4 border-b bg-gray-50 flex-shrink-0">
        <div className="bg-white rounded-xl p-3 shadow-sm">
          <div className="flex items-center gap-2 mb-2">
            <div className="w-6 h-6 rounded-full bg-gradient-to-br from-orange-400 to-pink-500 flex items-center justify-center">
              <span className="text-white text-xs font-bold">
                {getAccountById(sharingPost.authorId, sharingPost.authorType)?.username?.[0] || '?'}
              </span>
            </div>
            <span className="text-sm font-medium text-gray-800">
              {getAccountById(sharingPost.authorId, sharingPost.authorType)?.username || 'ç”¨æˆ·'}
            </span>
          </div>
          <p className="text-sm text-gray-600 line-clamp-2">{sharingPost.content}</p>
        </div>
      </div>
      
      {/* èŠå¤©åˆ—è¡¨ */}
      <div className="flex-1 overflow-y-auto p-4">
        {state.chats.length === 0 ? (
          <div className="text-center text-gray-400 py-8">
            <Icon name="MessageCircle" size={48} className="mx-auto mb-2 opacity-30" />
            <p>æš‚æ— èŠå¤©</p>
            <p className="text-sm mt-1">å…ˆå»å¾®ä¿¡åˆ›å»ºä¸€ä¸ªèŠå¤©å§</p>
          </div>
        ) : (
          <div className="space-y-2">
            {state.chats.map(chat => {
              const firstChar = state.characters.find(c => c.id === chat.characterIds?.[0]);
              const chatAvatar = chat.avatar || firstChar?.avatar;
              const chatName = chat.name || firstChar?.name || 'èŠå¤©';
              
              return (
                <button
                  key={chat.id}
                  onClick={() => {
                    // è½¬å‘å¸–å­åˆ°èŠå¤©
                    const postAuthor = getAccountById(sharingPost.authorId, sharingPost.authorType);
                    const shareMessage = {
                      type: 'shared_post',
                      content: sharingPost.content,
                      sharedPost: {
                        id: sharingPost.id,
                        authorName: postAuthor?.username || 'ç”¨æˆ·',
                        authorAvatar: postAuthor?.avatar || '',
                        content: sharingPost.content,
                        topic: sharingPost.topic,
                        likes: sharingPost.likes,
                        comments: sharingPost.comments?.length || 0,
                        platform: 'xingyu'
                      }
                    };
                    
                    actions.addMessage(chat.id, shareMessage);
                    
                    // å¢åŠ è½¬å‘æ•°
                    store.setState(s => ({
                      ...s,
                      socialMedia: {
                        ...s.socialMedia,
                        posts: s.socialMedia.posts.map(p => 
                          p.id === sharingPost.id 
                            ? { ...p, reposts: (p.reposts || 0) + 1 }
                            : p
                        )
                      }
                    }));
                    
                    setShowShareModal(false);
                    setSharingPost(null);
                    
                    // æç¤ºå¹¶è·³è½¬
                    if (confirm('è½¬å‘æˆåŠŸï¼æ˜¯å¦ç«‹å³æŸ¥çœ‹ï¼Ÿ')) {
                      actions.setScreen('wechat');
                      actions.setCurrentChat(chat.id);
                    }
                  }}
                  className="w-full flex items-center gap-3 p-3 bg-gray-50 rounded-xl active:bg-gray-100"
                >
                  <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-green-400 to-teal-500 flex items-center justify-center overflow-hidden">
                    {chatAvatar ? (
                      <img src={chatAvatar} alt="" className="w-full h-full object-cover" />
                    ) : (
                      <span className="text-white font-bold">{chatName[0]}</span>
                    )}
                  </div>
                  <div className="flex-1 text-left">
                    <p className="font-medium text-gray-800">{chatName}</p>
                    <p className="text-xs text-gray-400">
                      {chat.type === 'group' ? 'ç¾¤èŠ' : 'ç§èŠ'} Â· {chat.messages?.length || 0}æ¡æ¶ˆæ¯
                    </p>
                  </div>
                  <Icon name="Send" size={20} className="text-gray-400" />
                </button>
              );
            })}
          </div>
        )}
      </div>
    </div>
  </div>
)}
          
          {/* è´¦å·åˆ‡æ¢å¼¹çª— */}
          {showAccountPicker && (
            <div className="absolute inset-0 bg-black/50 z-50 flex items-end">
              <div className="w-full bg-white rounded-t-3xl animate-slide-up max-h-[60%]">
                <div className="flex items-center justify-between p-4 border-b">
                  <span className="font-semibold">åˆ‡æ¢è´¦å·</span>
                  <button onClick={() => setShowAccountPicker(false)}>
                    <Icon name="X" size={24} className="text-gray-500" />
                  </button>
                </div>
                
                <div className="p-4 overflow-y-auto">
                  {(state.socialMedia?.userAccounts || []).map(acc => (
                    <button
                      key={acc.id}
                      onClick={() => {
                        actions.setActiveAccount(acc.id);
                        setShowAccountPicker(false);
                      }}
                      className={`w-full flex items-center gap-3 p-3 rounded-xl mb-2 ${
                        acc.id === activeAccount?.id ? 'bg-orange-50 border-2 border-orange-500' : 'bg-gray-50'
                      }`}
                    >
                      <div className="w-12 h-12 rounded-full bg-gradient-to-br from-orange-400 to-pink-500 flex items-center justify-center overflow-hidden">
                        {acc.avatar ? (
                          <img src={acc.avatar} alt="" className="w-full h-full object-cover" />
                        ) : (
                          <span className="text-white font-bold">{acc.username?.[0]}</span>
                        )}
                      </div>
                      <div className="flex-1 text-left">
                        <p className="font-medium">{acc.username}</p>
                        <p className="text-xs text-gray-400">{acc.bio || 'æš‚æ— ç®€ä»‹'}</p>
                      </div>
                      {acc.id === activeAccount?.id && (
                        <Icon name="Check" size={20} className="text-orange-500" />
                      )}
                    </button>
                  ))}
                  
                  <button
                    onClick={() => {
                      setShowAccountPicker(false);
                      setCurrentPage('createAccount');
                    }}
                    className="w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 text-sm mt-2"
                  >
                    + åˆ›å»ºæ–°è´¦å·
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };
    
    // ==================== ä¸–ç•Œä¹¦ç»„ä»¶ ====================
    const WorldBook = () => {
      const state = useStore();
      const [currentFolderId, setCurrentFolderId] = useState(null);
      const [showCreateModal, setShowCreateModal] = useState(false);
      const [createType, setCreateType] = useState('entry');
      const [showEditor, setShowEditor] = useState(false);
      const [editingEntry, setEditingEntry] = useState(null);
      const [formName, setFormName] = useState('');
      const [formContent, setFormContent] = useState('');

      const currentEntries = state.worldBook.filter(e => e.parentId === currentFolderId);

      const getBreadcrumbs = () => {
        const breadcrumbs = [];
        let currentId = currentFolderId;
        while (currentId) {
          const entry = state.worldBook.find(e => e.id === currentId);
          if (entry) {
            breadcrumbs.unshift(entry);
            currentId = entry.parentId;
          } else break;
        }
        return breadcrumbs;
      };

      const handleCreate = () => {
        if (!formName.trim()) return;
        actions.createWorldBookEntry({
          type: createType,
          parentId: currentFolderId,
          name: formName.trim(),
          content: createType === 'entry' ? formContent : undefined
        });
        setShowCreateModal(false);
        setFormName('');
        setFormContent('');
      };

      const handleOpenEntry = (entry) => {
        if (entry.type === 'folder') {
          setCurrentFolderId(entry.id);
        } else {
          setEditingEntry(entry);
          setFormName(entry.name);
          setFormContent(entry.content || '');
          setShowEditor(true);
        }
      };

      const handleSaveEntry = () => {
        if (!editingEntry) return;
        actions.updateWorldBookEntry(editingEntry.id, {
          name: formName.trim(),
          content: formContent
        });
        setShowEditor(false);
        setEditingEntry(null);
      };

      const handleDelete = (entry) => {
        if (confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')) {
          actions.deleteWorldBookEntry(entry.id);
        }
      };

      const goBack = () => {
        if (currentFolderId) {
          const currentFolder = state.worldBook.find(e => e.id === currentFolderId);
          setCurrentFolderId(currentFolder?.parentId || null);
        }
      };

      return (
        <div className="w-full h-full bg-gray-100 flex flex-col">
          <div className="glass-dark pt-12 pb-4 px-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <button onClick={() => currentFolderId ? goBack() : actions.setScreen('home')} className="text-white">
                  <Icon name="ChevronLeft" size={24} />
                </button>
                <h1 className="text-white text-xl font-semibold">ä¸–ç•Œä¹¦</h1>
              </div>
              <button onClick={() => setShowCreateModal(true)} className="text-white">
                <Icon name="Plus" size={24} />
              </button>
            </div>

            <div className="flex items-center gap-1 mt-3 text-white/70 text-sm overflow-x-auto">
              <button onClick={() => setCurrentFolderId(null)} className="hover:text-white whitespace-nowrap">
                æ ¹ç›®å½•
              </button>
              {getBreadcrumbs().map((crumb) => (
                <React.Fragment key={crumb.id}>
                  <Icon name="ChevronRight" size={16} />
                  <button onClick={() => setCurrentFolderId(crumb.id)} className="hover:text-white whitespace-nowrap">
                    {crumb.name}
                  </button>
                </React.Fragment>
              ))}
            </div>
          </div>

          <div className="flex-1 overflow-y-auto p-4">
            {currentEntries.length === 0 ? (
              <div className="text-center text-gray-500 py-16">
                <Icon name="Folder" size={64} className="mx-auto mb-4 opacity-30" />
                <p>æ­¤æ–‡ä»¶å¤¹ä¸ºç©º</p>
              </div>
            ) : (
              <div className="space-y-2">
                {currentEntries
                  .sort((a, b) => (a.type === 'folder' ? -1 : 1))
                  .map((entry) => (
                    <div key={entry.id} className="bg-white rounded-xl p-4 flex items-center gap-3">
                      <button onClick={() => handleOpenEntry(entry)} className="flex-1 flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
                          entry.type === 'folder' ? 'bg-yellow-100' : 'bg-blue-100'
                        }`}>
                          <Icon 
                            name={entry.type === 'folder' ? 'Folder' : 'FileText'} 
                            size={20} 
                            className={entry.type === 'folder' ? 'text-yellow-600' : 'text-blue-500'} 
                          />
                        </div>
                        <div className="flex-1 text-left">
                          <h3 className="font-medium text-gray-800">{entry.name}</h3>
                          {entry.type === 'entry' && (
                            <p className="text-xs text-gray-500 truncate">{entry.content?.slice(0, 50) || 'ç©ºå†…å®¹'}</p>
                          )}
                        </div>
                        {entry.type === 'folder' && <Icon name="ChevronRight" size={20} className="text-gray-400" />}
                      </button>
                      <button onClick={() => handleDelete(entry)} className="p-2 text-red-400">
                        <Icon name="Trash2" size={20} />
                      </button>
                    </div>
                  ))}
              </div>
            )}
          </div>

          {/* åˆ›å»ºå¼¹çª— */}
          {showCreateModal && (
            <div className="absolute inset-0 bg-black/50 flex items-end z-50">
              <div className="w-full bg-white rounded-t-3xl p-6 animate-slide-up">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-xl font-bold">æ–°å»º</h2>
                  <button onClick={() => setShowCreateModal(false)} className="text-gray-500">
                    <Icon name="X" size={24} />
                  </button>
                </div>

                <div className="flex gap-4 mb-4">
                  <button
                    onClick={() => setCreateType('folder')}
                    className={`flex-1 p-4 rounded-xl flex flex-col items-center gap-2 border-2 ${
                      createType === 'folder' ? 'border-yellow-500 bg-yellow-50' : 'border-gray-200'
                    }`}
                  >
                    <Icon name="FolderPlus" size={32} className={createType === 'folder' ? 'text-yellow-500' : 'text-gray-400'} />
                    <span>æ–‡ä»¶å¤¹</span>
                  </button>
                  <button
                    onClick={() => setCreateType('entry')}
                    className={`flex-1 p-4 rounded-xl flex flex-col items-center gap-2 border-2 ${
                      createType === 'entry' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'
                    }`}
                  >
                    <Icon name="FilePlus" size={32} className={createType === 'entry' ? 'text-blue-500' : 'text-gray-400'} />
                    <span>æ¡ç›®</span>
                  </button>
                </div>

                <div className="space-y-4">
                  <input
                    type="text"
                    value={formName}
                    onChange={(e) => setFormName(e.target.value)}
                    className="w-full p-3 bg-gray-100 rounded-xl"
                    placeholder="åç§°"
                  />
                  {createType === 'entry' && (
                    <textarea
                      value={formContent}
                      onChange={(e) => setFormContent(e.target.value)}
                      className="w-full h-32 p-3 bg-gray-100 rounded-xl resize-none"
                      placeholder="å†…å®¹..."
                    />
                  )}
                </div>

                <button
                  onClick={handleCreate}
                  disabled={!formName.trim()}
                  className={`w-full mt-6 p-4 rounded-xl font-semibold ${
                    formName.trim() ? 'bg-purple-500 text-white' : 'bg-gray-200 text-gray-400'
                  }`}
                >
                  åˆ›å»º
                </button>
              </div>
            </div>
          )}

          {/* ç¼–è¾‘å¼¹çª— */}
          {showEditor && editingEntry && (
            <div className="absolute inset-0 bg-gray-100 z-50 flex flex-col">
              <div className="glass-dark pt-12 pb-4 px-4">
                <div className="flex items-center justify-between">
                  <button onClick={() => { setShowEditor(false); setEditingEntry(null); }} className="text-white">
                    <Icon name="X" size={24} />
                  </button>
                  <h1 className="text-white text-lg font-semibold">ç¼–è¾‘æ¡ç›®</h1>
                  <button onClick={handleSaveEntry} className="text-white">
                    <Icon name="Save" size={24} />
                  </button>
                </div>
              </div>
              <div className="flex-1 p-4 flex flex-col gap-4">
                <input
                  type="text"
                  value={formName}
                  onChange={(e) => setFormName(e.target.value)}
                  className="w-full p-3 bg-white rounded-xl"
                  placeholder="åç§°"
                />
                <textarea
                  value={formContent}
                  onChange={(e) => setFormContent(e.target.value)}
                  className="flex-1 p-3 bg-white rounded-xl resize-none"
                  placeholder="å†…å®¹..."
                />
              </div>
            </div>
          )}
        </div>
      );
    };
    
    // ==================== æç¤ºè¯è®¾ç½®é¡µé¢ ====================
const PromptsPage = () => {
  const state = useStore();
  const [localPrompts, setLocalPrompts] = useState({
    systemPrompt: state.apiSettings.systemPrompt || defaultSystemPrompt,
    summaryPrompt: state.apiSettings.summaryPrompt || defaultSummaryPrompt,
    xingyuPostPrompt: state.apiSettings.xingyuPostPrompt || defaultXingyuPostPrompt,
    xingyuCommentPrompt: state.apiSettings.xingyuCommentPrompt || defaultXingyuCommentPrompt,
    xingyuCharacterReplyPrompt: state.apiSettings.xingyuCharacterReplyPrompt || defaultXingyuCharacterReplyPrompt,
  });
  const [saveMsg, setSaveMsg] = useState('');
  const [activeTab, setActiveTab] = useState('system');

  const handleSave = () => {
    actions.updateApiSettings(localPrompts);
    setSaveMsg('âœ… å·²ä¿å­˜');
    setTimeout(() => setSaveMsg(''), 2000);
  };

  const handleReset = (key, defaultValue) => {
    setLocalPrompts(prev => ({ ...prev, [key]: defaultValue }));
  };

  const tabs = [
    { id: 'system', label: 'ç³»ç»Ÿ', icon: 'ğŸ¤–' },
    { id: 'summary', label: 'æ€»ç»“', icon: 'ğŸ“‹' },
    { id: 'xingyu', label: 'æ˜Ÿè¯­', icon: 'â­' },
  ];

  return (
    <div className="flex-1 overflow-y-auto p-4 space-y-4">
      {/* æ ‡ç­¾åˆ‡æ¢ */}
      <div className="flex bg-white rounded-xl p-1 gap-1">
        {tabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${
              activeTab === tab.id 
                ? 'bg-blue-500 text-white' 
                : 'text-gray-600'
            }`}
          >
            {tab.icon} {tab.label}
          </button>
        ))}
      </div>

      {/* ç³»ç»Ÿæç¤ºè¯ */}
      {activeTab === 'system' && (
        <div className="bg-white rounded-xl p-4 space-y-3">
          <div className="flex items-center justify-between">
            <h3 className="font-semibold">ğŸ¤– è§’è‰²æ‰®æ¼”ç³»ç»Ÿæç¤ºè¯</h3>
            <button
              onClick={() => handleReset('systemPrompt', defaultSystemPrompt)}
              className="text-xs text-blue-500"
            >
              é‡ç½®é»˜è®¤
            </button>
          </div>
          <p className="text-xs text-gray-500">
            ç”¨äºæ‰€æœ‰èŠå¤©çš„åŸºç¡€æç¤ºè¯ï¼ˆæ ¸å¿ƒè§„åˆ™å·²å†…ç½®ï¼Œè¿™é‡Œæ˜¯ä½ çš„è¡¥å……ï¼‰
          </p>
          <textarea
            value={localPrompts.systemPrompt}
            onChange={(e) => setLocalPrompts(prev => ({ ...prev, systemPrompt: e.target.value }))}
            className="w-full h-40 p-3 bg-gray-100 rounded-xl text-sm resize-none"
            placeholder="æ·»åŠ ä½ çš„è‡ªå®šä¹‰è§„åˆ™..."
          />
        </div>
      )}

      {/* æ€»ç»“æç¤ºè¯ */}
      {activeTab === 'summary' && (
        <div className="bg-white rounded-xl p-4 space-y-3">
          <div className="flex items-center justify-between">
            <h3 className="font-semibold">ğŸ“‹ å¯¹è¯æ€»ç»“æç¤ºè¯</h3>
            <button
              onClick={() => handleReset('summaryPrompt', defaultSummaryPrompt)}
              className="text-xs text-blue-500"
            >
              é‡ç½®é»˜è®¤
            </button>
          </div>
          <p className="text-xs text-gray-500">
            ç”¨äºç”ŸæˆèŠå¤©è®°å½•æ€»ç»“ï¼ˆæ ¸å¿ƒæ ¼å¼å·²å†…ç½®ï¼‰
          </p>
          <textarea
            value={localPrompts.summaryPrompt}
            onChange={(e) => setLocalPrompts(prev => ({ ...prev, summaryPrompt: e.target.value }))}
            className="w-full h-40 p-3 bg-gray-100 rounded-xl text-sm resize-none"
            placeholder="æ·»åŠ ä½ çš„æ€»ç»“è¦æ±‚..."
          />
        </div>
      )}

      {/* æ˜Ÿè¯­æç¤ºè¯ */}
      {activeTab === 'xingyu' && (
        <div className="space-y-4">
          <div className="bg-white rounded-xl p-4 space-y-3">
            <div className="flex items-center justify-between">
              <h3 className="font-semibold">ğŸ“ å¸–å­ç”Ÿæˆæç¤ºè¯</h3>
              <button
                onClick={() => handleReset('xingyuPostPrompt', defaultXingyuPostPrompt)}
                className="text-xs text-blue-500"
              >
                é‡ç½®
              </button>
            </div>
            <textarea
              value={localPrompts.xingyuPostPrompt}
              onChange={(e) => setLocalPrompts(prev => ({ ...prev, xingyuPostPrompt: e.target.value }))}
              className="w-full h-32 p-3 bg-gray-100 rounded-xl text-sm resize-none"
              placeholder="å¸–å­ç”Ÿæˆè§„åˆ™..."
            />
          </div>

          <div className="bg-white rounded-xl p-4 space-y-3">
            <div className="flex items-center justify-between">
              <h3 className="font-semibold">ğŸ’¬ è¯„è®ºç”Ÿæˆæç¤ºè¯</h3>
              <button
                onClick={() => handleReset('xingyuCommentPrompt', defaultXingyuCommentPrompt)}
                className="text-xs text-blue-500"
              >
                é‡ç½®
              </button>
            </div>
            <textarea
              value={localPrompts.xingyuCommentPrompt}
              onChange={(e) => setLocalPrompts(prev => ({ ...prev, xingyuCommentPrompt: e.target.value }))}
              className="w-full h-32 p-3 bg-gray-100 rounded-xl text-sm resize-none"
              placeholder="è¯„è®ºç”Ÿæˆè§„åˆ™..."
            />
          </div>

          <div className="bg-white rounded-xl p-4 space-y-3">
            <div className="flex items-center justify-between">
              <h3 className="font-semibold">ğŸ­ è§’è‰²å›å¤æç¤ºè¯</h3>
              <button
                onClick={() => handleReset('xingyuCharacterReplyPrompt', defaultXingyuCharacterReplyPrompt)}
                className="text-xs text-blue-500"
              >
                é‡ç½®
              </button>
            </div>
            <textarea
              value={localPrompts.xingyuCharacterReplyPrompt}
              onChange={(e) => setLocalPrompts(prev => ({ ...prev, xingyuCharacterReplyPrompt: e.target.value }))}
              className="w-full h-32 p-3 bg-gray-100 rounded-xl text-sm resize-none"
              placeholder="è§’è‰²å›å¤è¯„è®ºçš„è§„åˆ™..."
            />
          </div>
        </div>
      )}

      {/* ä¿å­˜æŒ‰é’® */}
      <button
        onClick={handleSave}
        className="w-full p-4 bg-blue-500 text-white rounded-xl font-medium"
      >
        ä¿å­˜æç¤ºè¯
      </button>

      {/* æç¤º */}
      <div className="bg-blue-50 rounded-xl p-4">
        <p className="text-xs text-blue-600">
          ğŸ’¡ æ ¸å¿ƒè§„åˆ™ï¼ˆå¦‚ç¬¦å·ä½¿ç”¨è§„èŒƒã€æ ¼å¼è¦æ±‚ç­‰ï¼‰å·²å†…ç½®ï¼Œæ— éœ€é‡å¤è®¾ç½®ã€‚
          è¿™é‡Œçš„æç¤ºè¯æ˜¯ä½ çš„<strong>è¡¥å……è§„åˆ™</strong>ï¼Œä¼šä¸å†…ç½®è§„åˆ™åˆå¹¶ä½¿ç”¨ã€‚
        </p>
      </div>

      {saveMsg && (
        <div className="fixed bottom-20 left-4 right-4 z-50">
          <div className="bg-black/80 text-white text-center py-3 px-4 rounded-xl text-sm">
            {saveMsg}
          </div>
        </div>
      )}
    </div>
  );
};
    
    // ==================== è£…æ‰®è®¾ç½®ç»„ä»¶ ====================
    const ThemeSettings = () => {
      const state = useStore();
      const [bgImage, setBgImage] = useState(state.themeSettings?.backgroundImage || '');
      const [bgColor, setBgColor] = useState(state.themeSettings?.backgroundColor || '');
      const [customCSS, setCustomCSS] = useState(state.themeSettings?.customCSS || '');
      const [saveMsg, setSaveMsg] = useState('');
      const [appIcons, setAppIcons] = useState(state.themeSettings?.appIcons || {});
      const fileInputRef = useRef(null);
      const iconInputRefs = useRef({});

      useEffect(() => {
        setBgImage(state.themeSettings?.backgroundImage || '');
        setBgColor(state.themeSettings?.backgroundColor || '');
        setCustomCSS(state.themeSettings?.customCSS || '');
        setAppIcons(state.themeSettings?.appIcons || {});
      }, [state.themeSettings]);

      const handleSave = () => {
        actions.updateThemeSettings({
          backgroundImage: bgImage,
          backgroundColor: bgColor,
          customCSS: customCSS,
          appIcons: appIcons
        });
        setSaveMsg('âœ… ä¿å­˜æˆåŠŸï¼');
        setTimeout(() => setSaveMsg(''), 2000);
      };

      const handleBgImageUpload = (e) => {
        const file = e.target.files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            setBgImage(event.target.result);
          };
          reader.readAsDataURL(file);
        }
      };

      const handleIconUpload = (appId, e) => {
        const file = e.target.files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            setAppIcons(prev => ({ ...prev, [appId]: event.target.result }));
          };
          reader.readAsDataURL(file);
        }
      };

      const clearIcon = (appId) => {
        setAppIcons(prev => ({ ...prev, [appId]: '' }));
      };

      const selectGradient = (gradient) => {
        setBgColor(gradient);
      };

      const gradients = [
        'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
        'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
        'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
        'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
        'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
        'linear-gradient(135deg, #d299c2 0%, #fef9d7 100%)',
        'linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)',
      ];

      const appList = [
        { id: 'worldbook', name: 'ä¸–ç•Œä¹¦' },
        { id: 'wechat', name: 'å¾®ä¿¡' },
        { id: 'contacts', name: 'é€šè®¯å½•' },
        { id: 'settings', name: 'è®¾ç½®' },
        { id: 'theme', name: 'è£…æ‰®' },
      ];

      return (
        <div className="w-full h-full bg-gray-100 flex flex-col">
          <div className="bg-pink-500 pt-12 pb-4 px-4">
            <div className="flex items-center gap-4">
              <button 
                onClick={() => actions.setScreen('home')} 
                className="text-white active:opacity-70"
              >
                <Icon name="ChevronLeft" size={24} />
              </button>
              <h1 className="text-white text-xl font-semibold">è£…æ‰®</h1>
            </div>
          </div>

          <div className="flex-1 overflow-y-auto p-4 space-y-4">
            
            {/* èƒŒæ™¯å›¾ç‰‡ */}
            <div className="bg-white rounded-2xl p-4 space-y-4">
              <h2 className="text-lg font-semibold text-gray-800">ğŸ–¼ï¸ èƒŒæ™¯å›¾ç‰‡</h2>
              
              <div>
                <label className="block text-sm text-gray-600 mb-2">å›¾ç‰‡URL</label>
                <input
                  type="text"
                  value={bgImage}
                  onChange={(e) => setBgImage(e.target.value)}
                  className="w-full p-3 bg-gray-100 rounded-xl text-sm"
                  placeholder="https://example.com/image.jpg"
                />
              </div>

              <div>
                <label className="block text-sm text-gray-600 mb-2">æˆ–ä¸Šä¼ å›¾ç‰‡</label>
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="image/*"
                  onChange={handleBgImageUpload}
                  className="hidden"
                />
                <button
                  onClick={() => fileInputRef.current?.click()}
                  className="w-full p-3 bg-pink-500 text-white rounded-xl text-sm active:bg-pink-600"
                >
                  ğŸ“ é€‰æ‹©å›¾ç‰‡æ–‡ä»¶
                </button>
              </div>

              {bgImage && (
                <div className="mt-2">
                  <p className="text-sm text-gray-600 mb-2">é¢„è§ˆï¼š</p>
                  <img src={bgImage} alt="é¢„è§ˆ" className="w-full h-32 object-cover rounded-xl" />
                  <button 
                    onClick={() => setBgImage('')}
                    className="mt-2 text-red-500 text-sm active:opacity-70"
                  >
                    ğŸ—‘ï¸ æ¸…é™¤å›¾ç‰‡
                  </button>
                </div>
              )}
            </div>

            {/* èƒŒæ™¯é¢œè‰² */}
            <div className="bg-white rounded-2xl p-4 space-y-4">
              <h2 className="text-lg font-semibold text-gray-800">ğŸ¨ èƒŒæ™¯é¢œè‰²</h2>
              
              <div>
                <label className="block text-sm text-gray-600 mb-2">é€‰æ‹©é¢œè‰²ï¼ˆå¦‚æœæ²¡æœ‰å›¾ç‰‡åˆ™ä½¿ç”¨é¢œè‰²ï¼‰</label>
                <div className="flex gap-2 items-center">
                  <input
                    type="color"
                    value={bgColor.startsWith('#') ? bgColor : '#a855f7'}
                    onChange={(e) => setBgColor(e.target.value)}
                    className="w-12 h-12 rounded-xl cursor-pointer border-0"
                    style={{ WebkitAppearance: 'none' }}
                  />
                  <input
                    type="text"
                    value={bgColor}
                    onChange={(e) => setBgColor(e.target.value)}
                    className="flex-1 p-3 bg-gray-100 rounded-xl text-sm"
                    placeholder="#a855f7 æˆ– linear-gradient(...)"
                  />
                </div>
              </div>

              {/* é¢„è®¾æ¸å˜ */}
              <div>
                <p className="text-sm text-gray-600 mb-2">é¢„è®¾æ¸å˜ï¼š</p>
                <div className="grid grid-cols-4 gap-2">
                  {gradients.map((gradient, i) => (
                    <button
                      key={i}
                      onClick={() => selectGradient(gradient)}
                      className={`w-full h-12 rounded-xl border-2 active:scale-95 transition-transform ${
                        bgColor === gradient ? 'border-pink-500 ring-2 ring-pink-300' : 'border-transparent'
                      }`}
                      style={{ background: gradient }}
                    />
                  ))}
                </div>
              </div>
            </div>
            
            {/* è‡ªå®šä¹‰å›¾æ ‡ */}
            <div className="bg-white rounded-2xl p-4 space-y-4">
              <h2 className="text-lg font-semibold text-gray-800">ğŸ° è‡ªå®šä¹‰å›¾æ ‡</h2>
              <p className="text-sm text-gray-500">ä¸Šä¼ é€æ˜èƒŒæ™¯çš„PNGå›¾ç‰‡æ•ˆæœæœ€ä½³</p>
              
              {appList.map((app) => (
                <div key={app.id} className="flex items-center gap-3 p-2 bg-gray-50 rounded-xl">
                  <div className="w-12 h-12 bg-gray-200 rounded-xl flex items-center justify-center overflow-hidden">
                    {appIcons[app.id] ? (
                      <img 
                        src={appIcons[app.id]} 
                        alt={app.name} 
                        className="w-full h-full object-contain"
                      />
                    ) : (
                      <span className="text-gray-400 text-xs">é»˜è®¤</span>
                    )}
                  </div>
                  <span className="flex-1 font-medium">{app.name}</span>
                  
                  <input
                    ref={el => iconInputRefs.current[app.id] = el}
                    type="file"
                    accept="image/*"
                    onChange={(e) => handleIconUpload(app.id, e)}
                    className="hidden"
                  />
                  <button
                    onClick={() => iconInputRefs.current[app.id]?.click()}
                    className="px-3 py-2 bg-pink-500 text-white text-sm rounded-lg active:bg-pink-600"
                  >
                    ä¸Šä¼ 
                  </button>
                  
                  {appIcons[app.id] && (
                    <button
                      onClick={() => clearIcon(app.id)}
                      className="px-3 py-2 bg-red-500 text-white text-sm rounded-lg active:bg-red-600"
                    >
                      æ¸…é™¤
                    </button>
                  )}
                </div>
              ))}
            </div>
            
            {/* è‡ªå®šä¹‰CSS */}
            <div className="bg-white rounded-2xl p-4 space-y-4">
              <h2 className="text-lg font-semibold text-gray-800">ğŸ’» å…¨å±€è‡ªå®šä¹‰CSS</h2>
              <textarea
                value={customCSS}
                onChange={(e) => setCustomCSS(e.target.value)}
                className="w-full h-40 p-3 bg-gray-100 rounded-xl text-sm font-mono resize-none"
                placeholder={`/* èŠå¤©é¡µé¢èƒŒæ™¯ */
.chat-bg {
  background: linear-gradient(to bottom, #e0f7fa, #fff);
}

/* å…¨å±€å­—ä½“ */
body {
  font-family: "PingFang SC", sans-serif;
}

/* å¤´éƒ¨å¯¼èˆªæ  */
.chat-header {
  background: #ff69b4;
}

/* è¾“å…¥æ¡†åŒºåŸŸ */
.chat-input {
  background: #fce4ec;
}`}
              />
              <p className="text-xs text-gray-500">
                æç¤ºï¼šç”¨äºä¿®æ”¹å…¨å±€æ ·å¼ï¼Œå¦‚èŠå¤©èƒŒæ™¯ã€å¯¼èˆªæ ã€å­—ä½“ç­‰ã€‚<br/>
                è§’è‰²çš„æ°”æ³¡å’ŒæŒ‚ä»¶è¯·åœ¨ã€Œé€šè®¯å½•ã€ä¸­è®¾ç½®ã€‚
              </p>
            </div>

            {/* ä¿å­˜æŒ‰é’® */}
            <button
              onClick={handleSave}
              className="w-full p-4 bg-pink-500 text-white rounded-2xl font-semibold flex items-center justify-center gap-2 active:bg-pink-600"
            >
              <Icon name="Save" size={20} />
              ä¿å­˜è£…æ‰®
            </button>

            {saveMsg && (
              <div className="fixed bottom-20 left-4 right-4 z-50">
                <div className="bg-black/80 text-white text-center py-3 px-4 rounded-xl font-medium animate-fade-in">
                  {saveMsg}
                </div>
              </div>
            )}

            {/* åº•éƒ¨ç©ºé—´ */}
            <div className="h-4"></div>
          </div>
        </div>
      );
    };
    
    // ==================== å…¨å±€é€šçŸ¥ç»„ä»¶ ====================
const GlobalNotifications = () => {
  const state = useStore();
  const notifications = state.notifications || [];
  
  if (notifications.length === 0) return null;
  
  const handleClick = (notification) => {
    actions.setCurrentChat(notification.chatId);
    actions.setScreen('wechat');
    actions.removeNotification(notification.id);
  };
  
  const handleDismiss = (e, id) => {
    e.stopPropagation();
    actions.removeNotification(id);
  };
  
  return (
    <div className="absolute top-0 left-0 right-0 z-[100] p-2 space-y-2 pointer-events-none">
      {notifications.slice(-3).map((notification) => (
        <div
          key={notification.id}
          onClick={() => handleClick(notification)}
          className="pointer-events-auto mx-2 bg-white rounded-2xl shadow-lg p-3 flex items-center gap-3 animate-slide-down cursor-pointer active:bg-gray-50"
        >
          <div className="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center">
            <Icon name="MessageCircle" size={20} className="text-white" />
          </div>
          <div className="flex-1 min-w-0">
            <p className="font-semibold text-gray-800 text-sm">{notification.chatName}</p>
            <p className="text-xs text-gray-500 truncate">{notification.message}</p>
          </div>
          <button 
            onClick={(e) => handleDismiss(e, notification.id)}
            className="text-gray-400 p-1"
          >
            <Icon name="X" size={16} />
          </button>
        </div>
      ))}
    </div>
  );
};

// ==================== æ‰‹æœºå¤–å£³ç»„ä»¶ ====================
const Phone = () => {
      const state = useStore();

      const renderScreen = () => {
        switch (state.appState.currentScreen) {
          case 'lock': return <LockScreen />;
          case 'home': return <HomeScreen />;
          case 'wechat': return <WeChat />;
          case 'contacts': return <Contacts />;
          case 'settings': return <Settings />;
          case 'worldbook': return <WorldBook />;
          case 'theme': return <ThemeSettings />;
          case 'xingyu': return <XingYuApp />;
          default: return <LockScreen />;
        }
      };

      return (
        <div className="relative">
          {/* iPhone å¤–å£³ */}
          <div className="relative w-[340px] h-[620px] bg-black rounded-[45px] p-[10px] shadow-2xl">
            {/* å±å¹•è¾¹æ¡† */}
            <div className="relative w-full h-full bg-black rounded-[32px] overflow-hidden">
              {/* åˆ˜æµ· */}
              <div className="absolute top-0 left-1/2 transform -translate-x-1/2 w-[110px] h-[22px] bg-black rounded-b-[14px] z-50" />
              
              {/* å±å¹•å†…å®¹ */}
              <div 
                className="w-full h-full overflow-hidden relative"
                style={{
                  background: state.themeSettings?.backgroundImage 
                    ? `url(${state.themeSettings.backgroundImage}) center/cover`
                    : state.themeSettings?.backgroundColor || 'linear-gradient(135deg, #a855f7 0%, #ec4899 50%, #3b82f6 100%)'
                }}
              >
                {renderScreen()}
<GlobalNotifications />
{state.themeSettings?.customCSS && (
  <style>{state.themeSettings.customCSS}</style>
)}
              </div>

              {/* åº•éƒ¨æŒ‡ç¤ºæ¡ */}
              <div className="absolute bottom-1 left-1/2 transform -translate-x-1/2 w-[100px] h-[4px] bg-white/50 rounded-full z-50" />
            </div>
          </div>
        </div>
      );
    };

    // ==================== ä¸»åº”ç”¨ ====================
    const App = () => {
      return (
        <div className="min-h-screen flex items-start justify-center pt-4 pb-8">
          <Phone />
        </div>
      );
    };

    // æ¸²æŸ“åº”ç”¨
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
